import{r as t,g as e,f as i,h as n,H as s}from"./p-7af91c05.js";import{r}from"./p-23a9d308.js";function o(t,e){e.forEach((function(e){e&&typeof e!=="string"&&!Array.isArray(e)&&Object.keys(e).forEach((function(i){if(i!=="default"&&!(i in t)){var n=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(t,i,n.get?n:{enumerable:true,get:function(){return e[i]}})}}))}));return Object.freeze(t)}var a=Object.defineProperty;var c=(t,e,i)=>e in t?a(t,e,{enumerable:true,configurable:true,writable:true,value:i}):t[e]=i;var u=(t,e,i)=>c(t,typeof e!="symbol"?e+"":e,i);class d{constructor(){u(this,"_locking");u(this,"_locks");this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){this._locks+=1;let t;const e=new Promise((e=>t=()=>{this._locks-=1,e()})),i=this._locking.then((()=>t));return this._locking=this._locking.then((()=>e)),i}}function h(t,e){if(!t){throw new Error(e)}}const l=34028234663852886e22,f=-34028234663852886e22,m=4294967295,v=2147483647,p=-2147483648;function b(t){if(typeof t!=="number")throw new Error("invalid int 32: "+typeof t);if(!Number.isInteger(t)||t>v||t<p)throw new Error("invalid int 32: "+t)}function g(t){if(typeof t!=="number")throw new Error("invalid uint 32: "+typeof t);if(!Number.isInteger(t)||t>m||t<0)throw new Error("invalid uint 32: "+t)}function y(t){if(typeof t!=="number")throw new Error("invalid float 32: "+typeof t);if(!Number.isFinite(t))return;if(t>l||t<f)throw new Error("invalid float 32: "+t)}const k=Symbol("@bufbuild/protobuf/enum-type");function w(t){const e=t[k];h(e,"missing enum type on enum object");return e}function T(t,e,i,n){t[k]=S(e,i.map((e=>({no:e.no,name:e.name,localName:t[e.no]}))))}function S(t,e,i){const n=Object.create(null);const s=Object.create(null);const r=[];for(const t of e){const e=E(t);r.push(e);n[t.name]=e;s[t.no]=e}return{typeName:t,values:r,findName(t){return n[t]},findNumber(t){return s[t]}}}function O(t,e,i){const n={};for(const t of e){const e=E(t);n[e.localName]=e.no;n[e.no]=e.localName}T(n,t,e);return n}function E(t){if("localName"in t){return t}return Object.assign(Object.assign({},t),{localName:t.name})}class C{equals(t){return this.getType().runtime.util.equals(this.getType(),this,t)}clone(){return this.getType().runtime.util.clone(this)}fromBinary(t,e){const i=this.getType(),n=i.runtime.bin,s=n.makeReadOptions(e);n.readMessage(this,s.readerFactory(t),t.byteLength,s);return this}fromJson(t,e){const i=this.getType(),n=i.runtime.json,s=n.makeReadOptions(e);n.readMessage(i,t,s,this);return this}fromJsonString(t,e){let i;try{i=JSON.parse(t)}catch(t){throw new Error("cannot decode ".concat(this.getType().typeName," from JSON: ").concat(t instanceof Error?t.message:String(t)))}return this.fromJson(i,e)}toBinary(t){const e=this.getType(),i=e.runtime.bin,n=i.makeWriteOptions(t),s=n.writerFactory();i.writeMessage(this,s,n);return s.finish()}toJson(t){const e=this.getType(),i=e.runtime.json,n=i.makeWriteOptions(t);return i.writeMessage(this,n)}toJsonString(t){var e;const i=this.toJson(t);return JSON.stringify(i,null,(e=t===null||t===void 0?void 0:t.prettySpaces)!==null&&e!==void 0?e:0)}toJSON(){return this.toJson({emitDefaultValues:true})}getType(){return Object.getPrototypeOf(this).constructor}}function j(t,e,i,n){var s;const r=(s=n===null||n===void 0?void 0:n.localName)!==null&&s!==void 0?s:e.substring(e.lastIndexOf(".")+1);const o={[r]:function(e){t.util.initFields(this);t.util.initPartial(e,this)}}[r];Object.setPrototypeOf(o.prototype,new C);Object.assign(o,{runtime:t,typeName:e,fields:t.util.newFieldList(i),fromBinary(t,e){return(new o).fromBinary(t,e)},fromJson(t,e){return(new o).fromJson(t,e)},fromJsonString(t,e){return(new o).fromJsonString(t,e)},equals(e,i){return t.util.equals(o,e,i)}});return o}function R(){let t=0;let e=0;for(let i=0;i<28;i+=7){let n=this.buf[this.pos++];t|=(n&127)<<i;if((n&128)==0){this.assertBounds();return[t,e]}}let i=this.buf[this.pos++];t|=(i&15)<<28;e=(i&112)>>4;if((i&128)==0){this.assertBounds();return[t,e]}for(let i=3;i<=31;i+=7){let n=this.buf[this.pos++];e|=(n&127)<<i;if((n&128)==0){this.assertBounds();return[t,e]}}throw new Error("invalid varint")}function I(t,e,i){for(let n=0;n<28;n=n+7){const s=t>>>n;const r=!(s>>>7==0&&e==0);const o=(r?s|128:s)&255;i.push(o);if(!r){return}}const n=t>>>28&15|(e&7)<<4;const s=!(e>>3==0);i.push((s?n|128:n)&255);if(!s){return}for(let t=3;t<31;t=t+7){const n=e>>>t;const s=!(n>>>7==0);const r=(s?n|128:n)&255;i.push(r);if(!s){return}}i.push(e>>>31&1)}const _=4294967296;function P(t){const e=t[0]==="-";if(e){t=t.slice(1)}const i=1e6;let n=0;let s=0;function r(e,r){const o=Number(t.slice(e,r));s*=i;n=n*i+o;if(n>=_){s=s+(n/_|0);n=n%_}}r(-24,-18);r(-18,-12);r(-12,-6);r(-6);return e?M(n,s):x(n,s)}function N(t,e){let i=x(t,e);const n=i.hi&2147483648;if(n){i=M(i.lo,i.hi)}const s=D(i.lo,i.hi);return n?"-"+s:s}function D(t,e){({lo:t,hi:e}=A(t,e));if(e<=2097151){return String(_*e+t)}const i=t&16777215;const n=(t>>>24|e<<8)&16777215;const s=e>>16&65535;let r=i+n*6777216+s*6710656;let o=n+s*8147497;let a=s*2;const c=1e7;if(r>=c){o+=Math.floor(r/c);r%=c}if(o>=c){a+=Math.floor(o/c);o%=c}return a.toString()+U(o)+U(r)}function A(t,e){return{lo:t>>>0,hi:e>>>0}}function x(t,e){return{lo:t|0,hi:e|0}}function M(t,e){e=~e;if(t){t=~t+1}else{e+=1}return x(t,e)}const U=t=>{const e=String(t);return"0000000".slice(e.length)+e};function L(t,e){if(t>=0){while(t>127){e.push(t&127|128);t=t>>>7}e.push(t)}else{for(let i=0;i<9;i++){e.push(t&127|128);t=t>>7}e.push(1)}}function F(){let t=this.buf[this.pos++];let e=t&127;if((t&128)==0){this.assertBounds();return e}t=this.buf[this.pos++];e|=(t&127)<<7;if((t&128)==0){this.assertBounds();return e}t=this.buf[this.pos++];e|=(t&127)<<14;if((t&128)==0){this.assertBounds();return e}t=this.buf[this.pos++];e|=(t&127)<<21;if((t&128)==0){this.assertBounds();return e}t=this.buf[this.pos++];e|=(t&15)<<28;for(let e=5;(t&128)!==0&&e<10;e++)t=this.buf[this.pos++];if((t&128)!=0)throw new Error("invalid varint");this.assertBounds();return e>>>0}function q(){const t=new DataView(new ArrayBuffer(8));const e=typeof BigInt==="function"&&typeof t.getBigInt64==="function"&&typeof t.getBigUint64==="function"&&typeof t.setBigInt64==="function"&&typeof t.setBigUint64==="function"&&(typeof process!="object"||typeof process.env!="object"||process.env.BUF_BIGINT_DISABLE!=="1");if(e){const e=BigInt("-9223372036854775808"),i=BigInt("9223372036854775807"),n=BigInt("0"),s=BigInt("18446744073709551615");return{zero:BigInt(0),supported:true,parse(t){const n=typeof t=="bigint"?t:BigInt(t);if(n>i||n<e){throw new Error("int64 invalid: ".concat(t))}return n},uParse(t){const e=typeof t=="bigint"?t:BigInt(t);if(e>s||e<n){throw new Error("uint64 invalid: ".concat(t))}return e},enc(e){t.setBigInt64(0,this.parse(e),true);return{lo:t.getInt32(0,true),hi:t.getInt32(4,true)}},uEnc(e){t.setBigInt64(0,this.uParse(e),true);return{lo:t.getInt32(0,true),hi:t.getInt32(4,true)}},dec(e,i){t.setInt32(0,e,true);t.setInt32(4,i,true);return t.getBigInt64(0,true)},uDec(e,i){t.setInt32(0,e,true);t.setInt32(4,i,true);return t.getBigUint64(0,true)}}}const i=t=>h(/^-?[0-9]+$/.test(t),"int64 invalid: ".concat(t));const n=t=>h(/^[0-9]+$/.test(t),"uint64 invalid: ".concat(t));return{zero:"0",supported:false,parse(t){if(typeof t!="string"){t=t.toString()}i(t);return t},uParse(t){if(typeof t!="string"){t=t.toString()}n(t);return t},enc(t){if(typeof t!="string"){t=t.toString()}i(t);return P(t)},uEnc(t){if(typeof t!="string"){t=t.toString()}n(t);return P(t)},dec(t,e){return N(t,e)},uDec(t,e){return D(t,e)}}}const B=q();var V;(function(t){t[t["DOUBLE"]=1]="DOUBLE";t[t["FLOAT"]=2]="FLOAT";t[t["INT64"]=3]="INT64";t[t["UINT64"]=4]="UINT64";t[t["INT32"]=5]="INT32";t[t["FIXED64"]=6]="FIXED64";t[t["FIXED32"]=7]="FIXED32";t[t["BOOL"]=8]="BOOL";t[t["STRING"]=9]="STRING";t[t["BYTES"]=12]="BYTES";t[t["UINT32"]=13]="UINT32";t[t["SFIXED32"]=15]="SFIXED32";t[t["SFIXED64"]=16]="SFIXED64";t[t["SINT32"]=17]="SINT32";t[t["SINT64"]=18]="SINT64"})(V||(V={}));var J;(function(t){t[t["BIGINT"]=0]="BIGINT";t[t["STRING"]=1]="STRING"})(J||(J={}));function G(t,e,i){if(e===i){return true}if(t==V.BYTES){if(!(e instanceof Uint8Array)||!(i instanceof Uint8Array)){return false}if(e.length!==i.length){return false}for(let t=0;t<e.length;t++){if(e[t]!==i[t]){return false}}return true}switch(t){case V.UINT64:case V.FIXED64:case V.INT64:case V.SFIXED64:case V.SINT64:return e==i}return false}function H(t,e){switch(t){case V.BOOL:return false;case V.UINT64:case V.FIXED64:case V.INT64:case V.SFIXED64:case V.SINT64:return e==0?B.zero:"0";case V.DOUBLE:case V.FLOAT:return 0;case V.BYTES:return new Uint8Array(0);case V.STRING:return"";default:return 0}}function z(t,e){switch(t){case V.BOOL:return e===false;case V.STRING:return e==="";case V.BYTES:return e instanceof Uint8Array&&!e.byteLength;default:return e==0}}var W;(function(t){t[t["Varint"]=0]="Varint";t[t["Bit64"]=1]="Bit64";t[t["LengthDelimited"]=2]="LengthDelimited";t[t["StartGroup"]=3]="StartGroup";t[t["EndGroup"]=4]="EndGroup";t[t["Bit32"]=5]="Bit32"})(W||(W={}));class K{constructor(t){this.stack=[];this.textEncoder=t!==null&&t!==void 0?t:new TextEncoder;this.chunks=[];this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let t=0;for(let e=0;e<this.chunks.length;e++)t+=this.chunks[e].length;let e=new Uint8Array(t);let i=0;for(let t=0;t<this.chunks.length;t++){e.set(this.chunks[t],i);i+=this.chunks[t].length}this.chunks=[];return e}fork(){this.stack.push({chunks:this.chunks,buf:this.buf});this.chunks=[];this.buf=[];return this}join(){let t=this.finish();let e=this.stack.pop();if(!e)throw new Error("invalid state, fork stack empty");this.chunks=e.chunks;this.buf=e.buf;this.uint32(t.byteLength);return this.raw(t)}tag(t,e){return this.uint32((t<<3|e)>>>0)}raw(t){if(this.buf.length){this.chunks.push(new Uint8Array(this.buf));this.buf=[]}this.chunks.push(t);return this}uint32(t){g(t);while(t>127){this.buf.push(t&127|128);t=t>>>7}this.buf.push(t);return this}int32(t){b(t);L(t,this.buf);return this}bool(t){this.buf.push(t?1:0);return this}bytes(t){this.uint32(t.byteLength);return this.raw(t)}string(t){let e=this.textEncoder.encode(t);this.uint32(e.byteLength);return this.raw(e)}float(t){y(t);let e=new Uint8Array(4);new DataView(e.buffer).setFloat32(0,t,true);return this.raw(e)}double(t){let e=new Uint8Array(8);new DataView(e.buffer).setFloat64(0,t,true);return this.raw(e)}fixed32(t){g(t);let e=new Uint8Array(4);new DataView(e.buffer).setUint32(0,t,true);return this.raw(e)}sfixed32(t){b(t);let e=new Uint8Array(4);new DataView(e.buffer).setInt32(0,t,true);return this.raw(e)}sint32(t){b(t);t=(t<<1^t>>31)>>>0;L(t,this.buf);return this}sfixed64(t){let e=new Uint8Array(8),i=new DataView(e.buffer),n=B.enc(t);i.setInt32(0,n.lo,true);i.setInt32(4,n.hi,true);return this.raw(e)}fixed64(t){let e=new Uint8Array(8),i=new DataView(e.buffer),n=B.uEnc(t);i.setInt32(0,n.lo,true);i.setInt32(4,n.hi,true);return this.raw(e)}int64(t){let e=B.enc(t);I(e.lo,e.hi,this.buf);return this}sint64(t){let e=B.enc(t),i=e.hi>>31,n=e.lo<<1^i,s=(e.hi<<1|e.lo>>>31)^i;I(n,s,this.buf);return this}uint64(t){let e=B.uEnc(t);I(e.lo,e.hi,this.buf);return this}}class Q{constructor(t,e){this.varint64=R;this.uint32=F;this.buf=t;this.len=t.length;this.pos=0;this.view=new DataView(t.buffer,t.byteOffset,t.byteLength);this.textDecoder=e!==null&&e!==void 0?e:new TextDecoder}tag(){let t=this.uint32(),e=t>>>3,i=t&7;if(e<=0||i<0||i>5)throw new Error("illegal tag: field no "+e+" wire type "+i);return[e,i]}skip(t,e){let i=this.pos;switch(t){case W.Varint:while(this.buf[this.pos++]&128){}break;case W.Bit64:this.pos+=4;case W.Bit32:this.pos+=4;break;case W.LengthDelimited:let i=this.uint32();this.pos+=i;break;case W.StartGroup:for(;;){const[t,i]=this.tag();if(i===W.EndGroup){if(e!==undefined&&t!==e){throw new Error("invalid end group tag")}break}this.skip(i,t)}break;default:throw new Error("cant skip wire type "+t)}this.assertBounds();return this.buf.subarray(i,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return this.uint32()|0}sint32(){let t=this.uint32();return t>>>1^-(t&1)}int64(){return B.dec(...this.varint64())}uint64(){return B.uDec(...this.varint64())}sint64(){let[t,e]=this.varint64();let i=-(t&1);t=(t>>>1|(e&1)<<31)^i;e=e>>>1^i;return B.dec(t,e)}bool(){let[t,e]=this.varint64();return t!==0||e!==0}fixed32(){return this.view.getUint32((this.pos+=4)-4,true)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,true)}fixed64(){return B.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return B.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,true)}double(){return this.view.getFloat64((this.pos+=8)-8,true)}bytes(){let t=this.uint32(),e=this.pos;this.pos+=t;this.assertBounds();return this.buf.subarray(e,e+t)}string(){return this.textDecoder.decode(this.bytes())}}function Y(t,e,i,n){let s;return{typeName:e,extendee:i,get field(){if(!s){const i=typeof n=="function"?n():n;i.name=e.split(".").pop();i.jsonName="[".concat(e,"]");s=t.util.newFieldList([i]).list()[0]}return s},runtime:t}}function Z(t){const e=t.field.localName;const i=Object.create(null);i[e]=$(t);return[i,()=>i[e]]}function $(t){const e=t.field;if(e.repeated){return[]}if(e.default!==undefined){return e.default}switch(e.kind){case"enum":return e.T.values[0].no;case"scalar":return H(e.T,e.L);case"message":const t=e.T,i=new t;return t.fieldWrapper?t.fieldWrapper.unwrapField(i):i;case"map":throw"map fields are not allowed to be extensions"}}function X(t,e){if(!e.repeated&&(e.kind=="enum"||e.kind=="scalar")){for(let i=t.length-1;i>=0;--i){if(t[i].no==e.no){return[t[i]]}}return[]}return t.filter((t=>t.no===e.no))}let tt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("");let et=[];for(let t=0;t<tt.length;t++)et[tt[t].charCodeAt(0)]=t;et["-".charCodeAt(0)]=tt.indexOf("+");et["_".charCodeAt(0)]=tt.indexOf("/");const it={dec(t){let e=t.length*3/4;if(t[t.length-2]=="=")e-=2;else if(t[t.length-1]=="=")e-=1;let i=new Uint8Array(e),n=0,s=0,r,o=0;for(let e=0;e<t.length;e++){r=et[t.charCodeAt(e)];if(r===undefined){switch(t[e]){case"=":s=0;case"\n":case"\r":case"\t":case" ":continue;default:throw Error("invalid base64 string.")}}switch(s){case 0:o=r;s=1;break;case 1:i[n++]=o<<2|(r&48)>>4;o=r;s=2;break;case 2:i[n++]=(o&15)<<4|(r&60)>>2;o=r;s=3;break;case 3:i[n++]=(o&3)<<6|r;s=0;break}}if(s==1)throw Error("invalid base64 string.");return i.subarray(0,n)},enc(t){let e="",i=0,n,s=0;for(let r=0;r<t.length;r++){n=t[r];switch(i){case 0:e+=tt[n>>2];s=(n&3)<<4;i=1;break;case 1:e+=tt[s|n>>4];s=(n&15)<<2;i=2;break;case 2:e+=tt[s|n>>6];e+=tt[n&63];i=0;break}}if(i){e+=tt[s];e+="=";if(i==1)e+="="}return e}};function nt(t,e,i){ot(e,t);const n=e.runtime.bin.makeReadOptions(i);const s=X(t.getType().runtime.bin.listUnknownFields(t),e.field);const[r,o]=Z(e);for(const t of s){e.runtime.bin.readField(r,n.readerFactory(t.data),e.field,t.wireType,n)}return o()}function st(t,e,i,n){ot(e,t);const s=e.runtime.bin.makeReadOptions(n);const r=e.runtime.bin.makeWriteOptions(n);if(rt(t,e)){const i=t.getType().runtime.bin.listUnknownFields(t).filter((t=>t.no!=e.field.no));t.getType().runtime.bin.discardUnknownFields(t);for(const e of i){t.getType().runtime.bin.onUnknownField(t,e.no,e.wireType,e.data)}}const o=r.writerFactory();let a=e.field;if(!a.opt&&!a.repeated&&(a.kind=="enum"||a.kind=="scalar")){a=Object.assign(Object.assign({},e.field),{opt:true})}e.runtime.bin.writeField(a,i,o,r);const c=s.readerFactory(o.finish());while(c.pos<c.len){const[e,i]=c.tag();const n=c.skip(i,e);t.getType().runtime.bin.onUnknownField(t,e,i,n)}}function rt(t,e){const i=t.getType();return e.extendee.typeName===i.typeName&&!!i.runtime.bin.listUnknownFields(t).find((t=>t.no==e.field.no))}function ot(t,e){h(t.extendee.typeName==e.getType().typeName,"extension ".concat(t.typeName," can only be applied to message ").concat(t.extendee.typeName))}function at(t,e){const i=t.localName;if(t.repeated){return e[i].length>0}if(t.oneof){return e[t.oneof.localName].case===i}switch(t.kind){case"enum":case"scalar":if(t.opt||t.req){return e[i]!==undefined}if(t.kind=="enum"){return e[i]!==t.T.values[0].no}return!z(t.T,e[i]);case"message":return e[i]!==undefined;case"map":return Object.keys(e[i]).length>0}}function ct(t,e){const i=t.localName;const n=!t.opt&&!t.req;if(t.repeated){e[i]=[]}else if(t.oneof){e[t.oneof.localName]={case:undefined}}else{switch(t.kind){case"map":e[i]={};break;case"enum":e[i]=n?t.T.values[0].no:undefined;break;case"scalar":e[i]=n?H(t.T,t.L):undefined;break;case"message":e[i]=undefined;break}}}function ut(t,e){if(t===null||typeof t!="object"){return false}if(!Object.getOwnPropertyNames(C.prototype).every((e=>e in t&&typeof t[e]=="function"))){return false}const i=t.getType();if(i===null||typeof i!="function"||!("typeName"in i)||typeof i.typeName!="string"){return false}return e===undefined?true:i.typeName==e.typeName}function dt(t,e){if(ut(e)||!t.fieldWrapper){return e}return t.fieldWrapper.wrapField(e)}const ht={ignoreUnknownFields:false};const lt={emitDefaultValues:false,enumAsInteger:false,useProtoFieldName:false,prettySpaces:0};function ft(t){return t?Object.assign(Object.assign({},ht),t):ht}function mt(t){return t?Object.assign(Object.assign({},lt),t):lt}const vt=Symbol();const pt=Symbol();function bt(){return{makeReadOptions:ft,makeWriteOptions:mt,readMessage(t,e,i,n){if(e==null||Array.isArray(e)||typeof e!="object"){throw new Error("cannot decode message ".concat(t.typeName," from JSON: ").concat(gt(e)))}n=n!==null&&n!==void 0?n:new t;const s=new Map;const r=i.typeRegistry;for(const[o,a]of Object.entries(e)){const e=t.fields.findJsonName(o);if(e){if(e.oneof){if(a===null&&e.kind=="scalar"){continue}const i=s.get(e.oneof);if(i!==undefined){throw new Error("cannot decode message ".concat(t.typeName,' from JSON: multiple keys for oneof "').concat(e.oneof.name,'" present: "').concat(i,'", "').concat(o,'"'))}s.set(e.oneof,o)}yt(n,a,e,i,t)}else{let e=false;if((r===null||r===void 0?void 0:r.findExtension)&&o.startsWith("[")&&o.endsWith("]")){const s=r.findExtension(o.substring(1,o.length-1));if(s&&s.extendee.typeName==t.typeName){e=true;const[t,r]=Z(s);yt(t,a,s.field,i,s);st(n,s,r(),i)}}if(!e&&!i.ignoreUnknownFields){throw new Error("cannot decode message ".concat(t.typeName,' from JSON: key "').concat(o,'" is unknown'))}}}return n},writeMessage(t,e){const i=t.getType();const n={};let s;try{for(s of i.fields.byNumber()){if(!at(s,t)){if(s.req){throw"required field not set"}if(!e.emitDefaultValues){continue}if(!St(s)){continue}}const i=s.oneof?t[s.oneof.localName].value:t[s.localName];const r=Ot(s,i,e);if(r!==undefined){n[e.useProtoFieldName?s.name:s.jsonName]=r}}const r=e.typeRegistry;if(r===null||r===void 0?void 0:r.findExtensionFor){for(const s of i.runtime.bin.listUnknownFields(t)){const o=r.findExtensionFor(i.typeName,s.no);if(o&&rt(t,o)){const i=nt(t,o,e);const s=Ot(o.field,i,e);if(s!==undefined){n[o.field.jsonName]=s}}}}}catch(t){const e=s?"cannot encode field ".concat(i.typeName,".").concat(s.name," to JSON"):"cannot encode message ".concat(i.typeName," to JSON");const n=t instanceof Error?t.message:String(t);throw new Error(e+(n.length>0?": ".concat(n):""))}return n},readScalar(t,e,i){return wt(t,e,i!==null&&i!==void 0?i:J.BIGINT,true)},writeScalar(t,e,i){if(e===undefined){return undefined}if(i||z(t,e)){return Ct(t,e)}return undefined},debug:gt}}function gt(t){if(t===null){return"null"}switch(typeof t){case"object":return Array.isArray(t)?"array":"object";case"string":return t.length>100?"string":'"'.concat(t.split('"').join('\\"'),'"');default:return String(t)}}function yt(t,e,i,n,s){let r=i.localName;if(i.repeated){h(i.kind!="map");if(e===null){return}if(!Array.isArray(e)){throw new Error("cannot decode field ".concat(s.typeName,".").concat(i.name," from JSON: ").concat(gt(e)))}const o=t[r];for(const t of e){if(t===null){throw new Error("cannot decode field ".concat(s.typeName,".").concat(i.name," from JSON: ").concat(gt(t)))}switch(i.kind){case"message":o.push(i.T.fromJson(t,n));break;case"enum":const e=Tt(i.T,t,n.ignoreUnknownFields,true);if(e!==pt){o.push(e)}break;case"scalar":try{o.push(wt(i.T,t,i.L,true))}catch(e){let n="cannot decode field ".concat(s.typeName,".").concat(i.name," from JSON: ").concat(gt(t));if(e instanceof Error&&e.message.length>0){n+=": ".concat(e.message)}throw new Error(n)}break}}}else if(i.kind=="map"){if(e===null){return}if(typeof e!="object"||Array.isArray(e)){throw new Error("cannot decode field ".concat(s.typeName,".").concat(i.name," from JSON: ").concat(gt(e)))}const o=t[r];for(const[t,r]of Object.entries(e)){if(r===null){throw new Error("cannot decode field ".concat(s.typeName,".").concat(i.name," from JSON: map value null"))}let a;try{a=kt(i.K,t)}catch(t){let n="cannot decode map key for field ".concat(s.typeName,".").concat(i.name," from JSON: ").concat(gt(e));if(t instanceof Error&&t.message.length>0){n+=": ".concat(t.message)}throw new Error(n)}switch(i.V.kind){case"message":o[a]=i.V.T.fromJson(r,n);break;case"enum":const t=Tt(i.V.T,r,n.ignoreUnknownFields,true);if(t!==pt){o[a]=t}break;case"scalar":try{o[a]=wt(i.V.T,r,J.BIGINT,true)}catch(t){let n="cannot decode map value for field ".concat(s.typeName,".").concat(i.name," from JSON: ").concat(gt(e));if(t instanceof Error&&t.message.length>0){n+=": ".concat(t.message)}throw new Error(n)}break}}}else{if(i.oneof){t=t[i.oneof.localName]={case:r};r="value"}switch(i.kind){case"message":const o=i.T;if(e===null&&o.typeName!="google.protobuf.Value"){return}let a=t[r];if(ut(a)){a.fromJson(e,n)}else{t[r]=a=o.fromJson(e,n);if(o.fieldWrapper&&!i.oneof){t[r]=o.fieldWrapper.unwrapField(a)}}break;case"enum":const c=Tt(i.T,e,n.ignoreUnknownFields,false);switch(c){case vt:ct(i,t);break;case pt:break;default:t[r]=c;break}break;case"scalar":try{const n=wt(i.T,e,i.L,false);switch(n){case vt:ct(i,t);break;default:t[r]=n;break}}catch(t){let n="cannot decode field ".concat(s.typeName,".").concat(i.name," from JSON: ").concat(gt(e));if(t instanceof Error&&t.message.length>0){n+=": ".concat(t.message)}throw new Error(n)}break}}}function kt(t,e){if(t===V.BOOL){switch(e){case"true":e=true;break;case"false":e=false;break}}return wt(t,e,J.BIGINT,true).toString()}function wt(t,e,i,n){if(e===null){if(n){return H(t,i)}return vt}switch(t){case V.DOUBLE:case V.FLOAT:if(e==="NaN")return Number.NaN;if(e==="Infinity")return Number.POSITIVE_INFINITY;if(e==="-Infinity")return Number.NEGATIVE_INFINITY;if(e===""){break}if(typeof e=="string"&&e.trim().length!==e.length){break}if(typeof e!="string"&&typeof e!="number"){break}const n=Number(e);if(Number.isNaN(n)){break}if(!Number.isFinite(n)){break}if(t==V.FLOAT)y(n);return n;case V.INT32:case V.FIXED32:case V.SFIXED32:case V.SINT32:case V.UINT32:let s;if(typeof e=="number")s=e;else if(typeof e=="string"&&e.length>0){if(e.trim().length===e.length)s=Number(e)}if(s===undefined)break;if(t==V.UINT32||t==V.FIXED32)g(s);else b(s);return s;case V.INT64:case V.SFIXED64:case V.SINT64:if(typeof e!="number"&&typeof e!="string")break;const r=B.parse(e);return i?r.toString():r;case V.FIXED64:case V.UINT64:if(typeof e!="number"&&typeof e!="string")break;const o=B.uParse(e);return i?o.toString():o;case V.BOOL:if(typeof e!=="boolean")break;return e;case V.STRING:if(typeof e!=="string"){break}return e;case V.BYTES:if(e==="")return new Uint8Array(0);if(typeof e!=="string")break;return it.dec(e)}throw new Error}function Tt(t,e,i,n){if(e===null){if(t.typeName=="google.protobuf.NullValue"){return 0}return n?t.values[0].no:vt}switch(typeof e){case"number":if(Number.isInteger(e)){return e}break;case"string":const n=t.findName(e);if(n!==undefined){return n.no}if(i){return pt}break}throw new Error("cannot decode enum ".concat(t.typeName," from JSON: ").concat(gt(e)))}function St(t){if(t.repeated||t.kind=="map"){return true}if(t.oneof){return false}if(t.kind=="message"){return false}if(t.opt||t.req){return false}return true}function Ot(t,e,i){if(t.kind=="map"){h(typeof e=="object"&&e!=null);const n={};const s=Object.entries(e);switch(t.V.kind){case"scalar":for(const[e,i]of s){n[e.toString()]=Ct(t.V.T,i)}break;case"message":for(const[t,e]of s){n[t.toString()]=e.toJson(i)}break;case"enum":const e=t.V.T;for(const[t,r]of s){n[t.toString()]=Et(e,r,i.enumAsInteger)}break}return i.emitDefaultValues||s.length>0?n:undefined}if(t.repeated){h(Array.isArray(e));const n=[];switch(t.kind){case"scalar":for(let i=0;i<e.length;i++){n.push(Ct(t.T,e[i]))}break;case"enum":for(let s=0;s<e.length;s++){n.push(Et(t.T,e[s],i.enumAsInteger))}break;case"message":for(let t=0;t<e.length;t++){n.push(e[t].toJson(i))}break}return i.emitDefaultValues||n.length>0?n:undefined}switch(t.kind){case"scalar":return Ct(t.T,e);case"enum":return Et(t.T,e,i.enumAsInteger);case"message":return dt(t.T,e).toJson(i)}}function Et(t,e,i){var n;h(typeof e=="number");if(t.typeName=="google.protobuf.NullValue"){return null}if(i){return e}const s=t.findNumber(e);return(n=s===null||s===void 0?void 0:s.name)!==null&&n!==void 0?n:e}function Ct(t,e){switch(t){case V.INT32:case V.SFIXED32:case V.SINT32:case V.FIXED32:case V.UINT32:h(typeof e=="number");return e;case V.FLOAT:case V.DOUBLE:h(typeof e=="number");if(Number.isNaN(e))return"NaN";if(e===Number.POSITIVE_INFINITY)return"Infinity";if(e===Number.NEGATIVE_INFINITY)return"-Infinity";return e;case V.STRING:h(typeof e=="string");return e;case V.BOOL:h(typeof e=="boolean");return e;case V.UINT64:case V.FIXED64:case V.INT64:case V.SFIXED64:case V.SINT64:h(typeof e=="bigint"||typeof e=="string"||typeof e=="number");return e.toString();case V.BYTES:h(e instanceof Uint8Array);return it.enc(e)}}const jt=Symbol("@bufbuild/protobuf/unknown-fields");const Rt={readUnknownFields:true,readerFactory:t=>new Q(t)};const It={writeUnknownFields:true,writerFactory:()=>new K};function _t(t){return t?Object.assign(Object.assign({},Rt),t):Rt}function Pt(t){return t?Object.assign(Object.assign({},It),t):It}function Nt(){return{makeReadOptions:_t,makeWriteOptions:Pt,listUnknownFields(t){var e;return(e=t[jt])!==null&&e!==void 0?e:[]},discardUnknownFields(t){delete t[jt]},writeUnknownFields(t,e){const i=t;const n=i[jt];if(n){for(const t of n){e.tag(t.no,t.wireType).raw(t.data)}}},onUnknownField(t,e,i,n){const s=t;if(!Array.isArray(s[jt])){s[jt]=[]}s[jt].push({no:e,wireType:i,data:n})},readMessage(t,e,i,n,s){const r=t.getType();const o=s?e.len:e.pos+i;let a,c;while(e.pos<o){[a,c]=e.tag();if(s===true&&c==W.EndGroup){break}const i=r.fields.find(a);if(!i){const i=e.skip(c,a);if(n.readUnknownFields){this.onUnknownField(t,a,c,i)}continue}Dt(t,e,i,c,n)}if(s&&(c!=W.EndGroup||a!==i)){throw new Error("invalid end group tag")}},readField:Dt,writeMessage(t,e,i){const n=t.getType();for(const s of n.fields.byNumber()){if(!at(s,t)){if(s.req){throw new Error("cannot encode field ".concat(n.typeName,".").concat(s.name," to binary: required field not set"))}continue}const r=s.oneof?t[s.oneof.localName].value:t[s.localName];Lt(s,r,e,i)}if(i.writeUnknownFields){this.writeUnknownFields(t,e)}return e},writeField(t,e,i,n){if(e===undefined){return undefined}Lt(t,e,i,n)}}}function Dt(t,e,i,n,s){let{repeated:r,localName:o}=i;if(i.oneof){t=t[i.oneof.localName];if(t.case!=o){delete t.value}t.case=o;o="value"}switch(i.kind){case"scalar":case"enum":const a=i.kind=="enum"?V.INT32:i.T;let c=Ut;if(i.kind=="scalar"&&i.L>0){c=Mt}if(r){let i=t[o];const s=n==W.LengthDelimited&&a!=V.STRING&&a!=V.BYTES;if(s){let t=e.uint32()+e.pos;while(e.pos<t){i.push(c(e,a))}}else{i.push(c(e,a))}}else{t[o]=c(e,a)}break;case"message":const u=i.T;if(r){t[o].push(At(e,new u,s,i))}else{if(ut(t[o])){At(e,t[o],s,i)}else{t[o]=At(e,new u,s,i);if(u.fieldWrapper&&!i.oneof&&!i.repeated){t[o]=u.fieldWrapper.unwrapField(t[o])}}}break;case"map":let[d,h]=xt(i,e,s);t[o][d]=h;break}}function At(t,e,i,n){const s=e.getType().runtime.bin;const r=n===null||n===void 0?void 0:n.delimited;s.readMessage(e,t,r?n.no:t.uint32(),i,r);return e}function xt(t,e,i){const n=e.uint32(),s=e.pos+n;let r,o;while(e.pos<s){const[n]=e.tag();switch(n){case 1:r=Ut(e,t.K);break;case 2:switch(t.V.kind){case"scalar":o=Ut(e,t.V.T);break;case"enum":o=e.int32();break;case"message":o=At(e,new t.V.T,i,undefined);break}break}}if(r===undefined){r=H(t.K,J.BIGINT)}if(typeof r!="string"&&typeof r!="number"){r=r.toString()}if(o===undefined){switch(t.V.kind){case"scalar":o=H(t.V.T,J.BIGINT);break;case"enum":o=t.V.T.values[0].no;break;case"message":o=new t.V.T;break}}return[r,o]}function Mt(t,e){const i=Ut(t,e);return typeof i=="bigint"?i.toString():i}function Ut(t,e){switch(e){case V.STRING:return t.string();case V.BOOL:return t.bool();case V.DOUBLE:return t.double();case V.FLOAT:return t.float();case V.INT32:return t.int32();case V.INT64:return t.int64();case V.UINT64:return t.uint64();case V.FIXED64:return t.fixed64();case V.BYTES:return t.bytes();case V.FIXED32:return t.fixed32();case V.SFIXED32:return t.sfixed32();case V.SFIXED64:return t.sfixed64();case V.SINT64:return t.sint64();case V.UINT32:return t.uint32();case V.SINT32:return t.sint32()}}function Lt(t,e,i,n){h(e!==undefined);const s=t.repeated;switch(t.kind){case"scalar":case"enum":let r=t.kind=="enum"?V.INT32:t.T;if(s){h(Array.isArray(e));if(t.packed){Vt(i,r,t.no,e)}else{for(const n of e){Bt(i,r,t.no,n)}}}else{Bt(i,r,t.no,e)}break;case"message":if(s){h(Array.isArray(e));for(const s of e){qt(i,n,t,s)}}else{qt(i,n,t,e)}break;case"map":h(typeof e=="object"&&e!=null);for(const[s,r]of Object.entries(e)){Ft(i,n,t,s,r)}break}}function Ft(t,e,i,n,s){t.tag(i.no,W.LengthDelimited);t.fork();let r=n;switch(i.K){case V.INT32:case V.FIXED32:case V.UINT32:case V.SFIXED32:case V.SINT32:r=Number.parseInt(n);break;case V.BOOL:h(n=="true"||n=="false");r=n=="true";break}Bt(t,i.K,1,r);switch(i.V.kind){case"scalar":Bt(t,i.V.T,2,s);break;case"enum":Bt(t,V.INT32,2,s);break;case"message":h(s!==undefined);t.tag(2,W.LengthDelimited).bytes(s.toBinary(e));break}t.join()}function qt(t,e,i,n){const s=dt(i.T,n);if(i.delimited)t.tag(i.no,W.StartGroup).raw(s.toBinary(e)).tag(i.no,W.EndGroup);else t.tag(i.no,W.LengthDelimited).bytes(s.toBinary(e))}function Bt(t,e,i,n){h(n!==undefined);let[s,r]=Jt(e);t.tag(i,s)[r](n)}function Vt(t,e,i,n){if(!n.length){return}t.tag(i,W.LengthDelimited).fork();let[,s]=Jt(e);for(let e=0;e<n.length;e++){t[s](n[e])}t.join()}function Jt(t){let e=W.Varint;switch(t){case V.BYTES:case V.STRING:e=W.LengthDelimited;break;case V.DOUBLE:case V.FIXED64:case V.SFIXED64:e=W.Bit64;break;case V.FIXED32:case V.SFIXED32:case V.FLOAT:e=W.Bit32;break}const i=V[t].toLowerCase();return[e,i]}function Gt(){return{setEnumType:T,initPartial(t,e){if(t===undefined){return}const i=e.getType();for(const n of i.fields.byMember()){const i=n.localName,s=e,r=t;if(r[i]==null){continue}switch(n.kind){case"oneof":const t=r[i].case;if(t===undefined){continue}const e=n.findField(t);let o=r[i].value;if(e&&e.kind=="message"&&!ut(o,e.T)){o=new e.T(o)}else if(e&&e.kind==="scalar"&&e.T===V.BYTES){o=zt(o)}s[i]={case:t,value:o};break;case"scalar":case"enum":let a=r[i];if(n.T===V.BYTES){a=n.repeated?a.map(zt):zt(a)}s[i]=a;break;case"map":switch(n.V.kind){case"scalar":case"enum":if(n.V.T===V.BYTES){for(const[t,e]of Object.entries(r[i])){s[i][t]=zt(e)}}else{Object.assign(s[i],r[i])}break;case"message":const t=n.V.T;for(const e of Object.keys(r[i])){let n=r[i][e];if(!t.fieldWrapper){n=new t(n)}s[i][e]=n}break}break;case"message":const c=n.T;if(n.repeated){s[i]=r[i].map((t=>ut(t,c)?t:new c(t)))}else{const t=r[i];if(c.fieldWrapper){if(c.typeName==="google.protobuf.BytesValue"){s[i]=zt(t)}else{s[i]=t}}else{s[i]=ut(t,c)?t:new c(t)}}break}}},equals(t,e,i){if(e===i){return true}if(!e||!i){return false}return t.fields.byMember().every((t=>{const n=e[t.localName];const s=i[t.localName];if(t.repeated){if(n.length!==s.length){return false}switch(t.kind){case"message":return n.every(((e,i)=>t.T.equals(e,s[i])));case"scalar":return n.every(((e,i)=>G(t.T,e,s[i])));case"enum":return n.every(((t,e)=>G(V.INT32,t,s[e])))}throw new Error("repeated cannot contain ".concat(t.kind))}switch(t.kind){case"message":return t.T.equals(n,s);case"enum":return G(V.INT32,n,s);case"scalar":return G(t.T,n,s);case"oneof":if(n.case!==s.case){return false}const e=t.findField(n.case);if(e===undefined){return true}switch(e.kind){case"message":return e.T.equals(n.value,s.value);case"enum":return G(V.INT32,n.value,s.value);case"scalar":return G(e.T,n.value,s.value)}throw new Error("oneof cannot contain ".concat(e.kind));case"map":const i=Object.keys(n).concat(Object.keys(s));switch(t.V.kind){case"message":const e=t.V.T;return i.every((t=>e.equals(n[t],s[t])));case"enum":return i.every((t=>G(V.INT32,n[t],s[t])));case"scalar":const r=t.V.T;return i.every((t=>G(r,n[t],s[t])))}break}}))},clone(t){const e=t.getType(),i=new e,n=i;for(const i of e.fields.byMember()){const e=t[i.localName];let s;if(i.repeated){s=e.map(Ht)}else if(i.kind=="map"){s=n[i.localName];for(const[t,i]of Object.entries(e)){s[t]=Ht(i)}}else if(i.kind=="oneof"){const t=i.findField(e.case);s=t?{case:e.case,value:Ht(e.value)}:{case:undefined}}else{s=Ht(e)}n[i.localName]=s}for(const i of e.runtime.bin.listUnknownFields(t)){e.runtime.bin.onUnknownField(n,i.no,i.wireType,i.data)}return i}}}function Ht(t){if(t===undefined){return t}if(ut(t)){return t.clone()}if(t instanceof Uint8Array){const e=new Uint8Array(t.byteLength);e.set(t);return e}return t}function zt(t){return t instanceof Uint8Array?t:new Uint8Array(t)}function Wt(t,e,i){return{syntax:t,json:bt(),bin:Nt(),util:Object.assign(Object.assign({},Gt()),{newFieldList:e,initFields:i}),makeMessageType(t,e,i){return j(this,t,e,i)},makeEnum:O,makeEnumType:S,getEnumType:w,makeExtension(t,e,i){return Y(this,t,e,i)}}}class Kt{constructor(t,e){this._fields=t;this._normalizer=e}findJsonName(t){if(!this.jsonNames){const t={};for(const e of this.list()){t[e.jsonName]=t[e.name]=e}this.jsonNames=t}return this.jsonNames[t]}find(t){if(!this.numbers){const t={};for(const e of this.list()){t[e.no]=e}this.numbers=t}return this.numbers[t]}list(){if(!this.all){this.all=this._normalizer(this._fields)}return this.all}byNumber(){if(!this.numbersAsc){this.numbersAsc=this.list().concat().sort(((t,e)=>t.no-e.no))}return this.numbersAsc}byMember(){if(!this.members){this.members=[];const t=this.members;let e;for(const i of this.list()){if(i.oneof){if(i.oneof!==e){e=i.oneof;t.push(e)}}else{t.push(i)}}}return this.members}}function Qt(t,e){const i=$t(t);if(e){return i}return ne(ie(i))}function Yt(t){return Qt(t,false)}const Zt=$t;function $t(t){let e=false;const i=[];for(let n=0;n<t.length;n++){let s=t.charAt(n);switch(s){case"_":e=true;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":i.push(s);e=false;break;default:if(e){e=false;s=s.toUpperCase()}i.push(s);break}}return i.join("")}const Xt=new Set(["constructor","toString","toJSON","valueOf"]);const te=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]);const ee=t=>"".concat(t,"$");const ie=t=>{if(te.has(t)){return ee(t)}return t};const ne=t=>{if(Xt.has(t)){return ee(t)}return t};class se{constructor(t){this.kind="oneof";this.repeated=false;this.packed=false;this.opt=false;this.req=false;this.default=undefined;this.fields=[];this.name=t;this.localName=Yt(t)}addField(t){h(t.oneof===this,"field ".concat(t.name," not one of ").concat(this.name));this.fields.push(t)}findField(t){if(!this._lookup){this._lookup=Object.create(null);for(let t=0;t<this.fields.length;t++){this._lookup[this.fields[t].localName]=this.fields[t]}}return this._lookup[t]}}function re(t,e){var i,n,s,r,o,a;const c=[];let u;for(const e of typeof t=="function"?t():t){const t=e;t.localName=Qt(e.name,e.oneof!==undefined);t.jsonName=(i=e.jsonName)!==null&&i!==void 0?i:Zt(e.name);t.repeated=(n=e.repeated)!==null&&n!==void 0?n:false;if(e.kind=="scalar"){t.L=(s=e.L)!==null&&s!==void 0?s:J.BIGINT}t.delimited=(r=e.delimited)!==null&&r!==void 0?r:false;t.req=(o=e.req)!==null&&o!==void 0?o:false;t.opt=(a=e.opt)!==null&&a!==void 0?a:false;if(e.packed===undefined){{t.packed=e.kind=="enum"||e.kind=="scalar"&&e.T!=V.BYTES&&e.T!=V.STRING}}if(e.oneof!==undefined){const i=typeof e.oneof=="string"?e.oneof:e.oneof.name;if(!u||u.name!=i){u=new se(i)}t.oneof=u;u.addField(t)}c.push(t)}return c}const oe=Wt("proto3",(t=>new Kt(t,(t=>re(t)))),(t=>{for(const e of t.getType().fields.byMember()){if(e.opt){continue}const i=e.localName,n=t;if(e.repeated){n[i]=[];continue}switch(e.kind){case"oneof":n[i]={case:undefined};break;case"enum":n[i]=0;break;case"map":n[i]={};break;case"scalar":n[i]=H(e.T,e.L);break}}}));class ae extends C{constructor(t){super();this.seconds=B.zero;this.nanos=0;oe.util.initPartial(t,this)}fromJson(t,e){if(typeof t!=="string"){throw new Error("cannot decode google.protobuf.Timestamp from JSON: ".concat(oe.json.debug(t)))}const i=t.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!i){throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string")}const n=Date.parse(i[1]+"-"+i[2]+"-"+i[3]+"T"+i[4]+":"+i[5]+":"+i[6]+(i[8]?i[8]:"Z"));if(Number.isNaN(n)){throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string")}if(n<Date.parse("0001-01-01T00:00:00Z")||n>Date.parse("9999-12-31T23:59:59Z")){throw new Error("cannot decode message google.protobuf.Timestamp from JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive")}this.seconds=B.parse(n/1e3);this.nanos=0;if(i[7]){this.nanos=parseInt("1"+i[7]+"0".repeat(9-i[7].length))-1e9}return this}toJson(t){const e=Number(this.seconds)*1e3;if(e<Date.parse("0001-01-01T00:00:00Z")||e>Date.parse("9999-12-31T23:59:59Z")){throw new Error("cannot encode google.protobuf.Timestamp to JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive")}if(this.nanos<0){throw new Error("cannot encode google.protobuf.Timestamp to JSON: nanos must not be negative")}let i="Z";if(this.nanos>0){const t=(this.nanos+1e9).toString().substring(1);if(t.substring(3)==="000000"){i="."+t.substring(0,3)+"Z"}else if(t.substring(6)==="000"){i="."+t.substring(0,6)+"Z"}else{i="."+t+"Z"}}return new Date(e).toISOString().replace(".000Z",i)}toDate(){return new Date(Number(this.seconds)*1e3+Math.ceil(this.nanos/1e6))}static now(){return ae.fromDate(new Date)}static fromDate(t){const e=t.getTime();return new ae({seconds:B.parse(Math.floor(e/1e3)),nanos:e%1e3*1e6})}static fromBinary(t,e){return(new ae).fromBinary(t,e)}static fromJson(t,e){return(new ae).fromJson(t,e)}static fromJsonString(t,e){return(new ae).fromJsonString(t,e)}static equals(t,e){return oe.util.equals(ae,t,e)}}ae.runtime=oe;ae.typeName="google.protobuf.Timestamp";ae.fields=oe.util.newFieldList((()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}]));const ce=oe.makeMessageType("livekit.MetricsBatch",(()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:ae},{no:3,name:"str_data",kind:"scalar",T:9,repeated:true},{no:4,name:"time_series",kind:"message",T:ue,repeated:true},{no:5,name:"events",kind:"message",T:he,repeated:true}]));const ue=oe.makeMessageType("livekit.TimeSeriesMetric",(()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"samples",kind:"message",T:de,repeated:true},{no:5,name:"rid",kind:"scalar",T:13}]));const de=oe.makeMessageType("livekit.MetricSample",(()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:ae},{no:3,name:"value",kind:"scalar",T:2}]));const he=oe.makeMessageType("livekit.EventMetric",(()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"start_timestamp_ms",kind:"scalar",T:3},{no:5,name:"end_timestamp_ms",kind:"scalar",T:3,opt:true},{no:6,name:"normalized_start_timestamp",kind:"message",T:ae},{no:7,name:"normalized_end_timestamp",kind:"message",T:ae,opt:true},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"rid",kind:"scalar",T:13}]));const le=oe.makeEnum("livekit.BackupCodecPolicy",[{no:0,name:"PREFER_REGRESSION"},{no:1,name:"SIMULCAST"},{no:2,name:"REGRESSION"}]);const fe=oe.makeEnum("livekit.TrackType",[{no:0,name:"AUDIO"},{no:1,name:"VIDEO"},{no:2,name:"DATA"}]);const me=oe.makeEnum("livekit.TrackSource",[{no:0,name:"UNKNOWN"},{no:1,name:"CAMERA"},{no:2,name:"MICROPHONE"},{no:3,name:"SCREEN_SHARE"},{no:4,name:"SCREEN_SHARE_AUDIO"}]);const ve=oe.makeEnum("livekit.VideoQuality",[{no:0,name:"LOW"},{no:1,name:"MEDIUM"},{no:2,name:"HIGH"},{no:3,name:"OFF"}]);const pe=oe.makeEnum("livekit.ConnectionQuality",[{no:0,name:"POOR"},{no:1,name:"GOOD"},{no:2,name:"EXCELLENT"},{no:3,name:"LOST"}]);const be=oe.makeEnum("livekit.ClientConfigSetting",[{no:0,name:"UNSET"},{no:1,name:"DISABLED"},{no:2,name:"ENABLED"}]);const ge=oe.makeEnum("livekit.DisconnectReason",[{no:0,name:"UNKNOWN_REASON"},{no:1,name:"CLIENT_INITIATED"},{no:2,name:"DUPLICATE_IDENTITY"},{no:3,name:"SERVER_SHUTDOWN"},{no:4,name:"PARTICIPANT_REMOVED"},{no:5,name:"ROOM_DELETED"},{no:6,name:"STATE_MISMATCH"},{no:7,name:"JOIN_FAILURE"},{no:8,name:"MIGRATION"},{no:9,name:"SIGNAL_CLOSE"},{no:10,name:"ROOM_CLOSED"},{no:11,name:"USER_UNAVAILABLE"},{no:12,name:"USER_REJECTED"},{no:13,name:"SIP_TRUNK_FAILURE"},{no:14,name:"CONNECTION_TIMEOUT"}]);const ye=oe.makeEnum("livekit.ReconnectReason",[{no:0,name:"RR_UNKNOWN"},{no:1,name:"RR_SIGNAL_DISCONNECTED"},{no:2,name:"RR_PUBLISHER_FAILED"},{no:3,name:"RR_SUBSCRIBER_FAILED"},{no:4,name:"RR_SWITCH_CANDIDATE"}]);const ke=oe.makeEnum("livekit.SubscriptionError",[{no:0,name:"SE_UNKNOWN"},{no:1,name:"SE_CODEC_UNSUPPORTED"},{no:2,name:"SE_TRACK_NOTFOUND"}]);const we=oe.makeEnum("livekit.AudioTrackFeature",[{no:0,name:"TF_STEREO"},{no:1,name:"TF_NO_DTX"},{no:2,name:"TF_AUTO_GAIN_CONTROL"},{no:3,name:"TF_ECHO_CANCELLATION"},{no:4,name:"TF_NOISE_SUPPRESSION"},{no:5,name:"TF_ENHANCED_NOISE_CANCELLATION"},{no:6,name:"TF_PRECONNECT_BUFFER"}]);const Te=oe.makeMessageType("livekit.Room",(()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"empty_timeout",kind:"scalar",T:13},{no:14,name:"departure_timeout",kind:"scalar",T:13},{no:4,name:"max_participants",kind:"scalar",T:13},{no:5,name:"creation_time",kind:"scalar",T:3},{no:15,name:"creation_time_ms",kind:"scalar",T:3},{no:6,name:"turn_password",kind:"scalar",T:9},{no:7,name:"enabled_codecs",kind:"message",T:Se,repeated:true},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"num_participants",kind:"scalar",T:13},{no:11,name:"num_publishers",kind:"scalar",T:13},{no:10,name:"active_recording",kind:"scalar",T:8},{no:13,name:"version",kind:"message",T:ti}]));const Se=oe.makeMessageType("livekit.Codec",(()=>[{no:1,name:"mime",kind:"scalar",T:9},{no:2,name:"fmtp_line",kind:"scalar",T:9}]));const Oe=oe.makeMessageType("livekit.ParticipantPermission",(()=>[{no:1,name:"can_subscribe",kind:"scalar",T:8},{no:2,name:"can_publish",kind:"scalar",T:8},{no:3,name:"can_publish_data",kind:"scalar",T:8},{no:9,name:"can_publish_sources",kind:"enum",T:oe.getEnumType(me),repeated:true},{no:7,name:"hidden",kind:"scalar",T:8},{no:8,name:"recorder",kind:"scalar",T:8},{no:10,name:"can_update_metadata",kind:"scalar",T:8},{no:11,name:"agent",kind:"scalar",T:8},{no:12,name:"can_subscribe_metrics",kind:"scalar",T:8}]));const Ee=oe.makeMessageType("livekit.ParticipantInfo",(()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"identity",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:oe.getEnumType(Ce)},{no:4,name:"tracks",kind:"message",T:Pe,repeated:true},{no:5,name:"metadata",kind:"scalar",T:9},{no:6,name:"joined_at",kind:"scalar",T:3},{no:17,name:"joined_at_ms",kind:"scalar",T:3},{no:9,name:"name",kind:"scalar",T:9},{no:10,name:"version",kind:"scalar",T:13},{no:11,name:"permission",kind:"message",T:Oe},{no:12,name:"region",kind:"scalar",T:9},{no:13,name:"is_publisher",kind:"scalar",T:8},{no:14,name:"kind",kind:"enum",T:oe.getEnumType(je)},{no:15,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:16,name:"disconnect_reason",kind:"enum",T:oe.getEnumType(ge)},{no:18,name:"kind_details",kind:"enum",T:oe.getEnumType(Re),repeated:true}]));const Ce=oe.makeEnum("livekit.ParticipantInfo.State",[{no:0,name:"JOINING"},{no:1,name:"JOINED"},{no:2,name:"ACTIVE"},{no:3,name:"DISCONNECTED"}]);const je=oe.makeEnum("livekit.ParticipantInfo.Kind",[{no:0,name:"STANDARD"},{no:1,name:"INGRESS"},{no:2,name:"EGRESS"},{no:3,name:"SIP"},{no:4,name:"AGENT"}]);const Re=oe.makeEnum("livekit.ParticipantInfo.KindDetail",[{no:0,name:"CLOUD_AGENT"},{no:1,name:"FORWARDED"}]);const Ie=oe.makeEnum("livekit.Encryption.Type",[{no:0,name:"NONE"},{no:1,name:"GCM"},{no:2,name:"CUSTOM"}]);const _e=oe.makeMessageType("livekit.SimulcastCodecInfo",(()=>[{no:1,name:"mime_type",kind:"scalar",T:9},{no:2,name:"mid",kind:"scalar",T:9},{no:3,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:Ne,repeated:true}]));const Pe=oe.makeMessageType("livekit.TrackInfo",(()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"type",kind:"enum",T:oe.getEnumType(fe)},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"muted",kind:"scalar",T:8},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"simulcast",kind:"scalar",T:8},{no:8,name:"disable_dtx",kind:"scalar",T:8},{no:9,name:"source",kind:"enum",T:oe.getEnumType(me)},{no:10,name:"layers",kind:"message",T:Ne,repeated:true},{no:11,name:"mime_type",kind:"scalar",T:9},{no:12,name:"mid",kind:"scalar",T:9},{no:13,name:"codecs",kind:"message",T:_e,repeated:true},{no:14,name:"stereo",kind:"scalar",T:8},{no:15,name:"disable_red",kind:"scalar",T:8},{no:16,name:"encryption",kind:"enum",T:oe.getEnumType(Ie)},{no:17,name:"stream",kind:"scalar",T:9},{no:18,name:"version",kind:"message",T:ti},{no:19,name:"audio_features",kind:"enum",T:oe.getEnumType(we),repeated:true},{no:20,name:"backup_codec_policy",kind:"enum",T:oe.getEnumType(le)}]));const Ne=oe.makeMessageType("livekit.VideoLayer",(()=>[{no:1,name:"quality",kind:"enum",T:oe.getEnumType(ve)},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13},{no:4,name:"bitrate",kind:"scalar",T:13},{no:5,name:"ssrc",kind:"scalar",T:13}]));const De=oe.makeMessageType("livekit.DataPacket",(()=>[{no:1,name:"kind",kind:"enum",T:oe.getEnumType(Ae)},{no:4,name:"participant_identity",kind:"scalar",T:9},{no:5,name:"destination_identities",kind:"scalar",T:9,repeated:true},{no:2,name:"user",kind:"message",T:Ue,oneof:"value"},{no:3,name:"speaker",kind:"message",T:xe,oneof:"value"},{no:6,name:"sip_dtmf",kind:"message",T:Le,oneof:"value"},{no:7,name:"transcription",kind:"message",T:Fe,oneof:"value"},{no:8,name:"metrics",kind:"message",T:ce,oneof:"value"},{no:9,name:"chat_message",kind:"message",T:Be,oneof:"value"},{no:10,name:"rpc_request",kind:"message",T:Ve,oneof:"value"},{no:11,name:"rpc_ack",kind:"message",T:Je,oneof:"value"},{no:12,name:"rpc_response",kind:"message",T:Ge,oneof:"value"},{no:13,name:"stream_header",kind:"message",T:si,oneof:"value"},{no:14,name:"stream_chunk",kind:"message",T:ri,oneof:"value"},{no:15,name:"stream_trailer",kind:"message",T:oi,oneof:"value"}]));const Ae=oe.makeEnum("livekit.DataPacket.Kind",[{no:0,name:"RELIABLE"},{no:1,name:"LOSSY"}]);const xe=oe.makeMessageType("livekit.ActiveSpeakerUpdate",(()=>[{no:1,name:"speakers",kind:"message",T:Me,repeated:true}]));const Me=oe.makeMessageType("livekit.SpeakerInfo",(()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"level",kind:"scalar",T:2},{no:3,name:"active",kind:"scalar",T:8}]));const Ue=oe.makeMessageType("livekit.UserPacket",(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:5,name:"participant_identity",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12},{no:3,name:"destination_sids",kind:"scalar",T:9,repeated:true},{no:6,name:"destination_identities",kind:"scalar",T:9,repeated:true},{no:4,name:"topic",kind:"scalar",T:9,opt:true},{no:8,name:"id",kind:"scalar",T:9,opt:true},{no:9,name:"start_time",kind:"scalar",T:4,opt:true},{no:10,name:"end_time",kind:"scalar",T:4,opt:true},{no:11,name:"nonce",kind:"scalar",T:12}]));const Le=oe.makeMessageType("livekit.SipDTMF",(()=>[{no:3,name:"code",kind:"scalar",T:13},{no:4,name:"digit",kind:"scalar",T:9}]));const Fe=oe.makeMessageType("livekit.Transcription",(()=>[{no:2,name:"transcribed_participant_identity",kind:"scalar",T:9},{no:3,name:"track_id",kind:"scalar",T:9},{no:4,name:"segments",kind:"message",T:qe,repeated:true}]));const qe=oe.makeMessageType("livekit.TranscriptionSegment",(()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"text",kind:"scalar",T:9},{no:3,name:"start_time",kind:"scalar",T:4},{no:4,name:"end_time",kind:"scalar",T:4},{no:5,name:"final",kind:"scalar",T:8},{no:6,name:"language",kind:"scalar",T:9}]));const Be=oe.makeMessageType("livekit.ChatMessage",(()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"edit_timestamp",kind:"scalar",T:3,opt:true},{no:4,name:"message",kind:"scalar",T:9},{no:5,name:"deleted",kind:"scalar",T:8},{no:6,name:"generated",kind:"scalar",T:8}]));const Ve=oe.makeMessageType("livekit.RpcRequest",(()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"method",kind:"scalar",T:9},{no:3,name:"payload",kind:"scalar",T:9},{no:4,name:"response_timeout_ms",kind:"scalar",T:13},{no:5,name:"version",kind:"scalar",T:13}]));const Je=oe.makeMessageType("livekit.RpcAck",(()=>[{no:1,name:"request_id",kind:"scalar",T:9}]));const Ge=oe.makeMessageType("livekit.RpcResponse",(()=>[{no:1,name:"request_id",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:9,oneof:"value"},{no:3,name:"error",kind:"message",T:He,oneof:"value"}]));const He=oe.makeMessageType("livekit.RpcError",(()=>[{no:1,name:"code",kind:"scalar",T:13},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"data",kind:"scalar",T:9}]));const ze=oe.makeMessageType("livekit.ParticipantTracks",(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sids",kind:"scalar",T:9,repeated:true}]));const We=oe.makeMessageType("livekit.ServerInfo",(()=>[{no:1,name:"edition",kind:"enum",T:oe.getEnumType(Ke)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"region",kind:"scalar",T:9},{no:5,name:"node_id",kind:"scalar",T:9},{no:6,name:"debug_info",kind:"scalar",T:9},{no:7,name:"agent_protocol",kind:"scalar",T:5}]));const Ke=oe.makeEnum("livekit.ServerInfo.Edition",[{no:0,name:"Standard"},{no:1,name:"Cloud"}]);const Qe=oe.makeMessageType("livekit.ClientInfo",(()=>[{no:1,name:"sdk",kind:"enum",T:oe.getEnumType(Ye)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"os",kind:"scalar",T:9},{no:5,name:"os_version",kind:"scalar",T:9},{no:6,name:"device_model",kind:"scalar",T:9},{no:7,name:"browser",kind:"scalar",T:9},{no:8,name:"browser_version",kind:"scalar",T:9},{no:9,name:"address",kind:"scalar",T:9},{no:10,name:"network",kind:"scalar",T:9},{no:11,name:"other_sdks",kind:"scalar",T:9}]));const Ye=oe.makeEnum("livekit.ClientInfo.SDK",[{no:0,name:"UNKNOWN"},{no:1,name:"JS"},{no:2,name:"SWIFT"},{no:3,name:"ANDROID"},{no:4,name:"FLUTTER"},{no:5,name:"GO"},{no:6,name:"UNITY"},{no:7,name:"REACT_NATIVE"},{no:8,name:"RUST"},{no:9,name:"PYTHON"},{no:10,name:"CPP"},{no:11,name:"UNITY_WEB"},{no:12,name:"NODE"},{no:13,name:"UNREAL"}]);const Ze=oe.makeMessageType("livekit.ClientConfiguration",(()=>[{no:1,name:"video",kind:"message",T:$e},{no:2,name:"screen",kind:"message",T:$e},{no:3,name:"resume_connection",kind:"enum",T:oe.getEnumType(be)},{no:4,name:"disabled_codecs",kind:"message",T:Xe},{no:5,name:"force_relay",kind:"enum",T:oe.getEnumType(be)}]));const $e=oe.makeMessageType("livekit.VideoConfiguration",(()=>[{no:1,name:"hardware_encoder",kind:"enum",T:oe.getEnumType(be)}]));const Xe=oe.makeMessageType("livekit.DisabledCodecs",(()=>[{no:1,name:"codecs",kind:"message",T:Se,repeated:true},{no:2,name:"publish",kind:"message",T:Se,repeated:true}]));const ti=oe.makeMessageType("livekit.TimedVersion",(()=>[{no:1,name:"unix_micro",kind:"scalar",T:3},{no:2,name:"ticks",kind:"scalar",T:5}]));const ei=oe.makeEnum("livekit.DataStream.OperationType",[{no:0,name:"CREATE"},{no:1,name:"UPDATE"},{no:2,name:"DELETE"},{no:3,name:"REACTION"}]);const ii=oe.makeMessageType("livekit.DataStream.TextHeader",(()=>[{no:1,name:"operation_type",kind:"enum",T:oe.getEnumType(ei)},{no:2,name:"version",kind:"scalar",T:5},{no:3,name:"reply_to_stream_id",kind:"scalar",T:9},{no:4,name:"attached_stream_ids",kind:"scalar",T:9,repeated:true},{no:5,name:"generated",kind:"scalar",T:8}]),{localName:"DataStream_TextHeader"});const ni=oe.makeMessageType("livekit.DataStream.ByteHeader",(()=>[{no:1,name:"name",kind:"scalar",T:9}]),{localName:"DataStream_ByteHeader"});const si=oe.makeMessageType("livekit.DataStream.Header",(()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"topic",kind:"scalar",T:9},{no:4,name:"mime_type",kind:"scalar",T:9},{no:5,name:"total_length",kind:"scalar",T:4,opt:true},{no:7,name:"encryption_type",kind:"enum",T:oe.getEnumType(Ie)},{no:8,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:9,name:"text_header",kind:"message",T:ii,oneof:"content_header"},{no:10,name:"byte_header",kind:"message",T:ni,oneof:"content_header"}]),{localName:"DataStream_Header"});const ri=oe.makeMessageType("livekit.DataStream.Chunk",(()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"chunk_index",kind:"scalar",T:4},{no:3,name:"content",kind:"scalar",T:12},{no:4,name:"version",kind:"scalar",T:5},{no:5,name:"iv",kind:"scalar",T:12,opt:true}]),{localName:"DataStream_Chunk"});const oi=oe.makeMessageType("livekit.DataStream.Trailer",(()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"reason",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}}]),{localName:"DataStream_Trailer"});const ai=oe.makeEnum("livekit.SignalTarget",[{no:0,name:"PUBLISHER"},{no:1,name:"SUBSCRIBER"}]);const ci=oe.makeEnum("livekit.StreamState",[{no:0,name:"ACTIVE"},{no:1,name:"PAUSED"}]);const ui=oe.makeEnum("livekit.CandidateProtocol",[{no:0,name:"UDP"},{no:1,name:"TCP"},{no:2,name:"TLS"}]);const di=oe.makeMessageType("livekit.SignalRequest",(()=>[{no:1,name:"offer",kind:"message",T:ki,oneof:"message"},{no:2,name:"answer",kind:"message",T:ki,oneof:"message"},{no:3,name:"trickle",kind:"message",T:mi,oneof:"message"},{no:4,name:"add_track",kind:"message",T:fi,oneof:"message"},{no:5,name:"mute",kind:"message",T:vi,oneof:"message"},{no:6,name:"subscription",kind:"message",T:Ti,oneof:"message"},{no:7,name:"track_setting",kind:"message",T:Si,oneof:"message"},{no:8,name:"leave",kind:"message",T:Ci,oneof:"message"},{no:10,name:"update_layers",kind:"message",T:Ri,oneof:"message"},{no:11,name:"subscription_permission",kind:"message",T:Bi,oneof:"message"},{no:12,name:"sync_state",kind:"message",T:Gi,oneof:"message"},{no:13,name:"simulate",kind:"message",T:zi,oneof:"message"},{no:14,name:"ping",kind:"scalar",T:3,oneof:"message"},{no:15,name:"update_metadata",kind:"message",T:Ii,oneof:"message"},{no:16,name:"ping_req",kind:"message",T:Wi,oneof:"message"},{no:17,name:"update_audio_track",kind:"message",T:Oi,oneof:"message"},{no:18,name:"update_video_track",kind:"message",T:Ei,oneof:"message"}]));const hi=oe.makeMessageType("livekit.SignalResponse",(()=>[{no:1,name:"join",kind:"message",T:pi,oneof:"message"},{no:2,name:"answer",kind:"message",T:ki,oneof:"message"},{no:3,name:"offer",kind:"message",T:ki,oneof:"message"},{no:4,name:"trickle",kind:"message",T:mi,oneof:"message"},{no:5,name:"update",kind:"message",T:wi,oneof:"message"},{no:6,name:"track_published",kind:"message",T:gi,oneof:"message"},{no:8,name:"leave",kind:"message",T:Ci,oneof:"message"},{no:9,name:"mute",kind:"message",T:vi,oneof:"message"},{no:10,name:"speakers_changed",kind:"message",T:Pi,oneof:"message"},{no:11,name:"room_update",kind:"message",T:Ni,oneof:"message"},{no:12,name:"connection_quality",kind:"message",T:Ai,oneof:"message"},{no:13,name:"stream_state_update",kind:"message",T:Mi,oneof:"message"},{no:14,name:"subscribed_quality_update",kind:"message",T:Fi,oneof:"message"},{no:15,name:"subscription_permission_update",kind:"message",T:Vi,oneof:"message"},{no:16,name:"refresh_token",kind:"scalar",T:9,oneof:"message"},{no:17,name:"track_unpublished",kind:"message",T:yi,oneof:"message"},{no:18,name:"pong",kind:"scalar",T:3,oneof:"message"},{no:19,name:"reconnect",kind:"message",T:bi,oneof:"message"},{no:20,name:"pong_resp",kind:"message",T:Ki,oneof:"message"},{no:21,name:"subscription_response",kind:"message",T:Zi,oneof:"message"},{no:22,name:"request_response",kind:"message",T:$i,oneof:"message"},{no:23,name:"track_subscribed",kind:"message",T:tn,oneof:"message"},{no:24,name:"room_moved",kind:"message",T:Ji,oneof:"message"}]));const li=oe.makeMessageType("livekit.SimulcastCodec",(()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"cid",kind:"scalar",T:9}]));const fi=oe.makeMessageType("livekit.AddTrackRequest",(()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"type",kind:"enum",T:oe.getEnumType(fe)},{no:4,name:"width",kind:"scalar",T:13},{no:5,name:"height",kind:"scalar",T:13},{no:6,name:"muted",kind:"scalar",T:8},{no:7,name:"disable_dtx",kind:"scalar",T:8},{no:8,name:"source",kind:"enum",T:oe.getEnumType(me)},{no:9,name:"layers",kind:"message",T:Ne,repeated:true},{no:10,name:"simulcast_codecs",kind:"message",T:li,repeated:true},{no:11,name:"sid",kind:"scalar",T:9},{no:12,name:"stereo",kind:"scalar",T:8},{no:13,name:"disable_red",kind:"scalar",T:8},{no:14,name:"encryption",kind:"enum",T:oe.getEnumType(Ie)},{no:15,name:"stream",kind:"scalar",T:9},{no:16,name:"backup_codec_policy",kind:"enum",T:oe.getEnumType(le)},{no:17,name:"audio_features",kind:"enum",T:oe.getEnumType(we),repeated:true}]));const mi=oe.makeMessageType("livekit.TrickleRequest",(()=>[{no:1,name:"candidateInit",kind:"scalar",T:9},{no:2,name:"target",kind:"enum",T:oe.getEnumType(ai)},{no:3,name:"final",kind:"scalar",T:8}]));const vi=oe.makeMessageType("livekit.MuteTrackRequest",(()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"muted",kind:"scalar",T:8}]));const pi=oe.makeMessageType("livekit.JoinResponse",(()=>[{no:1,name:"room",kind:"message",T:Te},{no:2,name:"participant",kind:"message",T:Ee},{no:3,name:"other_participants",kind:"message",T:Ee,repeated:true},{no:4,name:"server_version",kind:"scalar",T:9},{no:5,name:"ice_servers",kind:"message",T:_i,repeated:true},{no:6,name:"subscriber_primary",kind:"scalar",T:8},{no:7,name:"alternative_url",kind:"scalar",T:9},{no:8,name:"client_configuration",kind:"message",T:Ze},{no:9,name:"server_region",kind:"scalar",T:9},{no:10,name:"ping_timeout",kind:"scalar",T:5},{no:11,name:"ping_interval",kind:"scalar",T:5},{no:12,name:"server_info",kind:"message",T:We},{no:13,name:"sif_trailer",kind:"scalar",T:12},{no:14,name:"enabled_publish_codecs",kind:"message",T:Se,repeated:true},{no:15,name:"fast_publish",kind:"scalar",T:8}]));const bi=oe.makeMessageType("livekit.ReconnectResponse",(()=>[{no:1,name:"ice_servers",kind:"message",T:_i,repeated:true},{no:2,name:"client_configuration",kind:"message",T:Ze}]));const gi=oe.makeMessageType("livekit.TrackPublishedResponse",(()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"track",kind:"message",T:Pe}]));const yi=oe.makeMessageType("livekit.TrackUnpublishedResponse",(()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]));const ki=oe.makeMessageType("livekit.SessionDescription",(()=>[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"sdp",kind:"scalar",T:9}]));const wi=oe.makeMessageType("livekit.ParticipantUpdate",(()=>[{no:1,name:"participants",kind:"message",T:Ee,repeated:true}]));const Ti=oe.makeMessageType("livekit.UpdateSubscription",(()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:true},{no:2,name:"subscribe",kind:"scalar",T:8},{no:3,name:"participant_tracks",kind:"message",T:ze,repeated:true}]));const Si=oe.makeMessageType("livekit.UpdateTrackSettings",(()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:true},{no:3,name:"disabled",kind:"scalar",T:8},{no:4,name:"quality",kind:"enum",T:oe.getEnumType(ve)},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"fps",kind:"scalar",T:13},{no:8,name:"priority",kind:"scalar",T:13}]));const Oi=oe.makeMessageType("livekit.UpdateLocalAudioTrack",(()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"features",kind:"enum",T:oe.getEnumType(we),repeated:true}]));const Ei=oe.makeMessageType("livekit.UpdateLocalVideoTrack",(()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13}]));const Ci=oe.makeMessageType("livekit.LeaveRequest",(()=>[{no:1,name:"can_reconnect",kind:"scalar",T:8},{no:2,name:"reason",kind:"enum",T:oe.getEnumType(ge)},{no:3,name:"action",kind:"enum",T:oe.getEnumType(ji)},{no:4,name:"regions",kind:"message",T:Qi}]));const ji=oe.makeEnum("livekit.LeaveRequest.Action",[{no:0,name:"DISCONNECT"},{no:1,name:"RESUME"},{no:2,name:"RECONNECT"}]);const Ri=oe.makeMessageType("livekit.UpdateVideoLayers",(()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"layers",kind:"message",T:Ne,repeated:true}]));const Ii=oe.makeMessageType("livekit.UpdateParticipantMetadata",(()=>[{no:1,name:"metadata",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:4,name:"request_id",kind:"scalar",T:13}]));const _i=oe.makeMessageType("livekit.ICEServer",(()=>[{no:1,name:"urls",kind:"scalar",T:9,repeated:true},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"credential",kind:"scalar",T:9}]));const Pi=oe.makeMessageType("livekit.SpeakersChanged",(()=>[{no:1,name:"speakers",kind:"message",T:Me,repeated:true}]));const Ni=oe.makeMessageType("livekit.RoomUpdate",(()=>[{no:1,name:"room",kind:"message",T:Te}]));const Di=oe.makeMessageType("livekit.ConnectionQualityInfo",(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"quality",kind:"enum",T:oe.getEnumType(pe)},{no:3,name:"score",kind:"scalar",T:2}]));const Ai=oe.makeMessageType("livekit.ConnectionQualityUpdate",(()=>[{no:1,name:"updates",kind:"message",T:Di,repeated:true}]));const xi=oe.makeMessageType("livekit.StreamStateInfo",(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:oe.getEnumType(ci)}]));const Mi=oe.makeMessageType("livekit.StreamStateUpdate",(()=>[{no:1,name:"stream_states",kind:"message",T:xi,repeated:true}]));const Ui=oe.makeMessageType("livekit.SubscribedQuality",(()=>[{no:1,name:"quality",kind:"enum",T:oe.getEnumType(ve)},{no:2,name:"enabled",kind:"scalar",T:8}]));const Li=oe.makeMessageType("livekit.SubscribedCodec",(()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"qualities",kind:"message",T:Ui,repeated:true}]));const Fi=oe.makeMessageType("livekit.SubscribedQualityUpdate",(()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_qualities",kind:"message",T:Ui,repeated:true},{no:3,name:"subscribed_codecs",kind:"message",T:Li,repeated:true}]));const qi=oe.makeMessageType("livekit.TrackPermission",(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"all_tracks",kind:"scalar",T:8},{no:3,name:"track_sids",kind:"scalar",T:9,repeated:true},{no:4,name:"participant_identity",kind:"scalar",T:9}]));const Bi=oe.makeMessageType("livekit.SubscriptionPermission",(()=>[{no:1,name:"all_participants",kind:"scalar",T:8},{no:2,name:"track_permissions",kind:"message",T:qi,repeated:true}]));const Vi=oe.makeMessageType("livekit.SubscriptionPermissionUpdate",(()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"allowed",kind:"scalar",T:8}]));const Ji=oe.makeMessageType("livekit.RoomMovedResponse",(()=>[{no:1,name:"room",kind:"message",T:Te},{no:2,name:"token",kind:"scalar",T:9},{no:3,name:"participant",kind:"message",T:Ee},{no:4,name:"other_participants",kind:"message",T:Ee,repeated:true}]));const Gi=oe.makeMessageType("livekit.SyncState",(()=>[{no:1,name:"answer",kind:"message",T:ki},{no:2,name:"subscription",kind:"message",T:Ti},{no:3,name:"publish_tracks",kind:"message",T:gi,repeated:true},{no:4,name:"data_channels",kind:"message",T:Hi,repeated:true},{no:5,name:"offer",kind:"message",T:ki},{no:6,name:"track_sids_disabled",kind:"scalar",T:9,repeated:true}]));const Hi=oe.makeMessageType("livekit.DataChannelInfo",(()=>[{no:1,name:"label",kind:"scalar",T:9},{no:2,name:"id",kind:"scalar",T:13},{no:3,name:"target",kind:"enum",T:oe.getEnumType(ai)}]));const zi=oe.makeMessageType("livekit.SimulateScenario",(()=>[{no:1,name:"speaker_update",kind:"scalar",T:5,oneof:"scenario"},{no:2,name:"node_failure",kind:"scalar",T:8,oneof:"scenario"},{no:3,name:"migration",kind:"scalar",T:8,oneof:"scenario"},{no:4,name:"server_leave",kind:"scalar",T:8,oneof:"scenario"},{no:5,name:"switch_candidate_protocol",kind:"enum",T:oe.getEnumType(ui),oneof:"scenario"},{no:6,name:"subscriber_bandwidth",kind:"scalar",T:3,oneof:"scenario"},{no:7,name:"disconnect_signal_on_resume",kind:"scalar",T:8,oneof:"scenario"},{no:8,name:"disconnect_signal_on_resume_no_messages",kind:"scalar",T:8,oneof:"scenario"},{no:9,name:"leave_request_full_reconnect",kind:"scalar",T:8,oneof:"scenario"}]));const Wi=oe.makeMessageType("livekit.Ping",(()=>[{no:1,name:"timestamp",kind:"scalar",T:3},{no:2,name:"rtt",kind:"scalar",T:3}]));const Ki=oe.makeMessageType("livekit.Pong",(()=>[{no:1,name:"last_ping_timestamp",kind:"scalar",T:3},{no:2,name:"timestamp",kind:"scalar",T:3}]));const Qi=oe.makeMessageType("livekit.RegionSettings",(()=>[{no:1,name:"regions",kind:"message",T:Yi,repeated:true}]));const Yi=oe.makeMessageType("livekit.RegionInfo",(()=>[{no:1,name:"region",kind:"scalar",T:9},{no:2,name:"url",kind:"scalar",T:9},{no:3,name:"distance",kind:"scalar",T:3}]));const Zi=oe.makeMessageType("livekit.SubscriptionResponse",(()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"err",kind:"enum",T:oe.getEnumType(ke)}]));const $i=oe.makeMessageType("livekit.RequestResponse",(()=>[{no:1,name:"request_id",kind:"scalar",T:13},{no:2,name:"reason",kind:"enum",T:oe.getEnumType(Xi)},{no:3,name:"message",kind:"scalar",T:9}]));const Xi=oe.makeEnum("livekit.RequestResponse.Reason",[{no:0,name:"OK"},{no:1,name:"NOT_FOUND"},{no:2,name:"NOT_ALLOWED"},{no:3,name:"LIMIT_EXCEEDED"}]);const tn=oe.makeMessageType("livekit.TrackSubscribed",(()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]));function en(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t["default"]:t}var nn={exports:{}};var sn=nn.exports;var rn;function on(){if(rn)return nn.exports;rn=1;(function(t){(function(e,i){if(t.exports){t.exports=i()}else{e.log=i()}})(sn,(function(){var t=function(){};var e="undefined";var i=typeof window!==e&&typeof window.navigator!==e&&/Trident\/|MSIE /.test(window.navigator.userAgent);var n=["trace","debug","info","warn","error"];var s={};var r=null;function o(t,e){var i=t[e];if(typeof i.bind==="function"){return i.bind(t)}else{try{return Function.prototype.bind.call(i,t)}catch(e){return function(){return Function.prototype.apply.apply(i,[t,arguments])}}}}function a(){if(console.log){if(console.log.apply){console.log.apply(console,arguments)}else{Function.prototype.apply.apply(console.log,[console,arguments])}}if(console.trace)console.trace()}function c(n){if(n==="debug"){n="log"}if(typeof console===e){return false}else if(n==="trace"&&i){return a}else if(console[n]!==undefined){return o(console,n)}else if(console.log!==undefined){return o(console,"log")}else{return t}}function u(){var i=this.getLevel();for(var s=0;s<n.length;s++){var r=n[s];this[r]=s<i?t:this.methodFactory(r,i,this.name)}this.log=this.debug;if(typeof console===e&&i<this.levels.SILENT){return"No console available for logging"}}function d(t){return function(){if(typeof console!==e){u.call(this);this[t].apply(this,arguments)}}}function h(t,e,i){return c(t)||d.apply(this,arguments)}function l(t,i){var o=this;var a;var c;var d;var l="loglevel";if(typeof t==="string"){l+=":"+t}else if(typeof t==="symbol"){l=undefined}function f(t){var i=(n[t]||"silent").toUpperCase();if(typeof window===e||!l)return;try{window.localStorage[l]=i;return}catch(t){}try{window.document.cookie=encodeURIComponent(l)+"="+i+";"}catch(t){}}function m(){var t;if(typeof window===e||!l)return;try{t=window.localStorage[l]}catch(t){}if(typeof t===e){try{var i=window.document.cookie;var n=encodeURIComponent(l);var s=i.indexOf(n+"=");if(s!==-1){t=/^([^;]+)/.exec(i.slice(s+n.length+1))[1]}}catch(t){}}if(o.levels[t]===undefined){t=undefined}return t}function v(){if(typeof window===e||!l)return;try{window.localStorage.removeItem(l)}catch(t){}try{window.document.cookie=encodeURIComponent(l)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(t){}}function p(t){var e=t;if(typeof e==="string"&&o.levels[e.toUpperCase()]!==undefined){e=o.levels[e.toUpperCase()]}if(typeof e==="number"&&e>=0&&e<=o.levels.SILENT){return e}else{throw new TypeError("log.setLevel() called with invalid level: "+t)}}o.name=t;o.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5};o.methodFactory=i||h;o.getLevel=function(){if(d!=null){return d}else if(c!=null){return c}else{return a}};o.setLevel=function(t,e){d=p(t);if(e!==false){f(d)}return u.call(o)};o.setDefaultLevel=function(t){c=p(t);if(!m()){o.setLevel(t,false)}};o.resetLevel=function(){d=null;v();u.call(o)};o.enableAll=function(t){o.setLevel(o.levels.TRACE,t)};o.disableAll=function(t){o.setLevel(o.levels.SILENT,t)};o.rebuild=function(){if(r!==o){a=p(r.getLevel())}u.call(o);if(r===o){for(var t in s){s[t].rebuild()}}};a=p(r?r.getLevel():"WARN");var b=m();if(b!=null){d=p(b)}u.call(o)}r=new l;r.getLogger=function t(e){if(typeof e!=="symbol"&&typeof e!=="string"||e===""){throw new TypeError("You must supply a name when creating a logger.")}var i=s[e];if(!i){i=s[e]=new l(e,r.methodFactory)}return i};var f=typeof window!==e?window.log:undefined;r.noConflict=function(){if(typeof window!==e&&window.log===r){window.log=f}return r};r.getLoggers=function t(){return s};r["default"]=r;return r}))})(nn);return nn.exports}var an=on();var cn;(function(t){t[t["trace"]=0]="trace";t[t["debug"]=1]="debug";t[t["info"]=2]="info";t[t["warn"]=3]="warn";t[t["error"]=4]="error";t[t["silent"]=5]="silent"})(cn||(cn={}));var un;(function(t){t["Default"]="livekit";t["Room"]="livekit-room";t["Participant"]="livekit-participant";t["Track"]="livekit-track";t["Publication"]="livekit-track-publication";t["Engine"]="livekit-engine";t["Signal"]="livekit-signal";t["PCManager"]="livekit-pc-manager";t["PCTransport"]="livekit-pc-transport";t["E2EE"]="lk-e2ee"})(un||(un={}));let dn=an.getLogger("livekit");Object.values(un).map((t=>an.getLogger(t)));dn.setDefaultLevel(cn.info);function hn(t){const e=an.getLogger(t);e.setDefaultLevel(dn.getLevel());return e}const ln=an.getLogger("lk-e2ee");const fn=7e3;const mn=[0,300,2*2*300,3*3*300,4*4*300,fn,fn,fn,fn,fn];class vn{constructor(t){this._retryDelays=t!==undefined?[...t]:mn}nextRetryDelayInMs(t){if(t.retryCount>=this._retryDelays.length)return null;const e=this._retryDelays[t.retryCount];if(t.retryCount<=1)return e;return e+Math.random()*1e3}}function pn(t,e){var i={};for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0)i[n]=t[n];if(t!=null&&typeof Object.getOwnPropertySymbols==="function")for(var s=0,n=Object.getOwnPropertySymbols(t);s<n.length;s++){if(e.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(t,n[s]))i[n[s]]=t[n[s]]}return i}function bn(t,e,i,n){function s(t){return t instanceof i?t:new i((function(e){e(t)}))}return new(i||(i=Promise))((function(i,r){function o(t){try{c(n.next(t))}catch(t){r(t)}}function a(t){try{c(n["throw"](t))}catch(t){r(t)}}function c(t){t.done?i(t.value):s(t.value).then(o,a)}c((n=n.apply(t,e||[])).next())}))}function gn(t){var e=typeof Symbol==="function"&&Symbol.iterator,i=e&&t[e],n=0;if(i)return i.call(t);if(t&&typeof t.length==="number")return{next:function(){if(t&&n>=t.length)t=void 0;return{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function yn(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=t[Symbol.asyncIterator],i;return e?e.call(t):(t=typeof gn==="function"?gn(t):t[Symbol.iterator](),i={},n("next"),n("throw"),n("return"),i[Symbol.asyncIterator]=function(){return this},i);function n(e){i[e]=t[e]&&function(i){return new Promise((function(n,r){i=t[e](i),s(n,r,i.done,i.value)}))}}function s(t,e,i,n){Promise.resolve(n).then((function(e){t({value:e,done:i})}),e)}}typeof SuppressedError==="function"?SuppressedError:function(t,e,i){var n=new Error(i);return n.name="SuppressedError",n.error=t,n.suppressed=e,n};var kn={exports:{}};var wn;function Tn(){if(wn)return kn.exports;wn=1;var t=typeof Reflect==="object"?Reflect:null;var e=t&&typeof t.apply==="function"?t.apply:function t(e,i,n){return Function.prototype.apply.call(e,i,n)};var i;if(t&&typeof t.ownKeys==="function"){i=t.ownKeys}else if(Object.getOwnPropertySymbols){i=function t(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}}else{i=function t(e){return Object.getOwnPropertyNames(e)}}function n(t){if(console&&console.warn)console.warn(t)}var s=Number.isNaN||function t(e){return e!==e};function r(){r.init.call(this)}kn.exports=r;kn.exports.once=b;r.EventEmitter=r;r.prototype._events=undefined;r.prototype._eventsCount=0;r.prototype._maxListeners=undefined;var o=10;function a(t){if(typeof t!=="function"){throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}}Object.defineProperty(r,"defaultMaxListeners",{enumerable:true,get:function(){return o},set:function(t){if(typeof t!=="number"||t<0||s(t)){throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".")}o=t}});r.init=function(){if(this._events===undefined||this._events===Object.getPrototypeOf(this)._events){this._events=Object.create(null);this._eventsCount=0}this._maxListeners=this._maxListeners||undefined};r.prototype.setMaxListeners=function t(e){if(typeof e!=="number"||e<0||s(e)){throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".")}this._maxListeners=e;return this};function c(t){if(t._maxListeners===undefined)return r.defaultMaxListeners;return t._maxListeners}r.prototype.getMaxListeners=function t(){return c(this)};r.prototype.emit=function t(i){var n=[];for(var s=1;s<arguments.length;s++)n.push(arguments[s]);var r=i==="error";var o=this._events;if(o!==undefined)r=r&&o.error===undefined;else if(!r)return false;if(r){var a;if(n.length>0)a=n[0];if(a instanceof Error){throw a}var c=new Error("Unhandled error."+(a?" ("+a.message+")":""));c.context=a;throw c}var u=o[i];if(u===undefined)return false;if(typeof u==="function"){e(u,this,n)}else{var d=u.length;var h=m(u,d);for(var s=0;s<d;++s)e(h[s],this,n)}return true};function u(t,e,i,s){var r;var o;var u;a(i);o=t._events;if(o===undefined){o=t._events=Object.create(null);t._eventsCount=0}else{if(o.newListener!==undefined){t.emit("newListener",e,i.listener?i.listener:i);o=t._events}u=o[e]}if(u===undefined){u=o[e]=i;++t._eventsCount}else{if(typeof u==="function"){u=o[e]=s?[i,u]:[u,i]}else if(s){u.unshift(i)}else{u.push(i)}r=c(t);if(r>0&&u.length>r&&!u.warned){u.warned=true;var d=new Error("Possible EventEmitter memory leak detected. "+u.length+" "+String(e)+" listeners "+"added. Use emitter.setMaxListeners() to "+"increase limit");d.name="MaxListenersExceededWarning";d.emitter=t;d.type=e;d.count=u.length;n(d)}}return t}r.prototype.addListener=function t(e,i){return u(this,e,i,false)};r.prototype.on=r.prototype.addListener;r.prototype.prependListener=function t(e,i){return u(this,e,i,true)};function d(){if(!this.fired){this.target.removeListener(this.type,this.wrapFn);this.fired=true;if(arguments.length===0)return this.listener.call(this.target);return this.listener.apply(this.target,arguments)}}function h(t,e,i){var n={fired:false,wrapFn:undefined,target:t,type:e,listener:i};var s=d.bind(n);s.listener=i;n.wrapFn=s;return s}r.prototype.once=function t(e,i){a(i);this.on(e,h(this,e,i));return this};r.prototype.prependOnceListener=function t(e,i){a(i);this.prependListener(e,h(this,e,i));return this};r.prototype.removeListener=function t(e,i){var n,s,r,o,c;a(i);s=this._events;if(s===undefined)return this;n=s[e];if(n===undefined)return this;if(n===i||n.listener===i){if(--this._eventsCount===0)this._events=Object.create(null);else{delete s[e];if(s.removeListener)this.emit("removeListener",e,n.listener||i)}}else if(typeof n!=="function"){r=-1;for(o=n.length-1;o>=0;o--){if(n[o]===i||n[o].listener===i){c=n[o].listener;r=o;break}}if(r<0)return this;if(r===0)n.shift();else{v(n,r)}if(n.length===1)s[e]=n[0];if(s.removeListener!==undefined)this.emit("removeListener",e,c||i)}return this};r.prototype.off=r.prototype.removeListener;r.prototype.removeAllListeners=function t(e){var i,n,s;n=this._events;if(n===undefined)return this;if(n.removeListener===undefined){if(arguments.length===0){this._events=Object.create(null);this._eventsCount=0}else if(n[e]!==undefined){if(--this._eventsCount===0)this._events=Object.create(null);else delete n[e]}return this}if(arguments.length===0){var r=Object.keys(n);var o;for(s=0;s<r.length;++s){o=r[s];if(o==="removeListener")continue;this.removeAllListeners(o)}this.removeAllListeners("removeListener");this._events=Object.create(null);this._eventsCount=0;return this}i=n[e];if(typeof i==="function"){this.removeListener(e,i)}else if(i!==undefined){for(s=i.length-1;s>=0;s--){this.removeListener(e,i[s])}}return this};function l(t,e,i){var n=t._events;if(n===undefined)return[];var s=n[e];if(s===undefined)return[];if(typeof s==="function")return i?[s.listener||s]:[s];return i?p(s):m(s,s.length)}r.prototype.listeners=function t(e){return l(this,e,true)};r.prototype.rawListeners=function t(e){return l(this,e,false)};r.listenerCount=function(t,e){if(typeof t.listenerCount==="function"){return t.listenerCount(e)}else{return f.call(t,e)}};r.prototype.listenerCount=f;function f(t){var e=this._events;if(e!==undefined){var i=e[t];if(typeof i==="function"){return 1}else if(i!==undefined){return i.length}}return 0}r.prototype.eventNames=function t(){return this._eventsCount>0?i(this._events):[]};function m(t,e){var i=new Array(e);for(var n=0;n<e;++n)i[n]=t[n];return i}function v(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}function p(t){var e=new Array(t.length);for(var i=0;i<e.length;++i){e[i]=t[i].listener||t[i]}return e}function b(t,e){return new Promise((function(i,n){function s(i){t.removeListener(e,r);n(i)}function r(){if(typeof t.removeListener==="function"){t.removeListener("error",s)}i([].slice.call(arguments))}y(t,e,r,{once:true});if(e!=="error"){g(t,s,{once:true})}}))}function g(t,e,i){if(typeof t.on==="function"){y(t,"error",e,i)}}function y(t,e,i,n){if(typeof t.on==="function"){if(n.once){t.once(e,i)}else{t.on(e,i)}}else if(typeof t.addEventListener==="function"){t.addEventListener(e,(function s(r){if(n.once){t.removeEventListener(e,s)}i(r)}))}else{throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t)}}return kn.exports}var Sn=Tn();let On=true;let En=true;function Cn(t,e,i){const n=t.match(e);return n&&n.length>=i&&parseInt(n[i],10)}function jn(t,e,i){if(!t.RTCPeerConnection){return}const n=t.RTCPeerConnection.prototype;const s=n.addEventListener;n.addEventListener=function(t,n){if(t!==e){return s.apply(this,arguments)}const r=t=>{const e=i(t);if(e){if(n.handleEvent){n.handleEvent(e)}else{n(e)}}};this._eventMap=this._eventMap||{};if(!this._eventMap[e]){this._eventMap[e]=new Map}this._eventMap[e].set(n,r);return s.apply(this,[t,r])};const r=n.removeEventListener;n.removeEventListener=function(t,i){if(t!==e||!this._eventMap||!this._eventMap[e]){return r.apply(this,arguments)}if(!this._eventMap[e].has(i)){return r.apply(this,arguments)}const n=this._eventMap[e].get(i);this._eventMap[e].delete(i);if(this._eventMap[e].size===0){delete this._eventMap[e]}if(Object.keys(this._eventMap).length===0){delete this._eventMap}return r.apply(this,[t,n])};Object.defineProperty(n,"on"+e,{get(){return this["_on"+e]},set(t){if(this["_on"+e]){this.removeEventListener(e,this["_on"+e]);delete this["_on"+e]}if(t){this.addEventListener(e,this["_on"+e]=t)}},enumerable:true,configurable:true})}function Rn(t){if(typeof t!=="boolean"){return new Error("Argument type: "+typeof t+". Please use a boolean.")}On=t;return t?"adapter.js logging disabled":"adapter.js logging enabled"}function In(t){if(typeof t!=="boolean"){return new Error("Argument type: "+typeof t+". Please use a boolean.")}En=!t;return"adapter.js deprecation warnings "+(t?"disabled":"enabled")}function _n(){if(typeof window==="object"){if(On){return}if(typeof console!=="undefined"&&typeof console.log==="function"){console.log.apply(console,arguments)}}}function Pn(t,e){if(!En){return}console.warn(t+" is deprecated, please use "+e+" instead.")}function Nn(t){const e={browser:null,version:null};if(typeof t==="undefined"||!t.navigator||!t.navigator.userAgent){e.browser="Not a browser.";return e}const{navigator:i}=t;if(i.userAgentData&&i.userAgentData.brands){const t=i.userAgentData.brands.find((t=>t.brand==="Chromium"));if(t){return{browser:"chrome",version:parseInt(t.version,10)}}}if(i.mozGetUserMedia){e.browser="firefox";e.version=Cn(i.userAgent,/Firefox\/(\d+)\./,1)}else if(i.webkitGetUserMedia||t.isSecureContext===false&&t.webkitRTCPeerConnection){e.browser="chrome";e.version=Cn(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2)}else if(t.RTCPeerConnection&&i.userAgent.match(/AppleWebKit\/(\d+)\./)){e.browser="safari";e.version=Cn(i.userAgent,/AppleWebKit\/(\d+)\./,1);e.supportsUnifiedPlan=t.RTCRtpTransceiver&&"currentDirection"in t.RTCRtpTransceiver.prototype}else{e.browser="Not a supported browser.";return e}return e}function Dn(t){return Object.prototype.toString.call(t)==="[object Object]"}function An(t){if(!Dn(t)){return t}return Object.keys(t).reduce((function(e,i){const n=Dn(t[i]);const s=n?An(t[i]):t[i];const r=n&&!Object.keys(s).length;if(s===undefined||r){return e}return Object.assign(e,{[i]:s})}),{})}function xn(t,e,i){if(!e||i.has(e.id)){return}i.set(e.id,e);Object.keys(e).forEach((n=>{if(n.endsWith("Id")){xn(t,t.get(e[n]),i)}else if(n.endsWith("Ids")){e[n].forEach((e=>{xn(t,t.get(e),i)}))}}))}function Mn(t,e,i){const n=i?"outbound-rtp":"inbound-rtp";const s=new Map;if(e===null){return s}const r=[];t.forEach((t=>{if(t.type==="track"&&t.trackIdentifier===e.id){r.push(t)}}));r.forEach((e=>{t.forEach((i=>{if(i.type===n&&i.trackId===e.id){xn(t,i,s)}}))}));return s}const Un=_n;function Ln(t,e){const i=t&&t.navigator;if(!i.mediaDevices){return}const n=function(t){if(typeof t!=="object"||t.mandatory||t.optional){return t}const e={};Object.keys(t).forEach((i=>{if(i==="require"||i==="advanced"||i==="mediaSource"){return}const n=typeof t[i]==="object"?t[i]:{ideal:t[i]};if(n.exact!==undefined&&typeof n.exact==="number"){n.min=n.max=n.exact}const s=function(t,e){if(t){return t+e.charAt(0).toUpperCase()+e.slice(1)}return e==="deviceId"?"sourceId":e};if(n.ideal!==undefined){e.optional=e.optional||[];let t={};if(typeof n.ideal==="number"){t[s("min",i)]=n.ideal;e.optional.push(t);t={};t[s("max",i)]=n.ideal;e.optional.push(t)}else{t[s("",i)]=n.ideal;e.optional.push(t)}}if(n.exact!==undefined&&typeof n.exact!=="number"){e.mandatory=e.mandatory||{};e.mandatory[s("",i)]=n.exact}else{["min","max"].forEach((t=>{if(n[t]!==undefined){e.mandatory=e.mandatory||{};e.mandatory[s(t,i)]=n[t]}}))}}));if(t.advanced){e.optional=(e.optional||[]).concat(t.advanced)}return e};const s=function(t,s){if(e.version>=61){return s(t)}t=JSON.parse(JSON.stringify(t));if(t&&typeof t.audio==="object"){const e=function(t,e,i){if(e in t&&!(i in t)){t[i]=t[e];delete t[e]}};t=JSON.parse(JSON.stringify(t));e(t.audio,"autoGainControl","googAutoGainControl");e(t.audio,"noiseSuppression","googNoiseSuppression");t.audio=n(t.audio)}if(t&&typeof t.video==="object"){let r=t.video.facingMode;r=r&&(typeof r==="object"?r:{ideal:r});const o=e.version<66;if(r&&(r.exact==="user"||r.exact==="environment"||r.ideal==="user"||r.ideal==="environment")&&!(i.mediaDevices.getSupportedConstraints&&i.mediaDevices.getSupportedConstraints().facingMode&&!o)){delete t.video.facingMode;let e;if(r.exact==="environment"||r.ideal==="environment"){e=["back","rear"]}else if(r.exact==="user"||r.ideal==="user"){e=["front"]}if(e){return i.mediaDevices.enumerateDevices().then((i=>{i=i.filter((t=>t.kind==="videoinput"));let o=i.find((t=>e.some((e=>t.label.toLowerCase().includes(e)))));if(!o&&i.length&&e.includes("back")){o=i[i.length-1]}if(o){t.video.deviceId=r.exact?{exact:o.deviceId}:{ideal:o.deviceId}}t.video=n(t.video);Un("chrome: "+JSON.stringify(t));return s(t)}))}}t.video=n(t.video)}Un("chrome: "+JSON.stringify(t));return s(t)};const r=function(t){if(e.version>=64){return t}return{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[t.name]||t.name,message:t.message,constraint:t.constraint||t.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};const o=function(t,e,n){s(t,(t=>{i.webkitGetUserMedia(t,e,(t=>{if(n){n(r(t))}}))}))};i.getUserMedia=o.bind(i);if(i.mediaDevices.getUserMedia){const t=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(e){return s(e,(e=>t(e).then((t=>{if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length){t.getTracks().forEach((t=>{t.stop()}));throw new DOMException("","NotFoundError")}return t}),(t=>Promise.reject(r(t))))))}}}function Fn(t){t.MediaStream=t.MediaStream||t.webkitMediaStream}function qn(t){if(typeof t==="object"&&t.RTCPeerConnection&&!("ontrack"in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(t){if(this._ontrack){this.removeEventListener("track",this._ontrack)}this.addEventListener("track",this._ontrack=t)},enumerable:true,configurable:true});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function i(){if(!this._ontrackpoly){this._ontrackpoly=e=>{e.stream.addEventListener("addtrack",(i=>{let n;if(t.RTCPeerConnection.prototype.getReceivers){n=this.getReceivers().find((t=>t.track&&t.track.id===i.track.id))}else{n={track:i.track}}const s=new Event("track");s.track=i.track;s.receiver=n;s.transceiver={receiver:n};s.streams=[e.stream];this.dispatchEvent(s)}));e.stream.getTracks().forEach((i=>{let n;if(t.RTCPeerConnection.prototype.getReceivers){n=this.getReceivers().find((t=>t.track&&t.track.id===i.id))}else{n={track:i}}const s=new Event("track");s.track=i;s.receiver=n;s.transceiver={receiver:n};s.streams=[e.stream];this.dispatchEvent(s)}))};this.addEventListener("addstream",this._ontrackpoly)}return e.apply(this,arguments)}}else{jn(t,"track",(t=>{if(!t.transceiver){Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}})}return t}))}}function Bn(t){if(typeof t==="object"&&t.RTCPeerConnection&&!("getSenders"in t.RTCPeerConnection.prototype)&&"createDTMFSender"in t.RTCPeerConnection.prototype){const e=function(t,e){return{track:e,get dtmf(){if(this._dtmf===undefined){if(e.kind==="audio"){this._dtmf=t.createDTMFSender(e)}else{this._dtmf=null}}return this._dtmf},_pc:t}};if(!t.RTCPeerConnection.prototype.getSenders){t.RTCPeerConnection.prototype.getSenders=function t(){this._senders=this._senders||[];return this._senders.slice()};const i=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function t(n,s){let r=i.apply(this,arguments);if(!r){r=e(this,n);this._senders.push(r)}return r};const n=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function t(e){n.apply(this,arguments);const i=this._senders.indexOf(e);if(i!==-1){this._senders.splice(i,1)}}}const i=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function t(n){this._senders=this._senders||[];i.apply(this,[n]);n.getTracks().forEach((t=>{this._senders.push(e(this,t))}))};const n=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function t(e){this._senders=this._senders||[];n.apply(this,[e]);e.getTracks().forEach((t=>{const e=this._senders.find((e=>e.track===t));if(e){this._senders.splice(this._senders.indexOf(e),1)}}))}}else if(typeof t==="object"&&t.RTCPeerConnection&&"getSenders"in t.RTCPeerConnection.prototype&&"createDTMFSender"in t.RTCPeerConnection.prototype&&t.RTCRtpSender&&!("dtmf"in t.RTCRtpSender.prototype)){const e=t.RTCPeerConnection.prototype.getSenders;t.RTCPeerConnection.prototype.getSenders=function t(){const i=e.apply(this,[]);i.forEach((t=>t._pc=this));return i};Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get(){if(this._dtmf===undefined){if(this.track.kind==="audio"){this._dtmf=this._pc.createDTMFSender(this.track)}else{this._dtmf=null}}return this._dtmf}})}}function Vn(t){if(!(typeof t==="object"&&t.RTCPeerConnection&&t.RTCRtpSender&&t.RTCRtpReceiver)){return}if(!("getStats"in t.RTCRtpSender.prototype)){const e=t.RTCPeerConnection.prototype.getSenders;if(e){t.RTCPeerConnection.prototype.getSenders=function t(){const i=e.apply(this,[]);i.forEach((t=>t._pc=this));return i}}const i=t.RTCPeerConnection.prototype.addTrack;if(i){t.RTCPeerConnection.prototype.addTrack=function t(){const e=i.apply(this,arguments);e._pc=this;return e}}t.RTCRtpSender.prototype.getStats=function t(){const e=this;return this._pc.getStats().then((t=>Mn(t,e.track,true)))}}if(!("getStats"in t.RTCRtpReceiver.prototype)){const e=t.RTCPeerConnection.prototype.getReceivers;if(e){t.RTCPeerConnection.prototype.getReceivers=function t(){const i=e.apply(this,[]);i.forEach((t=>t._pc=this));return i}}jn(t,"track",(t=>{t.receiver._pc=t.srcElement;return t}));t.RTCRtpReceiver.prototype.getStats=function t(){const e=this;return this._pc.getStats().then((t=>Mn(t,e.track,false)))}}if(!("getStats"in t.RTCRtpSender.prototype&&"getStats"in t.RTCRtpReceiver.prototype)){return}const e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function i(){if(arguments.length>0&&arguments[0]instanceof t.MediaStreamTrack){const t=arguments[0];let e;let i;let n;this.getSenders().forEach((i=>{if(i.track===t){if(e){n=true}else{e=i}}}));this.getReceivers().forEach((e=>{if(e.track===t){if(i){n=true}else{i=e}}return e.track===t}));if(n||e&&i){return Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError"))}else if(e){return e.getStats()}else if(i){return i.getStats()}return Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function Jn(t){t.RTCPeerConnection.prototype.getLocalStreams=function t(){this._shimmedLocalStreams=this._shimmedLocalStreams||{};return Object.keys(this._shimmedLocalStreams).map((t=>this._shimmedLocalStreams[t][0]))};const e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function t(i,n){if(!n){return e.apply(this,arguments)}this._shimmedLocalStreams=this._shimmedLocalStreams||{};const s=e.apply(this,arguments);if(!this._shimmedLocalStreams[n.id]){this._shimmedLocalStreams[n.id]=[n,s]}else if(this._shimmedLocalStreams[n.id].indexOf(s)===-1){this._shimmedLocalStreams[n.id].push(s)}return s};const i=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function t(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{};e.getTracks().forEach((t=>{const e=this.getSenders().find((e=>e.track===t));if(e){throw new DOMException("Track already exists.","InvalidAccessError")}}));const n=this.getSenders();i.apply(this,arguments);const s=this.getSenders().filter((t=>n.indexOf(t)===-1));this._shimmedLocalStreams[e.id]=[e].concat(s)};const n=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function t(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{};delete this._shimmedLocalStreams[e.id];return n.apply(this,arguments)};const s=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function t(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{};if(e){Object.keys(this._shimmedLocalStreams).forEach((t=>{const i=this._shimmedLocalStreams[t].indexOf(e);if(i!==-1){this._shimmedLocalStreams[t].splice(i,1)}if(this._shimmedLocalStreams[t].length===1){delete this._shimmedLocalStreams[t]}}))}return s.apply(this,arguments)}}function Gn(t,e){if(!t.RTCPeerConnection){return}if(t.RTCPeerConnection.prototype.addTrack&&e.version>=65){return Jn(t)}const i=t.RTCPeerConnection.prototype.getLocalStreams;t.RTCPeerConnection.prototype.getLocalStreams=function t(){const e=i.apply(this);this._reverseStreams=this._reverseStreams||{};return e.map((t=>this._reverseStreams[t.id]))};const n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function e(i){this._streams=this._streams||{};this._reverseStreams=this._reverseStreams||{};i.getTracks().forEach((t=>{const e=this.getSenders().find((e=>e.track===t));if(e){throw new DOMException("Track already exists.","InvalidAccessError")}}));if(!this._reverseStreams[i.id]){const e=new t.MediaStream(i.getTracks());this._streams[i.id]=e;this._reverseStreams[e.id]=i;i=e}n.apply(this,[i])};const s=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function t(e){this._streams=this._streams||{};this._reverseStreams=this._reverseStreams||{};s.apply(this,[this._streams[e.id]||e]);delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id];delete this._streams[e.id]};t.RTCPeerConnection.prototype.addTrack=function e(i,n){if(this.signalingState==="closed"){throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError")}const s=[].slice.call(arguments,1);if(s.length!==1||!s[0].getTracks().find((t=>t===i))){throw new DOMException("The adapter.js addTrack polyfill only supports a single "+" stream which is associated with the specified track.","NotSupportedError")}const r=this.getSenders().find((t=>t.track===i));if(r){throw new DOMException("Track already exists.","InvalidAccessError")}this._streams=this._streams||{};this._reverseStreams=this._reverseStreams||{};const o=this._streams[n.id];if(o){o.addTrack(i);Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}))}else{const e=new t.MediaStream([i]);this._streams[n.id]=e;this._reverseStreams[e.id]=n;this.addStream(e)}return this.getSenders().find((t=>t.track===i))};function r(t,e){let i=e.sdp;Object.keys(t._reverseStreams||[]).forEach((e=>{const n=t._reverseStreams[e];const s=t._streams[n.id];i=i.replace(new RegExp(s.id,"g"),n.id)}));return new RTCSessionDescription({type:e.type,sdp:i})}function o(t,e){let i=e.sdp;Object.keys(t._reverseStreams||[]).forEach((e=>{const n=t._reverseStreams[e];const s=t._streams[n.id];i=i.replace(new RegExp(n.id,"g"),s.id)}));return new RTCSessionDescription({type:e.type,sdp:i})}["createOffer","createAnswer"].forEach((function(e){const i=t.RTCPeerConnection.prototype[e];const n={[e](){const t=arguments;const e=arguments.length&&typeof arguments[0]==="function";if(e){return i.apply(this,[e=>{const i=r(this,e);t[0].apply(null,[i])},e=>{if(t[1]){t[1].apply(null,e)}},arguments[2]])}return i.apply(this,arguments).then((t=>r(this,t)))}};t.RTCPeerConnection.prototype[e]=n[e]}));const a=t.RTCPeerConnection.prototype.setLocalDescription;t.RTCPeerConnection.prototype.setLocalDescription=function t(){if(!arguments.length||!arguments[0].type){return a.apply(this,arguments)}arguments[0]=o(this,arguments[0]);return a.apply(this,arguments)};const c=Object.getOwnPropertyDescriptor(t.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(t.RTCPeerConnection.prototype,"localDescription",{get(){const t=c.get.apply(this);if(t.type===""){return t}return r(this,t)}});t.RTCPeerConnection.prototype.removeTrack=function t(e){if(this.signalingState==="closed"){throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError")}if(!e._pc){throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack "+"does not implement interface RTCRtpSender.","TypeError")}const i=e._pc===this;if(!i){throw new DOMException("Sender was not created by this connection.","InvalidAccessError")}this._streams=this._streams||{};let n;Object.keys(this._streams).forEach((t=>{const i=this._streams[t].getTracks().find((t=>e.track===t));if(i){n=this._streams[t]}}));if(n){if(n.getTracks().length===1){this.removeStream(this._reverseStreams[n.id])}else{n.removeTrack(e.track)}this.dispatchEvent(new Event("negotiationneeded"))}}}function Hn(t,e){if(!t.RTCPeerConnection&&t.webkitRTCPeerConnection){t.RTCPeerConnection=t.webkitRTCPeerConnection}if(!t.RTCPeerConnection){return}if(e.version<53){["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(e){const i=t.RTCPeerConnection.prototype[e];const n={[e](){arguments[0]=new(e==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]);return i.apply(this,arguments)}};t.RTCPeerConnection.prototype[e]=n[e]}))}}function zn(t,e){jn(t,"negotiationneeded",(t=>{const i=t.target;if(e.version<72||i.getConfiguration&&i.getConfiguration().sdpSemantics==="plan-b"){if(i.signalingState!=="stable"){return}}return t}))}var Wn=Object.freeze({__proto__:null,fixNegotiationNeeded:zn,shimAddTrackRemoveTrack:Gn,shimAddTrackRemoveTrackWithNative:Jn,shimGetSendersWithDtmf:Bn,shimGetUserMedia:Ln,shimMediaStream:Fn,shimOnTrack:qn,shimPeerConnection:Hn,shimSenderReceiverGetStats:Vn});function Kn(t,e){const i=t&&t.navigator;const n=t&&t.MediaStreamTrack;i.getUserMedia=function(t,e,n){Pn("navigator.getUserMedia","navigator.mediaDevices.getUserMedia");i.mediaDevices.getUserMedia(t).then(e,n)};if(!(e.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const t=function(t,e,i){if(e in t&&!(i in t)){t[i]=t[e];delete t[e]}};const e=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(i){if(typeof i==="object"&&typeof i.audio==="object"){i=JSON.parse(JSON.stringify(i));t(i.audio,"autoGainControl","mozAutoGainControl");t(i.audio,"noiseSuppression","mozNoiseSuppression")}return e(i)};if(n&&n.prototype.getSettings){const e=n.prototype.getSettings;n.prototype.getSettings=function(){const i=e.apply(this,arguments);t(i,"mozAutoGainControl","autoGainControl");t(i,"mozNoiseSuppression","noiseSuppression");return i}}if(n&&n.prototype.applyConstraints){const e=n.prototype.applyConstraints;n.prototype.applyConstraints=function(i){if(this.kind==="audio"&&typeof i==="object"){i=JSON.parse(JSON.stringify(i));t(i,"autoGainControl","mozAutoGainControl");t(i,"noiseSuppression","mozNoiseSuppression")}return e.apply(this,[i])}}}}function Qn(t,e){if(t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices){return}if(!t.navigator.mediaDevices){return}t.navigator.mediaDevices.getDisplayMedia=function i(n){if(!(n&&n.video)){const t=new DOMException("getDisplayMedia without video "+"constraints is undefined");t.name="NotFoundError";t.code=8;return Promise.reject(t)}if(n.video===true){n.video={mediaSource:e}}else{n.video.mediaSource=e}return t.navigator.mediaDevices.getUserMedia(n)}}function Yn(t){if(typeof t==="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)){Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}}function Zn(t,e){if(typeof t!=="object"||!(t.RTCPeerConnection||t.mozRTCPeerConnection)){return}if(!t.RTCPeerConnection&&t.mozRTCPeerConnection){t.RTCPeerConnection=t.mozRTCPeerConnection}if(e.version<53){["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(e){const i=t.RTCPeerConnection.prototype[e];const n={[e](){arguments[0]=new(e==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]);return i.apply(this,arguments)}};t.RTCPeerConnection.prototype[e]=n[e]}))}const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"};const n=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function t(){const[s,r,o]=arguments;return n.apply(this,[s||null]).then((t=>{if(e.version<53&&!r){try{t.forEach((t=>{t.type=i[t.type]||t.type}))}catch(e){if(e.name!=="TypeError"){throw e}t.forEach(((e,n)=>{t.set(n,Object.assign({},e,{type:i[e.type]||e.type}))}))}}return t})).then(r,o)}}function $n(t){if(!(typeof t==="object"&&t.RTCPeerConnection&&t.RTCRtpSender)){return}if(t.RTCRtpSender&&"getStats"in t.RTCRtpSender.prototype){return}const e=t.RTCPeerConnection.prototype.getSenders;if(e){t.RTCPeerConnection.prototype.getSenders=function t(){const i=e.apply(this,[]);i.forEach((t=>t._pc=this));return i}}const i=t.RTCPeerConnection.prototype.addTrack;if(i){t.RTCPeerConnection.prototype.addTrack=function t(){const e=i.apply(this,arguments);e._pc=this;return e}}t.RTCRtpSender.prototype.getStats=function t(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function Xn(t){if(!(typeof t==="object"&&t.RTCPeerConnection&&t.RTCRtpSender)){return}if(t.RTCRtpSender&&"getStats"in t.RTCRtpReceiver.prototype){return}const e=t.RTCPeerConnection.prototype.getReceivers;if(e){t.RTCPeerConnection.prototype.getReceivers=function t(){const i=e.apply(this,[]);i.forEach((t=>t._pc=this));return i}}jn(t,"track",(t=>{t.receiver._pc=t.srcElement;return t}));t.RTCRtpReceiver.prototype.getStats=function t(){return this._pc.getStats(this.track)}}function ts(t){if(!t.RTCPeerConnection||"removeStream"in t.RTCPeerConnection.prototype){return}t.RTCPeerConnection.prototype.removeStream=function t(e){Pn("removeStream","removeTrack");this.getSenders().forEach((t=>{if(t.track&&e.getTracks().includes(t.track)){this.removeTrack(t)}}))}}function es(t){if(t.DataChannel&&!t.RTCDataChannel){t.RTCDataChannel=t.DataChannel}}function is(t){if(!(typeof t==="object"&&t.RTCPeerConnection)){return}const e=t.RTCPeerConnection.prototype.addTransceiver;if(e){t.RTCPeerConnection.prototype.addTransceiver=function t(){this.setParametersPromises=[];let i=arguments[1]&&arguments[1].sendEncodings;if(i===undefined){i=[]}i=[...i];const n=i.length>0;if(n){i.forEach((t=>{if("rid"in t){const e=/^[a-z0-9]{0,16}$/i;if(!e.test(t.rid)){throw new TypeError("Invalid RID value provided.")}}if("scaleResolutionDownBy"in t){if(!(parseFloat(t.scaleResolutionDownBy)>=1)){throw new RangeError("scale_resolution_down_by must be >= 1.0")}}if("maxFramerate"in t){if(!(parseFloat(t.maxFramerate)>=0)){throw new RangeError("max_framerate must be >= 0.0")}}}))}const s=e.apply(this,arguments);if(n){const{sender:t}=s;const e=t.getParameters();if(!("encodings"in e)||e.encodings.length===1&&Object.keys(e.encodings[0]).length===0){e.encodings=i;t.sendEncodings=i;this.setParametersPromises.push(t.setParameters(e).then((()=>{delete t.sendEncodings})).catch((()=>{delete t.sendEncodings})))}}return s}}}function ns(t){if(!(typeof t==="object"&&t.RTCRtpSender)){return}const e=t.RTCRtpSender.prototype.getParameters;if(e){t.RTCRtpSender.prototype.getParameters=function t(){const i=e.apply(this,arguments);if(!("encodings"in i)){i.encodings=[].concat(this.sendEncodings||[{}])}return i}}}function ss(t){if(!(typeof t==="object"&&t.RTCPeerConnection)){return}const e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function t(){if(this.setParametersPromises&&this.setParametersPromises.length){return Promise.all(this.setParametersPromises).then((()=>e.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]}))}return e.apply(this,arguments)}}function rs(t){if(!(typeof t==="object"&&t.RTCPeerConnection)){return}const e=t.RTCPeerConnection.prototype.createAnswer;t.RTCPeerConnection.prototype.createAnswer=function t(){if(this.setParametersPromises&&this.setParametersPromises.length){return Promise.all(this.setParametersPromises).then((()=>e.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]}))}return e.apply(this,arguments)}}var os=Object.freeze({__proto__:null,shimAddTransceiver:is,shimCreateAnswer:rs,shimCreateOffer:ss,shimGetDisplayMedia:Qn,shimGetParameters:ns,shimGetUserMedia:Kn,shimOnTrack:Yn,shimPeerConnection:Zn,shimRTCDataChannel:es,shimReceiverGetStats:Xn,shimRemoveStream:ts,shimSenderGetStats:$n});function as(t){if(typeof t!=="object"||!t.RTCPeerConnection){return}if(!("getLocalStreams"in t.RTCPeerConnection.prototype)){t.RTCPeerConnection.prototype.getLocalStreams=function t(){if(!this._localStreams){this._localStreams=[]}return this._localStreams}}if(!("addStream"in t.RTCPeerConnection.prototype)){const e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addStream=function t(i){if(!this._localStreams){this._localStreams=[]}if(!this._localStreams.includes(i)){this._localStreams.push(i)}i.getAudioTracks().forEach((t=>e.call(this,t,i)));i.getVideoTracks().forEach((t=>e.call(this,t,i)))};t.RTCPeerConnection.prototype.addTrack=function t(i){for(var n=arguments.length,s=new Array(n>1?n-1:0),r=1;r<n;r++){s[r-1]=arguments[r]}if(s){s.forEach((t=>{if(!this._localStreams){this._localStreams=[t]}else if(!this._localStreams.includes(t)){this._localStreams.push(t)}}))}return e.apply(this,arguments)}}if(!("removeStream"in t.RTCPeerConnection.prototype)){t.RTCPeerConnection.prototype.removeStream=function t(e){if(!this._localStreams){this._localStreams=[]}const i=this._localStreams.indexOf(e);if(i===-1){return}this._localStreams.splice(i,1);const n=e.getTracks();this.getSenders().forEach((t=>{if(n.includes(t.track)){this.removeTrack(t)}}))}}}function cs(t){if(typeof t!=="object"||!t.RTCPeerConnection){return}if(!("getRemoteStreams"in t.RTCPeerConnection.prototype)){t.RTCPeerConnection.prototype.getRemoteStreams=function t(){return this._remoteStreams?this._remoteStreams:[]}}if(!("onaddstream"in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(t){if(this._onaddstream){this.removeEventListener("addstream",this._onaddstream);this.removeEventListener("track",this._onaddstreampoly)}this.addEventListener("addstream",this._onaddstream=t);this.addEventListener("track",this._onaddstreampoly=t=>{t.streams.forEach((t=>{if(!this._remoteStreams){this._remoteStreams=[]}if(this._remoteStreams.includes(t)){return}this._remoteStreams.push(t);const e=new Event("addstream");e.stream=t;this.dispatchEvent(e)}))})}});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function t(){const i=this;if(!this._onaddstreampoly){this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{if(!i._remoteStreams){i._remoteStreams=[]}if(i._remoteStreams.indexOf(t)>=0){return}i._remoteStreams.push(t);const e=new Event("addstream");e.stream=t;i.dispatchEvent(e)}))})}return e.apply(i,arguments)}}}function us(t){if(typeof t!=="object"||!t.RTCPeerConnection){return}const e=t.RTCPeerConnection.prototype;const i=e.createOffer;const n=e.createAnswer;const s=e.setLocalDescription;const r=e.setRemoteDescription;const o=e.addIceCandidate;e.createOffer=function t(e,n){const s=arguments.length>=2?arguments[2]:arguments[0];const r=i.apply(this,[s]);if(!n){return r}r.then(e,n);return Promise.resolve()};e.createAnswer=function t(e,i){const s=arguments.length>=2?arguments[2]:arguments[0];const r=n.apply(this,[s]);if(!i){return r}r.then(e,i);return Promise.resolve()};let a=function(t,e,i){const n=s.apply(this,[t]);if(!i){return n}n.then(e,i);return Promise.resolve()};e.setLocalDescription=a;a=function(t,e,i){const n=r.apply(this,[t]);if(!i){return n}n.then(e,i);return Promise.resolve()};e.setRemoteDescription=a;a=function(t,e,i){const n=o.apply(this,[t]);if(!i){return n}n.then(e,i);return Promise.resolve()};e.addIceCandidate=a}function ds(t){const e=t&&t.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){const t=e.mediaDevices;const i=t.getUserMedia.bind(t);e.mediaDevices.getUserMedia=t=>i(hs(t))}if(!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia){e.getUserMedia=function t(i,n,s){e.mediaDevices.getUserMedia(i).then(n,s)}.bind(e)}}function hs(t){if(t&&t.video!==undefined){return Object.assign({},t,{video:An(t.video)})}return t}function ls(t){if(!t.RTCPeerConnection){return}const e=t.RTCPeerConnection;t.RTCPeerConnection=function t(i,n){if(i&&i.iceServers){const t=[];for(let e=0;e<i.iceServers.length;e++){let n=i.iceServers[e];if(n.urls===undefined&&n.url){Pn("RTCIceServer.url","RTCIceServer.urls");n=JSON.parse(JSON.stringify(n));n.urls=n.url;delete n.url;t.push(n)}else{t.push(i.iceServers[e])}}i.iceServers=t}return new e(i,n)};t.RTCPeerConnection.prototype=e.prototype;if("generateCertificate"in e){Object.defineProperty(t.RTCPeerConnection,"generateCertificate",{get(){return e.generateCertificate}})}}function fs(t){if(typeof t==="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)){Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}}function ms(t){const e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function t(i){if(i){if(typeof i.offerToReceiveAudio!=="undefined"){i.offerToReceiveAudio=!!i.offerToReceiveAudio}const t=this.getTransceivers().find((t=>t.receiver.track.kind==="audio"));if(i.offerToReceiveAudio===false&&t){if(t.direction==="sendrecv"){if(t.setDirection){t.setDirection("sendonly")}else{t.direction="sendonly"}}else if(t.direction==="recvonly"){if(t.setDirection){t.setDirection("inactive")}else{t.direction="inactive"}}}else if(i.offerToReceiveAudio===true&&!t){this.addTransceiver("audio",{direction:"recvonly"})}if(typeof i.offerToReceiveVideo!=="undefined"){i.offerToReceiveVideo=!!i.offerToReceiveVideo}const e=this.getTransceivers().find((t=>t.receiver.track.kind==="video"));if(i.offerToReceiveVideo===false&&e){if(e.direction==="sendrecv"){if(e.setDirection){e.setDirection("sendonly")}else{e.direction="sendonly"}}else if(e.direction==="recvonly"){if(e.setDirection){e.setDirection("inactive")}else{e.direction="inactive"}}}else if(i.offerToReceiveVideo===true&&!e){this.addTransceiver("video",{direction:"recvonly"})}}return e.apply(this,arguments)}}function vs(t){if(typeof t!=="object"||t.AudioContext){return}t.AudioContext=t.webkitAudioContext}var ps=Object.freeze({__proto__:null,shimAudioContext:vs,shimCallbacksAPI:us,shimConstraints:hs,shimCreateOfferLegacy:ms,shimGetUserMedia:ds,shimLocalStreamsAPI:as,shimRTCIceServerUrls:ls,shimRemoteStreamsAPI:cs,shimTrackEventTransceiver:fs});var bs={exports:{}};var gs;function ys(){if(gs)return bs.exports;gs=1;(function(t){const e={};e.generateIdentifier=function(){return Math.random().toString(36).substring(2,12)};e.localCName=e.generateIdentifier();e.splitLines=function(t){return t.trim().split("\n").map((t=>t.trim()))};e.splitSections=function(t){const e=t.split("\nm=");return e.map(((t,e)=>(e>0?"m="+t:t).trim()+"\r\n"))};e.getDescription=function(t){const i=e.splitSections(t);return i&&i[0]};e.getMediaSections=function(t){const i=e.splitSections(t);i.shift();return i};e.matchPrefix=function(t,i){return e.splitLines(t).filter((t=>t.indexOf(i)===0))};e.parseCandidate=function(t){let e;if(t.indexOf("a=candidate:")===0){e=t.substring(12).split(" ")}else{e=t.substring(10).split(" ")}const i={foundation:e[0],component:{1:"rtp",2:"rtcp"}[e[1]]||e[1],protocol:e[2].toLowerCase(),priority:parseInt(e[3],10),ip:e[4],address:e[4],port:parseInt(e[5],10),type:e[7]};for(let t=8;t<e.length;t+=2){switch(e[t]){case"raddr":i.relatedAddress=e[t+1];break;case"rport":i.relatedPort=parseInt(e[t+1],10);break;case"tcptype":i.tcpType=e[t+1];break;case"ufrag":i.ufrag=e[t+1];i.usernameFragment=e[t+1];break;default:if(i[e[t]]===undefined){i[e[t]]=e[t+1]}break}}return i};e.writeCandidate=function(t){const e=[];e.push(t.foundation);const i=t.component;if(i==="rtp"){e.push(1)}else if(i==="rtcp"){e.push(2)}else{e.push(i)}e.push(t.protocol.toUpperCase());e.push(t.priority);e.push(t.address||t.ip);e.push(t.port);const n=t.type;e.push("typ");e.push(n);if(n!=="host"&&t.relatedAddress&&t.relatedPort){e.push("raddr");e.push(t.relatedAddress);e.push("rport");e.push(t.relatedPort)}if(t.tcpType&&t.protocol.toLowerCase()==="tcp"){e.push("tcptype");e.push(t.tcpType)}if(t.usernameFragment||t.ufrag){e.push("ufrag");e.push(t.usernameFragment||t.ufrag)}return"candidate:"+e.join(" ")};e.parseIceOptions=function(t){return t.substring(14).split(" ")};e.parseRtpMap=function(t){let e=t.substring(9).split(" ");const i={payloadType:parseInt(e.shift(),10)};e=e[0].split("/");i.name=e[0];i.clockRate=parseInt(e[1],10);i.channels=e.length===3?parseInt(e[2],10):1;i.numChannels=i.channels;return i};e.writeRtpMap=function(t){let e=t.payloadType;if(t.preferredPayloadType!==undefined){e=t.preferredPayloadType}const i=t.channels||t.numChannels||1;return"a=rtpmap:"+e+" "+t.name+"/"+t.clockRate+(i!==1?"/"+i:"")+"\r\n"};e.parseExtmap=function(t){const e=t.substring(9).split(" ");return{id:parseInt(e[0],10),direction:e[0].indexOf("/")>0?e[0].split("/")[1]:"sendrecv",uri:e[1],attributes:e.slice(2).join(" ")}};e.writeExtmap=function(t){return"a=extmap:"+(t.id||t.preferredId)+(t.direction&&t.direction!=="sendrecv"?"/"+t.direction:"")+" "+t.uri+(t.attributes?" "+t.attributes:"")+"\r\n"};e.parseFmtp=function(t){const e={};let i;const n=t.substring(t.indexOf(" ")+1).split(";");for(let t=0;t<n.length;t++){i=n[t].trim().split("=");e[i[0].trim()]=i[1]}return e};e.writeFmtp=function(t){let e="";let i=t.payloadType;if(t.preferredPayloadType!==undefined){i=t.preferredPayloadType}if(t.parameters&&Object.keys(t.parameters).length){const n=[];Object.keys(t.parameters).forEach((e=>{if(t.parameters[e]!==undefined){n.push(e+"="+t.parameters[e])}else{n.push(e)}}));e+="a=fmtp:"+i+" "+n.join(";")+"\r\n"}return e};e.parseRtcpFb=function(t){const e=t.substring(t.indexOf(" ")+1).split(" ");return{type:e.shift(),parameter:e.join(" ")}};e.writeRtcpFb=function(t){let e="";let i=t.payloadType;if(t.preferredPayloadType!==undefined){i=t.preferredPayloadType}if(t.rtcpFeedback&&t.rtcpFeedback.length){t.rtcpFeedback.forEach((t=>{e+="a=rtcp-fb:"+i+" "+t.type+(t.parameter&&t.parameter.length?" "+t.parameter:"")+"\r\n"}))}return e};e.parseSsrcMedia=function(t){const e=t.indexOf(" ");const i={ssrc:parseInt(t.substring(7,e),10)};const n=t.indexOf(":",e);if(n>-1){i.attribute=t.substring(e+1,n);i.value=t.substring(n+1)}else{i.attribute=t.substring(e+1)}return i};e.parseSsrcGroup=function(t){const e=t.substring(13).split(" ");return{semantics:e.shift(),ssrcs:e.map((t=>parseInt(t,10)))}};e.getMid=function(t){const i=e.matchPrefix(t,"a=mid:")[0];if(i){return i.substring(6)}};e.parseFingerprint=function(t){const e=t.substring(14).split(" ");return{algorithm:e[0].toLowerCase(),value:e[1].toUpperCase()}};e.getDtlsParameters=function(t,i){const n=e.matchPrefix(t+i,"a=fingerprint:");return{role:"auto",fingerprints:n.map(e.parseFingerprint)}};e.writeDtlsParameters=function(t,e){let i="a=setup:"+e+"\r\n";t.fingerprints.forEach((t=>{i+="a=fingerprint:"+t.algorithm+" "+t.value+"\r\n"}));return i};e.parseCryptoLine=function(t){const e=t.substring(9).split(" ");return{tag:parseInt(e[0],10),cryptoSuite:e[1],keyParams:e[2],sessionParams:e.slice(3)}};e.writeCryptoLine=function(t){return"a=crypto:"+t.tag+" "+t.cryptoSuite+" "+(typeof t.keyParams==="object"?e.writeCryptoKeyParams(t.keyParams):t.keyParams)+(t.sessionParams?" "+t.sessionParams.join(" "):"")+"\r\n"};e.parseCryptoKeyParams=function(t){if(t.indexOf("inline:")!==0){return null}const e=t.substring(7).split("|");return{keyMethod:"inline",keySalt:e[0],lifeTime:e[1],mkiValue:e[2]?e[2].split(":")[0]:undefined,mkiLength:e[2]?e[2].split(":")[1]:undefined}};e.writeCryptoKeyParams=function(t){return t.keyMethod+":"+t.keySalt+(t.lifeTime?"|"+t.lifeTime:"")+(t.mkiValue&&t.mkiLength?"|"+t.mkiValue+":"+t.mkiLength:"")};e.getCryptoParameters=function(t,i){const n=e.matchPrefix(t+i,"a=crypto:");return n.map(e.parseCryptoLine)};e.getIceParameters=function(t,i){const n=e.matchPrefix(t+i,"a=ice-ufrag:")[0];const s=e.matchPrefix(t+i,"a=ice-pwd:")[0];if(!(n&&s)){return null}return{usernameFragment:n.substring(12),password:s.substring(10)}};e.writeIceParameters=function(t){let e="a=ice-ufrag:"+t.usernameFragment+"\r\n"+"a=ice-pwd:"+t.password+"\r\n";if(t.iceLite){e+="a=ice-lite\r\n"}return e};e.parseRtpParameters=function(t){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]};const n=e.splitLines(t);const s=n[0].split(" ");i.profile=s[2];for(let n=3;n<s.length;n++){const r=s[n];const o=e.matchPrefix(t,"a=rtpmap:"+r+" ")[0];if(o){const n=e.parseRtpMap(o);const s=e.matchPrefix(t,"a=fmtp:"+r+" ");n.parameters=s.length?e.parseFmtp(s[0]):{};n.rtcpFeedback=e.matchPrefix(t,"a=rtcp-fb:"+r+" ").map(e.parseRtcpFb);i.codecs.push(n);switch(n.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(n.name.toUpperCase());break}}}e.matchPrefix(t,"a=extmap:").forEach((t=>{i.headerExtensions.push(e.parseExtmap(t))}));const r=e.matchPrefix(t,"a=rtcp-fb:* ").map(e.parseRtcpFb);i.codecs.forEach((t=>{r.forEach((e=>{const i=t.rtcpFeedback.find((t=>t.type===e.type&&t.parameter===e.parameter));if(!i){t.rtcpFeedback.push(e)}}))}));return i};e.writeRtpDescription=function(t,i){let n="";n+="m="+t+" ";n+=i.codecs.length>0?"9":"0";n+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ";n+=i.codecs.map((t=>{if(t.preferredPayloadType!==undefined){return t.preferredPayloadType}return t.payloadType})).join(" ")+"\r\n";n+="c=IN IP4 0.0.0.0\r\n";n+="a=rtcp:9 IN IP4 0.0.0.0\r\n";i.codecs.forEach((t=>{n+=e.writeRtpMap(t);n+=e.writeFmtp(t);n+=e.writeRtcpFb(t)}));let s=0;i.codecs.forEach((t=>{if(t.maxptime>s){s=t.maxptime}}));if(s>0){n+="a=maxptime:"+s+"\r\n"}if(i.headerExtensions){i.headerExtensions.forEach((t=>{n+=e.writeExtmap(t)}))}return n};e.parseRtpEncodingParameters=function(t){const i=[];const n=e.parseRtpParameters(t);const s=n.fecMechanisms.indexOf("RED")!==-1;const r=n.fecMechanisms.indexOf("ULPFEC")!==-1;const o=e.matchPrefix(t,"a=ssrc:").map((t=>e.parseSsrcMedia(t))).filter((t=>t.attribute==="cname"));const a=o.length>0&&o[0].ssrc;let c;const u=e.matchPrefix(t,"a=ssrc-group:FID").map((t=>{const e=t.substring(17).split(" ");return e.map((t=>parseInt(t,10)))}));if(u.length>0&&u[0].length>1&&u[0][0]===a){c=u[0][1]}n.codecs.forEach((t=>{if(t.name.toUpperCase()==="RTX"&&t.parameters.apt){let e={ssrc:a,codecPayloadType:parseInt(t.parameters.apt,10)};if(a&&c){e.rtx={ssrc:c}}i.push(e);if(s){e=JSON.parse(JSON.stringify(e));e.fec={ssrc:a,mechanism:r?"red+ulpfec":"red"};i.push(e)}}}));if(i.length===0&&a){i.push({ssrc:a})}let d=e.matchPrefix(t,"b=");if(d.length){if(d[0].indexOf("b=TIAS:")===0){d=parseInt(d[0].substring(7),10)}else if(d[0].indexOf("b=AS:")===0){d=parseInt(d[0].substring(5),10)*1e3*.95-50*40*8}else{d=undefined}i.forEach((t=>{t.maxBitrate=d}))}return i};e.parseRtcpParameters=function(t){const i={};const n=e.matchPrefix(t,"a=ssrc:").map((t=>e.parseSsrcMedia(t))).filter((t=>t.attribute==="cname"))[0];if(n){i.cname=n.value;i.ssrc=n.ssrc}const s=e.matchPrefix(t,"a=rtcp-rsize");i.reducedSize=s.length>0;i.compound=s.length===0;const r=e.matchPrefix(t,"a=rtcp-mux");i.mux=r.length>0;return i};e.writeRtcpParameters=function(t){let e="";if(t.reducedSize){e+="a=rtcp-rsize\r\n"}if(t.mux){e+="a=rtcp-mux\r\n"}if(t.ssrc!==undefined&&t.cname){e+="a=ssrc:"+t.ssrc+" cname:"+t.cname+"\r\n"}return e};e.parseMsid=function(t){let i;const n=e.matchPrefix(t,"a=msid:");if(n.length===1){i=n[0].substring(7).split(" ");return{stream:i[0],track:i[1]}}const s=e.matchPrefix(t,"a=ssrc:").map((t=>e.parseSsrcMedia(t))).filter((t=>t.attribute==="msid"));if(s.length>0){i=s[0].value.split(" ");return{stream:i[0],track:i[1]}}};e.parseSctpDescription=function(t){const i=e.parseMLine(t);const n=e.matchPrefix(t,"a=max-message-size:");let s;if(n.length>0){s=parseInt(n[0].substring(19),10)}if(isNaN(s)){s=65536}const r=e.matchPrefix(t,"a=sctp-port:");if(r.length>0){return{port:parseInt(r[0].substring(12),10),protocol:i.fmt,maxMessageSize:s}}const o=e.matchPrefix(t,"a=sctpmap:");if(o.length>0){const t=o[0].substring(10).split(" ");return{port:parseInt(t[0],10),protocol:t[1],maxMessageSize:s}}};e.writeSctpDescription=function(t,e){let i=[];if(t.protocol!=="DTLS/SCTP"){i=["m="+t.kind+" 9 "+t.protocol+" "+e.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+e.port+"\r\n"]}else{i=["m="+t.kind+" 9 "+t.protocol+" "+e.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+e.port+" "+e.protocol+" 65535\r\n"]}if(e.maxMessageSize!==undefined){i.push("a=max-message-size:"+e.maxMessageSize+"\r\n")}return i.join("")};e.generateSessionId=function(){return Math.random().toString().substr(2,22)};e.writeSessionBoilerplate=function(t,i,n){let s;const r=i!==undefined?i:2;if(t){s=t}else{s=e.generateSessionId()}const o=n||"thisisadapterortc";return"v=0\r\n"+"o="+o+" "+s+" "+r+" IN IP4 127.0.0.1\r\n"+"s=-\r\n"+"t=0 0\r\n"};e.getDirection=function(t,i){const n=e.splitLines(t);for(let t=0;t<n.length;t++){switch(n[t]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[t].substring(2)}}if(i){return e.getDirection(i)}return"sendrecv"};e.getKind=function(t){const i=e.splitLines(t);const n=i[0].split(" ");return n[0].substring(2)};e.isRejected=function(t){return t.split(" ",2)[1]==="0"};e.parseMLine=function(t){const i=e.splitLines(t);const n=i[0].substring(2).split(" ");return{kind:n[0],port:parseInt(n[1],10),protocol:n[2],fmt:n.slice(3).join(" ")}};e.parseOLine=function(t){const i=e.matchPrefix(t,"o=")[0];const n=i.substring(2).split(" ");return{username:n[0],sessionId:n[1],sessionVersion:parseInt(n[2],10),netType:n[3],addressType:n[4],address:n[5]}};e.isValidSDP=function(t){if(typeof t!=="string"||t.length===0){return false}const i=e.splitLines(t);for(let t=0;t<i.length;t++){if(i[t].length<2||i[t].charAt(1)!=="="){return false}}return true};{t.exports=e}})(bs);return bs.exports}var ks=ys();var ws=en(ks);var Ts=o({__proto__:null,default:ws},[ks]);function Ss(t){if(!t.RTCIceCandidate||t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype){return}const e=t.RTCIceCandidate;t.RTCIceCandidate=function t(i){if(typeof i==="object"&&i.candidate&&i.candidate.indexOf("a=")===0){i=JSON.parse(JSON.stringify(i));i.candidate=i.candidate.substring(2)}if(i.candidate&&i.candidate.length){const t=new e(i);const n=ws.parseCandidate(i.candidate);for(const e in n){if(!(e in t)){Object.defineProperty(t,e,{value:n[e]})}}t.toJSON=function e(){return{candidate:t.candidate,sdpMid:t.sdpMid,sdpMLineIndex:t.sdpMLineIndex,usernameFragment:t.usernameFragment}};return t}return new e(i)};t.RTCIceCandidate.prototype=e.prototype;jn(t,"icecandidate",(e=>{if(e.candidate){Object.defineProperty(e,"candidate",{value:new t.RTCIceCandidate(e.candidate),writable:"false"})}return e}))}function Os(t){if(!t.RTCIceCandidate||t.RTCIceCandidate&&"relayProtocol"in t.RTCIceCandidate.prototype){return}jn(t,"icecandidate",(t=>{if(t.candidate){const e=ws.parseCandidate(t.candidate.candidate);if(e.type==="relay"){t.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[e.priority>>24]}}return t}))}function Es(t,e){if(!t.RTCPeerConnection){return}if(!("sctp"in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp==="undefined"?null:this._sctp}})}const i=function(t){if(!t||!t.sdp){return false}const e=ws.splitSections(t.sdp);e.shift();return e.some((t=>{const e=ws.parseMLine(t);return e&&e.kind==="application"&&e.protocol.indexOf("SCTP")!==-1}))};const n=function(t){const e=t.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(e===null||e.length<2){return-1}const i=parseInt(e[1],10);return i!==i?-1:i};const s=function(t){let i=65536;if(e.browser==="firefox"){if(e.version<57){if(t===-1){i=16384}else{i=2147483637}}else if(e.version<60){i=e.version===57?65535:65536}else{i=2147483637}}return i};const r=function(t,i){let n=65536;if(e.browser==="firefox"&&e.version===57){n=65535}const s=ws.matchPrefix(t.sdp,"a=max-message-size:");if(s.length>0){n=parseInt(s[0].substring(19),10)}else if(e.browser==="firefox"&&i!==-1){n=2147483637}return n};const o=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function t(){this._sctp=null;if(e.browser==="chrome"&&e.version>=76){const{sdpSemantics:t}=this.getConfiguration();if(t==="plan-b"){Object.defineProperty(this,"sctp",{get(){return typeof this._sctp==="undefined"?null:this._sctp},enumerable:true,configurable:true})}}if(i(arguments[0])){const t=n(arguments[0]);const e=s(t);const i=r(arguments[0],t);let o;if(e===0&&i===0){o=Number.POSITIVE_INFINITY}else if(e===0||i===0){o=Math.max(e,i)}else{o=Math.min(e,i)}const a={};Object.defineProperty(a,"maxMessageSize",{get(){return o}});this._sctp=a}return o.apply(this,arguments)}}function Cs(t){if(!(t.RTCPeerConnection&&"createDataChannel"in t.RTCPeerConnection.prototype)){return}function e(t,e){const i=t.send;t.send=function n(){const s=arguments[0];const r=s.length||s.size||s.byteLength;if(t.readyState==="open"&&e.sctp&&r>e.sctp.maxMessageSize){throw new TypeError("Message too large (can send a maximum of "+e.sctp.maxMessageSize+" bytes)")}return i.apply(t,arguments)}}const i=t.RTCPeerConnection.prototype.createDataChannel;t.RTCPeerConnection.prototype.createDataChannel=function t(){const n=i.apply(this,arguments);e(n,this);return n};jn(t,"datachannel",(t=>{e(t.channel,t.target);return t}))}function js(t){if(!t.RTCPeerConnection||"connectionState"in t.RTCPeerConnection.prototype){return}const e=t.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:true,configurable:true});Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(t){if(this._onconnectionstatechange){this.removeEventListener("connectionstatechange",this._onconnectionstatechange);delete this._onconnectionstatechange}if(t){this.addEventListener("connectionstatechange",this._onconnectionstatechange=t)}},enumerable:true,configurable:true});["setLocalDescription","setRemoteDescription"].forEach((t=>{const i=e[t];e[t]=function(){if(!this._connectionstatechangepoly){this._connectionstatechangepoly=t=>{const e=t.target;if(e._lastConnectionState!==e.connectionState){e._lastConnectionState=e.connectionState;const i=new Event("connectionstatechange",t);e.dispatchEvent(i)}return t};this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)}return i.apply(this,arguments)}}))}function Rs(t,e){if(!t.RTCPeerConnection){return}if(e.browser==="chrome"&&e.version>=71){return}if(e.browser==="safari"&&e.version>=605){return}const i=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function e(n){if(n&&n.sdp&&n.sdp.indexOf("\na=extmap-allow-mixed")!==-1){const e=n.sdp.split("\n").filter((t=>t.trim()!=="a=extmap-allow-mixed")).join("\n");if(t.RTCSessionDescription&&n instanceof t.RTCSessionDescription){arguments[0]=new t.RTCSessionDescription({type:n.type,sdp:e})}else{n.sdp=e}}return i.apply(this,arguments)}}function Is(t,e){if(!(t.RTCPeerConnection&&t.RTCPeerConnection.prototype)){return}const i=t.RTCPeerConnection.prototype.addIceCandidate;if(!i||i.length===0){return}t.RTCPeerConnection.prototype.addIceCandidate=function t(){if(!arguments[0]){if(arguments[1]){arguments[1].apply(null)}return Promise.resolve()}if((e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""){return Promise.resolve()}return i.apply(this,arguments)}}function _s(t,e){if(!(t.RTCPeerConnection&&t.RTCPeerConnection.prototype)){return}const i=t.RTCPeerConnection.prototype.setLocalDescription;if(!i||i.length===0){return}t.RTCPeerConnection.prototype.setLocalDescription=function t(){let e=arguments[0]||{};if(typeof e!=="object"||e.type&&e.sdp){return i.apply(this,arguments)}e={type:e.type,sdp:e.sdp};if(!e.type){switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":e.type="offer";break;default:e.type="answer";break}}if(e.sdp||e.type!=="offer"&&e.type!=="answer"){return i.apply(this,[e])}const n=e.type==="offer"?this.createOffer:this.createAnswer;return n.apply(this).then((t=>i.apply(this,[t])))}}var Ps=Object.freeze({__proto__:null,removeExtmapAllowMixed:Rs,shimAddIceCandidateNullOrEmpty:Is,shimConnectionState:js,shimMaxMessageSize:Es,shimParameterlessSetLocalDescription:_s,shimRTCIceCandidate:Ss,shimRTCIceCandidateRelayProtocol:Os,shimSendThrowTypeError:Cs});function Ns(){let{window:t}=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};let e=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{shimChrome:true,shimFirefox:true,shimSafari:true};const i=_n;const n=Nn(t);const s={browserDetails:n,commonShim:Ps,extractVersion:Cn,disableLog:Rn,disableWarnings:In,sdp:Ts};switch(n.browser){case"chrome":if(!Wn||!Hn||!e.shimChrome){i("Chrome shim is not included in this adapter release.");return s}if(n.version===null){i("Chrome shim can not determine version, not shimming.");return s}i("adapter.js shimming chrome.");s.browserShim=Wn;Is(t,n);_s(t);Ln(t,n);Fn(t);Hn(t,n);qn(t);Gn(t,n);Bn(t);Vn(t);zn(t,n);Ss(t);Os(t);js(t);Es(t,n);Cs(t);Rs(t,n);break;case"firefox":if(!os||!Zn||!e.shimFirefox){i("Firefox shim is not included in this adapter release.");return s}i("adapter.js shimming firefox.");s.browserShim=os;Is(t,n);_s(t);Kn(t,n);Zn(t,n);Yn(t);ts(t);$n(t);Xn(t);es(t);is(t);ns(t);ss(t);rs(t);Ss(t);js(t);Es(t,n);Cs(t);break;case"safari":if(!ps||!e.shimSafari){i("Safari shim is not included in this adapter release.");return s}i("adapter.js shimming safari.");s.browserShim=ps;Is(t,n);_s(t);ls(t);ms(t);us(t);as(t);cs(t);fs(t);ds(t);vs(t);Ss(t);Os(t);Es(t,n);Cs(t);Rs(t,n);break;default:i("Unsupported browser!");break}return s}Ns({window:typeof window==="undefined"?undefined:window});const Ds="lk_e2ee";var As;(function(t){t["SetKey"]="setKey";t["RatchetRequest"]="ratchetRequest";t["KeyRatcheted"]="keyRatcheted"})(As||(As={}));var xs;(function(t){t["KeyRatcheted"]="keyRatcheted"})(xs||(xs={}));var Ms;(function(t){t["ParticipantEncryptionStatusChanged"]="participantEncryptionStatusChanged";t["EncryptionError"]="encryptionError"})(Ms||(Ms={}));var Us;(function(t){t["Error"]="cryptorError"})(Us||(Us={}));function Ls(){return qs()||Fs()}function Fs(){return typeof window.RTCRtpScriptTransform!=="undefined"}function qs(){return typeof window.RTCRtpSender!=="undefined"&&typeof window.RTCRtpSender.prototype.createEncodedStreams!=="undefined"}class Bs extends Error{constructor(t,e){super(e||"an error has occured");this.name="LiveKitError";this.code=t}}var Vs;(function(t){t[t["NotAllowed"]=0]="NotAllowed";t[t["ServerUnreachable"]=1]="ServerUnreachable";t[t["InternalError"]=2]="InternalError";t[t["Cancelled"]=3]="Cancelled";t[t["LeaveRequest"]=4]="LeaveRequest"})(Vs||(Vs={}));class Js extends Bs{constructor(t,e,i,n){super(1,t);this.name="ConnectionError";this.status=i;this.reason=e;this.context=n;this.reasonName=Vs[e]}}class Gs extends Bs{constructor(t){super(21,t!==null&&t!==void 0?t:"device is unsupported");this.name="DeviceUnsupportedError"}}class Hs extends Bs{constructor(t){super(20,t!==null&&t!==void 0?t:"track is invalid");this.name="TrackInvalidError"}}class zs extends Bs{constructor(t){super(10,t!==null&&t!==void 0?t:"unsupported server");this.name="UnsupportedServer"}}class Ws extends Bs{constructor(t){super(12,t!==null&&t!==void 0?t:"unexpected connection state");this.name="UnexpectedConnectionState"}}class Ks extends Bs{constructor(t){super(13,t!==null&&t!==void 0?t:"unable to negotiate");this.name="NegotiationError"}}class Qs extends Bs{constructor(t,e){super(15,t);this.name="PublishTrackError";this.status=e}}class Ys extends Bs{constructor(t,e){super(15,t);this.reason=e;this.reasonName=typeof e==="string"?e:Xi[e]}}var Zs;(function(t){t["PermissionDenied"]="PermissionDenied";t["NotFound"]="NotFound";t["DeviceInUse"]="DeviceInUse";t["Other"]="Other"})(Zs||(Zs={}));(function(t){function e(e){if(e&&"name"in e){if(e.name==="NotFoundError"||e.name==="DevicesNotFoundError"){return t.NotFound}if(e.name==="NotAllowedError"||e.name==="PermissionDeniedError"){return t.PermissionDenied}if(e.name==="NotReadableError"||e.name==="TrackStartError"){return t.DeviceInUse}return t.Other}}t.getFailure=e})(Zs||(Zs={}));var $s;(function(t){t[t["InvalidKey"]=0]="InvalidKey";t[t["MissingKey"]=1]="MissingKey";t[t["InternalError"]=2]="InternalError"})($s||($s={}));var Xs;(function(t){t["Connected"]="connected";t["Reconnecting"]="reconnecting";t["SignalReconnecting"]="signalReconnecting";t["Reconnected"]="reconnected";t["Disconnected"]="disconnected";t["ConnectionStateChanged"]="connectionStateChanged";t["Moved"]="moved";t["MediaDevicesChanged"]="mediaDevicesChanged";t["ParticipantConnected"]="participantConnected";t["ParticipantDisconnected"]="participantDisconnected";t["TrackPublished"]="trackPublished";t["TrackSubscribed"]="trackSubscribed";t["TrackSubscriptionFailed"]="trackSubscriptionFailed";t["TrackUnpublished"]="trackUnpublished";t["TrackUnsubscribed"]="trackUnsubscribed";t["TrackMuted"]="trackMuted";t["TrackUnmuted"]="trackUnmuted";t["LocalTrackPublished"]="localTrackPublished";t["LocalTrackUnpublished"]="localTrackUnpublished";t["LocalAudioSilenceDetected"]="localAudioSilenceDetected";t["ActiveSpeakersChanged"]="activeSpeakersChanged";t["ParticipantMetadataChanged"]="participantMetadataChanged";t["ParticipantNameChanged"]="participantNameChanged";t["ParticipantAttributesChanged"]="participantAttributesChanged";t["RoomMetadataChanged"]="roomMetadataChanged";t["DataReceived"]="dataReceived";t["SipDTMFReceived"]="sipDTMFReceived";t["TranscriptionReceived"]="transcriptionReceived";t["ConnectionQualityChanged"]="connectionQualityChanged";t["TrackStreamStateChanged"]="trackStreamStateChanged";t["TrackSubscriptionPermissionChanged"]="trackSubscriptionPermissionChanged";t["TrackSubscriptionStatusChanged"]="trackSubscriptionStatusChanged";t["AudioPlaybackStatusChanged"]="audioPlaybackChanged";t["VideoPlaybackStatusChanged"]="videoPlaybackChanged";t["MediaDevicesError"]="mediaDevicesError";t["ParticipantPermissionsChanged"]="participantPermissionsChanged";t["SignalConnected"]="signalConnected";t["RecordingStatusChanged"]="recordingStatusChanged";t["ParticipantEncryptionStatusChanged"]="participantEncryptionStatusChanged";t["EncryptionError"]="encryptionError";t["DCBufferStatusChanged"]="dcBufferStatusChanged";t["ActiveDeviceChanged"]="activeDeviceChanged";t["ChatMessage"]="chatMessage";t["LocalTrackSubscribed"]="localTrackSubscribed";t["MetricsReceived"]="metricsReceived"})(Xs||(Xs={}));var tr;(function(t){t["TrackPublished"]="trackPublished";t["TrackSubscribed"]="trackSubscribed";t["TrackSubscriptionFailed"]="trackSubscriptionFailed";t["TrackUnpublished"]="trackUnpublished";t["TrackUnsubscribed"]="trackUnsubscribed";t["TrackMuted"]="trackMuted";t["TrackUnmuted"]="trackUnmuted";t["LocalTrackPublished"]="localTrackPublished";t["LocalTrackUnpublished"]="localTrackUnpublished";t["ParticipantMetadataChanged"]="participantMetadataChanged";t["ParticipantNameChanged"]="participantNameChanged";t["DataReceived"]="dataReceived";t["SipDTMFReceived"]="sipDTMFReceived";t["TranscriptionReceived"]="transcriptionReceived";t["IsSpeakingChanged"]="isSpeakingChanged";t["ConnectionQualityChanged"]="connectionQualityChanged";t["TrackStreamStateChanged"]="trackStreamStateChanged";t["TrackSubscriptionPermissionChanged"]="trackSubscriptionPermissionChanged";t["TrackSubscriptionStatusChanged"]="trackSubscriptionStatusChanged";t["MediaDevicesError"]="mediaDevicesError";t["AudioStreamAcquired"]="audioStreamAcquired";t["ParticipantPermissionsChanged"]="participantPermissionsChanged";t["PCTrackAdded"]="pcTrackAdded";t["AttributesChanged"]="attributesChanged";t["LocalTrackSubscribed"]="localTrackSubscribed";t["ChatMessage"]="chatMessage"})(tr||(tr={}));var er;(function(t){t["TransportsCreated"]="transportsCreated";t["Connected"]="connected";t["Disconnected"]="disconnected";t["Resuming"]="resuming";t["Resumed"]="resumed";t["Restarting"]="restarting";t["Restarted"]="restarted";t["SignalResumed"]="signalResumed";t["SignalRestarted"]="signalRestarted";t["Closing"]="closing";t["MediaTrackAdded"]="mediaTrackAdded";t["ActiveSpeakersUpdate"]="activeSpeakersUpdate";t["DataPacketReceived"]="dataPacketReceived";t["RTPVideoMapUpdate"]="rtpVideoMapUpdate";t["DCBufferStatusChanged"]="dcBufferStatusChanged";t["ParticipantUpdate"]="participantUpdate";t["RoomUpdate"]="roomUpdate";t["SpeakersChanged"]="speakersChanged";t["StreamStateChanged"]="streamStateChanged";t["ConnectionQualityUpdate"]="connectionQualityUpdate";t["SubscriptionError"]="subscriptionError";t["SubscriptionPermissionUpdate"]="subscriptionPermissionUpdate";t["RemoteMute"]="remoteMute";t["SubscribedQualityUpdate"]="subscribedQualityUpdate";t["LocalTrackUnpublished"]="localTrackUnpublished";t["LocalTrackSubscribed"]="localTrackSubscribed";t["Offline"]="offline";t["SignalRequestResponse"]="signalRequestResponse";t["SignalConnected"]="signalConnected";t["RoomMoved"]="roomMoved"})(er||(er={}));var ir;(function(t){t["Message"]="message";t["Muted"]="muted";t["Unmuted"]="unmuted";t["Restarted"]="restarted";t["Ended"]="ended";t["Subscribed"]="subscribed";t["Unsubscribed"]="unsubscribed";t["UpdateSettings"]="updateSettings";t["UpdateSubscription"]="updateSubscription";t["AudioPlaybackStarted"]="audioPlaybackStarted";t["AudioPlaybackFailed"]="audioPlaybackFailed";t["AudioSilenceDetected"]="audioSilenceDetected";t["VisibilityChanged"]="visibilityChanged";t["VideoDimensionsChanged"]="videoDimensionsChanged";t["VideoPlaybackStarted"]="videoPlaybackStarted";t["VideoPlaybackFailed"]="videoPlaybackFailed";t["ElementAttached"]="elementAttached";t["ElementDetached"]="elementDetached";t["UpstreamPaused"]="upstreamPaused";t["UpstreamResumed"]="upstreamResumed";t["SubscriptionPermissionChanged"]="subscriptionPermissionChanged";t["SubscriptionStatusChanged"]="subscriptionStatusChanged";t["SubscriptionFailed"]="subscriptionFailed";t["TrackProcessorUpdate"]="trackProcessorUpdate";t["AudioTrackFeatureUpdate"]="audioTrackFeatureUpdate";t["TranscriptionReceived"]="transcriptionReceived";t["TimeSyncUpdate"]="timeSyncUpdate"})(ir||(ir={}));function nr(t){if(typeof t==="undefined"){return t}if(typeof structuredClone==="function"){return structuredClone(t)}else{return JSON.parse(JSON.stringify(t))}}const sr=/version\/(\d+(\.?_?\d+)+)/i;let rr;function or(t){let e=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;if(typeof t==="undefined"&&typeof navigator==="undefined"){return}const i=(t!==null&&t!==void 0?t:navigator.userAgent).toLowerCase();if(rr===undefined||e){const t=ar.find((t=>{let{test:e}=t;return e.test(i)}));rr=t===null||t===void 0?void 0:t.describe(i)}return rr}const ar=[{test:/firefox|iceweasel|fxios/i,describe(t){const e={name:"Firefox",version:cr(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,t),os:t.toLowerCase().includes("fxios")?"iOS":undefined,osVersion:ur(t)};return e}},{test:/chrom|crios|crmo/i,describe(t){const e={name:"Chrome",version:cr(/(?:chrome|chromium|crios|crmo)\/(\d+(\.?_?\d+)+)/i,t),os:t.toLowerCase().includes("crios")?"iOS":undefined,osVersion:ur(t)};return e}},{test:/safari|applewebkit/i,describe(t){const e={name:"Safari",version:cr(sr,t),os:t.includes("mobile/")?"iOS":"macOS",osVersion:ur(t)};return e}}];function cr(t,e){let i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:1;const n=e.match(t);return n&&n.length>=i&&n[i]||""}function ur(t){return t.includes("mac os")?cr(/\(.+?(\d+_\d+(:?_\d+)?)/,t,1).replace(/_/g,"."):undefined}var dr="2.12.0";const hr=dr;const lr=16;class fr{}fr.setTimeout=function(){return setTimeout(...arguments)};fr.setInterval=function(){return setInterval(...arguments)};fr.clearTimeout=function(){return clearTimeout(...arguments)};fr.clearInterval=function(){return clearInterval(...arguments)};const mr=5e3;const vr=[];var pr;(function(t){t[t["LOW"]=0]="LOW";t[t["MEDIUM"]=1]="MEDIUM";t[t["HIGH"]=2]="HIGH"})(pr||(pr={}));class br extends Sn.EventEmitter{constructor(t,e){let i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var n;super();this.attachedElements=[];this.isMuted=false;this.streamState=br.StreamState.Active;this.isInBackground=false;this._currentBitrate=0;this.log=dn;this.appVisibilityChangedListener=()=>{if(this.backgroundTimeout){clearTimeout(this.backgroundTimeout)}if(document.visibilityState==="hidden"){this.backgroundTimeout=setTimeout((()=>this.handleAppVisibilityChanged()),mr)}else{this.handleAppVisibilityChanged()}};this.log=hn((n=i.loggerName)!==null&&n!==void 0?n:un.Track);this.loggerContextCb=i.loggerContextCb;this.setMaxListeners(100);this.kind=e;this._mediaStreamTrack=t;this._mediaStreamID=t.id;this.source=br.Source.Unknown}get logContext(){var t;return Object.assign(Object.assign({},(t=this.loggerContextCb)===null||t===void 0?void 0:t.call(this)),Fo(this))}get currentBitrate(){return this._currentBitrate}get mediaStreamTrack(){return this._mediaStreamTrack}get mediaStreamID(){return this._mediaStreamID}attach(t){let e="audio";if(this.kind===br.Kind.Video){e="video"}if(this.attachedElements.length===0&&this.kind===br.Kind.Video){this.addAppVisibilityListener()}if(!t){if(e==="audio"){vr.forEach((e=>{if(e.parentElement===null&&!t){t=e}}));if(t){vr.splice(vr.indexOf(t),1)}}if(!t){t=document.createElement(e)}}if(!this.attachedElements.includes(t)){this.attachedElements.push(t)}gr(this.mediaStreamTrack,t);const i=t.srcObject.getTracks();const n=i.some((t=>t.kind==="audio"));t.play().then((()=>{this.emit(n?ir.AudioPlaybackStarted:ir.VideoPlaybackStarted)})).catch((e=>{if(e.name==="NotAllowedError"){this.emit(n?ir.AudioPlaybackFailed:ir.VideoPlaybackFailed,e)}else if(e.name==="AbortError"){dn.debug("".concat(n?"audio":"video"," playback aborted, likely due to new play request"))}else{dn.warn("could not playback ".concat(n?"audio":"video"),e)}if(n&&t&&i.some((t=>t.kind==="video"))&&e.name==="NotAllowedError"){t.muted=true;t.play().catch((()=>{}))}}));this.emit(ir.ElementAttached,t);return t}detach(t){try{if(t){yr(this.mediaStreamTrack,t);const e=this.attachedElements.indexOf(t);if(e>=0){this.attachedElements.splice(e,1);this.recycleElement(t);this.emit(ir.ElementDetached,t)}return t}const e=[];this.attachedElements.forEach((t=>{yr(this.mediaStreamTrack,t);e.push(t);this.recycleElement(t);this.emit(ir.ElementDetached,t)}));this.attachedElements=[];return e}finally{if(this.attachedElements.length===0){this.removeAppVisibilityListener()}}}stop(){this.stopMonitor();this._mediaStreamTrack.stop()}enable(){this._mediaStreamTrack.enabled=true}disable(){this._mediaStreamTrack.enabled=false}stopMonitor(){if(this.monitorInterval){clearInterval(this.monitorInterval)}if(this.timeSyncHandle){cancelAnimationFrame(this.timeSyncHandle)}}updateLoggerOptions(t){if(t.loggerName){this.log=hn(t.loggerName)}if(t.loggerContextCb){this.loggerContextCb=t.loggerContextCb}}recycleElement(t){if(t instanceof HTMLAudioElement){let e=true;t.pause();vr.forEach((t=>{if(!t.parentElement){e=false}}));if(e){vr.push(t)}}}handleAppVisibilityChanged(){return bn(this,void 0,void 0,(function*(){this.isInBackground=document.visibilityState==="hidden";if(!this.isInBackground&&this.kind===br.Kind.Video){setTimeout((()=>this.attachedElements.forEach((t=>t.play().catch((()=>{}))))),0)}}))}addAppVisibilityListener(){if(Hr()){this.isInBackground=document.visibilityState==="hidden";document.addEventListener("visibilitychange",this.appVisibilityChangedListener)}else{this.isInBackground=false}}removeAppVisibilityListener(){if(Hr()){document.removeEventListener("visibilitychange",this.appVisibilityChangedListener)}}}function gr(t,e){let i;if(e.srcObject instanceof MediaStream){i=e.srcObject}else{i=new MediaStream}let n;if(t.kind==="audio"){n=i.getAudioTracks()}else{n=i.getVideoTracks()}if(!n.includes(t)){n.forEach((t=>{i.removeTrack(t)}));i.addTrack(t)}if(!Br()||!(e instanceof HTMLVideoElement)){e.autoplay=true}e.muted=i.getAudioTracks().length===0;if(e instanceof HTMLVideoElement){e.playsInline=true}if(e.srcObject!==i){e.srcObject=i;if((Br()||qr())&&e instanceof HTMLVideoElement){setTimeout((()=>{e.srcObject=i;e.play().catch((()=>{}))}),0)}}}function yr(t,e){if(e.srcObject instanceof MediaStream){const i=e.srcObject;i.removeTrack(t);if(i.getTracks().length>0){e.srcObject=i}else{e.srcObject=null}}}(function(t){let e;(function(t){t["Audio"]="audio";t["Video"]="video";t["Unknown"]="unknown"})(e=t.Kind||(t.Kind={}));let i;(function(t){t["Camera"]="camera";t["Microphone"]="microphone";t["ScreenShare"]="screen_share";t["ScreenShareAudio"]="screen_share_audio";t["Unknown"]="unknown"})(i=t.Source||(t.Source={}));let n;(function(t){t["Active"]="active";t["Paused"]="paused";t["Unknown"]="unknown"})(n=t.StreamState||(t.StreamState={}));function s(t){switch(t){case e.Audio:return fe.AUDIO;case e.Video:return fe.VIDEO;default:return fe.DATA}}t.kindToProto=s;function r(t){switch(t){case fe.AUDIO:return e.Audio;case fe.VIDEO:return e.Video;default:return e.Unknown}}t.kindFromProto=r;function o(t){switch(t){case i.Camera:return me.CAMERA;case i.Microphone:return me.MICROPHONE;case i.ScreenShare:return me.SCREEN_SHARE;case i.ScreenShareAudio:return me.SCREEN_SHARE_AUDIO;default:return me.UNKNOWN}}t.sourceToProto=o;function a(t){switch(t){case me.CAMERA:return i.Camera;case me.MICROPHONE:return i.Microphone;case me.SCREEN_SHARE:return i.ScreenShare;case me.SCREEN_SHARE_AUDIO:return i.ScreenShareAudio;default:return i.Unknown}}t.sourceFromProto=a;function c(t){switch(t){case ci.ACTIVE:return n.Active;case ci.PAUSED:return n.Paused;default:return n.Unknown}}t.streamStateFromProto=c})(br||(br={}));class kr{constructor(t,e,i,n,s){if(typeof t==="object"){this.width=t.width;this.height=t.height;this.aspectRatio=t.aspectRatio;this.encoding={maxBitrate:t.maxBitrate,maxFramerate:t.maxFramerate,priority:t.priority}}else if(e!==undefined&&i!==undefined){this.width=t;this.height=e;this.aspectRatio=t/e;this.encoding={maxBitrate:i,maxFramerate:n,priority:s}}else{throw new TypeError("Unsupported options: provide at least width, height and maxBitrate")}}get resolution(){return{width:this.width,height:this.height,frameRate:this.encoding.maxFramerate,aspectRatio:this.aspectRatio}}}const wr=["vp8","h264"];const Tr=["vp8","h264","vp9","av1"];function Sr(t){return!!wr.find((e=>e===t))}var Or;(function(t){t[t["PREFER_REGRESSION"]=0]="PREFER_REGRESSION";t[t["SIMULCAST"]=1]="SIMULCAST";t[t["REGRESSION"]=2]="REGRESSION"})(Or||(Or={}));var Er;(function(t){t.telephone={maxBitrate:12e3};t.speech={maxBitrate:24e3};t.music={maxBitrate:48e3};t.musicStereo={maxBitrate:64e3};t.musicHighQuality={maxBitrate:96e3};t.musicHighQualityStereo={maxBitrate:128e3}})(Er||(Er={}));const Cr={h90:new kr(160,90,9e4,20),h180:new kr(320,180,16e4,20),h216:new kr(384,216,18e4,20),h360:new kr(640,360,45e4,20),h540:new kr(960,540,8e5,25),h720:new kr(1280,720,17e5,30),h1080:new kr(1920,1080,3e6,30),h1440:new kr(2560,1440,5e6,30),h2160:new kr(3840,2160,8e6,30)};const jr={h120:new kr(160,120,7e4,20),h180:new kr(240,180,125e3,20),h240:new kr(320,240,14e4,20),h360:new kr(480,360,33e4,20),h480:new kr(640,480,5e5,20),h540:new kr(720,540,6e5,25),h720:new kr(960,720,13e5,30),h1080:new kr(1440,1080,23e5,30),h1440:new kr(1920,1440,38e5,30)};const Rr={h360fps3:new kr(640,360,2e5,3,"medium"),h360fps15:new kr(640,360,4e5,15,"medium"),h720fps5:new kr(1280,720,8e5,5,"medium"),h720fps15:new kr(1280,720,15e5,15,"medium"),h720fps30:new kr(1280,720,2e6,30,"medium"),h1080fps15:new kr(1920,1080,25e5,15,"medium"),h1080fps30:new kr(1920,1080,5e6,30,"medium"),original:new kr(0,0,7e6,30,"medium")};const Ir="|";const _r="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension";function Pr(t){const e=t.split(Ir);if(e.length>1){return[e[0],t.substr(e[0].length+1)]}return[t,""]}function Nr(t){return bn(this,void 0,void 0,(function*(){return new Promise((e=>fr.setTimeout(e,t)))}))}function Dr(){return"addTransceiver"in RTCPeerConnection.prototype}function Ar(){return"addTrack"in RTCPeerConnection.prototype}function xr(){if(!("getCapabilities"in RTCRtpSender)){return false}if(Br()){return false}const t=RTCRtpSender.getCapabilities("video");let e=false;if(t){for(const i of t.codecs){if(i.mimeType==="video/AV1"){e=true;break}}}return e}function Mr(){if(!("getCapabilities"in RTCRtpSender)){return false}if(qr()){return false}if(Br()){const t=or();if((t===null||t===void 0?void 0:t.version)&&Zr(t.version,"16")<0){return false}}const t=RTCRtpSender.getCapabilities("video");let e=false;if(t){for(const i of t.codecs){if(i.mimeType==="video/VP9"){e=true;break}}}return e}function Ur(t){return t==="av1"||t==="vp9"}function Lr(t){if(!document){return false}if(!t){t=document.createElement("audio")}return"setSinkId"in t}function Fr(){if(typeof RTCPeerConnection==="undefined"){return false}return Dr()||Ar()}function qr(){var t;return((t=or())===null||t===void 0?void 0:t.name)==="Firefox"}function Br(){var t;return((t=or())===null||t===void 0?void 0:t.name)==="Safari"}function Vr(){const t=or();return(t===null||t===void 0?void 0:t.name)==="Safari"&&t.version.startsWith("17.")}function Jr(){var t,e;if(!Hr())return false;return(e=(t=navigator.userAgentData)===null||t===void 0?void 0:t.mobile)!==null&&e!==void 0?e:/Tablet|iPad|Mobile|Android|BlackBerry/.test(navigator.userAgent)}function Gr(){const t=or();const e="17.2";if(t){if(t.name!=="Safari"&&t.os!=="iOS"){return true}else if(t.os==="iOS"&&t.osVersion&&Zr(e,t.osVersion)>=0){return true}else if(t.name==="Safari"&&Zr(e,t.version)>=0){return true}else{return false}}}function Hr(){return typeof document!=="undefined"}function zr(){return navigator.product=="ReactNative"}function Wr(t){return t.hostname.endsWith(".livekit.cloud")||t.hostname.endsWith(".livekit.run")}function Kr(){if(global&&global.LiveKitReactNativeGlobal){return global.LiveKitReactNativeGlobal}return undefined}function Qr(){if(!zr()){return undefined}let t=Kr();if(t){return t.platform}return undefined}function Yr(){if(Hr()){return window.devicePixelRatio}if(zr()){let t=Kr();if(t){return t.devicePixelRatio}}return 1}function Zr(t,e){const i=t.split(".");const n=e.split(".");const s=Math.min(i.length,n.length);for(let t=0;t<s;++t){const e=parseInt(i[t],10);const r=parseInt(n[t],10);if(e>r)return 1;if(e<r)return-1;if(t===s-1&&e===r)return 0}if(t===""&&e!==""){return-1}else if(e===""){return 1}return i.length==n.length?0:i.length<n.length?-1:1}function $r(t){for(const e of t){e.target.handleResize(e)}}function Xr(t){for(const e of t){e.target.handleVisibilityChanged(e)}}let to=null;const eo=()=>{if(!to)to=new ResizeObserver($r);return to};let io=null;const no=()=>{if(!io){io=new IntersectionObserver(Xr,{root:null,rootMargin:"0px"})}return io};function so(){var t;const e=new Qe({sdk:Ye.JS,protocol:lr,version:hr});if(zr()){e.os=(t=Qr())!==null&&t!==void 0?t:""}return e}function ro(){let t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:16;let e=arguments.length>1&&arguments[1]!==undefined?arguments[1]:16;let i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;let n=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;const s=document.createElement("canvas");s.width=t;s.height=e;const r=s.getContext("2d");r===null||r===void 0?void 0:r.fillRect(0,0,s.width,s.height);if(n&&r){r.beginPath();r.arc(t/2,e/2,50,0,Math.PI*2,true);r.closePath();r.fillStyle="grey";r.fill()}const o=s.captureStream();const[a]=o.getTracks();if(!a){throw Error("Could not get empty media stream video track")}a.enabled=i;return a}let oo;function ao(){if(!oo){const t=new AudioContext;const e=t.createOscillator();const i=t.createGain();i.gain.setValueAtTime(0,0);const n=t.createMediaStreamDestination();e.connect(i);i.connect(n);e.start();[oo]=n.stream.getAudioTracks();if(!oo){throw Error("Could not get empty media stream audio track")}oo.enabled=false}return oo.clone()}class co{constructor(t,e){this.onFinally=e;this.promise=new Promise(((e,i)=>bn(this,void 0,void 0,(function*(){this.resolve=e;this.reject=i;if(t){yield t(e,i)}})))).finally((()=>{var t;return(t=this.onFinally)===null||t===void 0?void 0:t.call(this)}))}}function uo(t){return Tr.includes(t)}function ho(t){if(typeof t==="string"||typeof t==="number"){return t}if(Array.isArray(t)){return t[0]}if(t.exact){if(Array.isArray(t.exact)){return t.exact[0]}return t.exact}if(t.ideal){if(Array.isArray(t.ideal)){return t.ideal[0]}return t.ideal}throw Error("could not unwrap constraint")}function lo(t){if(t.startsWith("http")){return t.replace(/^(http)/,"ws")}return t}function fo(t){if(t.startsWith("ws")){return t.replace(/^(ws)/,"http")}return t}function mo(t,e){return t.segments.map((t=>{let{id:i,text:n,language:s,startTime:r,endTime:o,final:a}=t;var c;const u=(c=e.get(i))!==null&&c!==void 0?c:Date.now();const d=Date.now();if(a){e.delete(i)}else{e.set(i,u)}return{id:i,text:n,startTime:Number.parseInt(r.toString()),endTime:Number.parseInt(o.toString()),final:a,language:s,firstReceivedTime:u,lastReceivedTime:d}}))}function vo(t){const{id:e,timestamp:i,message:n,editTimestamp:s}=t;return{id:e,timestamp:Number.parseInt(i.toString()),editTimestamp:s?Number.parseInt(s.toString()):undefined,message:n}}function po(t){switch(t.reason){case Vs.LeaveRequest:return t.context;case Vs.Cancelled:return ge.CLIENT_INITIATED;case Vs.NotAllowed:return ge.USER_REJECTED;case Vs.ServerUnreachable:return ge.JOIN_FAILURE;default:return ge.UNKNOWN_REASON}}function bo(t){return t!==undefined?Number(t):undefined}function go(t){return t!==undefined?BigInt(t):undefined}function yo(t){return!!t&&!(t instanceof MediaStreamTrack)&&t.isLocal}function ko(t){return!!t&&t.kind==br.Kind.Audio}function wo(t){return!!t&&t.kind==br.Kind.Video}function To(t){return yo(t)&&wo(t)}function So(t){return yo(t)&&ko(t)}function Oo(t){return!!t&&!t.isLocal}function Eo(t){return!!t&&!t.isLocal}function Co(t){return Oo(t)&&wo(t)}function jo(t){return t.isLocal}function Ro(t,e){const i=[];let n=(new TextEncoder).encode(t);while(n.length>e){let t=e;while(t>0){const e=n[t];if(e!==undefined&&(e&192)!==128){break}t--}i.push(n.slice(0,t));n=n.slice(t)}if(n.length>0){i.push(n)}return i}function Io(t,e,i){var n,s;var r,o;const{optionsWithoutProcessor:a,audioProcessor:c,videoProcessor:u}=Vo(t!==null&&t!==void 0?t:{});const d=e===null||e===void 0?void 0:e.processor;const h=i===null||i===void 0?void 0:i.processor;const l=a!==null&&a!==void 0?a:{};if(l.audio===true)l.audio={};if(l.video===true)l.video={};if(l.audio){_o(l.audio,e);(n=(r=l.audio).deviceId)!==null&&n!==void 0?n:r.deviceId={ideal:"default"};if(c||d){l.audio.processor=c!==null&&c!==void 0?c:d}}if(l.video){_o(l.video,i);(s=(o=l.video).deviceId)!==null&&s!==void 0?s:o.deviceId={ideal:"default"};if(u||h){l.video.processor=u!==null&&u!==void 0?u:h}}return l}function _o(t,e){Object.keys(e).forEach((i=>{if(t[i]===undefined)t[i]=e[i]}));return t}function Po(t){var e,i;var n,s;const r={};if(t.video){if(typeof t.video==="object"){const i={};const s=i;const o=t.video;Object.keys(o).forEach((t=>{switch(t){case"resolution":_o(s,o.resolution);break;default:s[t]=o[t]}}));r.video=i;(e=(n=r.video).deviceId)!==null&&e!==void 0?e:n.deviceId={ideal:"default"}}else{r.video=t.video?{deviceId:{ideal:"default"}}:false}}else{r.video=false}if(t.audio){if(typeof t.audio==="object"){r.audio=t.audio;(i=(s=r.audio).deviceId)!==null&&i!==void 0?i:s.deviceId={ideal:"default"}}else{r.audio={deviceId:{ideal:"default"}}}}else{r.audio=false}return r}function No(t){return bn(this,arguments,void 0,(function(t){let e=arguments.length>1&&arguments[1]!==undefined?arguments[1]:200;return function*(){const i=Do();if(i){const n=i.createAnalyser();n.fftSize=2048;const s=n.frequencyBinCount;const r=new Uint8Array(s);const o=i.createMediaStreamSource(new MediaStream([t.mediaStreamTrack]));o.connect(n);yield Nr(e);n.getByteTimeDomainData(r);const a=r.some((t=>t!==128&&t!==0));i.close();return!a}return false}()}))}function Do(){var t;const e=typeof window!=="undefined"&&(window.AudioContext||window.webkitAudioContext);if(e){const i=new e({latencyHint:"interactive"});if(i.state==="suspended"&&typeof window!=="undefined"&&((t=window.document)===null||t===void 0?void 0:t.body)){const t=()=>bn(this,void 0,void 0,(function*(){var e;try{if(i.state==="suspended"){yield i.resume()}}catch(t){console.warn("Error trying to auto-resume audio context",t)}(e=window.document.body)===null||e===void 0?void 0:e.removeEventListener("click",t)}));window.document.body.addEventListener("click",t)}return i}}function Ao(t){if(t==="audioinput"){return br.Source.Microphone}else if(t==="videoinput"){return br.Source.Camera}else{return br.Source.Unknown}}function xo(t){if(t===br.Source.Microphone){return"audioinput"}else if(t===br.Source.Camera){return"videoinput"}else{return undefined}}function Mo(t){var e,i;let n=(e=t.video)!==null&&e!==void 0?e:true;if(t.resolution&&t.resolution.width>0&&t.resolution.height>0){n=typeof n==="boolean"?{}:n;if(Br()){n=Object.assign(Object.assign({},n),{width:{max:t.resolution.width},height:{max:t.resolution.height},frameRate:t.resolution.frameRate})}else{n=Object.assign(Object.assign({},n),{width:{ideal:t.resolution.width},height:{ideal:t.resolution.height},frameRate:t.resolution.frameRate})}}return{audio:(i=t.audio)!==null&&i!==void 0?i:false,video:n,controller:t.controller,selfBrowserSurface:t.selfBrowserSurface,surfaceSwitching:t.surfaceSwitching,systemAudio:t.systemAudio,preferCurrentTab:t.preferCurrentTab}}function Uo(t){return t.split("/")[1].toLowerCase()}function Lo(t){const e=[];t.forEach((t=>{if(t.track!==undefined){e.push(new gi({cid:t.track.mediaStreamID,track:t.trackInfo}))}}));return e}function Fo(t){if("mediaStreamTrack"in t){return{trackID:t.sid,source:t.source,muted:t.isMuted,enabled:t.mediaStreamTrack.enabled,kind:t.kind,streamID:t.mediaStreamID,streamTrackID:t.mediaStreamTrack.id}}else{return{trackID:t.trackSid,enabled:t.isEnabled,muted:t.isMuted,trackInfo:Object.assign({mimeType:t.mimeType,name:t.trackName,encrypted:t.isEncrypted,kind:t.kind,source:t.source},t.track?Fo(t.track):{})}}}function qo(){return typeof RTCRtpReceiver!=="undefined"&&"getSynchronizationSources"in RTCRtpReceiver}function Bo(t,e){var i;if(t===undefined){t={}}if(e===undefined){e={}}const n=[...Object.keys(e),...Object.keys(t)];const s={};for(const r of n){if(t[r]!==e[r]){s[r]=(i=e[r])!==null&&i!==void 0?i:""}}return s}function Vo(t){const e=Object.assign({},t);let i;let n;if(typeof e.audio==="object"&&e.audio.processor){i=e.audio.processor;e.audio=Object.assign(Object.assign({},e.audio),{processor:undefined})}if(typeof e.video==="object"&&e.video.processor){n=e.video.processor;e.video=Object.assign(Object.assign({},e.video),{processor:undefined})}return{audioProcessor:i,videoProcessor:n,optionsWithoutProcessor:nr(e)}}function Jo(t){switch(t){case me.CAMERA:return br.Source.Camera;case me.MICROPHONE:return br.Source.Microphone;case me.SCREEN_SHARE:return br.Source.ScreenShare;case me.SCREEN_SHARE_AUDIO:return br.Source.ScreenShareAudio;default:return br.Source.Unknown}}class Go extends Sn.EventEmitter{constructor(t){super();this.onWorkerMessage=t=>{var e,i;const{kind:n,data:s}=t.data;switch(n){case"error":dn.error(s.error.message);this.emit(Ms.EncryptionError,s.error);break;case"initAck":if(s.enabled){this.keyProvider.getKeys().forEach((t=>{this.postKey(t)}))}break;case"enable":if(s.enabled){this.keyProvider.getKeys().forEach((t=>{this.postKey(t)}))}if(this.encryptionEnabled!==s.enabled&&s.participantIdentity===((e=this.room)===null||e===void 0?void 0:e.localParticipant.identity)){this.emit(Ms.ParticipantEncryptionStatusChanged,s.enabled,this.room.localParticipant);this.encryptionEnabled=s.enabled}else if(s.participantIdentity){const t=(i=this.room)===null||i===void 0?void 0:i.getParticipantByIdentity(s.participantIdentity);if(!t){throw TypeError("couldn't set encryption status, participant not found".concat(s.participantIdentity))}this.emit(Ms.ParticipantEncryptionStatusChanged,s.enabled,t)}break;case"ratchetKey":this.keyProvider.emit(As.KeyRatcheted,s.ratchetResult,s.participantIdentity,s.keyIndex);break}};this.onWorkerError=t=>{dn.error("e2ee worker encountered an error:",{error:t.error});this.emit(Ms.EncryptionError,t.error)};this.keyProvider=t.keyProvider;this.worker=t.worker;this.encryptionEnabled=false}setup(t){if(!Ls()){throw new Gs("tried to setup end-to-end encryption on an unsupported browser")}dn.info("setting up e2ee");if(t!==this.room){this.room=t;this.setupEventListeners(t,this.keyProvider);const e={kind:"init",data:{keyProviderOptions:this.keyProvider.getOptions(),loglevel:ln.getLevel()}};if(this.worker){dn.info("initializing worker",{worker:this.worker});this.worker.onmessage=this.onWorkerMessage;this.worker.onerror=this.onWorkerError;this.worker.postMessage(e)}}}setParticipantCryptorEnabled(t,e){dn.debug("set e2ee to ".concat(t," for participant ").concat(e));this.postEnable(t,e)}setSifTrailer(t){if(!t||t.length===0){dn.warn("ignoring server sent trailer as it's empty")}else{this.postSifTrailer(t)}}setupEngine(t){t.on(er.RTPVideoMapUpdate,(t=>{this.postRTPMap(t)}))}setupEventListeners(t,e){t.on(Xs.TrackPublished,((t,e)=>this.setParticipantCryptorEnabled(t.trackInfo.encryption!==Ie.NONE,e.identity)));t.on(Xs.ConnectionStateChanged,(e=>{if(e===Wc.Connected){t.remoteParticipants.forEach((t=>{t.trackPublications.forEach((e=>{this.setParticipantCryptorEnabled(e.trackInfo.encryption!==Ie.NONE,t.identity)}))}))}})).on(Xs.TrackUnsubscribed,((t,e,i)=>{var n;const s={kind:"removeTransform",data:{participantIdentity:i.identity,trackId:t.mediaStreamID}};(n=this.worker)===null||n===void 0?void 0:n.postMessage(s)})).on(Xs.TrackSubscribed,((t,e,i)=>{this.setupE2EEReceiver(t,i.identity,e.trackInfo)})).on(Xs.SignalConnected,(()=>{if(!this.room){throw new TypeError("expected room to be present on signal connect")}e.getKeys().forEach((t=>{this.postKey(t)}));this.setParticipantCryptorEnabled(this.room.localParticipant.isE2EEEnabled,this.room.localParticipant.identity)}));t.localParticipant.on(tr.LocalTrackPublished,(t=>bn(this,void 0,void 0,(function*(){this.setupE2EESender(t.track,t.track.sender)}))));e.on(As.SetKey,(t=>this.postKey(t))).on(As.RatchetRequest,((t,e)=>this.postRatchetRequest(t,e)))}postRatchetRequest(t,e){if(!this.worker){throw Error("could not ratchet key, worker is missing")}const i={kind:"ratchetRequest",data:{participantIdentity:t,keyIndex:e}};this.worker.postMessage(i)}postKey(t){let{key:e,participantIdentity:i,keyIndex:n}=t;var s;if(!this.worker){throw Error("could not set key, worker is missing")}const r={kind:"setKey",data:{participantIdentity:i,isPublisher:i===((s=this.room)===null||s===void 0?void 0:s.localParticipant.identity),key:e,keyIndex:n}};this.worker.postMessage(r)}postEnable(t,e){if(this.worker){const i={kind:"enable",data:{enabled:t,participantIdentity:e}};this.worker.postMessage(i)}else{throw new ReferenceError("failed to enable e2ee, worker is not ready")}}postRTPMap(t){var e;if(!this.worker){throw TypeError("could not post rtp map, worker is missing")}if(!((e=this.room)===null||e===void 0?void 0:e.localParticipant.identity)){throw TypeError("could not post rtp map, local participant identity is missing")}const i={kind:"setRTPMap",data:{map:t,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(i)}postSifTrailer(t){if(!this.worker){throw Error("could not post SIF trailer, worker is missing")}const e={kind:"setSifTrailer",data:{trailer:t}};this.worker.postMessage(e)}setupE2EEReceiver(t,e,i){if(!t.receiver){return}if(!(i===null||i===void 0?void 0:i.mimeType)||i.mimeType===""){throw new TypeError("MimeType missing from trackInfo, cannot set up E2EE cryptor")}this.handleReceiver(t.receiver,t.mediaStreamID,e,t.kind==="video"?Uo(i.mimeType):undefined)}setupE2EESender(t,e){if(!yo(t)||!e){if(!e)dn.warn("early return because sender is not ready");return}this.handleSender(e,t.mediaStreamID,undefined)}handleReceiver(t,e,i,n){return bn(this,void 0,void 0,(function*(){if(!this.worker){return}if(Fs()){const s={kind:"decode",participantIdentity:i,trackId:e,codec:n};t.transform=new RTCRtpScriptTransform(this.worker,s)}else{if(Ds in t&&n){const t={kind:"updateCodec",data:{trackId:e,codec:n,participantIdentity:i}};this.worker.postMessage(t);return}let s=t.writableStream;let r=t.readableStream;if(!s||!r){const e=t.createEncodedStreams();t.writableStream=e.writable;s=e.writable;t.readableStream=e.readable;r=e.readable}const o={kind:"decode",data:{readableStream:r,writableStream:s,trackId:e,codec:n,participantIdentity:i}};this.worker.postMessage(o,[r,s])}t[Ds]=true}))}handleSender(t,e,i){var n;if(Ds in t||!this.worker){return}if(!((n=this.room)===null||n===void 0?void 0:n.localParticipant.identity)||this.room.localParticipant.identity===""){throw TypeError("local identity needs to be known in order to set up encrypted sender")}if(Fs()){dn.info("initialize script transform");const n={kind:"encode",participantIdentity:this.room.localParticipant.identity,trackId:e,codec:i};t.transform=new RTCRtpScriptTransform(this.worker,n)}else{dn.info("initialize encoded streams");const n=t.createEncodedStreams();const s={kind:"encode",data:{readableStream:n.readable,writableStream:n.writable,codec:i,trackId:e,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(s,[n.readable,n.writable])}t[Ds]=true}}const Ho="default";class zo{constructor(){this._previousDevices=[]}static getInstance(){if(this.instance===undefined){this.instance=new zo}return this.instance}get previousDevices(){return this._previousDevices}getDevices(t){return bn(this,arguments,void 0,(function(t){var e=this;let i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;return function*(){var n;if(((n=zo.userMediaPromiseMap)===null||n===void 0?void 0:n.size)>0){dn.debug("awaiting getUserMedia promise");try{if(t){yield zo.userMediaPromiseMap.get(t)}else{yield Promise.all(zo.userMediaPromiseMap.values())}}catch(t){dn.warn("error waiting for media permissons")}}let s=yield navigator.mediaDevices.enumerateDevices();if(i&&!(Br()&&e.hasDeviceInUse(t))){const e=s.filter((e=>e.kind===t)).length===0||s.some((e=>{const i=e.label==="";const n=t?e.kind===t:true;return i&&n}));if(e){const e={video:t!=="audioinput"&&t!=="audiooutput",audio:t!=="videoinput"&&{deviceId:{ideal:"default"}}};const i=yield navigator.mediaDevices.getUserMedia(e);s=yield navigator.mediaDevices.enumerateDevices();i.getTracks().forEach((t=>{t.stop()}))}}e._previousDevices=s;if(t){s=s.filter((e=>e.kind===t))}return s}()}))}normalizeDeviceId(t,e,i){return bn(this,void 0,void 0,(function*(){if(e!==Ho){return e}const n=yield this.getDevices(t);const s=n.find((t=>t.deviceId===Ho));if(!s){dn.warn("could not reliably determine default device");return undefined}const r=n.find((t=>t.deviceId!==Ho&&t.groupId===(i!==null&&i!==void 0?i:s.groupId)));if(!r){dn.warn("could not reliably determine default device");return undefined}return r===null||r===void 0?void 0:r.deviceId}))}hasDeviceInUse(t){return t?zo.userMediaPromiseMap.has(t):zo.userMediaPromiseMap.size>0}}zo.mediaDeviceKinds=["audioinput","audiooutput","videoinput"];zo.userMediaPromiseMap=new Map;var Wo;(function(t){t[t["WAITING"]=0]="WAITING";t[t["RUNNING"]=1]="RUNNING";t[t["COMPLETED"]=2]="COMPLETED"})(Wo||(Wo={}));class Ko{constructor(){this.pendingTasks=new Map;this.taskMutex=new d;this.nextTaskIndex=0}run(t){return bn(this,void 0,void 0,(function*(){const e={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:Wo.WAITING};this.pendingTasks.set(e.id,e);const i=yield this.taskMutex.lock();try{e.executedAt=Date.now();e.status=Wo.RUNNING;return yield t()}finally{e.status=Wo.COMPLETED;this.pendingTasks.delete(e.id);i()}}))}flush(){return bn(this,void 0,void 0,(function*(){return this.run((()=>bn(this,void 0,void 0,(function*(){}))))}))}snapshot(){return Array.from(this.pendingTasks.values())}}function Qo(t,e){const i=new URL(lo(t));e.forEach(((t,e)=>{i.searchParams.set(e,t)}));return $o(i,"rtc")}function Yo(t){const e=new URL(fo(t));return $o(e,"validate")}function Zo(t){return t.endsWith("/")?t:"".concat(t,"/")}function $o(t,e){t.pathname="".concat(Zo(t.pathname)).concat(e);return t.toString()}const Xo=["syncState","trickle","offer","answer","simulate","leave"];function ta(t){const e=Xo.indexOf(t.case)>=0;dn.trace("request allowed to bypass queue:",{canPass:e,req:t});return e}var ea;(function(t){t[t["CONNECTING"]=0]="CONNECTING";t[t["CONNECTED"]=1]="CONNECTED";t[t["RECONNECTING"]=2]="RECONNECTING";t[t["DISCONNECTING"]=3]="DISCONNECTING";t[t["DISCONNECTED"]=4]="DISCONNECTED"})(ea||(ea={}));class ia{get currentState(){return this.state}get isDisconnected(){return this.state===ea.DISCONNECTING||this.state===ea.DISCONNECTED}get isEstablishingConnection(){return this.state===ea.CONNECTING||this.state===ea.RECONNECTING}getNextRequestId(){this._requestId+=1;return this._requestId}constructor(){let t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;let e=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var i;this.rtt=0;this.state=ea.DISCONNECTED;this.log=dn;this._requestId=0;this.resetCallbacks=()=>{this.onAnswer=undefined;this.onLeave=undefined;this.onLocalTrackPublished=undefined;this.onLocalTrackUnpublished=undefined;this.onNegotiateRequested=undefined;this.onOffer=undefined;this.onRemoteMuteChanged=undefined;this.onSubscribedQualityUpdate=undefined;this.onTokenRefresh=undefined;this.onTrickle=undefined;this.onClose=undefined};this.log=hn((i=e.loggerName)!==null&&i!==void 0?i:un.Signal);this.loggerContextCb=e.loggerContextCb;this.useJSON=t;this.requestQueue=new Ko;this.queuedRequests=[];this.closingLock=new d;this.connectionLock=new d;this.state=ea.DISCONNECTED}get logContext(){var t,e;return(e=(t=this.loggerContextCb)===null||t===void 0?void 0:t.call(this))!==null&&e!==void 0?e:{}}join(t,e,i,n){return bn(this,void 0,void 0,(function*(){this.state=ea.CONNECTING;this.options=i;const s=yield this.connect(t,e,i,n);return s}))}reconnect(t,e,i,n){return bn(this,void 0,void 0,(function*(){if(!this.options){this.log.warn("attempted to reconnect without signal options being set, ignoring",this.logContext);return}this.state=ea.RECONNECTING;this.clearPingInterval();const s=yield this.connect(t,e,Object.assign(Object.assign({},this.options),{reconnect:true,sid:i,reconnectReason:n}));return s}))}connect(t,e,i,n){this.connectOptions=i;const s=so();const r=ra(e,s,i);const o=Qo(t,r);const a=Yo(o);return new Promise(((t,e)=>bn(this,void 0,void 0,(function*(){const s=yield this.connectionLock.lock();try{const s=()=>bn(this,void 0,void 0,(function*(){this.close();clearTimeout(r);e(new Js("room connection has been cancelled (signal)",Vs.Cancelled))}));const r=setTimeout((()=>{this.close();e(new Js("room connection has timed out (signal)",Vs.ServerUnreachable))}),i.websocketTimeout);if(n===null||n===void 0?void 0:n.aborted){s()}n===null||n===void 0?void 0:n.addEventListener("abort",s);const c=new URL(o);if(c.searchParams.has("access_token")){c.searchParams.set("access_token","<redacted>")}this.log.debug("connecting to ".concat(c),Object.assign({reconnect:i.reconnect,reconnectReason:i.reconnectReason},this.logContext));if(this.ws){yield this.close(false)}this.ws=new WebSocket(o);this.ws.binaryType="arraybuffer";this.ws.onopen=()=>{clearTimeout(r)};this.ws.onerror=t=>bn(this,void 0,void 0,(function*(){if(this.state!==ea.CONNECTED){this.state=ea.DISCONNECTED;clearTimeout(r);try{const i=yield fetch(a);if(i.status.toFixed(0).startsWith("4")){const t=yield i.text();e(new Js(t,Vs.NotAllowed,i.status))}else{e(new Js("Encountered unknown websocket error during connection: ".concat(t.toString()),Vs.InternalError,i.status))}}catch(t){e(new Js(t instanceof Error?t.message:"server was not reachable",Vs.ServerUnreachable))}return}this.handleWSError(t)}));this.ws.onmessage=r=>bn(this,void 0,void 0,(function*(){var o,a,c;let u;if(typeof r.data==="string"){const t=JSON.parse(r.data);u=hi.fromJson(t,{ignoreUnknownFields:true})}else if(r.data instanceof ArrayBuffer){u=hi.fromBinary(new Uint8Array(r.data))}else{this.log.error("could not decode websocket message: ".concat(typeof r.data),this.logContext);return}if(this.state!==ea.CONNECTED){let r=false;if(((o=u.message)===null||o===void 0?void 0:o.case)==="join"){this.state=ea.CONNECTED;n===null||n===void 0?void 0:n.removeEventListener("abort",s);this.pingTimeoutDuration=u.message.value.pingTimeout;this.pingIntervalDuration=u.message.value.pingInterval;if(this.pingTimeoutDuration&&this.pingTimeoutDuration>0){this.log.debug("ping config",Object.assign(Object.assign({},this.logContext),{timeout:this.pingTimeoutDuration,interval:this.pingIntervalDuration}));this.startPingInterval()}t(u.message.value)}else if(this.state===ea.RECONNECTING&&u.message.case!=="leave"){this.state=ea.CONNECTED;n===null||n===void 0?void 0:n.removeEventListener("abort",s);this.startPingInterval();if(((a=u.message)===null||a===void 0?void 0:a.case)==="reconnect"){t(u.message.value)}else{this.log.debug("declaring signal reconnected without reconnect response received",this.logContext);t(undefined);r=true}}else if(this.isEstablishingConnection&&u.message.case==="leave"){e(new Js("Received leave request while trying to (re)connect",Vs.LeaveRequest,undefined,u.message.value.reason))}else if(!i.reconnect){e(new Js("did not receive join response, got ".concat((c=u.message)===null||c===void 0?void 0:c.case," instead"),Vs.InternalError))}if(!r){return}}if(this.signalLatency){yield Nr(this.signalLatency)}this.handleSignalResponse(u)}));this.ws.onclose=t=>{if(this.isEstablishingConnection){e(new Js("Websocket got closed during a (re)connection attempt",Vs.InternalError))}this.log.warn("websocket closed",Object.assign(Object.assign({},this.logContext),{reason:t.reason,code:t.code,wasClean:t.wasClean,state:this.state}));this.handleOnClose(t.reason)}}finally{s()}}))))}close(){return bn(this,arguments,void 0,(function(){var t=this;let e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;return function*(){const i=yield t.closingLock.lock();try{t.clearPingInterval();if(e){t.state=ea.DISCONNECTING}if(t.ws){t.ws.onmessage=null;t.ws.onopen=null;t.ws.onclose=null;const e=new Promise((e=>{if(t.ws){t.ws.onclose=()=>{e()}}else{e()}}));if(t.ws.readyState<t.ws.CLOSING){t.ws.close();yield Promise.race([e,Nr(250)])}t.ws=undefined}}finally{if(e){t.state=ea.DISCONNECTED}i()}}()}))}sendOffer(t){this.log.debug("sending offer",Object.assign(Object.assign({},this.logContext),{offerSdp:t.sdp}));this.sendRequest({case:"offer",value:sa(t)})}sendAnswer(t){this.log.debug("sending answer",Object.assign(Object.assign({},this.logContext),{answerSdp:t.sdp}));return this.sendRequest({case:"answer",value:sa(t)})}sendIceCandidate(t,e){this.log.debug("sending ice candidate",Object.assign(Object.assign({},this.logContext),{candidate:t}));return this.sendRequest({case:"trickle",value:new mi({candidateInit:JSON.stringify(t),target:e})})}sendMuteTrack(t,e){return this.sendRequest({case:"mute",value:new vi({sid:t,muted:e})})}sendAddTrack(t){return this.sendRequest({case:"addTrack",value:t})}sendUpdateLocalMetadata(t,e){return bn(this,arguments,void 0,(function(t,e){var i=this;let n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};return function*(){const s=i.getNextRequestId();yield i.sendRequest({case:"updateMetadata",value:new Ii({requestId:s,metadata:t,name:e,attributes:n})});return s}()}))}sendUpdateTrackSettings(t){this.sendRequest({case:"trackSetting",value:t})}sendUpdateSubscription(t){return this.sendRequest({case:"subscription",value:t})}sendSyncState(t){return this.sendRequest({case:"syncState",value:t})}sendUpdateVideoLayers(t,e){return this.sendRequest({case:"updateLayers",value:new Ri({trackSid:t,layers:e})})}sendUpdateSubscriptionPermissions(t,e){return this.sendRequest({case:"subscriptionPermission",value:new Bi({allParticipants:t,trackPermissions:e})})}sendSimulateScenario(t){return this.sendRequest({case:"simulate",value:t})}sendPing(){return Promise.all([this.sendRequest({case:"ping",value:B.parse(Date.now())}),this.sendRequest({case:"pingReq",value:new Wi({timestamp:B.parse(Date.now()),rtt:B.parse(this.rtt)})})])}sendUpdateLocalAudioTrack(t,e){return this.sendRequest({case:"updateAudioTrack",value:new Oi({trackSid:t,features:e})})}sendLeave(){return this.sendRequest({case:"leave",value:new Ci({reason:ge.CLIENT_INITIATED,action:ji.DISCONNECT})})}sendRequest(t){return bn(this,arguments,void 0,(function(t){var e=this;let i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;return function*(){const n=!i&&!ta(t);if(n&&e.state===ea.RECONNECTING){e.queuedRequests.push((()=>bn(e,void 0,void 0,(function*(){yield this.sendRequest(t,true)}))));return}if(!i){yield e.requestQueue.flush()}if(e.signalLatency){yield Nr(e.signalLatency)}if(!e.ws||e.ws.readyState!==e.ws.OPEN){e.log.error("cannot send signal request before connected, type: ".concat(t===null||t===void 0?void 0:t.case),e.logContext);return}const s=new di({message:t});try{if(e.useJSON){e.ws.send(s.toJsonString())}else{e.ws.send(s.toBinary())}}catch(t){e.log.error("error sending signal message",Object.assign(Object.assign({},e.logContext),{error:t}))}}()}))}handleSignalResponse(t){var e,i;const n=t.message;if(n==undefined){this.log.debug("received unsupported message",this.logContext);return}let s=false;if(n.case==="answer"){const t=na(n.value);if(this.onAnswer){this.onAnswer(t)}}else if(n.case==="offer"){const t=na(n.value);if(this.onOffer){this.onOffer(t)}}else if(n.case==="trickle"){const t=JSON.parse(n.value.candidateInit);if(this.onTrickle){this.onTrickle(t,n.value.target)}}else if(n.case==="update"){if(this.onParticipantUpdate){this.onParticipantUpdate((e=n.value.participants)!==null&&e!==void 0?e:[])}}else if(n.case==="trackPublished"){if(this.onLocalTrackPublished){this.onLocalTrackPublished(n.value)}}else if(n.case==="speakersChanged"){if(this.onSpeakersChanged){this.onSpeakersChanged((i=n.value.speakers)!==null&&i!==void 0?i:[])}}else if(n.case==="leave"){if(this.onLeave){this.onLeave(n.value)}}else if(n.case==="mute"){if(this.onRemoteMuteChanged){this.onRemoteMuteChanged(n.value.sid,n.value.muted)}}else if(n.case==="roomUpdate"){if(this.onRoomUpdate&&n.value.room){this.onRoomUpdate(n.value.room)}}else if(n.case==="connectionQuality"){if(this.onConnectionQuality){this.onConnectionQuality(n.value)}}else if(n.case==="streamStateUpdate"){if(this.onStreamStateUpdate){this.onStreamStateUpdate(n.value)}}else if(n.case==="subscribedQualityUpdate"){if(this.onSubscribedQualityUpdate){this.onSubscribedQualityUpdate(n.value)}}else if(n.case==="subscriptionPermissionUpdate"){if(this.onSubscriptionPermissionUpdate){this.onSubscriptionPermissionUpdate(n.value)}}else if(n.case==="refreshToken"){if(this.onTokenRefresh){this.onTokenRefresh(n.value)}}else if(n.case==="trackUnpublished"){if(this.onLocalTrackUnpublished){this.onLocalTrackUnpublished(n.value)}}else if(n.case==="subscriptionResponse"){if(this.onSubscriptionError){this.onSubscriptionError(n.value)}}else if(n.case==="pong");else if(n.case==="pongResp"){this.rtt=Date.now()-Number.parseInt(n.value.lastPingTimestamp.toString());this.resetPingTimeout();s=true}else if(n.case==="requestResponse"){if(this.onRequestResponse){this.onRequestResponse(n.value)}}else if(n.case==="trackSubscribed"){if(this.onLocalTrackSubscribed){this.onLocalTrackSubscribed(n.value.trackSid)}}else if(n.case==="roomMoved"){if(this.onTokenRefresh){this.onTokenRefresh(n.value.token)}if(this.onRoomMoved){this.onRoomMoved(n.value)}}else{this.log.debug("unsupported message",Object.assign(Object.assign({},this.logContext),{msgCase:n.case}))}if(!s){this.resetPingTimeout()}}setReconnected(){while(this.queuedRequests.length>0){const t=this.queuedRequests.shift();if(t){this.requestQueue.run(t)}}}handleOnClose(t){return bn(this,void 0,void 0,(function*(){if(this.state===ea.DISCONNECTED)return;const e=this.onClose;yield this.close();this.log.debug("websocket connection closed: ".concat(t),Object.assign(Object.assign({},this.logContext),{reason:t}));if(e){e(t)}}))}handleWSError(t){this.log.error("websocket error",Object.assign(Object.assign({},this.logContext),{error:t}))}resetPingTimeout(){this.clearPingTimeout();if(!this.pingTimeoutDuration){this.log.warn("ping timeout duration not set",this.logContext);return}this.pingTimeout=fr.setTimeout((()=>{this.log.warn("ping timeout triggered. last pong received at: ".concat(new Date(Date.now()-this.pingTimeoutDuration*1e3).toUTCString()),this.logContext);this.handleOnClose("ping timeout")}),this.pingTimeoutDuration*1e3)}clearPingTimeout(){if(this.pingTimeout){fr.clearTimeout(this.pingTimeout)}}startPingInterval(){this.clearPingInterval();this.resetPingTimeout();if(!this.pingIntervalDuration){this.log.warn("ping interval duration not set",this.logContext);return}this.log.debug("start ping interval",this.logContext);this.pingInterval=fr.setInterval((()=>{this.sendPing()}),this.pingIntervalDuration*1e3)}clearPingInterval(){this.log.debug("clearing ping interval",this.logContext);this.clearPingTimeout();if(this.pingInterval){fr.clearInterval(this.pingInterval)}}}function na(t){const e={type:"offer",sdp:t.sdp};switch(t.type){case"answer":case"offer":case"pranswer":case"rollback":e.type=t.type;break}return e}function sa(t){const e=new ki({sdp:t.sdp,type:t.type});return e}function ra(t,e,i){var n;const s=new URLSearchParams;s.set("access_token",t);if(i.reconnect){s.set("reconnect","1");if(i.sid){s.set("sid",i.sid)}}s.set("auto_subscribe",i.autoSubscribe?"1":"0");s.set("sdk",zr()?"reactnative":"js");s.set("version",e.version);s.set("protocol",e.protocol.toString());if(e.deviceModel){s.set("device_model",e.deviceModel)}if(e.os){s.set("os",e.os)}if(e.osVersion){s.set("os_version",e.osVersion)}if(e.browser){s.set("browser",e.browser)}if(e.browserVersion){s.set("browser_version",e.browserVersion)}if(i.adaptiveStream){s.set("adaptive_stream","1")}if(i.reconnectReason){s.set("reconnect_reason",i.reconnectReason.toString())}if((n=navigator.connection)===null||n===void 0?void 0:n.type){s.set("network",navigator.connection.type)}return s}var oa={};var aa={};var ca={exports:{}};var ua;function da(){if(ua)return ca.exports;ua=1;var t=ca.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(t){return t.encoding?"rtpmap:%d %s/%s/%s":t.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(t){return t.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(t){return t.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(t){return"extmap:%d"+(t.direction?"/%s":"%v")+(t["encrypt-uri"]?" %s":"%v")+" %s"+(t.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(t){return t.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(t){var e="candidate:%s %d %s %d %s %d typ %s";e+=t.raddr!=null?" raddr %s rport %d":"%v%v";e+=t.tcptype!=null?" tcptype %s":"%v";if(t.generation!=null){e+=" generation %d"}e+=t["network-id"]!=null?" network-id %d":"%v";e+=t["network-cost"]!=null?" network-cost %d":"%v";return e}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(t){var e="ssrc:%d";if(t.attribute!=null){e+=" %s";if(t.value!=null){e+=":%s"}}return e}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(t){return t.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(t){return t.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)"+"[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)"+"(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(t){return"imageattr:%s %s %s"+(t.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:"+"(send|recv) ([a-zA-Z0-9\\-_~;,]+)"+"(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?"+"$"),names:["dir1","list1","dir2","list2"],format:function(t){return"simulcast:%s %s"+(t.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(t){return"ts-refclk:%s"+(t.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(t){var e="mediaclk:";e+=t.id!=null?"id=%s %s":"%v%s";e+=t.mediaClockValue!=null?"=%s":"";e+=t.rateNumerator!=null?" rate=%s":"";e+=t.rateDenominator!=null?"/%s":"";return e}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(t).forEach((function(e){var i=t[e];i.forEach((function(t){if(!t.reg){t.reg=/(.*)/}if(!t.format){t.format="%s"}}))}));return ca.exports}var ha;function la(){if(ha)return aa;ha=1;(function(t){var e=function(t){return String(Number(t))===t?Number(t):t};var i=function(t,i,n,s){if(s&&!n){i[s]=e(t[1])}else{for(var r=0;r<n.length;r+=1){if(t[r+1]!=null){i[n[r]]=e(t[r+1])}}}};var n=function(t,e,n){var s=t.name&&t.names;if(t.push&&!e[t.push]){e[t.push]=[]}else if(s&&!e[t.name]){e[t.name]={}}var r=t.push?{}:s?e[t.name]:e;i(n.match(t.reg),r,t.names,t.name);if(t.push){e[t.push].push(r)}};var s=da();var r=RegExp.prototype.test.bind(/^([a-z])=(.*)/);t.parse=function(t){var e={},i=[],o=e;t.split(/(\r\n|\r|\n)/).filter(r).forEach((function(t){var e=t[0];var r=t.slice(2);if(e==="m"){i.push({rtp:[],fmtp:[]});o=i[i.length-1]}for(var a=0;a<(s[e]||[]).length;a+=1){var c=s[e][a];if(c.reg.test(r)){return n(c,o,r)}}}));e.media=i;return e};var o=function(t,i){var n=i.split(/=(.+)/,2);if(n.length===2){t[n[0]]=e(n[1])}else if(n.length===1&&i.length>1){t[n[0]]=undefined}return t};t.parseParams=function(t){return t.split(/;\s?/).reduce(o,{})};t.parseFmtpConfig=t.parseParams;t.parsePayloads=function(t){return t.toString().split(" ").map(Number)};t.parseRemoteCandidates=function(t){var i=[];var n=t.split(" ").map(e);for(var s=0;s<n.length;s+=3){i.push({component:n[s],ip:n[s+1],port:n[s+2]})}return i};t.parseImageAttributes=function(t){return t.split(" ").map((function(t){return t.substring(1,t.length-1).split(",").reduce(o,{})}))};t.parseSimulcastStreamList=function(t){return t.split(";").map((function(t){return t.split(",").map((function(t){var i,n=false;if(t[0]!=="~"){i=e(t)}else{i=e(t.substring(1,t.length));n=true}return{scid:i,paused:n}}))}))}})(aa);return aa}var fa;var ma;function va(){if(ma)return fa;ma=1;var t=da();var e=/%[sdv%]/g;var i=function(t){var i=1;var n=arguments;var s=n.length;return t.replace(e,(function(t){if(i>=s){return t}var e=n[i];i+=1;switch(t){case"%%":return"%";case"%s":return String(e);case"%d":return Number(e);case"%v":return""}}))};var n=function(t,e,n){var s=e.format instanceof Function?e.format(e.push?n:n[e.name]):e.format;var r=[t+"="+s];if(e.names){for(var o=0;o<e.names.length;o+=1){var a=e.names[o];if(e.name){r.push(n[e.name][a])}else{r.push(n[e.names[o]])}}}else{r.push(n[e.name])}return i.apply(null,r)};var s=["v","o","s","i","u","e","p","c","b","t","r","z","a"];var r=["i","c","b","a"];fa=function(e,i){i=i||{};if(e.version==null){e.version=0}if(e.name==null){e.name=" "}e.media.forEach((function(t){if(t.payloads==null){t.payloads=""}}));var o=i.outerOrder||s;var a=i.innerOrder||r;var c=[];o.forEach((function(i){t[i].forEach((function(t){if(t.name in e&&e[t.name]!=null){c.push(n(i,t,e))}else if(t.push in e&&e[t.push]!=null){e[t.push].forEach((function(e){c.push(n(i,t,e))}))}}))}));e.media.forEach((function(e){c.push(n("m",t.m[0],e));a.forEach((function(i){t[i].forEach((function(t){if(t.name in e&&e[t.name]!=null){c.push(n(i,t,e))}else if(t.push in e&&e[t.push]!=null){e[t.push].forEach((function(e){c.push(n(i,t,e))}))}}))}))}));return c.join("\r\n")+"\r\n"};return fa}var pa;function ba(){if(pa)return oa;pa=1;var t=la();var e=va();var i=da();oa.grammar=i;oa.write=e;oa.parse=t.parse;oa.parseParams=t.parseParams;oa.parseFmtpConfig=t.parseFmtpConfig;oa.parsePayloads=t.parsePayloads;oa.parseRemoteCandidates=t.parseRemoteCandidates;oa.parseImageAttributes=t.parseImageAttributes;oa.parseSimulcastStreamList=t.parseSimulcastStreamList;return oa}var ga=ba();function ya(t,e,i){var n,s,r;void 0===e&&(e=50),void 0===i&&(i={});var o=null!=(n=i.isImmediate)&&n,a=null!=(s=i.callback)&&s,c=i.maxWait,u=Date.now(),d=[];function h(){if(void 0!==c){var t=Date.now()-u;if(t+e>=c)return c-t}return e}var l=function(){var e=[].slice.call(arguments),i=this;return new Promise((function(n,s){var c=o&&void 0===r;if(void 0!==r&&clearTimeout(r),r=setTimeout((function(){if(r=void 0,u=Date.now(),!o){var n=t.apply(i,e);a&&a(n),d.forEach((function(t){return(0,t.resolve)(n)})),d=[]}}),h()),c){var l=t.apply(i,e);return a&&a(l),n(l)}d.push({resolve:n,reject:s})}))};return l.cancel=function(t){void 0!==r&&clearTimeout(r),d.forEach((function(e){return(0,e.reject)(t)})),d=[]},l}const ka=.7;const wa=20;const Ta={NegotiationStarted:"negotiationStarted",NegotiationComplete:"negotiationComplete",RTPVideoPayloadTypes:"rtpVideoPayloadTypes"};class Sa extends Sn.EventEmitter{get pc(){if(!this._pc){this._pc=this.createPC()}return this._pc}constructor(t){let e=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var i;super();this.log=dn;this.ddExtID=0;this.pendingCandidates=[];this.restartingIce=false;this.renegotiate=false;this.trackBitrates=[];this.remoteStereoMids=[];this.remoteNackMids=[];this.negotiate=ya((t=>bn(this,void 0,void 0,(function*(){this.emit(Ta.NegotiationStarted);try{yield this.createAndSendOffer()}catch(e){if(t){t(e)}else{throw e}}}))),wa);this.close=()=>{if(!this._pc){return}this._pc.close();this._pc.onconnectionstatechange=null;this._pc.oniceconnectionstatechange=null;this._pc.onicegatheringstatechange=null;this._pc.ondatachannel=null;this._pc.onnegotiationneeded=null;this._pc.onsignalingstatechange=null;this._pc.onicecandidate=null;this._pc.ondatachannel=null;this._pc.ontrack=null;this._pc.onconnectionstatechange=null;this._pc.oniceconnectionstatechange=null;this._pc=null};this.log=hn((i=e.loggerName)!==null&&i!==void 0?i:un.PCTransport);this.loggerOptions=e;this.config=t;this._pc=this.createPC()}createPC(){const t=new RTCPeerConnection(this.config);t.onicecandidate=t=>{var e;if(!t.candidate)return;(e=this.onIceCandidate)===null||e===void 0?void 0:e.call(this,t.candidate)};t.onicecandidateerror=t=>{var e;(e=this.onIceCandidateError)===null||e===void 0?void 0:e.call(this,t)};t.oniceconnectionstatechange=()=>{var e;(e=this.onIceConnectionStateChange)===null||e===void 0?void 0:e.call(this,t.iceConnectionState)};t.onsignalingstatechange=()=>{var e;(e=this.onSignalingStatechange)===null||e===void 0?void 0:e.call(this,t.signalingState)};t.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0?void 0:e.call(this,t.connectionState)};t.ondatachannel=t=>{var e;(e=this.onDataChannel)===null||e===void 0?void 0:e.call(this,t)};t.ontrack=t=>{var e;(e=this.onTrack)===null||e===void 0?void 0:e.call(this,t)};return t}get logContext(){var t,e;return Object.assign({},(e=(t=this.loggerOptions).loggerContextCb)===null||e===void 0?void 0:e.call(t))}get isICEConnected(){return this._pc!==null&&(this.pc.iceConnectionState==="connected"||this.pc.iceConnectionState==="completed")}addIceCandidate(t){return bn(this,void 0,void 0,(function*(){if(this.pc.remoteDescription&&!this.restartingIce){return this.pc.addIceCandidate(t)}this.pendingCandidates.push(t)}))}setRemoteDescription(t){return bn(this,void 0,void 0,(function*(){var e;let i=undefined;if(t.type==="offer"){let{stereoMids:e,nackMids:i}=Ea(t);this.remoteStereoMids=e;this.remoteNackMids=i}else if(t.type==="answer"){const n=ga.parse((e=t.sdp)!==null&&e!==void 0?e:"");n.media.forEach((t=>{if(t.type==="audio"){this.trackBitrates.some((e=>{if(!e.transceiver||t.mid!=e.transceiver.mid){return false}let i=0;t.rtp.some((t=>{if(t.codec.toUpperCase()===e.codec.toUpperCase()){i=t.payload;return true}return false}));if(i===0){return true}let n=false;for(const s of t.fmtp){if(s.payload===i){s.config=s.config.split(";").filter((t=>!t.includes("maxaveragebitrate"))).join(";");if(e.maxbr>0){s.config+=";maxaveragebitrate=".concat(e.maxbr*1e3)}n=true;break}}if(!n){if(e.maxbr>0){t.fmtp.push({payload:i,config:"maxaveragebitrate=".concat(e.maxbr*1e3)})}}return true}))}}));i=ga.write(n)}yield this.setMungedSDP(t,i,true);this.pendingCandidates.forEach((t=>{this.pc.addIceCandidate(t)}));this.pendingCandidates=[];this.restartingIce=false;if(this.renegotiate){this.renegotiate=false;yield this.createAndSendOffer()}else if(t.type==="answer"){this.emit(Ta.NegotiationComplete);if(t.sdp){const e=ga.parse(t.sdp);e.media.forEach((t=>{if(t.type==="video"){this.emit(Ta.RTPVideoPayloadTypes,t.rtp)}}))}}}))}createAndSendOffer(t){return bn(this,void 0,void 0,(function*(){var e;if(this.onOffer===undefined){return}if(t===null||t===void 0?void 0:t.iceRestart){this.log.debug("restarting ICE",this.logContext);this.restartingIce=true}if(this._pc&&this._pc.signalingState==="have-local-offer"){const e=this._pc.remoteDescription;if((t===null||t===void 0?void 0:t.iceRestart)&&e){yield this._pc.setRemoteDescription(e)}else{this.renegotiate=true;return}}else if(!this._pc||this._pc.signalingState==="closed"){this.log.warn("could not createOffer with closed peer connection",this.logContext);return}this.log.debug("starting to negotiate",this.logContext);const i=yield this.pc.createOffer(t);this.log.debug("original offer",Object.assign({sdp:i.sdp},this.logContext));const n=ga.parse((e=i.sdp)!==null&&e!==void 0?e:"");n.media.forEach((t=>{Ca(t);if(t.type==="audio"){Oa(t,[],[])}else if(t.type==="video"){this.trackBitrates.some((e=>{if(!t.msid||!e.cid||!t.msid.includes(e.cid)){return false}let i=0;t.rtp.some((t=>{if(t.codec.toUpperCase()===e.codec.toUpperCase()){i=t.payload;return true}return false}));if(i===0){return true}if(Ur(e.codec)){this.ensureVideoDDExtensionForSVC(t,n)}if(e.codec!=="av1"){return true}const s=Math.round(e.maxbr*ka);for(const e of t.fmtp){if(e.payload===i){if(!e.config.includes("x-google-start-bitrate")){e.config+=";x-google-start-bitrate=".concat(s)}break}}return true}))}}));yield this.setMungedSDP(i,ga.write(n));this.onOffer(i)}))}createAndSetAnswer(){return bn(this,void 0,void 0,(function*(){var t;const e=yield this.pc.createAnswer();const i=ga.parse((t=e.sdp)!==null&&t!==void 0?t:"");i.media.forEach((t=>{Ca(t);if(t.type==="audio"){Oa(t,this.remoteStereoMids,this.remoteNackMids)}}));yield this.setMungedSDP(e,ga.write(i));return e}))}createDataChannel(t,e){return this.pc.createDataChannel(t,e)}addTransceiver(t,e){return this.pc.addTransceiver(t,e)}addTrack(t){if(!this._pc){throw new Ws("PC closed, cannot add track")}return this._pc.addTrack(t)}setTrackCodecBitrate(t){this.trackBitrates.push(t)}setConfiguration(t){var e;if(!this._pc){throw new Ws("PC closed, cannot configure")}return(e=this._pc)===null||e===void 0?void 0:e.setConfiguration(t)}canRemoveTrack(){var t;return!!((t=this._pc)===null||t===void 0?void 0:t.removeTrack)}removeTrack(t){var e;return(e=this._pc)===null||e===void 0?void 0:e.removeTrack(t)}getConnectionState(){var t,e;return(e=(t=this._pc)===null||t===void 0?void 0:t.connectionState)!==null&&e!==void 0?e:"closed"}getICEConnectionState(){var t,e;return(e=(t=this._pc)===null||t===void 0?void 0:t.iceConnectionState)!==null&&e!==void 0?e:"closed"}getSignallingState(){var t,e;return(e=(t=this._pc)===null||t===void 0?void 0:t.signalingState)!==null&&e!==void 0?e:"closed"}getTransceivers(){var t,e;return(e=(t=this._pc)===null||t===void 0?void 0:t.getTransceivers())!==null&&e!==void 0?e:[]}getSenders(){var t,e;return(e=(t=this._pc)===null||t===void 0?void 0:t.getSenders())!==null&&e!==void 0?e:[]}getLocalDescription(){var t;return(t=this._pc)===null||t===void 0?void 0:t.localDescription}getRemoteDescription(){var t;return(t=this.pc)===null||t===void 0?void 0:t.remoteDescription}getStats(){return this.pc.getStats()}getConnectedAddress(){return bn(this,void 0,void 0,(function*(){var t;if(!this._pc){return}let e="";const i=new Map;const n=new Map;const s=yield this._pc.getStats();s.forEach((t=>{switch(t.type){case"transport":e=t.selectedCandidatePairId;break;case"candidate-pair":if(e===""&&t.selected){e=t.id}i.set(t.id,t);break;case"remote-candidate":n.set(t.id,"".concat(t.address,":").concat(t.port));break}}));if(e===""){return undefined}const r=(t=i.get(e))===null||t===void 0?void 0:t.remoteCandidateId;if(r===undefined){return undefined}return n.get(r)}))}setMungedSDP(t,e,i){return bn(this,void 0,void 0,(function*(){if(e){const n=t.sdp;t.sdp=e;try{this.log.debug("setting munged ".concat(i?"remote":"local"," description"),this.logContext);if(i){yield this.pc.setRemoteDescription(t)}else{yield this.pc.setLocalDescription(t)}return}catch(i){this.log.warn("not able to set ".concat(t.type,", falling back to unmodified sdp"),Object.assign(Object.assign({},this.logContext),{error:i,sdp:e}));t.sdp=n}}try{if(i){yield this.pc.setRemoteDescription(t)}else{yield this.pc.setLocalDescription(t)}}catch(e){let n="unknown error";if(e instanceof Error){n=e.message}else if(typeof e==="string"){n=e}const s={error:n,sdp:t.sdp};if(!i&&this.pc.remoteDescription){s.remoteSdp=this.pc.remoteDescription}this.log.error("unable to set ".concat(t.type),Object.assign(Object.assign({},this.logContext),{fields:s}));throw new Ks(n)}}))}ensureVideoDDExtensionForSVC(t,e){var i,n;const s=(i=t.ext)===null||i===void 0?void 0:i.some((t=>{if(t.uri===_r){return true}return false}));if(!s){if(this.ddExtID===0){let t=0;e.media.forEach((e=>{var i;if(e.type!=="video"){return}(i=e.ext)===null||i===void 0?void 0:i.forEach((e=>{if(e.value>t){t=e.value}}))}));this.ddExtID=t+1}(n=t.ext)===null||n===void 0?void 0:n.push({value:this.ddExtID,uri:_r})}}}function Oa(t,e,i){let n=0;t.rtp.some((t=>{if(t.codec==="opus"){n=t.payload;return true}return false}));if(n>0){if(!t.rtcpFb){t.rtcpFb=[]}if(i.includes(t.mid)&&!t.rtcpFb.some((t=>t.payload===n&&t.type==="nack"))){t.rtcpFb.push({payload:n,type:"nack"})}if(e.includes(t.mid)){t.fmtp.some((t=>{if(t.payload===n){if(!t.config.includes("stereo=1")){t.config+=";stereo=1"}return true}return false}))}}}function Ea(t){var e;const i=[];const n=[];const s=ga.parse((e=t.sdp)!==null&&e!==void 0?e:"");let r=0;s.media.forEach((t=>{var e;if(t.type==="audio"){t.rtp.some((t=>{if(t.codec==="opus"){r=t.payload;return true}return false}));if((e=t.rtcpFb)===null||e===void 0?void 0:e.some((t=>t.payload===r&&t.type==="nack"))){n.push(t.mid)}t.fmtp.some((e=>{if(e.payload===r){if(e.config.includes("sprop-stereo=1")){i.push(t.mid)}return true}return false}))}}));return{stereoMids:i,nackMids:n}}function Ca(t){if(t.connection){const e=t.connection.ip.indexOf(":")>=0;if(t.connection.version===4&&e||t.connection.version===6&&!e){t.connection.ip="0.0.0.0";t.connection.version=4}}}const ja="vp8";const Ra={audioPreset:Er.music,dtx:true,red:true,forceStereo:false,simulcast:true,screenShareEncoding:Rr.h1080fps15.encoding,stopMicTrackOnMute:false,videoCodec:ja,backupCodec:true};const Ia={deviceId:{ideal:"default"},autoGainControl:true,echoCancellation:true,noiseSuppression:true,voiceIsolation:true};const _a={deviceId:{ideal:"default"},resolution:Cr.h720.resolution};const Pa={adaptiveStream:false,dynacast:false,stopLocalTrackOnUnpublish:true,reconnectPolicy:new vn,disconnectOnPageLeave:true,webAudioMix:false};const Na={autoSubscribe:true,maxRetries:1,peerConnectionTimeout:15e3,websocketTimeout:15e3};var Da;(function(t){t[t["NEW"]=0]="NEW";t[t["CONNECTING"]=1]="CONNECTING";t[t["CONNECTED"]=2]="CONNECTED";t[t["FAILED"]=3]="FAILED";t[t["CLOSING"]=4]="CLOSING";t[t["CLOSED"]=5]="CLOSED"})(Da||(Da={}));class Aa{get needsPublisher(){return this.isPublisherConnectionRequired}get needsSubscriber(){return this.isSubscriberConnectionRequired}get currentState(){return this.state}constructor(t,e,i){var n;this.peerConnectionTimeout=Na.peerConnectionTimeout;this.log=dn;this.updateState=()=>{var t;const e=this.state;const i=this.requiredTransports.map((t=>t.getConnectionState()));if(i.every((t=>t==="connected"))){this.state=Da.CONNECTED}else if(i.some((t=>t==="failed"))){this.state=Da.FAILED}else if(i.some((t=>t==="connecting"))){this.state=Da.CONNECTING}else if(i.every((t=>t==="closed"))){this.state=Da.CLOSED}else if(i.some((t=>t==="closed"))){this.state=Da.CLOSING}else if(i.every((t=>t==="new"))){this.state=Da.NEW}if(e!==this.state){this.log.debug("pc state change: from ".concat(Da[e]," to ").concat(Da[this.state]),this.logContext);(t=this.onStateChange)===null||t===void 0?void 0:t.call(this,this.state,this.publisher.getConnectionState(),this.subscriber.getConnectionState())}};this.log=hn((n=i.loggerName)!==null&&n!==void 0?n:un.PCManager);this.loggerOptions=i;this.isPublisherConnectionRequired=!e;this.isSubscriberConnectionRequired=e;this.publisher=new Sa(t,i);this.subscriber=new Sa(t,i);this.publisher.onConnectionStateChange=this.updateState;this.subscriber.onConnectionStateChange=this.updateState;this.publisher.onIceConnectionStateChange=this.updateState;this.subscriber.onIceConnectionStateChange=this.updateState;this.publisher.onSignalingStatechange=this.updateState;this.subscriber.onSignalingStatechange=this.updateState;this.publisher.onIceCandidate=t=>{var e;(e=this.onIceCandidate)===null||e===void 0?void 0:e.call(this,t,ai.PUBLISHER)};this.subscriber.onIceCandidate=t=>{var e;(e=this.onIceCandidate)===null||e===void 0?void 0:e.call(this,t,ai.SUBSCRIBER)};this.subscriber.onDataChannel=t=>{var e;(e=this.onDataChannel)===null||e===void 0?void 0:e.call(this,t)};this.subscriber.onTrack=t=>{var e;(e=this.onTrack)===null||e===void 0?void 0:e.call(this,t)};this.publisher.onOffer=t=>{var e;(e=this.onPublisherOffer)===null||e===void 0?void 0:e.call(this,t)};this.state=Da.NEW;this.connectionLock=new d;this.remoteOfferLock=new d}get logContext(){var t,e;return Object.assign({},(e=(t=this.loggerOptions).loggerContextCb)===null||e===void 0?void 0:e.call(t))}requirePublisher(){let t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;this.isPublisherConnectionRequired=t;this.updateState()}requireSubscriber(){let t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;this.isSubscriberConnectionRequired=t;this.updateState()}createAndSendPublisherOffer(t){return this.publisher.createAndSendOffer(t)}setPublisherAnswer(t){return this.publisher.setRemoteDescription(t)}removeTrack(t){return this.publisher.removeTrack(t)}close(){return bn(this,void 0,void 0,(function*(){if(this.publisher&&this.publisher.getSignallingState()!=="closed"){const t=this.publisher;for(const e of t.getSenders()){try{if(t.canRemoveTrack()){t.removeTrack(e)}}catch(t){this.log.warn("could not removeTrack",Object.assign(Object.assign({},this.logContext),{error:t}))}}}yield Promise.all([this.publisher.close(),this.subscriber.close()]);this.updateState()}))}triggerIceRestart(){return bn(this,void 0,void 0,(function*(){this.subscriber.restartingIce=true;if(this.needsPublisher){yield this.createAndSendPublisherOffer({iceRestart:true})}}))}addIceCandidate(t,e){return bn(this,void 0,void 0,(function*(){if(e===ai.PUBLISHER){yield this.publisher.addIceCandidate(t)}else{yield this.subscriber.addIceCandidate(t)}}))}createSubscriberAnswerFromOffer(t){return bn(this,void 0,void 0,(function*(){this.log.debug("received server offer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:t.type,sdp:t.sdp,signalingState:this.subscriber.getSignallingState().toString()}));const e=yield this.remoteOfferLock.lock();try{yield this.subscriber.setRemoteDescription(t);const e=yield this.subscriber.createAndSetAnswer();return e}finally{e()}}))}updateConfiguration(t,e){this.publisher.setConfiguration(t);this.subscriber.setConfiguration(t);if(e){this.triggerIceRestart()}}ensurePCTransportConnection(t,e){return bn(this,void 0,void 0,(function*(){var i;const n=yield this.connectionLock.lock();try{if(this.isPublisherConnectionRequired&&this.publisher.getConnectionState()!=="connected"&&this.publisher.getConnectionState()!=="connecting"){this.log.debug("negotiation required, start negotiating",this.logContext);this.publisher.negotiate()}yield Promise.all((i=this.requiredTransports)===null||i===void 0?void 0:i.map((i=>this.ensureTransportConnected(i,t,e))))}finally{n()}}))}negotiate(t){return bn(this,void 0,void 0,(function*(){return new Promise(((e,i)=>bn(this,void 0,void 0,(function*(){const n=setTimeout((()=>{i("negotiation timed out")}),this.peerConnectionTimeout);const s=()=>{clearTimeout(n);i("negotiation aborted")};t.signal.addEventListener("abort",s);this.publisher.once(Ta.NegotiationStarted,(()=>{if(t.signal.aborted){return}this.publisher.once(Ta.NegotiationComplete,(()=>{clearTimeout(n);e()}))}));yield this.publisher.negotiate((t=>{clearTimeout(n);i(t)}))}))))}))}addPublisherTransceiver(t,e){return this.publisher.addTransceiver(t,e)}addPublisherTrack(t){return this.publisher.addTrack(t)}createPublisherDataChannel(t,e){return this.publisher.createDataChannel(t,e)}getConnectedAddress(t){if(t===ai.PUBLISHER){return this.publisher.getConnectedAddress()}else if(t===ai.SUBSCRIBER){return this.publisher.getConnectedAddress()}return this.requiredTransports[0].getConnectedAddress()}get requiredTransports(){const t=[];if(this.isPublisherConnectionRequired){t.push(this.publisher)}if(this.isSubscriberConnectionRequired){t.push(this.subscriber)}return t}ensureTransportConnected(t,e){return bn(this,arguments,void 0,(function(t,e){var i=this;let n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:this.peerConnectionTimeout;return function*(){const s=t.getConnectionState();if(s==="connected"){return}return new Promise(((t,s)=>bn(i,void 0,void 0,(function*(){const i=()=>{this.log.warn("abort transport connection",this.logContext);fr.clearTimeout(r);s(new Js("room connection has been cancelled",Vs.Cancelled))};if(e===null||e===void 0?void 0:e.signal.aborted){i()}e===null||e===void 0?void 0:e.signal.addEventListener("abort",i);const r=fr.setTimeout((()=>{e===null||e===void 0?void 0:e.signal.removeEventListener("abort",i);s(new Js("could not establish pc connection",Vs.InternalError))}),n);while(this.state!==Da.CONNECTED){yield Nr(50);if(e===null||e===void 0?void 0:e.signal.aborted){s(new Js("room connection has been cancelled",Vs.Cancelled));return}}fr.clearTimeout(r);e===null||e===void 0?void 0:e.signal.removeEventListener("abort",i);t()}))))}()}))}}class xa extends Error{constructor(t,e,i){super(e);this.code=t;this.message=La(e,xa.MAX_MESSAGE_BYTES);this.data=i?La(i,xa.MAX_DATA_BYTES):undefined}static fromProto(t){return new xa(t.code,t.message,t.data)}toProto(){return new He({code:this.code,message:this.message,data:this.data})}static builtIn(t,e){return new xa(xa.ErrorCode[t],xa.ErrorMessage[t],e)}}xa.MAX_MESSAGE_BYTES=256;xa.MAX_DATA_BYTES=15360;xa.ErrorCode={APPLICATION_ERROR:1500,CONNECTION_TIMEOUT:1501,RESPONSE_TIMEOUT:1502,RECIPIENT_DISCONNECTED:1503,RESPONSE_PAYLOAD_TOO_LARGE:1504,SEND_FAILED:1505,UNSUPPORTED_METHOD:1400,RECIPIENT_NOT_FOUND:1401,REQUEST_PAYLOAD_TOO_LARGE:1402,UNSUPPORTED_SERVER:1403,UNSUPPORTED_VERSION:1404};xa.ErrorMessage={APPLICATION_ERROR:"Application error in method handler",CONNECTION_TIMEOUT:"Connection timeout",RESPONSE_TIMEOUT:"Response timeout",RECIPIENT_DISCONNECTED:"Recipient disconnected",RESPONSE_PAYLOAD_TOO_LARGE:"Response payload too large",SEND_FAILED:"Failed to send",UNSUPPORTED_METHOD:"Method not supported at destination",RECIPIENT_NOT_FOUND:"Recipient not found",REQUEST_PAYLOAD_TOO_LARGE:"Request payload too large",UNSUPPORTED_SERVER:"RPC not supported by server",UNSUPPORTED_VERSION:"Unsupported RPC version"};const Ma=15360;function Ua(t){const e=new TextEncoder;return e.encode(t).length}function La(t,e){if(Ua(t)<=e){return t}let i=0;let n=t.length;const s=new TextEncoder;while(i<n){const r=Math.floor((i+n+1)/2);if(s.encode(t.slice(0,r)).length<=e){i=r}else{n=r-1}}return t.slice(0,i)}const Fa=2e3;function qa(t,e){if(!e){return 0}let i;let n;if("bytesReceived"in t){i=t.bytesReceived;n=e.bytesReceived}else if("bytesSent"in t){i=t.bytesSent;n=e.bytesSent}if(i===undefined||n===undefined||t.timestamp===undefined||e.timestamp===undefined){return 0}return(i-n)*8*1e3/(t.timestamp-e.timestamp)}const Ba=1e3;class Va extends br{get sender(){return this._sender}set sender(t){this._sender=t}get constraints(){return this._constraints}constructor(t,e,i){let n=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;let s=arguments.length>4?arguments[4]:undefined;super(t,e,s);this.manuallyStopped=false;this._isUpstreamPaused=false;this.handleTrackMuteEvent=()=>this.debouncedTrackMuteHandler().catch((()=>this.log.debug("track mute bounce got cancelled by an unmute event",this.logContext)));this.debouncedTrackMuteHandler=ya((()=>bn(this,void 0,void 0,(function*(){yield this.pauseUpstream()}))),5e3);this.handleTrackUnmuteEvent=()=>bn(this,void 0,void 0,(function*(){this.debouncedTrackMuteHandler.cancel("unmute");yield this.resumeUpstream()}));this.handleEnded=()=>{if(this.isInBackground){this.reacquireTrack=true}this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent);this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent);this.emit(ir.Ended,this)};this.reacquireTrack=false;this.providedByUser=n;this.muteLock=new d;this.pauseUpstreamLock=new d;this.processorLock=new d;this.restartLock=new d;this.setMediaStreamTrack(t,true);this._constraints=t.getConstraints();if(i){this._constraints=i}}get id(){return this._mediaStreamTrack.id}get dimensions(){if(this.kind!==br.Kind.Video){return undefined}const{width:t,height:e}=this._mediaStreamTrack.getSettings();if(t&&e){return{width:t,height:e}}return undefined}get isUpstreamPaused(){return this._isUpstreamPaused}get isUserProvided(){return this.providedByUser}get mediaStreamTrack(){var t,e;return(e=(t=this.processor)===null||t===void 0?void 0:t.processedTrack)!==null&&e!==void 0?e:this._mediaStreamTrack}get isLocal(){return true}getSourceTrackSettings(){return this._mediaStreamTrack.getSettings()}setMediaStreamTrack(t,e){return bn(this,void 0,void 0,(function*(){var i;if(t===this._mediaStreamTrack&&!e){return}if(this._mediaStreamTrack){this.attachedElements.forEach((t=>{yr(this._mediaStreamTrack,t)}));this.debouncedTrackMuteHandler.cancel("new-track");this._mediaStreamTrack.removeEventListener("ended",this.handleEnded);this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent);this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent)}this.mediaStream=new MediaStream([t]);if(t){t.addEventListener("ended",this.handleEnded);t.addEventListener("mute",this.handleTrackMuteEvent);t.addEventListener("unmute",this.handleTrackUnmuteEvent);this._constraints=t.getConstraints()}let n;if(this.processor&&t){const e=yield this.processorLock.lock();try{this.log.debug("restarting processor",this.logContext);if(this.kind==="unknown"){throw TypeError("cannot set processor on track of unknown kind")}if(this.processorElement){gr(t,this.processorElement);this.processorElement.muted=true}yield this.processor.restart({track:t,kind:this.kind,element:this.processorElement});n=this.processor.processedTrack}finally{e()}}if(this.sender&&((i=this.sender.transport)===null||i===void 0?void 0:i.state)!=="closed"){yield this.sender.replaceTrack(n!==null&&n!==void 0?n:t)}if(!this.providedByUser&&this._mediaStreamTrack!==t){this._mediaStreamTrack.stop()}this._mediaStreamTrack=t;if(t){this._mediaStreamTrack.enabled=!this.isMuted;yield this.resumeUpstream();this.attachedElements.forEach((e=>{gr(n!==null&&n!==void 0?n:t,e)}))}}))}waitForDimensions(){return bn(this,arguments,void 0,(function(){var t=this;let e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:Ba;return function*(){var i;if(t.kind===br.Kind.Audio){throw new Error("cannot get dimensions for audio tracks")}if(((i=or())===null||i===void 0?void 0:i.os)==="iOS"){yield Nr(10)}const n=Date.now();while(Date.now()-n<e){const e=t.dimensions;if(e){return e}yield Nr(50)}throw new Hs("unable to get track dimensions after timeout")}()}))}setDeviceId(t){return bn(this,void 0,void 0,(function*(){if(this._constraints.deviceId===t&&this._mediaStreamTrack.getSettings().deviceId===ho(t)){return true}this._constraints.deviceId=t;if(this.isMuted){return true}yield this.restartTrack();return ho(t)===this._mediaStreamTrack.getSettings().deviceId}))}getDeviceId(){return bn(this,arguments,void 0,(function(){var t=this;let e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;return function*(){if(t.source===br.Source.ScreenShare){return}const{deviceId:i,groupId:n}=t._mediaStreamTrack.getSettings();const s=t.kind===br.Kind.Audio?"audioinput":"videoinput";return e?zo.getInstance().normalizeDeviceId(s,i,n):i}()}))}mute(){return bn(this,void 0,void 0,(function*(){this.setTrackMuted(true);return this}))}unmute(){return bn(this,void 0,void 0,(function*(){this.setTrackMuted(false);return this}))}replaceTrack(t,e){return bn(this,void 0,void 0,(function*(){if(!this.sender){throw new Hs("unable to replace an unpublished track")}let i;let n;if(typeof e==="boolean"){i=e}else if(e!==undefined){i=e.userProvidedTrack;n=e.stopProcessor}this.providedByUser=i!==null&&i!==void 0?i:true;this.log.debug("replace MediaStreamTrack",this.logContext);yield this.setMediaStreamTrack(t);if(n&&this.processor){yield this.stopProcessor()}return this}))}restart(t){return bn(this,void 0,void 0,(function*(){this.manuallyStopped=false;const e=yield this.restartLock.lock();try{if(!t){t=this._constraints}const{deviceId:e,facingMode:i}=t,n=pn(t,["deviceId","facingMode"]);this.log.debug("restarting track with constraints",Object.assign(Object.assign({},this.logContext),{constraints:t}));const s={audio:false,video:false};if(this.kind===br.Kind.Video){s.video=e||i?{deviceId:e,facingMode:i}:true}else{s.audio=e?{deviceId:e}:true}this.attachedElements.forEach((t=>{yr(this.mediaStreamTrack,t)}));this._mediaStreamTrack.removeEventListener("ended",this.handleEnded);this._mediaStreamTrack.stop();const r=yield navigator.mediaDevices.getUserMedia(s);const o=r.getTracks()[0];yield o.applyConstraints(n);o.addEventListener("ended",this.handleEnded);this.log.debug("re-acquired MediaStreamTrack",this.logContext);yield this.setMediaStreamTrack(o);this._constraints=t;this.emit(ir.Restarted,this);if(this.manuallyStopped){this.log.warn("track was stopped during a restart, stopping restarted track",this.logContext);this.stop()}return this}finally{e()}}))}setTrackMuted(t){this.log.debug("setting ".concat(this.kind," track ").concat(t?"muted":"unmuted"),this.logContext);if(this.isMuted===t&&this._mediaStreamTrack.enabled!==t){return}this.isMuted=t;this._mediaStreamTrack.enabled=!t;this.emit(t?ir.Muted:ir.Unmuted,this)}get needsReAcquisition(){return this._mediaStreamTrack.readyState!=="live"||this._mediaStreamTrack.muted||!this._mediaStreamTrack.enabled||this.reacquireTrack}handleAppVisibilityChanged(){const t=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return bn(this,void 0,void 0,(function*(){yield t.handleAppVisibilityChanged.call(this);if(!Jr())return;this.log.debug("visibility changed, is in Background: ".concat(this.isInBackground),this.logContext);if(!this.isInBackground&&this.needsReAcquisition&&!this.isUserProvided&&!this.isMuted){this.log.debug("track needs to be reacquired, restarting ".concat(this.source),this.logContext);yield this.restart();this.reacquireTrack=false}}))}stop(){var t;this.manuallyStopped=true;super.stop();this._mediaStreamTrack.removeEventListener("ended",this.handleEnded);this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent);this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent);(t=this.processor)===null||t===void 0?void 0:t.destroy();this.processor=undefined}pauseUpstream(){return bn(this,void 0,void 0,(function*(){var t;const e=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===true){return}if(!this.sender){this.log.warn("unable to pause upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=true;this.emit(ir.UpstreamPaused,this);const e=or();if((e===null||e===void 0?void 0:e.name)==="Safari"&&Zr(e.version,"12.0")<0){throw new Gs("pauseUpstream is not supported on Safari < 12.")}if(((t=this.sender.transport)===null||t===void 0?void 0:t.state)!=="closed"){yield this.sender.replaceTrack(null)}}finally{e()}}))}resumeUpstream(){return bn(this,void 0,void 0,(function*(){var t;const e=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===false){return}if(!this.sender){this.log.warn("unable to resume upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=false;this.emit(ir.UpstreamResumed,this);if(((t=this.sender.transport)===null||t===void 0?void 0:t.state)!=="closed"){yield this.sender.replaceTrack(this.mediaStreamTrack)}}finally{e()}}))}getRTCStatsReport(){return bn(this,void 0,void 0,(function*(){var t;if(!((t=this.sender)===null||t===void 0?void 0:t.getStats)){return}const e=yield this.sender.getStats();return e}))}setProcessor(t){return bn(this,arguments,void 0,(function(t){var e=this;let i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;return function*(){var n;const s=yield e.processorLock.lock();try{e.log.debug("setting up processor",e.logContext);const s=document.createElement(e.kind);const r={kind:e.kind,track:e._mediaStreamTrack,element:s,audioContext:e.audioContext};yield t.init(r);e.log.debug("processor initialized",e.logContext);if(e.processor){yield e.stopProcessor()}if(e.kind==="unknown"){throw TypeError("cannot set processor on track of unknown kind")}gr(e._mediaStreamTrack,s);s.muted=true;s.play().catch((t=>e.log.error("failed to play processor element",Object.assign(Object.assign({},e.logContext),{error:t}))));e.processor=t;e.processorElement=s;if(e.processor.processedTrack){for(const t of e.attachedElements){if(t!==e.processorElement&&i){yr(e._mediaStreamTrack,t);gr(e.processor.processedTrack,t)}}yield(n=e.sender)===null||n===void 0?void 0:n.replaceTrack(e.processor.processedTrack)}e.emit(ir.TrackProcessorUpdate,e.processor)}finally{s()}}()}))}getProcessor(){return this.processor}stopProcessor(){return bn(this,arguments,void 0,(function(){var t=this;let e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;return function*(){var i,n;if(!t.processor)return;t.log.debug("stopping processor",t.logContext);(i=t.processor.processedTrack)===null||i===void 0?void 0:i.stop();yield t.processor.destroy();t.processor=undefined;if(!e){(n=t.processorElement)===null||n===void 0?void 0:n.remove();t.processorElement=undefined}yield t._mediaStreamTrack.applyConstraints(t._constraints);yield t.setMediaStreamTrack(t._mediaStreamTrack,true);t.emit(ir.TrackProcessorUpdate)}()}))}}class Ja extends Va{get enhancedNoiseCancellation(){return this.isKrispNoiseFilterEnabled}constructor(t,e){let i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;let n=arguments.length>3?arguments[3]:undefined;let s=arguments.length>4?arguments[4]:undefined;super(t,br.Kind.Audio,e,i,s);this.stopOnMute=false;this.isKrispNoiseFilterEnabled=false;this.monitorSender=()=>bn(this,void 0,void 0,(function*(){if(!this.sender){this._currentBitrate=0;return}let t;try{t=yield this.getSenderStats()}catch(t){this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:t}));return}if(t&&this.prevStats){this._currentBitrate=qa(t,this.prevStats)}this.prevStats=t}));this.handleKrispNoiseFilterEnable=()=>{this.isKrispNoiseFilterEnabled=true;this.log.debug("Krisp noise filter enabled",this.logContext);this.emit(ir.AudioTrackFeatureUpdate,this,we.TF_ENHANCED_NOISE_CANCELLATION,true)};this.handleKrispNoiseFilterDisable=()=>{this.isKrispNoiseFilterEnabled=false;this.log.debug("Krisp noise filter disabled",this.logContext);this.emit(ir.AudioTrackFeatureUpdate,this,we.TF_ENHANCED_NOISE_CANCELLATION,false)};this.audioContext=n;this.checkForSilence()}mute(){const t=Object.create(null,{mute:{get:()=>super.mute}});return bn(this,void 0,void 0,(function*(){const e=yield this.muteLock.lock();try{if(this.isMuted){this.log.debug("Track already muted",this.logContext);return this}if(this.source===br.Source.Microphone&&this.stopOnMute&&!this.isUserProvided){this.log.debug("stopping mic track",this.logContext);this._mediaStreamTrack.stop()}yield t.mute.call(this);return this}finally{e()}}))}unmute(){const t=Object.create(null,{unmute:{get:()=>super.unmute}});return bn(this,void 0,void 0,(function*(){const e=yield this.muteLock.lock();try{if(!this.isMuted){this.log.debug("Track already unmuted",this.logContext);return this}const e=this._constraints.deviceId&&this._mediaStreamTrack.getSettings().deviceId!==ho(this._constraints.deviceId);if(this.source===br.Source.Microphone&&(this.stopOnMute||this._mediaStreamTrack.readyState==="ended"||e)&&!this.isUserProvided){this.log.debug("reacquiring mic track",this.logContext);yield this.restartTrack()}yield t.unmute.call(this);return this}finally{e()}}))}restartTrack(t){return bn(this,void 0,void 0,(function*(){let e;if(t){const i=Po({audio:t});if(typeof i.audio!=="boolean"){e=i.audio}}yield this.restart(e)}))}restart(t){const e=Object.create(null,{restart:{get:()=>super.restart}});return bn(this,void 0,void 0,(function*(){const i=yield e.restart.call(this,t);this.checkForSilence();return i}))}startMonitor(){if(!Hr()){return}if(this.monitorInterval){return}this.monitorInterval=setInterval((()=>{this.monitorSender()}),Fa)}setProcessor(t){return bn(this,void 0,void 0,(function*(){var e;const i=yield this.processorLock.lock();try{if(!zr()&&!this.audioContext){throw Error("Audio context needs to be set on LocalAudioTrack in order to enable processors")}if(this.processor){yield this.stopProcessor()}const i={kind:this.kind,track:this._mediaStreamTrack,audioContext:this.audioContext};this.log.debug("setting up audio processor ".concat(t.name),this.logContext);yield t.init(i);this.processor=t;if(this.processor.processedTrack){yield(e=this.sender)===null||e===void 0?void 0:e.replaceTrack(this.processor.processedTrack);this.processor.processedTrack.addEventListener("enable-lk-krisp-noise-filter",this.handleKrispNoiseFilterEnable);this.processor.processedTrack.addEventListener("disable-lk-krisp-noise-filter",this.handleKrispNoiseFilterDisable)}this.emit(ir.TrackProcessorUpdate,this.processor)}finally{i()}}))}setAudioContext(t){this.audioContext=t}getSenderStats(){return bn(this,void 0,void 0,(function*(){var t;if(!((t=this.sender)===null||t===void 0?void 0:t.getStats)){return undefined}const e=yield this.sender.getStats();let i;e.forEach((t=>{if(t.type==="outbound-rtp"){i={type:"audio",streamId:t.id,packetsSent:t.packetsSent,packetsLost:t.packetsLost,bytesSent:t.bytesSent,timestamp:t.timestamp,roundTripTime:t.roundTripTime,jitter:t.jitter}}}));return i}))}checkForSilence(){return bn(this,void 0,void 0,(function*(){const t=yield No(this);if(t){if(!this.isMuted){this.log.warn("silence detected on local audio track",this.logContext)}this.emit(ir.AudioSilenceDetected)}return t}))}}function Ga(t,e,i){switch(t.kind){case"audio":return new Ja(t,e,false,undefined,i);case"video":return new cc(t,e,false,i);default:throw new Hs("unsupported track type: ".concat(t.kind))}}const Ha=Object.values(Cr);const za=Object.values(jr);const Wa=Object.values(Rr);const Ka=[Cr.h180,Cr.h360];const Qa=[jr.h180,jr.h360];const Ya=t=>{const e=[{scaleResolutionDownBy:2,fps:t.encoding.maxFramerate}];return e.map((e=>{var i,n;return new kr(Math.floor(t.width/e.scaleResolutionDownBy),Math.floor(t.height/e.scaleResolutionDownBy),Math.max(15e4,Math.floor(t.encoding.maxBitrate/(Math.pow(e.scaleResolutionDownBy,2)*(((i=t.encoding.maxFramerate)!==null&&i!==void 0?i:30)/((n=e.fps)!==null&&n!==void 0?n:30))))),e.fps,t.encoding.priority)}))};const Za=["q","h","f"];function $a(t,e,i,n){var s,r;let o=n===null||n===void 0?void 0:n.videoEncoding;if(t){o=n===null||n===void 0?void 0:n.screenShareEncoding}const a=n===null||n===void 0?void 0:n.simulcast;const c=n===null||n===void 0?void 0:n.scalabilityMode;const u=n===null||n===void 0?void 0:n.videoCodec;if(!o&&!a&&!c||!e||!i){return[{}]}if(!o){o=tc(t,e,i,u);dn.debug("using video encoding",o)}const d=o.maxFramerate;const h=new kr(e,i,o.maxBitrate,o.maxFramerate,o.priority);if(c&&Ur(u)){const t=new rc(c);const e=[];if(t.spatial>3){throw new Error("unsupported scalabilityMode: ".concat(c))}const i=or();if(Br()||zr()||(i===null||i===void 0?void 0:i.name)==="Chrome"&&Zr(i===null||i===void 0?void 0:i.version,"113")<0){const i=t.suffix=="h"?2:3;for(let n=0;n<t.spatial;n+=1){e.push({rid:Za[2-n],maxBitrate:o.maxBitrate/Math.pow(i,n),maxFramerate:h.encoding.maxFramerate})}e[0].scalabilityMode=c}else{e.push({maxBitrate:o.maxBitrate,maxFramerate:h.encoding.maxFramerate,scalabilityMode:c})}if(h.encoding.priority){e[0].priority=h.encoding.priority;e[0].networkPriority=h.encoding.priority}dn.debug("using svc encoding",{encodings:e});return e}if(!a){return[o]}let l=[];if(t){l=(s=sc(n===null||n===void 0?void 0:n.screenShareSimulcastLayers))!==null&&s!==void 0?s:ic(t,h)}else{l=(r=sc(n===null||n===void 0?void 0:n.videoSimulcastLayers))!==null&&r!==void 0?r:ic(t,h)}let f;if(l.length>0){const t=l[0];if(l.length>1){[,f]=l}const n=Math.max(e,i);if(n>=960&&f){return nc(e,i,[t,f,h],d)}if(n>=480){return nc(e,i,[t,h],d)}}return nc(e,i,[h])}function Xa(t,e,i){var n,s,r,o;if(!i.backupCodec||i.backupCodec===true||i.backupCodec.codec===i.videoCodec){return}if(e!==i.backupCodec.codec){dn.warn("requested a different codec than specified as backup",{serverRequested:e,backup:i.backupCodec.codec})}i.videoCodec=e;i.videoEncoding=i.backupCodec.encoding;const a=t.mediaStreamTrack.getSettings();const c=(n=a.width)!==null&&n!==void 0?n:(s=t.dimensions)===null||s===void 0?void 0:s.width;const u=(r=a.height)!==null&&r!==void 0?r:(o=t.dimensions)===null||o===void 0?void 0:o.height;if(t.source===br.Source.ScreenShare&&i.simulcast){i.simulcast=false}const d=$a(t.source===br.Source.ScreenShare,c,u,i);return d}function tc(t,e,i,n){const s=ec(t,e,i);let{encoding:r}=s[0];const o=Math.max(e,i);for(let t=0;t<s.length;t+=1){const e=s[t];r=e.encoding;if(e.width>=o){break}}if(n){switch(n){case"av1":r=Object.assign({},r);r.maxBitrate=r.maxBitrate*.7;break;case"vp9":r=Object.assign({},r);r.maxBitrate=r.maxBitrate*.85;break}}return r}function ec(t,e,i){if(t){return Wa}const n=e>i?e/i:i/e;if(Math.abs(n-16/9)<Math.abs(n-4/3)){return Ha}return za}function ic(t,e){if(t){return Ya(e)}const{width:i,height:n}=e;const s=i>n?i/n:n/i;if(Math.abs(s-16/9)<Math.abs(s-4/3)){return Ka}return Qa}function nc(t,e,i,n){const s=[];i.forEach(((i,r)=>{if(r>=Za.length){return}const o=Math.min(t,e);const a=Za[r];const c={rid:a,scaleResolutionDownBy:Math.max(1,o/Math.min(i.width,i.height)),maxBitrate:i.encoding.maxBitrate};const u=n&&i.encoding.maxFramerate?Math.min(n,i.encoding.maxFramerate):i.encoding.maxFramerate;if(u){c.maxFramerate=u}const d=qr()||r===0;if(i.encoding.priority&&d){c.priority=i.encoding.priority;c.networkPriority=i.encoding.priority}s.push(c)}));if(zr()&&Qr()==="ios"){let t=undefined;s.forEach((e=>{if(!t){t=e.maxFramerate}else if(e.maxFramerate&&e.maxFramerate>t){t=e.maxFramerate}}));let e=true;s.forEach((i=>{var n;if(i.maxFramerate!=t){if(e){e=false;dn.info("Simulcast on iOS React-Native requires all encodings to share the same framerate.")}dn.info('Setting framerate of encoding "'.concat((n=i.rid)!==null&&n!==void 0?n:"",'" to ').concat(t));i.maxFramerate=t}}))}return s}function sc(t){if(!t)return;return t.sort(((t,e)=>{const{encoding:i}=t;const{encoding:n}=e;if(i.maxBitrate>n.maxBitrate){return 1}if(i.maxBitrate<n.maxBitrate)return-1;if(i.maxBitrate===n.maxBitrate&&i.maxFramerate&&n.maxFramerate){return i.maxFramerate>n.maxFramerate?1:-1}return 0}))}class rc{constructor(t){const e=t.match(/^L(\d)T(\d)(h|_KEY|_KEY_SHIFT){0,1}$/);if(!e){throw new Error("invalid scalability mode")}this.spatial=parseInt(e[1]);this.temporal=parseInt(e[2]);if(e.length>3){switch(e[3]){case"h":case"_KEY":case"_KEY_SHIFT":this.suffix=e[3]}}}toString(){var t;return"L".concat(this.spatial,"T").concat(this.temporal).concat((t=this.suffix)!==null&&t!==void 0?t:"")}}function oc(t){if(t.source===br.Source.ScreenShare||t.constraints.height&&ho(t.constraints.height)>=1080){return"maintain-resolution"}else{return"balanced"}}const ac=5e3;class cc extends Va{get sender(){return this._sender}set sender(t){this._sender=t;if(this.degradationPreference){this.setDegradationPreference(this.degradationPreference)}}constructor(t,e){let i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;let n=arguments.length>3?arguments[3]:undefined;super(t,br.Kind.Video,e,i,n);this.simulcastCodecs=new Map;this.degradationPreference="balanced";this.monitorSender=()=>bn(this,void 0,void 0,(function*(){if(!this.sender){this._currentBitrate=0;return}let t;try{t=yield this.getSenderStats()}catch(t){this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:t}));return}const e=new Map(t.map((t=>[t.rid,t])));if(this.prevStats){let t=0;e.forEach(((e,i)=>{var n;const s=(n=this.prevStats)===null||n===void 0?void 0:n.get(i);t+=qa(e,s)}));this._currentBitrate=t}this.prevStats=e}));this.senderLock=new d}get isSimulcast(){if(this.sender&&this.sender.getParameters().encodings.length>1){return true}return false}startMonitor(t){var e;this.signalClient=t;if(!Hr()){return}const i=(e=this.sender)===null||e===void 0?void 0:e.getParameters();if(i){this.encodings=i.encodings}if(this.monitorInterval){return}this.monitorInterval=setInterval((()=>{this.monitorSender()}),Fa)}stop(){this._mediaStreamTrack.getConstraints();this.simulcastCodecs.forEach((t=>{t.mediaStreamTrack.stop()}));super.stop()}pauseUpstream(){const t=Object.create(null,{pauseUpstream:{get:()=>super.pauseUpstream}});return bn(this,void 0,void 0,(function*(){var e,i,n,s;var r;yield t.pauseUpstream.call(this);try{for(var o=true,a=yn(this.simulcastCodecs.values()),c;c=yield a.next(),e=c.done,!e;o=true){s=c.value;o=false;const t=s;yield(r=t.sender)===null||r===void 0?void 0:r.replaceTrack(null)}}catch(t){i={error:t}}finally{try{if(!o&&!e&&(n=a.return))yield n.call(a)}finally{if(i)throw i.error}}}))}resumeUpstream(){const t=Object.create(null,{resumeUpstream:{get:()=>super.resumeUpstream}});return bn(this,void 0,void 0,(function*(){var e,i,n,s;var r;yield t.resumeUpstream.call(this);try{for(var o=true,a=yn(this.simulcastCodecs.values()),c;c=yield a.next(),e=c.done,!e;o=true){s=c.value;o=false;const t=s;yield(r=t.sender)===null||r===void 0?void 0:r.replaceTrack(t.mediaStreamTrack)}}catch(t){i={error:t}}finally{try{if(!o&&!e&&(n=a.return))yield n.call(a)}finally{if(i)throw i.error}}}))}mute(){const t=Object.create(null,{mute:{get:()=>super.mute}});return bn(this,void 0,void 0,(function*(){const e=yield this.muteLock.lock();try{if(this.isMuted){this.log.debug("Track already muted",this.logContext);return this}if(this.source===br.Source.Camera&&!this.isUserProvided){this.log.debug("stopping camera track",this.logContext);this._mediaStreamTrack.stop()}yield t.mute.call(this);return this}finally{e()}}))}unmute(){const t=Object.create(null,{unmute:{get:()=>super.unmute}});return bn(this,void 0,void 0,(function*(){const e=yield this.muteLock.lock();try{if(!this.isMuted){this.log.debug("Track already unmuted",this.logContext);return this}if(this.source===br.Source.Camera&&!this.isUserProvided){this.log.debug("reacquiring camera track",this.logContext);yield this.restartTrack()}yield t.unmute.call(this);return this}finally{e()}}))}setTrackMuted(t){super.setTrackMuted(t);for(const e of this.simulcastCodecs.values()){e.mediaStreamTrack.enabled=!t}}getSenderStats(){return bn(this,void 0,void 0,(function*(){var t;if(!((t=this.sender)===null||t===void 0?void 0:t.getStats)){return[]}const e=[];const i=yield this.sender.getStats();i.forEach((t=>{var n;if(t.type==="outbound-rtp"){const s={type:"video",streamId:t.id,frameHeight:t.frameHeight,frameWidth:t.frameWidth,framesPerSecond:t.framesPerSecond,framesSent:t.framesSent,firCount:t.firCount,pliCount:t.pliCount,nackCount:t.nackCount,packetsSent:t.packetsSent,bytesSent:t.bytesSent,qualityLimitationReason:t.qualityLimitationReason,qualityLimitationDurations:t.qualityLimitationDurations,qualityLimitationResolutionChanges:t.qualityLimitationResolutionChanges,rid:(n=t.rid)!==null&&n!==void 0?n:t.id,retransmittedPacketsSent:t.retransmittedPacketsSent,targetBitrate:t.targetBitrate,timestamp:t.timestamp};const r=i.get(t.remoteId);if(r){s.jitter=r.jitter;s.packetsLost=r.packetsLost;s.roundTripTime=r.roundTripTime}e.push(s)}}));e.sort(((t,e)=>{var i,n;return((i=e.frameWidth)!==null&&i!==void 0?i:0)-((n=t.frameWidth)!==null&&n!==void 0?n:0)}));return e}))}setPublishingQuality(t){const e=[];for(let i=pr.LOW;i<=pr.HIGH;i+=1){e.push(new Ui({quality:i,enabled:i<=t}))}this.log.debug("setting publishing quality. max quality ".concat(t),this.logContext);this.setPublishingLayers(e)}restartTrack(t){return bn(this,void 0,void 0,(function*(){var e,i,n,s;var r;let o;if(t){const e=Po({video:t});if(typeof e.video!=="boolean"){o=e.video}}yield this.restart(o);try{for(var a=true,c=yn(this.simulcastCodecs.values()),u;u=yield c.next(),e=u.done,!e;a=true){s=u.value;a=false;const t=s;if(t.sender&&((r=t.sender.transport)===null||r===void 0?void 0:r.state)!=="closed"){t.mediaStreamTrack=this.mediaStreamTrack.clone();yield t.sender.replaceTrack(t.mediaStreamTrack)}}}catch(t){i={error:t}}finally{try{if(!a&&!e&&(n=c.return))yield n.call(c)}finally{if(i)throw i.error}}}))}setProcessor(t){const e=Object.create(null,{setProcessor:{get:()=>super.setProcessor}});return bn(this,arguments,void 0,(function(t){var i=this;let n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;return function*(){var s,r,o,a;var c,u;yield e.setProcessor.call(i,t,n);if((c=i.processor)===null||c===void 0?void 0:c.processedTrack){try{for(var d=true,h=yn(i.simulcastCodecs.values()),l;l=yield h.next(),s=l.done,!s;d=true){a=l.value;d=false;const t=a;yield(u=t.sender)===null||u===void 0?void 0:u.replaceTrack(i.processor.processedTrack)}}catch(t){r={error:t}}finally{try{if(!d&&!s&&(o=h.return))yield o.call(h)}finally{if(r)throw r.error}}}}()}))}setDegradationPreference(t){return bn(this,void 0,void 0,(function*(){this.degradationPreference=t;if(this.sender){try{this.log.debug("setting degradationPreference to ".concat(t),this.logContext);const e=this.sender.getParameters();e.degradationPreference=t;this.sender.setParameters(e)}catch(t){this.log.warn("failed to set degradationPreference",Object.assign({error:t},this.logContext))}}}))}addSimulcastTrack(t,e){if(this.simulcastCodecs.has(t)){this.log.error("".concat(t," already added, skipping adding simulcast codec"),this.logContext);return}const i={codec:t,mediaStreamTrack:this.mediaStreamTrack.clone(),sender:undefined,encodings:e};this.simulcastCodecs.set(t,i);return i}setSimulcastTrackSender(t,e){const i=this.simulcastCodecs.get(t);if(!i){return}i.sender=e;setTimeout((()=>{if(this.subscribedCodecs){this.setPublishingCodecs(this.subscribedCodecs)}}),ac)}setPublishingCodecs(t){return bn(this,void 0,void 0,(function*(){var e,i,n;var s,r,o,a;this.log.debug("setting publishing codecs",Object.assign(Object.assign({},this.logContext),{codecs:t,currentCodec:this.codec}));if(!this.codec&&t.length>0){yield this.setPublishingLayers(t[0].qualities);return[]}this.subscribedCodecs=t;const c=[];try{for(e=true,i=yn(t);n=yield i.next(),s=n.done,!s;e=true){a=n.value;e=false;const t=a;if(!this.codec||this.codec===t.codec){yield this.setPublishingLayers(t.qualities)}else{const e=this.simulcastCodecs.get(t.codec);this.log.debug("try setPublishingCodec for ".concat(t.codec),Object.assign(Object.assign({},this.logContext),{simulcastCodecInfo:e}));if(!e||!e.sender){for(const e of t.qualities){if(e.enabled){c.push(t.codec);break}}}else if(e.encodings){this.log.debug("try setPublishingLayersForSender ".concat(t.codec),this.logContext);yield uc(e.sender,e.encodings,t.qualities,this.senderLock,this.log,this.logContext)}}}}catch(t){r={error:t}}finally{try{if(!e&&!s&&(o=i.return))yield o.call(i)}finally{if(r)throw r.error}}return c}))}setPublishingLayers(t){return bn(this,void 0,void 0,(function*(){this.log.debug("setting publishing layers",Object.assign(Object.assign({},this.logContext),{qualities:t}));if(!this.sender||!this.encodings){return}yield uc(this.sender,this.encodings,t,this.senderLock,this.log,this.logContext)}))}handleAppVisibilityChanged(){const t=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return bn(this,void 0,void 0,(function*(){yield t.handleAppVisibilityChanged.call(this);if(!Jr())return;if(this.isInBackground&&this.source===br.Source.Camera){this._mediaStreamTrack.enabled=false}}))}}function uc(t,e,i,n,s,r){return bn(this,void 0,void 0,(function*(){const o=yield n.lock();s.debug("setPublishingLayersForSender",Object.assign(Object.assign({},r),{sender:t,qualities:i,senderEncodings:e}));try{const n=t.getParameters();const{encodings:o}=n;if(!o){return}if(o.length!==e.length){s.warn("cannot set publishing layers, encodings mismatch",Object.assign(Object.assign({},r),{encodings:o,senderEncodings:e}));return}let a=false;const c=or();const u=(c===null||c===void 0?void 0:c.name)==="Chrome"&&Zr(c===null||c===void 0?void 0:c.version,"133")>0;if(u&&o[0].scalabilityMode){const t=o[0];const n=new rc(t.scalabilityMode);let s=ve.OFF;i.forEach((t=>{if(t.enabled&&(s===ve.OFF||t.quality>s)){s=t.quality}}));if(s===ve.OFF){if(t.active){t.active=false;a=true}}else if(!t.active||n.spatial!==s+1){a=true;t.active=true;const i=new rc(e[0].scalabilityMode);n.spatial=s+1;n.suffix=i.suffix;if(n.spatial===1){n.suffix=undefined}t.scalabilityMode=n.toString();t.scaleResolutionDownBy=Math.pow(2,2-s);if(e[0].maxBitrate){t.maxBitrate=e[0].maxBitrate/(t.scaleResolutionDownBy*t.scaleResolutionDownBy)}}}else{o.forEach(((t,n)=>{var o;let c=(o=t.rid)!==null&&o!==void 0?o:"";if(c===""){c="q"}const u=dc(c);const d=i.find((t=>t.quality===u));if(!d){return}if(t.active!==d.enabled){a=true;t.active=d.enabled;s.debug("setting layer ".concat(d.quality," to ").concat(t.active?"enabled":"disabled"),r);if(qr()){if(d.enabled){t.scaleResolutionDownBy=e[n].scaleResolutionDownBy;t.maxBitrate=e[n].maxBitrate;t.maxFrameRate=e[n].maxFrameRate}else{t.scaleResolutionDownBy=4;t.maxBitrate=10;t.maxFrameRate=2}}}}))}if(a){n.encodings=o;s.debug("setting encodings",Object.assign(Object.assign({},r),{encodings:n.encodings}));yield t.setParameters(n)}}finally{o()}}))}function dc(t){switch(t){case"f":return pr.HIGH;case"h":return pr.MEDIUM;case"q":return pr.LOW;default:return pr.HIGH}}function hc(t,e,i,n){if(!i){return[new Ne({quality:pr.HIGH,width:t,height:e,bitrate:0,ssrc:0})]}if(n){const n=i[0].scalabilityMode;const s=new rc(n);const r=[];const o=s.suffix=="h"?1.5:2;const a=s.suffix=="h"?2:3;for(let n=0;n<s.spatial;n+=1){r.push(new Ne({quality:Math.min(pr.HIGH,s.spatial-1)-n,width:Math.ceil(t/Math.pow(o,n)),height:Math.ceil(e/Math.pow(o,n)),bitrate:i[0].maxBitrate?Math.ceil(i[0].maxBitrate/Math.pow(a,n)):0,ssrc:0}))}return r}return i.map((i=>{var n,s,r;const o=(n=i.scaleResolutionDownBy)!==null&&n!==void 0?n:1;let a=dc((s=i.rid)!==null&&s!==void 0?s:"");return new Ne({quality:a,width:Math.ceil(t/o),height:Math.ceil(e/o),bitrate:(r=i.maxBitrate)!==null&&r!==void 0?r:0,ssrc:0})}))}const lc="_lossy";const fc="_reliable";const mc=2*1e3;const vc="leave-reconnect";var pc;(function(t){t[t["New"]=0]="New";t[t["Connected"]=1]="Connected";t[t["Disconnected"]=2]="Disconnected";t[t["Reconnecting"]=3]="Reconnecting";t[t["Closed"]=4]="Closed"})(pc||(pc={}));class bc extends Sn.EventEmitter{get isClosed(){return this._isClosed}get pendingReconnect(){return!!this.reconnectTimeout}constructor(t){var e;super();this.options=t;this.rtcConfig={};this.peerConnectionTimeout=Na.peerConnectionTimeout;this.fullReconnectOnNext=false;this.subscriberPrimary=false;this.pcState=pc.New;this._isClosed=true;this.pendingTrackResolvers={};this.reconnectAttempts=0;this.reconnectStart=0;this.attemptingReconnect=false;this.joinAttempts=0;this.maxJoinAttempts=1;this.shouldFailNext=false;this.log=dn;this.handleDataChannel=t=>bn(this,[t],void 0,(function(t){var e=this;let{channel:i}=t;return function*(){if(!i){return}if(i.label===fc){e.reliableDCSub=i}else if(i.label===lc){e.lossyDCSub=i}else{return}e.log.debug("on data channel ".concat(i.id,", ").concat(i.label),e.logContext);i.onmessage=e.handleDataMessage}()}));this.handleDataMessage=t=>bn(this,void 0,void 0,(function*(){var e,i;const n=yield this.dataProcessLock.lock();try{let n;if(t.data instanceof ArrayBuffer){n=t.data}else if(t.data instanceof Blob){n=yield t.data.arrayBuffer()}else{this.log.error("unsupported data type",Object.assign(Object.assign({},this.logContext),{data:t.data}));return}const s=De.fromBinary(new Uint8Array(n));if(((e=s.value)===null||e===void 0?void 0:e.case)==="speaker"){this.emit(er.ActiveSpeakersUpdate,s.value.value.speakers)}else{if(((i=s.value)===null||i===void 0?void 0:i.case)==="user"){kc(s,s.value.value)}this.emit(er.DataPacketReceived,s)}}finally{n()}}));this.handleDataError=t=>{const e=t.currentTarget;const i=e.maxRetransmits===0?"lossy":"reliable";if(t instanceof ErrorEvent&&t.error){const{error:e}=t.error;this.log.error("DataChannel error on ".concat(i,": ").concat(t.message),Object.assign(Object.assign({},this.logContext),{error:e}))}else{this.log.error("Unknown DataChannel error on ".concat(i),Object.assign(Object.assign({},this.logContext),{event:t}))}};this.handleBufferedAmountLow=t=>{const e=t.currentTarget;const i=e.maxRetransmits===0?Ae.LOSSY:Ae.RELIABLE;this.updateAndEmitDCBufferStatus(i)};this.handleDisconnect=(t,e)=>{if(this._isClosed){return}this.log.warn("".concat(t," disconnected"),this.logContext);if(this.reconnectAttempts===0){this.reconnectStart=Date.now()}const i=t=>{this.log.warn("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(t,"ms. giving up"),this.logContext);this.emit(er.Disconnected);this.close()};const n=Date.now()-this.reconnectStart;let s=this.getNextRetryDelay({elapsedMs:n,retryCount:this.reconnectAttempts});if(s===null){i(n);return}if(t===vc){s=0}this.log.debug("reconnecting in ".concat(s,"ms"),this.logContext);this.clearReconnectTimeout();if(this.token&&this.regionUrlProvider){this.regionUrlProvider.updateToken(this.token)}this.reconnectTimeout=fr.setTimeout((()=>this.attemptReconnect(e).finally((()=>this.reconnectTimeout=undefined))),s)};this.waitForRestarted=()=>new Promise(((t,e)=>{if(this.pcState===pc.Connected){t()}const i=()=>{this.off(er.Disconnected,n);t()};const n=()=>{this.off(er.Restarted,i);e()};this.once(er.Restarted,i);this.once(er.Disconnected,n)}));this.updateAndEmitDCBufferStatus=t=>{const e=this.isBufferStatusLow(t);if(typeof e!=="undefined"&&e!==this.dcBufferStatus.get(t)){this.dcBufferStatus.set(t,e);this.emit(er.DCBufferStatusChanged,e,t)}};this.isBufferStatusLow=t=>{const e=this.dataChannelForKind(t);if(e){return e.bufferedAmount<=e.bufferedAmountLowThreshold}};this.handleBrowserOnLine=()=>{if(this.client.currentState===ea.RECONNECTING){this.clearReconnectTimeout();this.attemptReconnect(ye.RR_SIGNAL_DISCONNECTED)}};this.log=hn((e=t.loggerName)!==null&&e!==void 0?e:un.Engine);this.loggerOptions={loggerName:t.loggerName,loggerContextCb:()=>this.logContext};this.client=new ia(undefined,this.loggerOptions);this.client.signalLatency=this.options.expSignalLatency;this.reconnectPolicy=this.options.reconnectPolicy;this.registerOnLineListener();this.closingLock=new d;this.dataProcessLock=new d;this.dcBufferStatus=new Map([[Ae.LOSSY,true],[Ae.RELIABLE,true]]);this.client.onParticipantUpdate=t=>this.emit(er.ParticipantUpdate,t);this.client.onConnectionQuality=t=>this.emit(er.ConnectionQualityUpdate,t);this.client.onRoomUpdate=t=>this.emit(er.RoomUpdate,t);this.client.onSubscriptionError=t=>this.emit(er.SubscriptionError,t);this.client.onSubscriptionPermissionUpdate=t=>this.emit(er.SubscriptionPermissionUpdate,t);this.client.onSpeakersChanged=t=>this.emit(er.SpeakersChanged,t);this.client.onStreamStateUpdate=t=>this.emit(er.StreamStateChanged,t);this.client.onRequestResponse=t=>this.emit(er.SignalRequestResponse,t)}get logContext(){var t,e,i,n,s,r,o,a;return{room:(e=(t=this.latestJoinResponse)===null||t===void 0?void 0:t.room)===null||e===void 0?void 0:e.name,roomID:(n=(i=this.latestJoinResponse)===null||i===void 0?void 0:i.room)===null||n===void 0?void 0:n.sid,participant:(r=(s=this.latestJoinResponse)===null||s===void 0?void 0:s.participant)===null||r===void 0?void 0:r.identity,pID:(a=(o=this.latestJoinResponse)===null||o===void 0?void 0:o.participant)===null||a===void 0?void 0:a.sid}}join(t,e,i,n){return bn(this,void 0,void 0,(function*(){this.url=t;this.token=e;this.signalOpts=i;this.maxJoinAttempts=i.maxRetries;try{this.joinAttempts+=1;this.setupSignalClientCallbacks();const s=yield this.client.join(t,e,i,n);this._isClosed=false;this.latestJoinResponse=s;this.subscriberPrimary=s.subscriberPrimary;if(!this.pcManager){yield this.configure(s)}if(!this.subscriberPrimary||s.fastPublish){this.negotiate()}this.clientConfiguration=s.clientConfiguration;setTimeout((()=>{this.emit(er.SignalConnected)}),10);return s}catch(s){if(s instanceof Js){if(s.reason===Vs.ServerUnreachable){this.log.warn("Couldn't connect to server, attempt ".concat(this.joinAttempts," of ").concat(this.maxJoinAttempts),this.logContext);if(this.joinAttempts<this.maxJoinAttempts){return this.join(t,e,i,n)}}}throw s}}))}close(){return bn(this,void 0,void 0,(function*(){const t=yield this.closingLock.lock();if(this.isClosed){t();return}try{this._isClosed=true;this.joinAttempts=0;this.emit(er.Closing);this.removeAllListeners();this.deregisterOnLineListener();this.clearPendingReconnect();yield this.cleanupPeerConnections();yield this.cleanupClient()}finally{t()}}))}cleanupPeerConnections(){return bn(this,void 0,void 0,(function*(){var t;yield(t=this.pcManager)===null||t===void 0?void 0:t.close();this.pcManager=undefined;const e=t=>{if(!t)return;t.close();t.onbufferedamountlow=null;t.onclose=null;t.onclosing=null;t.onerror=null;t.onmessage=null;t.onopen=null};e(this.lossyDC);e(this.lossyDCSub);e(this.reliableDC);e(this.reliableDCSub);this.lossyDC=undefined;this.lossyDCSub=undefined;this.reliableDC=undefined;this.reliableDCSub=undefined}))}cleanupClient(){return bn(this,void 0,void 0,(function*(){yield this.client.close();this.client.resetCallbacks()}))}addTrack(t){if(this.pendingTrackResolvers[t.cid]){throw new Hs("a track with the same ID has already been published")}return new Promise(((e,i)=>{const n=setTimeout((()=>{delete this.pendingTrackResolvers[t.cid];i(new Js("publication of local track timed out, no response from server",Vs.InternalError))}),1e4);this.pendingTrackResolvers[t.cid]={resolve:t=>{clearTimeout(n);e(t)},reject:()=>{clearTimeout(n);i(new Error("Cancelled publication by calling unpublish"))}};this.client.sendAddTrack(t)}))}removeTrack(t){if(t.track&&this.pendingTrackResolvers[t.track.id]){const{reject:e}=this.pendingTrackResolvers[t.track.id];if(e){e()}delete this.pendingTrackResolvers[t.track.id]}try{this.pcManager.removeTrack(t);return true}catch(t){this.log.warn("failed to remove track",Object.assign(Object.assign({},this.logContext),{error:t}))}return false}updateMuteStatus(t,e){this.client.sendMuteTrack(t,e)}get dataSubscriberReadyState(){var t;return(t=this.reliableDCSub)===null||t===void 0?void 0:t.readyState}getConnectedServerAddress(){return bn(this,void 0,void 0,(function*(){var t;return(t=this.pcManager)===null||t===void 0?void 0:t.getConnectedAddress()}))}setRegionUrlProvider(t){this.regionUrlProvider=t}configure(t){return bn(this,void 0,void 0,(function*(){var e,i;if(this.pcManager&&this.pcManager.currentState!==Da.NEW){return}this.participantSid=(e=t.participant)===null||e===void 0?void 0:e.sid;const n=this.makeRTCConfiguration(t);this.pcManager=new Aa(n,t.subscriberPrimary,this.loggerOptions);this.emit(er.TransportsCreated,this.pcManager.publisher,this.pcManager.subscriber);this.pcManager.onIceCandidate=(t,e)=>{this.client.sendIceCandidate(t,e)};this.pcManager.onPublisherOffer=t=>{this.client.sendOffer(t)};this.pcManager.onDataChannel=this.handleDataChannel;this.pcManager.onStateChange=(e,i,n)=>bn(this,void 0,void 0,(function*(){this.log.debug("primary PC state changed ".concat(e),this.logContext);if(["closed","disconnected","failed"].includes(i)){this.publisherConnectionPromise=undefined}if(e===Da.CONNECTED){const e=this.pcState===pc.New;this.pcState=pc.Connected;if(e){this.emit(er.Connected,t)}}else if(e===Da.FAILED){if(this.pcState===pc.Connected){this.pcState=pc.Disconnected;this.handleDisconnect("peerconnection failed",n==="failed"?ye.RR_SUBSCRIBER_FAILED:ye.RR_PUBLISHER_FAILED)}}const s=this.client.isDisconnected||this.client.currentState===ea.RECONNECTING;const r=[Da.FAILED,Da.CLOSING,Da.CLOSED].includes(e);if(s&&r&&!this._isClosed){this.emit(er.Offline)}}));this.pcManager.onTrack=t=>{this.emit(er.MediaTrackAdded,t.track,t.streams[0],t.receiver)};if(!yc((i=t.serverInfo)===null||i===void 0?void 0:i.protocol)){this.createDataChannels()}}))}setupSignalClientCallbacks(){this.client.onAnswer=t=>bn(this,void 0,void 0,(function*(){if(!this.pcManager){return}this.log.debug("received server answer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:t.type}));yield this.pcManager.setPublisherAnswer(t)}));this.client.onTrickle=(t,e)=>{if(!this.pcManager){return}this.log.debug("got ICE candidate from peer",Object.assign(Object.assign({},this.logContext),{candidate:t,target:e}));this.pcManager.addIceCandidate(t,e)};this.client.onOffer=t=>bn(this,void 0,void 0,(function*(){if(!this.pcManager){return}const e=yield this.pcManager.createSubscriberAnswerFromOffer(t);this.client.sendAnswer(e)}));this.client.onLocalTrackPublished=t=>{var e;this.log.debug("received trackPublishedResponse",Object.assign(Object.assign({},this.logContext),{cid:t.cid,track:(e=t.track)===null||e===void 0?void 0:e.sid}));if(!this.pendingTrackResolvers[t.cid]){this.log.error("missing track resolver for ".concat(t.cid),Object.assign(Object.assign({},this.logContext),{cid:t.cid}));return}const{resolve:i}=this.pendingTrackResolvers[t.cid];delete this.pendingTrackResolvers[t.cid];i(t.track)};this.client.onLocalTrackUnpublished=t=>{this.emit(er.LocalTrackUnpublished,t)};this.client.onLocalTrackSubscribed=t=>{this.emit(er.LocalTrackSubscribed,t)};this.client.onTokenRefresh=t=>{this.token=t};this.client.onRemoteMuteChanged=(t,e)=>{this.emit(er.RemoteMute,t,e)};this.client.onSubscribedQualityUpdate=t=>{this.emit(er.SubscribedQualityUpdate,t)};this.client.onRoomMoved=t=>{var e;this.participantSid=(e=t.participant)===null||e===void 0?void 0:e.sid;this.emit(er.RoomMoved,t)};this.client.onClose=()=>{this.handleDisconnect("signal",ye.RR_SIGNAL_DISCONNECTED)};this.client.onLeave=t=>{this.log.debug("client leave request",Object.assign(Object.assign({},this.logContext),{reason:t===null||t===void 0?void 0:t.reason}));if(t.regions&&this.regionUrlProvider){this.log.debug("updating regions",this.logContext);this.regionUrlProvider.setServerReportedRegions(t.regions)}switch(t.action){case ji.DISCONNECT:this.emit(er.Disconnected,t===null||t===void 0?void 0:t.reason);this.close();break;case ji.RECONNECT:this.fullReconnectOnNext=true;this.handleDisconnect(vc);break;case ji.RESUME:this.handleDisconnect(vc)}}}makeRTCConfiguration(t){var e;const i=Object.assign({},this.rtcConfig);if((e=this.signalOpts)===null||e===void 0?void 0:e.e2eeEnabled){this.log.debug("E2EE - setting up transports with insertable streams",this.logContext);i.encodedInsertableStreams=true}if(t.iceServers&&!i.iceServers){const e=[];t.iceServers.forEach((t=>{const i={urls:t.urls};if(t.username)i.username=t.username;if(t.credential){i.credential=t.credential}e.push(i)}));i.iceServers=e}if(t.clientConfiguration&&t.clientConfiguration.forceRelay===be.ENABLED){i.iceTransportPolicy="relay"}i.sdpSemantics="unified-plan";i.continualGatheringPolicy="gather_continually";return i}createDataChannels(){if(!this.pcManager){return}if(this.lossyDC){this.lossyDC.onmessage=null;this.lossyDC.onerror=null}if(this.reliableDC){this.reliableDC.onmessage=null;this.reliableDC.onerror=null}this.lossyDC=this.pcManager.createPublisherDataChannel(lc,{ordered:true,maxRetransmits:0});this.reliableDC=this.pcManager.createPublisherDataChannel(fc,{ordered:true});this.lossyDC.onmessage=this.handleDataMessage;this.reliableDC.onmessage=this.handleDataMessage;this.lossyDC.onerror=this.handleDataError;this.reliableDC.onerror=this.handleDataError;this.lossyDC.bufferedAmountLowThreshold=65535;this.reliableDC.bufferedAmountLowThreshold=65535;this.lossyDC.onbufferedamountlow=this.handleBufferedAmountLow;this.reliableDC.onbufferedamountlow=this.handleBufferedAmountLow}createSender(t,e,i){return bn(this,void 0,void 0,(function*(){if(Dr()){const n=yield this.createTransceiverRTCRtpSender(t,e,i);return n}if(Ar()){this.log.warn("using add-track fallback",this.logContext);const e=yield this.createRTCRtpSender(t.mediaStreamTrack);return e}throw new Ws("Required webRTC APIs not supported on this device")}))}createSimulcastSender(t,e,i,n){return bn(this,void 0,void 0,(function*(){if(Dr()){return this.createSimulcastTransceiverSender(t,e,i,n)}if(Ar()){this.log.debug("using add-track fallback",this.logContext);return this.createRTCRtpSender(t.mediaStreamTrack)}throw new Ws("Cannot stream on this device")}))}createTransceiverRTCRtpSender(t,e,i){return bn(this,void 0,void 0,(function*(){if(!this.pcManager){throw new Ws("publisher is closed")}const n=[];if(t.mediaStream){n.push(t.mediaStream)}if(wo(t)){t.codec=e.videoCodec}const s={direction:"sendonly",streams:n};if(i){s.sendEncodings=i}const r=yield this.pcManager.addPublisherTransceiver(t.mediaStreamTrack,s);return r.sender}))}createSimulcastTransceiverSender(t,e,i,n){return bn(this,void 0,void 0,(function*(){if(!this.pcManager){throw new Ws("publisher is closed")}const s={direction:"sendonly"};if(n){s.sendEncodings=n}const r=yield this.pcManager.addPublisherTransceiver(e.mediaStreamTrack,s);if(!i.videoCodec){return}t.setSimulcastTrackSender(i.videoCodec,r.sender);return r.sender}))}createRTCRtpSender(t){return bn(this,void 0,void 0,(function*(){if(!this.pcManager){throw new Ws("publisher is closed")}return this.pcManager.addPublisherTrack(t)}))}attemptReconnect(t){return bn(this,void 0,void 0,(function*(){var e,i,n;if(this._isClosed){return}if(this.attemptingReconnect){dn.warn("already attempting reconnect, returning early",this.logContext);return}if(((e=this.clientConfiguration)===null||e===void 0?void 0:e.resumeConnection)===be.DISABLED||((n=(i=this.pcManager)===null||i===void 0?void 0:i.currentState)!==null&&n!==void 0?n:Da.NEW)===Da.NEW){this.fullReconnectOnNext=true}try{this.attemptingReconnect=true;if(this.fullReconnectOnNext){yield this.restartConnection()}else{yield this.resumeConnection(t)}this.clearPendingReconnect();this.fullReconnectOnNext=false}catch(t){this.reconnectAttempts+=1;let e=true;if(t instanceof Ws){this.log.debug("received unrecoverable error",Object.assign(Object.assign({},this.logContext),{error:t}));e=false}else if(!(t instanceof gc)){this.fullReconnectOnNext=true}if(e){this.handleDisconnect("reconnect",ye.RR_UNKNOWN)}else{this.log.info("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(Date.now()-this.reconnectStart,"ms. giving up"),this.logContext);this.emit(er.Disconnected);yield this.close()}}finally{this.attemptingReconnect=false}}))}getNextRetryDelay(t){try{return this.reconnectPolicy.nextRetryDelayInMs(t)}catch(t){this.log.warn("encountered error in reconnect policy",Object.assign(Object.assign({},this.logContext),{error:t}))}return null}restartConnection(t){return bn(this,void 0,void 0,(function*(){var e,i,n;try{if(!this.url||!this.token){throw new Ws("could not reconnect, url or token not saved")}this.log.info("reconnecting, attempt: ".concat(this.reconnectAttempts),this.logContext);this.emit(er.Restarting);if(!this.client.isDisconnected){yield this.client.sendLeave()}yield this.cleanupPeerConnections();yield this.cleanupClient();let i;try{if(!this.signalOpts){this.log.warn("attempted connection restart, without signal options present",this.logContext);throw new gc}i=yield this.join(t!==null&&t!==void 0?t:this.url,this.token,this.signalOpts)}catch(t){if(t instanceof Js&&t.reason===Vs.NotAllowed){throw new Ws("could not reconnect, token might be expired")}throw new gc}if(this.shouldFailNext){this.shouldFailNext=false;throw new Error("simulated failure")}this.client.setReconnected();this.emit(er.SignalRestarted,i);yield this.waitForPCReconnected();if(this.client.currentState!==ea.CONNECTED){throw new gc("Signal connection got severed during reconnect")}(e=this.regionUrlProvider)===null||e===void 0?void 0:e.resetAttempts();this.emit(er.Restarted)}catch(t){const e=yield(i=this.regionUrlProvider)===null||i===void 0?void 0:i.getNextBestRegionUrl();if(e){yield this.restartConnection(e);return}else{(n=this.regionUrlProvider)===null||n===void 0?void 0:n.resetAttempts();throw t}}}))}resumeConnection(t){return bn(this,void 0,void 0,(function*(){var e;if(!this.url||!this.token){throw new Ws("could not reconnect, url or token not saved")}if(!this.pcManager){throw new Ws("publisher and subscriber connections unset")}this.log.info("resuming signal connection, attempt ".concat(this.reconnectAttempts),this.logContext);this.emit(er.Resuming);let i;try{this.setupSignalClientCallbacks();i=yield this.client.reconnect(this.url,this.token,this.participantSid,t)}catch(t){let e="";if(t instanceof Error){e=t.message;this.log.error(t.message,Object.assign(Object.assign({},this.logContext),{error:t}))}if(t instanceof Js&&t.reason===Vs.NotAllowed){throw new Ws("could not reconnect, token might be expired")}if(t instanceof Js&&t.reason===Vs.LeaveRequest){throw t}throw new gc(e)}this.emit(er.SignalResumed);if(i){const t=this.makeRTCConfiguration(i);this.pcManager.updateConfiguration(t)}else{this.log.warn("Did not receive reconnect response",this.logContext)}if(this.shouldFailNext){this.shouldFailNext=false;throw new Error("simulated failure")}yield this.pcManager.triggerIceRestart();yield this.waitForPCReconnected();if(this.client.currentState!==ea.CONNECTED){throw new gc("Signal connection got severed during reconnect")}this.client.setReconnected();if(((e=this.reliableDC)===null||e===void 0?void 0:e.readyState)==="open"&&this.reliableDC.id===null){this.createDataChannels()}this.emit(er.Resumed)}))}waitForPCInitialConnection(t,e){return bn(this,void 0,void 0,(function*(){if(!this.pcManager){throw new Ws("PC manager is closed")}yield this.pcManager.ensurePCTransportConnection(e,t)}))}waitForPCReconnected(){return bn(this,void 0,void 0,(function*(){this.pcState=pc.Reconnecting;this.log.debug("waiting for peer connection to reconnect",this.logContext);try{yield Nr(mc);if(!this.pcManager){throw new Ws("PC manager is closed")}yield this.pcManager.ensurePCTransportConnection(undefined,this.peerConnectionTimeout);this.pcState=pc.Connected}catch(t){this.pcState=pc.Disconnected;throw new Js("could not establish PC connection, ".concat(t.message),Vs.InternalError)}}))}publishRpcResponse(t,e,i,n){return bn(this,void 0,void 0,(function*(){const s=new De({destinationIdentities:[t],kind:Ae.RELIABLE,value:{case:"rpcResponse",value:new Ge({requestId:e,value:n?{case:"error",value:n.toProto()}:{case:"payload",value:i!==null&&i!==void 0?i:""}})}});yield this.sendDataPacket(s,Ae.RELIABLE)}))}publishRpcAck(t,e){return bn(this,void 0,void 0,(function*(){const i=new De({destinationIdentities:[t],kind:Ae.RELIABLE,value:{case:"rpcAck",value:new Je({requestId:e})}});yield this.sendDataPacket(i,Ae.RELIABLE)}))}sendDataPacket(t,e){return bn(this,void 0,void 0,(function*(){const i=t.toBinary();yield this.ensurePublisherConnected(e);const n=this.dataChannelForKind(e);if(n){n.send(i)}this.updateAndEmitDCBufferStatus(e)}))}waitForBufferStatusLow(t){return new Promise(((e,i)=>bn(this,void 0,void 0,(function*(){if(this.isBufferStatusLow(t)){e()}else{const n=()=>i("Engine closed");this.once(er.Closing,n);while(!this.dcBufferStatus.get(t)){yield Nr(10)}this.off(er.Closing,n);e()}}))))}ensureDataTransportConnected(t){return bn(this,arguments,void 0,(function(t){var e=this;let i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:this.subscriberPrimary;return function*(){var n;if(!e.pcManager){throw new Ws("PC manager is closed")}const s=i?e.pcManager.subscriber:e.pcManager.publisher;const r=i?"Subscriber":"Publisher";if(!s){throw new Js("".concat(r," connection not set"),Vs.InternalError)}let o=false;if(!i&&!e.dataChannelForKind(t,i)){e.createDataChannels();o=true}if(!o&&!i&&!e.pcManager.publisher.isICEConnected&&e.pcManager.publisher.getICEConnectionState()!=="checking"){o=true}if(o){e.negotiate()}const a=e.dataChannelForKind(t,i);if((a===null||a===void 0?void 0:a.readyState)==="open"){return}const c=(new Date).getTime()+e.peerConnectionTimeout;while((new Date).getTime()<c){if(s.isICEConnected&&((n=e.dataChannelForKind(t,i))===null||n===void 0?void 0:n.readyState)==="open"){return}yield Nr(50)}throw new Js("could not establish ".concat(r," connection, state: ").concat(s.getICEConnectionState()),Vs.InternalError)}()}))}ensurePublisherConnected(t){return bn(this,void 0,void 0,(function*(){if(!this.publisherConnectionPromise){this.publisherConnectionPromise=this.ensureDataTransportConnected(t,false)}yield this.publisherConnectionPromise}))}verifyTransport(){if(!this.pcManager){return false}if(this.pcManager.currentState!==Da.CONNECTED){return false}if(!this.client.ws||this.client.ws.readyState===WebSocket.CLOSED){return false}return true}negotiate(){return bn(this,void 0,void 0,(function*(){return new Promise(((t,e)=>bn(this,void 0,void 0,(function*(){if(!this.pcManager){e(new Ks("PC manager is closed"));return}this.pcManager.requirePublisher();if(this.pcManager.publisher.getTransceivers().length==0&&!this.lossyDC&&!this.reliableDC){this.createDataChannels()}const i=new AbortController;const n=()=>{i.abort();this.log.debug("engine disconnected while negotiation was ongoing",this.logContext);t();return};if(this.isClosed){e("cannot negotiate on closed engine")}this.on(er.Closing,n);this.pcManager.publisher.once(Ta.RTPVideoPayloadTypes,(t=>{const e=new Map;t.forEach((t=>{const i=t.codec.toLowerCase();if(uo(i)){e.set(t.payload,i)}}));this.emit(er.RTPVideoMapUpdate,e)}));try{yield this.pcManager.negotiate(i);t()}catch(t){if(t instanceof Ks){this.fullReconnectOnNext=true}this.handleDisconnect("negotiation",ye.RR_UNKNOWN);e(t)}finally{this.off(er.Closing,n)}}))))}))}dataChannelForKind(t,e){if(!e){if(t===Ae.LOSSY){return this.lossyDC}if(t===Ae.RELIABLE){return this.reliableDC}}else{if(t===Ae.LOSSY){return this.lossyDCSub}if(t===Ae.RELIABLE){return this.reliableDCSub}}}sendSyncState(t,e){var i,n;if(!this.pcManager){this.log.warn("sync state cannot be sent without peer connection setup",this.logContext);return}const s=this.pcManager.subscriber.getLocalDescription();const r=this.pcManager.subscriber.getRemoteDescription();const o=(n=(i=this.signalOpts)===null||i===void 0?void 0:i.autoSubscribe)!==null&&n!==void 0?n:true;const a=new Array;const c=new Array;t.forEach((t=>{if(t.isDesired!==o){a.push(t.trackSid)}if(!t.isEnabled){c.push(t.trackSid)}}));this.client.sendSyncState(new Gi({answer:s?sa({sdp:s.sdp,type:s.type}):undefined,offer:r?sa({sdp:r.sdp,type:r.type}):undefined,subscription:new Ti({trackSids:a,subscribe:!o,participantTracks:[]}),publishTracks:Lo(e),dataChannels:this.dataChannelsInfo(),trackSidsDisabled:c}))}failNext(){this.shouldFailNext=true}dataChannelsInfo(){const t=[];const e=(e,i)=>{if((e===null||e===void 0?void 0:e.id)!==undefined&&e.id!==null){t.push(new Hi({label:e.label,id:e.id,target:i}))}};e(this.dataChannelForKind(Ae.LOSSY),ai.PUBLISHER);e(this.dataChannelForKind(Ae.RELIABLE),ai.PUBLISHER);e(this.dataChannelForKind(Ae.LOSSY,true),ai.SUBSCRIBER);e(this.dataChannelForKind(Ae.RELIABLE,true),ai.SUBSCRIBER);return t}clearReconnectTimeout(){if(this.reconnectTimeout){fr.clearTimeout(this.reconnectTimeout)}}clearPendingReconnect(){this.clearReconnectTimeout();this.reconnectAttempts=0}registerOnLineListener(){if(Hr()){window.addEventListener("online",this.handleBrowserOnLine)}}deregisterOnLineListener(){if(Hr()){window.removeEventListener("online",this.handleBrowserOnLine)}}}class gc extends Error{}function yc(t){return t!==undefined&&t>13}function kc(t,e){const i=t.participantIdentity?t.participantIdentity:e.participantIdentity;t.participantIdentity=i;e.participantIdentity=i;const n=t.destinationIdentities.length!==0?t.destinationIdentities:e.destinationIdentities;t.destinationIdentities=n;e.destinationIdentities=n}class wc{constructor(t,e){this.lastUpdateAt=0;this.settingsCacheTime=3e3;this.attemptedRegions=[];this.serverUrl=new URL(t);this.token=e}updateToken(t){this.token=t}isCloud(){return Wr(this.serverUrl)}getServerUrl(){return this.serverUrl}getNextBestRegionUrl(t){return bn(this,void 0,void 0,(function*(){if(!this.isCloud()){throw Error("region availability is only supported for LiveKit Cloud domains")}if(!this.regionSettings||Date.now()-this.lastUpdateAt>this.settingsCacheTime){this.regionSettings=yield this.fetchRegionSettings(t)}const e=this.regionSettings.regions.filter((t=>!this.attemptedRegions.find((e=>e.url===t.url))));if(e.length>0){const t=e[0];this.attemptedRegions.push(t);dn.debug("next region: ".concat(t.region));return t.url}else{return null}}))}resetAttempts(){this.attemptedRegions=[]}fetchRegionSettings(t){return bn(this,void 0,void 0,(function*(){const e=yield fetch("".concat(Tc(this.serverUrl),"/regions"),{headers:{authorization:"Bearer ".concat(this.token)},signal:t});if(e.ok){const t=yield e.json();this.lastUpdateAt=Date.now();return t}else{throw new Js("Could not fetch region settings: ".concat(e.statusText),e.status===401?Vs.NotAllowed:Vs.InternalError,e.status)}}))}setServerReportedRegions(t){this.regionSettings=t;this.lastUpdateAt=Date.now()}}function Tc(t){return"".concat(t.protocol.replace("ws","http"),"//").concat(t.host,"/settings")}class Sc{get info(){return this._info}constructor(t,e,i){this.reader=e;this.totalByteSize=i;this._info=t;this.bytesReceived=0}}class Oc extends Sc{handleChunkReceived(t){var e;this.bytesReceived+=t.content.byteLength;const i=this.totalByteSize?this.bytesReceived/this.totalByteSize:undefined;(e=this.onProgress)===null||e===void 0?void 0:e.call(this,i)}[Symbol.asyncIterator](){const t=this.reader.getReader();return{next:()=>bn(this,void 0,void 0,(function*(){try{const{done:e,value:i}=yield t.read();if(e){return{done:true,value:undefined}}else{this.handleChunkReceived(i);return{done:false,value:i.content}}}catch(t){return{done:true,value:undefined}}})),return(){return bn(this,void 0,void 0,(function*(){t.releaseLock();return{done:true,value:undefined}}))}}}readAll(){return bn(this,void 0,void 0,(function*(){var t,e,i,n;let s=new Set;try{for(var r=true,o=yn(this),a;a=yield o.next(),t=a.done,!t;r=true){n=a.value;r=false;const t=n;s.add(t)}}catch(t){e={error:t}}finally{try{if(!r&&!t&&(i=o.return))yield i.call(o)}finally{if(e)throw e.error}}return Array.from(s)}))}}class Ec extends Sc{constructor(t,e,i){super(t,e,i);this.receivedChunks=new Map}handleChunkReceived(t){var e;const i=bo(t.chunkIndex);const n=this.receivedChunks.get(i);if(n&&n.version>t.version){return}this.receivedChunks.set(i,t);this.bytesReceived+=t.content.byteLength;const s=this.totalByteSize?this.bytesReceived/this.totalByteSize:undefined;(e=this.onProgress)===null||e===void 0?void 0:e.call(this,s)}[Symbol.asyncIterator](){const t=this.reader.getReader();const e=new TextDecoder;return{next:()=>bn(this,void 0,void 0,(function*(){try{const{done:i,value:n}=yield t.read();if(i){return{done:true,value:undefined}}else{this.handleChunkReceived(n);return{done:false,value:e.decode(n.content)}}}catch(t){return{done:true,value:undefined}}})),return(){return bn(this,void 0,void 0,(function*(){t.releaseLock();return{done:true,value:undefined}}))}}}readAll(){return bn(this,void 0,void 0,(function*(){var t,e,i,n;let s="";try{for(var r=true,o=yn(this),a;a=yield o.next(),t=a.done,!t;r=true){n=a.value;r=false;const t=n;s+=t}}catch(t){e={error:t}}finally{try{if(!r&&!t&&(i=o.return))yield i.call(o)}finally{if(e)throw e.error}}return s}))}}class Cc{constructor(t,e,i){this.writableStream=t;this.defaultWriter=t.getWriter();this.onClose=i;this.info=e}write(t){return this.defaultWriter.write(t)}close(){return bn(this,void 0,void 0,(function*(){var t;yield this.defaultWriter.close();this.defaultWriter.releaseLock();(t=this.onClose)===null||t===void 0?void 0:t.call(this)}))}}class jc extends Cc{}class Rc extends Cc{}class Ic extends br{constructor(t,e,i,n,s){super(t,i,s);this.sid=e;this.receiver=n}get isLocal(){return false}setMuted(t){if(this.isMuted!==t){this.isMuted=t;this._mediaStreamTrack.enabled=!t;this.emit(t?ir.Muted:ir.Unmuted,this)}}setMediaStream(t){this.mediaStream=t;const e=i=>{if(i.track===this._mediaStreamTrack){t.removeEventListener("removetrack",e);if(this.receiver&&"playoutDelayHint"in this.receiver){this.receiver.playoutDelayHint=undefined}this.receiver=undefined;this._currentBitrate=0;this.emit(ir.Ended,this)}};t.addEventListener("removetrack",e)}start(){this.startMonitor();super.enable()}stop(){this.stopMonitor();super.disable()}getRTCStatsReport(){return bn(this,void 0,void 0,(function*(){var t;if(!((t=this.receiver)===null||t===void 0?void 0:t.getStats)){return}const e=yield this.receiver.getStats();return e}))}setPlayoutDelay(t){if(this.receiver){if("playoutDelayHint"in this.receiver){this.receiver.playoutDelayHint=t}else{this.log.warn("Playout delay not supported in this browser")}}else{this.log.warn("Cannot set playout delay, track already ended")}}getPlayoutDelay(){if(this.receiver){if("playoutDelayHint"in this.receiver){return this.receiver.playoutDelayHint}else{this.log.warn("Playout delay not supported in this browser")}}else{this.log.warn("Cannot get playout delay, track already ended")}return 0}startMonitor(){if(!this.monitorInterval){this.monitorInterval=setInterval((()=>this.monitorReceiver()),Fa)}if(qo()){this.registerTimeSyncUpdate()}}registerTimeSyncUpdate(){const t=()=>{var e;this.timeSyncHandle=requestAnimationFrame((()=>t()));const i=(e=this.receiver)===null||e===void 0?void 0:e.getSynchronizationSources()[0];if(i){const{timestamp:t,rtpTimestamp:e}=i;if(e&&this.rtpTimestamp!==e){this.emit(ir.TimeSyncUpdate,{timestamp:t,rtpTimestamp:e});this.rtpTimestamp=e}}};t()}}class _c extends Ic{constructor(t,e,i,n,s,r){super(t,e,br.Kind.Audio,i,r);this.monitorReceiver=()=>bn(this,void 0,void 0,(function*(){if(!this.receiver){this._currentBitrate=0;return}const t=yield this.getReceiverStats();if(t&&this.prevStats&&this.receiver){this._currentBitrate=qa(t,this.prevStats)}this.prevStats=t}));this.audioContext=n;this.webAudioPluginNodes=[];if(s){this.sinkId=s.deviceId}}setVolume(t){var e;for(const i of this.attachedElements){if(this.audioContext){(e=this.gainNode)===null||e===void 0?void 0:e.gain.setTargetAtTime(t,0,.1)}else{i.volume=t}}if(zr()){this._mediaStreamTrack._setVolume(t)}this.elementVolume=t}getVolume(){if(this.elementVolume){return this.elementVolume}if(zr()){return 1}let t=0;this.attachedElements.forEach((e=>{if(e.volume>t){t=e.volume}}));return t}setSinkId(t){return bn(this,void 0,void 0,(function*(){this.sinkId=t;yield Promise.all(this.attachedElements.map((e=>{if(!Lr(e)){return}return e.setSinkId(t)})))}))}attach(t){const e=this.attachedElements.length===0;if(!t){t=super.attach()}else{super.attach(t)}if(this.sinkId&&Lr(t)){t.setSinkId(this.sinkId).catch((t=>{this.log.error("Failed to set sink id on remote audio track",t,this.logContext)}))}if(this.audioContext&&e){this.log.debug("using audio context mapping",this.logContext);this.connectWebAudio(this.audioContext,t);t.volume=0;t.muted=true}if(this.elementVolume){this.setVolume(this.elementVolume)}return t}detach(t){let e;if(!t){e=super.detach();this.disconnectWebAudio()}else{e=super.detach(t);if(this.audioContext){if(this.attachedElements.length>0){this.connectWebAudio(this.audioContext,this.attachedElements[0])}else{this.disconnectWebAudio()}}}return e}setAudioContext(t){this.audioContext=t;if(t&&this.attachedElements.length>0){this.connectWebAudio(t,this.attachedElements[0])}else if(!t){this.disconnectWebAudio()}}setWebAudioPlugins(t){this.webAudioPluginNodes=t;if(this.attachedElements.length>0&&this.audioContext){this.connectWebAudio(this.audioContext,this.attachedElements[0])}}connectWebAudio(t,e){this.disconnectWebAudio();this.sourceNode=t.createMediaStreamSource(e.srcObject);let i=this.sourceNode;this.webAudioPluginNodes.forEach((t=>{i.connect(t);i=t}));this.gainNode=t.createGain();i.connect(this.gainNode);this.gainNode.connect(t.destination);if(this.elementVolume){this.gainNode.gain.setTargetAtTime(this.elementVolume,0,.1)}if(t.state!=="running"){t.resume().then((()=>{if(t.state!=="running"){this.emit(ir.AudioPlaybackFailed,new Error("Audio Context couldn't be started automatically"))}})).catch((t=>{this.emit(ir.AudioPlaybackFailed,t)}))}}disconnectWebAudio(){var t,e;(t=this.gainNode)===null||t===void 0?void 0:t.disconnect();(e=this.sourceNode)===null||e===void 0?void 0:e.disconnect();this.gainNode=undefined;this.sourceNode=undefined}getReceiverStats(){return bn(this,void 0,void 0,(function*(){if(!this.receiver||!this.receiver.getStats){return}const t=yield this.receiver.getStats();let e;t.forEach((t=>{if(t.type==="inbound-rtp"){e={type:"audio",streamId:t.id,timestamp:t.timestamp,jitter:t.jitter,bytesReceived:t.bytesReceived,concealedSamples:t.concealedSamples,concealmentEvents:t.concealmentEvents,silentConcealedSamples:t.silentConcealedSamples,silentConcealmentEvents:t.silentConcealmentEvents,totalAudioEnergy:t.totalAudioEnergy,totalSamplesDuration:t.totalSamplesDuration}}}));return e}))}}const Pc=100;class Nc extends Ic{constructor(t,e,i,n,s){super(t,e,br.Kind.Video,i,s);this.elementInfos=[];this.monitorReceiver=()=>bn(this,void 0,void 0,(function*(){if(!this.receiver){this._currentBitrate=0;return}const t=yield this.getReceiverStats();if(t&&this.prevStats&&this.receiver){this._currentBitrate=qa(t,this.prevStats)}this.prevStats=t}));this.debouncedHandleResize=ya((()=>{this.updateDimensions()}),Pc);this.adaptiveStreamSettings=n}get isAdaptiveStream(){return this.adaptiveStreamSettings!==undefined}get mediaStreamTrack(){return this._mediaStreamTrack}setMuted(t){super.setMuted(t);this.attachedElements.forEach((e=>{if(t){yr(this._mediaStreamTrack,e)}else{gr(this._mediaStreamTrack,e)}}))}attach(t){if(!t){t=super.attach()}else{super.attach(t)}if(this.adaptiveStreamSettings&&this.elementInfos.find((e=>e.element===t))===undefined){const e=new Dc(t);this.observeElementInfo(e)}return t}observeElementInfo(t){if(this.adaptiveStreamSettings&&this.elementInfos.find((e=>e===t))===undefined){t.handleResize=()=>{this.debouncedHandleResize()};t.handleVisibilityChanged=()=>{this.updateVisibility()};this.elementInfos.push(t);t.observe();this.debouncedHandleResize();this.updateVisibility()}else{this.log.warn("visibility resize observer not triggered",this.logContext)}}stopObservingElementInfo(t){if(!this.isAdaptiveStream){this.log.warn("stopObservingElementInfo ignored",this.logContext);return}const e=this.elementInfos.filter((e=>e===t));for(const t of e){t.stopObserving()}this.elementInfos=this.elementInfos.filter((e=>e!==t));this.updateVisibility();this.debouncedHandleResize()}detach(t){let e=[];if(t){this.stopObservingElement(t);return super.detach(t)}e=super.detach();for(const t of e){this.stopObservingElement(t)}return e}getDecoderImplementation(){var t;return(t=this.prevStats)===null||t===void 0?void 0:t.decoderImplementation}getReceiverStats(){return bn(this,void 0,void 0,(function*(){if(!this.receiver||!this.receiver.getStats){return}const t=yield this.receiver.getStats();let e;let i="";let n=new Map;t.forEach((t=>{if(t.type==="inbound-rtp"){i=t.codecId;e={type:"video",streamId:t.id,framesDecoded:t.framesDecoded,framesDropped:t.framesDropped,framesReceived:t.framesReceived,packetsReceived:t.packetsReceived,packetsLost:t.packetsLost,frameWidth:t.frameWidth,frameHeight:t.frameHeight,pliCount:t.pliCount,firCount:t.firCount,nackCount:t.nackCount,jitter:t.jitter,timestamp:t.timestamp,bytesReceived:t.bytesReceived,decoderImplementation:t.decoderImplementation}}else if(t.type==="codec"){n.set(t.id,t)}}));if(e&&i!==""&&n.get(i)){e.mimeType=n.get(i).mimeType}return e}))}stopObservingElement(t){const e=this.elementInfos.filter((e=>e.element===t));for(const t of e){this.stopObservingElementInfo(t)}}handleAppVisibilityChanged(){const t=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return bn(this,void 0,void 0,(function*(){yield t.handleAppVisibilityChanged.call(this);if(!this.isAdaptiveStream)return;this.updateVisibility()}))}updateVisibility(){var t,e;const i=this.elementInfos.reduce(((t,e)=>Math.max(t,e.visibilityChangedAt||0)),0);const n=((e=(t=this.adaptiveStreamSettings)===null||t===void 0?void 0:t.pauseVideoInBackground)!==null&&e!==void 0?e:true)?this.isInBackground:false;const s=this.elementInfos.some((t=>t.pictureInPicture));const r=this.elementInfos.some((t=>t.visible))&&!n||s;if(this.lastVisible===r){return}if(!r&&Date.now()-i<Pc){fr.setTimeout((()=>{this.updateVisibility()}),Pc);return}this.lastVisible=r;this.emit(ir.VisibilityChanged,r,this)}updateDimensions(){var t,e;let i=0;let n=0;const s=this.getPixelDensity();for(const t of this.elementInfos){const e=t.width()*s;const r=t.height()*s;if(e+r>i+n){i=e;n=r}}if(((t=this.lastDimensions)===null||t===void 0?void 0:t.width)===i&&((e=this.lastDimensions)===null||e===void 0?void 0:e.height)===n){return}this.lastDimensions={width:i,height:n};this.emit(ir.VideoDimensionsChanged,this.lastDimensions,this)}getPixelDensity(){var t;const e=(t=this.adaptiveStreamSettings)===null||t===void 0?void 0:t.pixelDensity;if(e==="screen"){return Yr()}else if(!e){const t=Yr();if(t>2){return 2}else{return 1}}return e}}class Dc{get visible(){return this.isPiP||this.isIntersecting}get pictureInPicture(){return this.isPiP}constructor(t,e){this.onVisibilityChanged=t=>{var e;const{target:i,isIntersecting:n}=t;if(i===this.element){this.isIntersecting=n;this.isPiP=Ac(this.element);this.visibilityChangedAt=Date.now();(e=this.handleVisibilityChanged)===null||e===void 0?void 0:e.call(this)}};this.onEnterPiP=()=>{var t,e,i;(e=(t=window.documentPictureInPicture)===null||t===void 0?void 0:t.window)===null||e===void 0?void 0:e.addEventListener("pagehide",this.onLeavePiP);this.isPiP=Ac(this.element);(i=this.handleVisibilityChanged)===null||i===void 0?void 0:i.call(this)};this.onLeavePiP=()=>{var t;this.isPiP=Ac(this.element);(t=this.handleVisibilityChanged)===null||t===void 0?void 0:t.call(this)};this.element=t;this.isIntersecting=e!==null&&e!==void 0?e:xc(t);this.isPiP=Hr()&&Ac(t);this.visibilityChangedAt=0}width(){return this.element.clientWidth}height(){return this.element.clientHeight}observe(){var t,e,i;this.isIntersecting=xc(this.element);this.isPiP=Ac(this.element);this.element.handleResize=()=>{var t;(t=this.handleResize)===null||t===void 0?void 0:t.call(this)};this.element.handleVisibilityChanged=this.onVisibilityChanged;no().observe(this.element);eo().observe(this.element);this.element.addEventListener("enterpictureinpicture",this.onEnterPiP);this.element.addEventListener("leavepictureinpicture",this.onLeavePiP);(t=window.documentPictureInPicture)===null||t===void 0?void 0:t.addEventListener("enter",this.onEnterPiP);(i=(e=window.documentPictureInPicture)===null||e===void 0?void 0:e.window)===null||i===void 0?void 0:i.addEventListener("pagehide",this.onLeavePiP)}stopObserving(){var t,e,i,n,s;(t=no())===null||t===void 0?void 0:t.unobserve(this.element);(e=eo())===null||e===void 0?void 0:e.unobserve(this.element);this.element.removeEventListener("enterpictureinpicture",this.onEnterPiP);this.element.removeEventListener("leavepictureinpicture",this.onLeavePiP);(i=window.documentPictureInPicture)===null||i===void 0?void 0:i.removeEventListener("enter",this.onEnterPiP);(s=(n=window.documentPictureInPicture)===null||n===void 0?void 0:n.window)===null||s===void 0?void 0:s.removeEventListener("pagehide",this.onLeavePiP)}}function Ac(t){var e,i;if(document.pictureInPictureElement===t)return true;if((e=window.documentPictureInPicture)===null||e===void 0?void 0:e.window)return xc(t,(i=window.documentPictureInPicture)===null||i===void 0?void 0:i.window);return false}function xc(t,e){const i=e||window;let n=t.offsetTop;let s=t.offsetLeft;const r=t.offsetWidth;const o=t.offsetHeight;const{hidden:a}=t;const{display:c}=getComputedStyle(t);while(t.offsetParent){t=t.offsetParent;n+=t.offsetTop;s+=t.offsetLeft}return n<i.pageYOffset+i.innerHeight&&s<i.pageXOffset+i.innerWidth&&n+o>i.pageYOffset&&s+r>i.pageXOffset&&!a&&c!=="none"}class Mc extends Sn.EventEmitter{constructor(t,e,i,n){var s;super();this.metadataMuted=false;this.encryption=Ie.NONE;this.log=dn;this.handleMuted=()=>{this.emit(ir.Muted)};this.handleUnmuted=()=>{this.emit(ir.Unmuted)};this.log=hn((s=n===null||n===void 0?void 0:n.loggerName)!==null&&s!==void 0?s:un.Publication);this.loggerContextCb=this.loggerContextCb;this.setMaxListeners(100);this.kind=t;this.trackSid=e;this.trackName=i;this.source=br.Source.Unknown}setTrack(t){if(this.track){this.track.off(ir.Muted,this.handleMuted);this.track.off(ir.Unmuted,this.handleUnmuted)}this.track=t;if(t){t.on(ir.Muted,this.handleMuted);t.on(ir.Unmuted,this.handleUnmuted)}}get logContext(){var t;return Object.assign(Object.assign({},(t=this.loggerContextCb)===null||t===void 0?void 0:t.call(this)),Fo(this))}get isMuted(){return this.metadataMuted}get isEnabled(){return true}get isSubscribed(){return this.track!==undefined}get isEncrypted(){return this.encryption!==Ie.NONE}get audioTrack(){if(ko(this.track)){return this.track}}get videoTrack(){if(wo(this.track)){return this.track}}updateInfo(t){this.trackSid=t.sid;this.trackName=t.name;this.source=br.sourceFromProto(t.source);this.mimeType=t.mimeType;if(this.kind===br.Kind.Video&&t.width>0){this.dimensions={width:t.width,height:t.height};this.simulcasted=t.simulcast}this.encryption=t.encryption;this.trackInfo=t;this.log.debug("update publication info",Object.assign(Object.assign({},this.logContext),{info:t}))}}(function(t){(function(t){t["Desired"]="desired";t["Subscribed"]="subscribed";t["Unsubscribed"]="unsubscribed"})(t.SubscriptionStatus||(t.SubscriptionStatus={}));(function(t){t["Allowed"]="allowed";t["NotAllowed"]="not_allowed"})(t.PermissionStatus||(t.PermissionStatus={}))})(Mc||(Mc={}));class Uc extends Mc{get isUpstreamPaused(){var t;return(t=this.track)===null||t===void 0?void 0:t.isUpstreamPaused}constructor(t,e,i,n){super(t,e.sid,e.name,n);this.track=undefined;this.handleTrackEnded=()=>{this.emit(ir.Ended)};this.updateInfo(e);this.setTrack(i)}setTrack(t){if(this.track){this.track.off(ir.Ended,this.handleTrackEnded)}super.setTrack(t);if(t){t.on(ir.Ended,this.handleTrackEnded)}}get isMuted(){if(this.track){return this.track.isMuted}return super.isMuted}get audioTrack(){return super.audioTrack}get videoTrack(){return super.videoTrack}get isLocal(){return true}mute(){return bn(this,void 0,void 0,(function*(){var t;return(t=this.track)===null||t===void 0?void 0:t.mute()}))}unmute(){return bn(this,void 0,void 0,(function*(){var t;return(t=this.track)===null||t===void 0?void 0:t.unmute()}))}pauseUpstream(){return bn(this,void 0,void 0,(function*(){var t;yield(t=this.track)===null||t===void 0?void 0:t.pauseUpstream()}))}resumeUpstream(){return bn(this,void 0,void 0,(function*(){var t;yield(t=this.track)===null||t===void 0?void 0:t.resumeUpstream()}))}getTrackFeatures(){var t;if(ko(this.track)){const e=this.track.getSourceTrackSettings();const i=new Set;if(e.autoGainControl){i.add(we.TF_AUTO_GAIN_CONTROL)}if(e.echoCancellation){i.add(we.TF_ECHO_CANCELLATION)}if(e.noiseSuppression){i.add(we.TF_NOISE_SUPPRESSION)}if(e.channelCount&&e.channelCount>1){i.add(we.TF_STEREO)}if(!((t=this.options)===null||t===void 0?void 0:t.dtx)){i.add(we.TF_NO_DTX)}if(this.track.enhancedNoiseCancellation){i.add(we.TF_ENHANCED_NOISE_CANCELLATION)}return Array.from(i.values())}else return[]}}function Lc(t,e){return bn(this,void 0,void 0,(function*(){t!==null&&t!==void 0?t:t={};let i=false;const{audioProcessor:n,videoProcessor:s,optionsWithoutProcessor:r}=Vo(t);let o=r.audio;let a=r.video;if(n&&typeof r.audio==="object"){r.audio.processor=n}if(s&&typeof r.video==="object"){r.video.processor=s}if(t.audio&&typeof r.audio==="object"&&typeof r.audio.deviceId==="string"){const t=r.audio.deviceId;r.audio.deviceId={exact:t};i=true;o=Object.assign(Object.assign({},r.audio),{deviceId:{ideal:t}})}if(r.video&&typeof r.video==="object"&&typeof r.video.deviceId==="string"){const t=r.video.deviceId;r.video.deviceId={exact:t};i=true;a=Object.assign(Object.assign({},r.video),{deviceId:{ideal:t}})}if(r.audio===true||typeof r.audio==="object"&&!r.audio.deviceId){r.audio={deviceId:"default"}}if(r.video===true||typeof r.video==="object"&&!r.video.deviceId){r.video={deviceId:"default"}}const c=Io(r,Ia,_a);const u=Po(c);const d=navigator.mediaDevices.getUserMedia(u);if(r.audio){zo.userMediaPromiseMap.set("audioinput",d);d.catch((()=>zo.userMediaPromiseMap.delete("audioinput")))}if(r.video){zo.userMediaPromiseMap.set("videoinput",d);d.catch((()=>zo.userMediaPromiseMap.delete("videoinput")))}try{const t=yield d;return yield Promise.all(t.getTracks().map((i=>bn(this,void 0,void 0,(function*(){const r=i.kind==="audio";let o;const a=r?u.audio:u.video;if(typeof a!=="boolean"){o=a}const c=i.getSettings().deviceId;if((o===null||o===void 0?void 0:o.deviceId)&&ho(o.deviceId)!==c){o.deviceId=c}else if(!o){o={deviceId:c}}const d=Ga(i,o,e);if(d.kind===br.Kind.Video){d.source=br.Source.Camera}else if(d.kind===br.Kind.Audio){d.source=br.Source.Microphone}d.mediaStream=t;if(ko(d)&&n){yield d.setProcessor(n)}else if(wo(d)&&s){yield d.setProcessor(s)}return d})))))}catch(n){if(!i){throw n}return Lc(Object.assign(Object.assign({},t),{audio:o,video:a}),e)}}))}var Fc;(function(t){t["Excellent"]="excellent";t["Good"]="good";t["Poor"]="poor";t["Lost"]="lost";t["Unknown"]="unknown"})(Fc||(Fc={}));function qc(t){switch(t){case pe.EXCELLENT:return Fc.Excellent;case pe.GOOD:return Fc.Good;case pe.POOR:return Fc.Poor;case pe.LOST:return Fc.Lost;default:return Fc.Unknown}}class Bc extends Sn.EventEmitter{get logContext(){var t,e;return Object.assign({},(e=(t=this.loggerOptions)===null||t===void 0?void 0:t.loggerContextCb)===null||e===void 0?void 0:e.call(t))}get isEncrypted(){return this.trackPublications.size>0&&Array.from(this.trackPublications.values()).every((t=>t.isEncrypted))}get isAgent(){var t;return((t=this.permissions)===null||t===void 0?void 0:t.agent)||this.kind===je.AGENT}get kind(){return this._kind}get attributes(){return Object.freeze(Object.assign({},this._attributes))}constructor(t,e,i,n,s,r){let o=arguments.length>6&&arguments[6]!==undefined?arguments[6]:je.STANDARD;var a;super();this.audioLevel=0;this.isSpeaking=false;this._connectionQuality=Fc.Unknown;this.log=dn;this.log=hn((a=r===null||r===void 0?void 0:r.loggerName)!==null&&a!==void 0?a:un.Participant);this.loggerOptions=r;this.setMaxListeners(100);this.sid=t;this.identity=e;this.name=i;this.metadata=n;this.audioTrackPublications=new Map;this.videoTrackPublications=new Map;this.trackPublications=new Map;this._kind=o;this._attributes=s!==null&&s!==void 0?s:{}}getTrackPublications(){return Array.from(this.trackPublications.values())}getTrackPublication(t){for(const[,e]of this.trackPublications){if(e.source===t){return e}}}getTrackPublicationByName(t){for(const[,e]of this.trackPublications){if(e.trackName===t){return e}}}get connectionQuality(){return this._connectionQuality}get isCameraEnabled(){var t;const e=this.getTrackPublication(br.Source.Camera);return!((t=e===null||e===void 0?void 0:e.isMuted)!==null&&t!==void 0?t:true)}get isMicrophoneEnabled(){var t;const e=this.getTrackPublication(br.Source.Microphone);return!((t=e===null||e===void 0?void 0:e.isMuted)!==null&&t!==void 0?t:true)}get isScreenShareEnabled(){const t=this.getTrackPublication(br.Source.ScreenShare);return!!t}get isLocal(){return false}get joinedAt(){if(this.participantInfo){return new Date(Number.parseInt(this.participantInfo.joinedAt.toString())*1e3)}return new Date}updateInfo(t){if(this.participantInfo&&this.participantInfo.sid===t.sid&&this.participantInfo.version>t.version){return false}this.identity=t.identity;this.sid=t.sid;this._setName(t.name);this._setMetadata(t.metadata);this._setAttributes(t.attributes);if(t.permission){this.setPermissions(t.permission)}this.participantInfo=t;this.log.trace("update participant info",Object.assign(Object.assign({},this.logContext),{info:t}));return true}_setMetadata(t){const e=this.metadata!==t;const i=this.metadata;this.metadata=t;if(e){this.emit(tr.ParticipantMetadataChanged,i)}}_setName(t){const e=this.name!==t;this.name=t;if(e){this.emit(tr.ParticipantNameChanged,t)}}_setAttributes(t){const e=Bo(this.attributes,t);this._attributes=t;if(Object.keys(e).length>0){this.emit(tr.AttributesChanged,e)}}setPermissions(t){var e,i,n,s,r,o;const a=this.permissions;const c=t.canPublish!==((e=this.permissions)===null||e===void 0?void 0:e.canPublish)||t.canSubscribe!==((i=this.permissions)===null||i===void 0?void 0:i.canSubscribe)||t.canPublishData!==((n=this.permissions)===null||n===void 0?void 0:n.canPublishData)||t.hidden!==((s=this.permissions)===null||s===void 0?void 0:s.hidden)||t.recorder!==((r=this.permissions)===null||r===void 0?void 0:r.recorder)||t.canPublishSources.length!==this.permissions.canPublishSources.length||t.canPublishSources.some(((t,e)=>{var i;return t!==((i=this.permissions)===null||i===void 0?void 0:i.canPublishSources[e])}))||t.canSubscribeMetrics!==((o=this.permissions)===null||o===void 0?void 0:o.canSubscribeMetrics);this.permissions=t;if(c){this.emit(tr.ParticipantPermissionsChanged,a)}return c}setIsSpeaking(t){if(t===this.isSpeaking){return}this.isSpeaking=t;if(t){this.lastSpokeAt=new Date}this.emit(tr.IsSpeakingChanged,t)}setConnectionQuality(t){const e=this._connectionQuality;this._connectionQuality=qc(t);if(e!==this._connectionQuality){this.emit(tr.ConnectionQualityChanged,this._connectionQuality)}}setAudioContext(t){this.audioContext=t;this.audioTrackPublications.forEach((e=>ko(e.track)&&e.track.setAudioContext(t)))}addTrackPublication(t){t.on(ir.Muted,(()=>{this.emit(tr.TrackMuted,t)}));t.on(ir.Unmuted,(()=>{this.emit(tr.TrackUnmuted,t)}));const e=t;if(e.track){e.track.sid=t.trackSid}this.trackPublications.set(t.trackSid,t);switch(t.kind){case br.Kind.Audio:this.audioTrackPublications.set(t.trackSid,t);break;case br.Kind.Video:this.videoTrackPublications.set(t.trackSid,t);break}}}function Vc(t){var e,i,n;if(!t.participantSid&&!t.participantIdentity){throw new Error("Invalid track permission, must provide at least one of participantIdentity and participantSid")}return new qi({participantIdentity:(e=t.participantIdentity)!==null&&e!==void 0?e:"",participantSid:(i=t.participantSid)!==null&&i!==void 0?i:"",allTracks:(n=t.allowAll)!==null&&n!==void 0?n:false,trackSids:t.allowedTrackSids||[]})}const Jc=15e3;class Gc extends Bc{constructor(t,e,i,n,s){super(t,e,undefined,undefined,undefined,{loggerName:n.loggerName,loggerContextCb:()=>this.engine.logContext});this.pendingPublishing=new Set;this.pendingPublishPromises=new Map;this.participantTrackPermissions=[];this.allParticipantsAllowedToSubscribe=true;this.encryptionType=Ie.NONE;this.enabledPublishVideoCodecs=[];this.pendingAcks=new Map;this.pendingResponses=new Map;this.handleReconnecting=()=>{if(!this.reconnectFuture){this.reconnectFuture=new co}};this.handleReconnected=()=>{var t,e;(e=(t=this.reconnectFuture)===null||t===void 0?void 0:t.resolve)===null||e===void 0?void 0:e.call(t);this.reconnectFuture=undefined;this.updateTrackSubscriptionPermissions()};this.handleDisconnected=()=>{var t,e;if(this.reconnectFuture){this.reconnectFuture.promise.catch((t=>this.log.warn(t.message,this.logContext)));(e=(t=this.reconnectFuture)===null||t===void 0?void 0:t.reject)===null||e===void 0?void 0:e.call(t,"Got disconnected during reconnection attempt");this.reconnectFuture=undefined}};this.handleSignalRequestResponse=t=>{const{requestId:e,reason:i,message:n}=t;const s=this.pendingSignalRequests.get(e);if(s){if(i!==Xi.OK){s.reject(new Ys(n,i))}this.pendingSignalRequests.delete(e)}};this.handleDataPacket=t=>{switch(t.value.case){case"rpcResponse":let e=t.value.value;let i=null;let n=null;if(e.value.case==="payload"){i=e.value.value}else if(e.value.case==="error"){n=xa.fromProto(e.value.value)}this.handleIncomingRpcResponse(e.requestId,i,n);break;case"rpcAck":let s=t.value.value;this.handleIncomingRpcAck(s.requestId);break}};this.updateTrackSubscriptionPermissions=()=>{this.log.debug("updating track subscription permissions",Object.assign(Object.assign({},this.logContext),{allParticipantsAllowed:this.allParticipantsAllowedToSubscribe,participantTrackPermissions:this.participantTrackPermissions}));this.engine.client.sendUpdateSubscriptionPermissions(this.allParticipantsAllowedToSubscribe,this.participantTrackPermissions.map((t=>Vc(t))))};this.onTrackUnmuted=t=>{this.onTrackMuted(t,t.isUpstreamPaused)};this.onTrackMuted=(t,e)=>{if(e===undefined){e=true}if(!t.sid){this.log.error("could not update mute status for unpublished track",Object.assign(Object.assign({},this.logContext),Fo(t)));return}this.engine.updateMuteStatus(t.sid,e)};this.onTrackUpstreamPaused=t=>{this.log.debug("upstream paused",Object.assign(Object.assign({},this.logContext),Fo(t)));this.onTrackMuted(t,true)};this.onTrackUpstreamResumed=t=>{this.log.debug("upstream resumed",Object.assign(Object.assign({},this.logContext),Fo(t)));this.onTrackMuted(t,t.isMuted)};this.onTrackFeatureUpdate=t=>{const e=this.audioTrackPublications.get(t.sid);if(!e){this.log.warn("Could not update local audio track settings, missing publication for track ".concat(t.sid),this.logContext);return}this.engine.client.sendUpdateLocalAudioTrack(e.trackSid,e.getTrackFeatures())};this.handleSubscribedQualityUpdate=t=>bn(this,void 0,void 0,(function*(){var e,i,n,s;var r,o;if(!((r=this.roomOptions)===null||r===void 0?void 0:r.dynacast)){return}const a=this.videoTrackPublications.get(t.trackSid);if(!a){this.log.warn("received subscribed quality update for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:t.trackSid}));return}if(t.subscribedCodecs.length>0){if(!a.videoTrack){return}const r=yield a.videoTrack.setPublishingCodecs(t.subscribedCodecs);try{for(var c=true,u=yn(r),d;d=yield u.next(),e=d.done,!e;c=true){s=d.value;c=false;const t=s;if(Sr(t)){this.log.debug("publish ".concat(t," for ").concat(a.videoTrack.sid),Object.assign(Object.assign({},this.logContext),Fo(a)));yield this.publishAdditionalCodecForTrack(a.videoTrack,t,a.options)}}}catch(t){i={error:t}}finally{try{if(!c&&!e&&(n=u.return))yield n.call(u)}finally{if(i)throw i.error}}}else if(t.subscribedQualities.length>0){yield(o=a.videoTrack)===null||o===void 0?void 0:o.setPublishingLayers(t.subscribedQualities)}}));this.handleLocalTrackUnpublished=t=>{const e=this.trackPublications.get(t.trackSid);if(!e){this.log.warn("received unpublished event for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:t.trackSid}));return}this.unpublishTrack(e.track)};this.handleTrackEnded=t=>bn(this,void 0,void 0,(function*(){if(t.source===br.Source.ScreenShare||t.source===br.Source.ScreenShareAudio){this.log.debug("unpublishing local track due to TrackEnded",Object.assign(Object.assign({},this.logContext),Fo(t)));this.unpublishTrack(t)}else if(t.isUserProvided){yield t.mute()}else if(So(t)||To(t)){try{if(Hr()){try{const e=yield navigator===null||navigator===void 0?void 0:navigator.permissions.query({name:t.source===br.Source.Camera?"camera":"microphone"});if(e&&e.state==="denied"){this.log.warn("user has revoked access to ".concat(t.source),Object.assign(Object.assign({},this.logContext),Fo(t)));e.onchange=()=>{if(e.state!=="denied"){if(!t.isMuted){t.restartTrack()}e.onchange=null}};throw new Error("GetUserMedia Permission denied")}}catch(t){}}if(!t.isMuted){this.log.debug("track ended, attempting to use a different device",Object.assign(Object.assign({},this.logContext),Fo(t)));if(So(t)){yield t.restartTrack({deviceId:"default"})}else{yield t.restartTrack()}}}catch(e){this.log.warn("could not restart track, muting instead",Object.assign(Object.assign({},this.logContext),Fo(t)));yield t.mute()}}}));this.audioTrackPublications=new Map;this.videoTrackPublications=new Map;this.trackPublications=new Map;this.engine=i;this.roomOptions=n;this.setupEngine(i);this.activeDeviceMap=new Map([["audioinput","default"],["videoinput","default"],["audiooutput","default"]]);this.pendingSignalRequests=new Map;this.rpcHandlers=s}get lastCameraError(){return this.cameraError}get lastMicrophoneError(){return this.microphoneError}get isE2EEEnabled(){return this.encryptionType!==Ie.NONE}getTrackPublication(t){const e=super.getTrackPublication(t);if(e){return e}}getTrackPublicationByName(t){const e=super.getTrackPublicationByName(t);if(e){return e}}setupEngine(t){this.engine=t;this.engine.on(er.RemoteMute,((t,e)=>{const i=this.trackPublications.get(t);if(!i||!i.track){return}if(e){i.mute()}else{i.unmute()}}));this.engine.on(er.Connected,this.handleReconnected).on(er.SignalRestarted,this.handleReconnected).on(er.SignalResumed,this.handleReconnected).on(er.Restarting,this.handleReconnecting).on(er.Resuming,this.handleReconnecting).on(er.LocalTrackUnpublished,this.handleLocalTrackUnpublished).on(er.SubscribedQualityUpdate,this.handleSubscribedQualityUpdate).on(er.Disconnected,this.handleDisconnected).on(er.SignalRequestResponse,this.handleSignalRequestResponse).on(er.DataPacketReceived,this.handleDataPacket)}setMetadata(t){return bn(this,void 0,void 0,(function*(){yield this.requestMetadataUpdate({metadata:t})}))}setName(t){return bn(this,void 0,void 0,(function*(){yield this.requestMetadataUpdate({name:t})}))}setAttributes(t){return bn(this,void 0,void 0,(function*(){yield this.requestMetadataUpdate({attributes:t})}))}requestMetadataUpdate(t){return bn(this,arguments,void 0,(function(t){var e=this;let{metadata:i,name:n,attributes:s}=t;return function*(){return new Promise(((t,r)=>bn(e,void 0,void 0,(function*(){var e,o;try{let a=false;const c=yield this.engine.client.sendUpdateLocalMetadata((e=i!==null&&i!==void 0?i:this.metadata)!==null&&e!==void 0?e:"",(o=n!==null&&n!==void 0?n:this.name)!==null&&o!==void 0?o:"",s);const u=performance.now();this.pendingSignalRequests.set(c,{resolve:t,reject:t=>{r(t);a=true},values:{name:n,metadata:i,attributes:s}});while(performance.now()-u<5e3&&!a){if((!n||this.name===n)&&(!i||this.metadata===i)&&(!s||Object.entries(s).every((t=>{let[e,i]=t;return this.attributes[e]===i||i===""&&!this.attributes[e]})))){this.pendingSignalRequests.delete(c);t();return}yield Nr(50)}r(new Ys("Request to update local metadata timed out","TimeoutError"))}catch(t){if(t instanceof Error)r(t)}}))))}()}))}setCameraEnabled(t,e,i){return this.setTrackEnabled(br.Source.Camera,t,e,i)}setMicrophoneEnabled(t,e,i){return this.setTrackEnabled(br.Source.Microphone,t,e,i)}setScreenShareEnabled(t,e,i){return this.setTrackEnabled(br.Source.ScreenShare,t,e,i)}setPermissions(t){const e=this.permissions;const i=super.setPermissions(t);if(i&&e){this.emit(tr.ParticipantPermissionsChanged,e)}return i}setE2EEEnabled(t){return bn(this,void 0,void 0,(function*(){this.encryptionType=t?Ie.GCM:Ie.NONE;yield this.republishAllTracks(undefined,false)}))}setTrackEnabled(t,e,i,n){return bn(this,void 0,void 0,(function*(){var s,r;this.log.debug("setTrackEnabled",Object.assign(Object.assign({},this.logContext),{source:t,enabled:e}));if(this.republishPromise){yield this.republishPromise}let o=this.getTrackPublication(t);if(e){if(o){yield o.unmute()}else{let e;if(this.pendingPublishing.has(t)){const e=yield this.waitForPendingPublicationOfSource(t);if(!e){this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:t}))}yield e===null||e===void 0?void 0:e.unmute();return e}this.pendingPublishing.add(t);try{switch(t){case br.Source.Camera:e=yield this.createTracks({video:(s=i)!==null&&s!==void 0?s:true});break;case br.Source.Microphone:e=yield this.createTracks({audio:(r=i)!==null&&r!==void 0?r:true});break;case br.Source.ScreenShare:e=yield this.createScreenTracks(Object.assign({},i));break;default:throw new Hs(t)}}catch(i){e===null||e===void 0?void 0:e.forEach((t=>{t.stop()}));if(i instanceof Error){this.emit(tr.MediaDevicesError,i)}this.pendingPublishing.delete(t);throw i}try{const t=[];for(const i of e){this.log.info("publishing track",Object.assign(Object.assign({},this.logContext),Fo(i)));t.push(this.publishTrack(i,n))}const i=yield Promise.all(t);[o]=i}catch(t){e===null||e===void 0?void 0:e.forEach((t=>{t.stop()}));throw t}finally{this.pendingPublishing.delete(t)}}}else{if(!(o===null||o===void 0?void 0:o.track)&&this.pendingPublishing.has(t)){o=yield this.waitForPendingPublicationOfSource(t);if(!o){this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:t}))}}if(o&&o.track){if(t===br.Source.ScreenShare){o=yield this.unpublishTrack(o.track);const t=this.getTrackPublication(br.Source.ScreenShareAudio);if(t&&t.track){this.unpublishTrack(t.track)}}else{yield o.mute()}}}return o}))}enableCameraAndMicrophone(){return bn(this,void 0,void 0,(function*(){if(this.pendingPublishing.has(br.Source.Camera)||this.pendingPublishing.has(br.Source.Microphone)){return}this.pendingPublishing.add(br.Source.Camera);this.pendingPublishing.add(br.Source.Microphone);try{const t=yield this.createTracks({audio:true,video:true});yield Promise.all(t.map((t=>this.publishTrack(t))))}finally{this.pendingPublishing.delete(br.Source.Camera);this.pendingPublishing.delete(br.Source.Microphone)}}))}createTracks(t){return bn(this,void 0,void 0,(function*(){var e,i;t!==null&&t!==void 0?t:t={};const n=Io(t,(e=this.roomOptions)===null||e===void 0?void 0:e.audioCaptureDefaults,(i=this.roomOptions)===null||i===void 0?void 0:i.videoCaptureDefaults);try{const t=yield Lc(n,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});const e=t.map((t=>{if(ko(t)){this.microphoneError=undefined;t.setAudioContext(this.audioContext);t.source=br.Source.Microphone;this.emit(tr.AudioStreamAcquired)}if(wo(t)){this.cameraError=undefined;t.source=br.Source.Camera}return t}));return e}catch(e){if(e instanceof Error){if(t.audio){this.microphoneError=e}if(t.video){this.cameraError=e}}throw e}}))}createScreenTracks(t){return bn(this,void 0,void 0,(function*(){if(t===undefined){t={}}if(navigator.mediaDevices.getDisplayMedia===undefined){throw new Gs("getDisplayMedia not supported")}if(t.resolution===undefined&&!Vr()){t.resolution=Rr.h1080fps30.resolution}const e=Mo(t);const i=yield navigator.mediaDevices.getDisplayMedia(e);const n=i.getVideoTracks();if(n.length===0){throw new Hs("no video track found")}const s=new cc(n[0],undefined,false,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});s.source=br.Source.ScreenShare;if(t.contentHint){s.mediaStreamTrack.contentHint=t.contentHint}const r=[s];if(i.getAudioTracks().length>0){this.emit(tr.AudioStreamAcquired);const t=new Ja(i.getAudioTracks()[0],undefined,false,this.audioContext,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});t.source=br.Source.ScreenShareAudio;r.push(t)}return r}))}publishTrack(t,e){return bn(this,void 0,void 0,(function*(){return this.publishOrRepublishTrack(t,e)}))}publishOrRepublishTrack(t,e){return bn(this,arguments,void 0,(function(t,e){var i=this;let n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;return function*(){var s,r,o,a;if(So(t)){t.setAudioContext(i.audioContext)}yield(s=i.reconnectFuture)===null||s===void 0?void 0:s.promise;if(i.republishPromise&&!n){yield i.republishPromise}if(yo(t)&&i.pendingPublishPromises.has(t)){yield i.pendingPublishPromises.get(t)}let c;if(t instanceof MediaStreamTrack){c=t.getConstraints()}else{c=t.constraints;let e=undefined;switch(t.source){case br.Source.Microphone:e="audioinput";break;case br.Source.Camera:e="videoinput"}if(e&&i.activeDeviceMap.has(e)){c=Object.assign(Object.assign({},c),{deviceId:i.activeDeviceMap.get(e)})}}if(t instanceof MediaStreamTrack){switch(t.kind){case"audio":t=new Ja(t,c,true,i.audioContext,{loggerName:i.roomOptions.loggerName,loggerContextCb:()=>i.logContext});break;case"video":t=new cc(t,c,true,{loggerName:i.roomOptions.loggerName,loggerContextCb:()=>i.logContext});break;default:throw new Hs("unsupported MediaStreamTrack kind ".concat(t.kind))}}else{t.updateLoggerOptions({loggerName:i.roomOptions.loggerName,loggerContextCb:()=>i.logContext})}let u;i.trackPublications.forEach((e=>{if(!e.track){return}if(e.track===t){u=e}}));if(u){i.log.warn("track has already been published, skipping",Object.assign(Object.assign({},i.logContext),Fo(u)));return u}const d="channelCount"in t.mediaStreamTrack.getSettings()&&t.mediaStreamTrack.getSettings().channelCount===2||t.mediaStreamTrack.getConstraints().channelCount===2;const h=(r=e===null||e===void 0?void 0:e.forceStereo)!==null&&r!==void 0?r:d;if(h){if(!e){e={}}if(e.dtx===undefined){i.log.info("Opus DTX will be disabled for stereo tracks by default. Enable them explicitly to make it work.",Object.assign(Object.assign({},i.logContext),Fo(t)))}if(e.red===undefined){i.log.info("Opus RED will be disabled for stereo tracks by default. Enable them explicitly to make it work.")}(o=e.dtx)!==null&&o!==void 0?o:e.dtx=false;(a=e.red)!==null&&a!==void 0?a:e.red=false}const l=Object.assign(Object.assign({},i.roomOptions.publishDefaults),e);if(!Gr()&&i.roomOptions.e2ee){i.log.info("End-to-end encryption is set up, simulcast publishing will be disabled on Safari versions and iOS browsers running iOS < v17.2",Object.assign({},i.logContext));l.simulcast=false}if(l.source){t.source=l.source}const f=new Promise(((e,n)=>bn(i,void 0,void 0,(function*(){try{if(this.engine.client.currentState!==ea.CONNECTED){this.log.debug("deferring track publication until signal is connected",Object.assign(Object.assign({},this.logContext),{track:Fo(t)}));const i=()=>bn(this,void 0,void 0,(function*(){try{const i=yield this.publish(t,l,h);e(i)}catch(t){n(t)}}));setTimeout((()=>{this.engine.off(er.SignalConnected,i);n(new Qs("publishing rejected as engine not connected within timeout",408))}),15e3);this.engine.once(er.SignalConnected,i);this.engine.on(er.Closing,(()=>{this.engine.off(er.SignalConnected,i);n(new Qs("publishing rejected as engine closed",499))}))}else{try{const i=yield this.publish(t,l,h);e(i)}catch(t){n(t)}}}catch(t){n(t)}}))));i.pendingPublishPromises.set(t,f);try{const t=yield f;return t}catch(t){throw t}finally{i.pendingPublishPromises.delete(t)}}()}))}hasPermissionsToPublish(t){if(!this.permissions){this.log.warn("no permissions present for publishing track",Object.assign(Object.assign({},this.logContext),Fo(t)));return false}const{canPublish:e,canPublishSources:i}=this.permissions;if(e&&(i.length===0||i.map((t=>Jo(t))).includes(t.source))){return true}this.log.warn("insufficient permissions to publish",Object.assign(Object.assign({},this.logContext),Fo(t)));return false}publish(t,e,i){return bn(this,void 0,void 0,(function*(){var n,s,r,o,a,c,u,d,h,l;if(!this.hasPermissionsToPublish(t)){throw new Qs("failed to publish track, insufficient permissions",403)}const f=Array.from(this.trackPublications.values()).find((e=>yo(t)&&e.source===t.source));if(f&&t.source!==br.Source.Unknown){this.log.info("publishing a second track with the same source: ".concat(t.source),Object.assign(Object.assign({},this.logContext),Fo(t)))}if(e.stopMicTrackOnMute&&ko(t)){t.stopOnMute=true}if(t.source===br.Source.ScreenShare&&qr()){e.simulcast=false}if(e.videoCodec==="av1"&&!xr()){e.videoCodec=undefined}if(e.videoCodec==="vp9"&&!Mr()){e.videoCodec=undefined}if(e.videoCodec===undefined){e.videoCodec=ja}if(this.enabledPublishVideoCodecs.length>0){if(!this.enabledPublishVideoCodecs.some((t=>e.videoCodec===Uo(t.mime)))){e.videoCodec=Uo(this.enabledPublishVideoCodecs[0].mime)}}const m=e.videoCodec;t.on(ir.Muted,this.onTrackMuted);t.on(ir.Unmuted,this.onTrackUnmuted);t.on(ir.Ended,this.handleTrackEnded);t.on(ir.UpstreamPaused,this.onTrackUpstreamPaused);t.on(ir.UpstreamResumed,this.onTrackUpstreamResumed);t.on(ir.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate);const v=new fi({cid:t.mediaStreamTrack.id,name:e.name,type:br.kindToProto(t.kind),muted:t.isMuted,source:br.sourceToProto(t.source),disableDtx:!((n=e.dtx)!==null&&n!==void 0?n:true),encryption:this.encryptionType,stereo:i,disableRed:this.isE2EEEnabled||!((s=e.red)!==null&&s!==void 0?s:true),stream:e===null||e===void 0?void 0:e.stream,backupCodecPolicy:e===null||e===void 0?void 0:e.backupCodecPolicy});let p;if(t.kind===br.Kind.Video){let i={width:0,height:0};try{i=yield t.waitForDimensions()}catch(e){const n=(o=(r=this.roomOptions.videoCaptureDefaults)===null||r===void 0?void 0:r.resolution)!==null&&o!==void 0?o:Cr.h720.resolution;i={width:n.width,height:n.height};this.log.error("could not determine track dimensions, using defaults",Object.assign(Object.assign(Object.assign({},this.logContext),Fo(t)),{dims:i}))}v.width=i.width;v.height=i.height;if(To(t)){if(Ur(m)){if(t.source===br.Source.ScreenShare){e.scalabilityMode="L1T3";if("contentHint"in t.mediaStreamTrack){t.mediaStreamTrack.contentHint="motion";this.log.info("forcing contentHint to motion for screenshare with SVC codecs",Object.assign(Object.assign({},this.logContext),Fo(t)))}}e.scalabilityMode=(a=e.scalabilityMode)!==null&&a!==void 0?a:"L3T3_KEY"}v.simulcastCodecs=[new li({codec:m,cid:t.mediaStreamTrack.id})];if(e.backupCodec===true){e.backupCodec={codec:ja}}if(e.backupCodec&&m!==e.backupCodec.codec&&v.encryption===Ie.NONE){if(!this.roomOptions.dynacast){this.roomOptions.dynacast=true}v.simulcastCodecs.push(new li({codec:e.backupCodec.codec,cid:""}))}}p=$a(t.source===br.Source.ScreenShare,v.width,v.height,e);v.layers=hc(v.width,v.height,p,Ur(e.videoCodec))}else if(t.kind===br.Kind.Audio){p=[{maxBitrate:(c=e.audioPreset)===null||c===void 0?void 0:c.maxBitrate,priority:(d=(u=e.audioPreset)===null||u===void 0?void 0:u.priority)!==null&&d!==void 0?d:"high",networkPriority:(l=(h=e.audioPreset)===null||h===void 0?void 0:h.priority)!==null&&l!==void 0?l:"high"}]}if(!this.engine||this.engine.isClosed){throw new Ws("cannot publish track when not connected")}const b=()=>bn(this,void 0,void 0,(function*(){var i,n,s;if(!this.engine.pcManager){throw new Ws("pcManager is not ready")}t.sender=yield this.engine.createSender(t,e,p);if(To(t)){(i=e.degradationPreference)!==null&&i!==void 0?i:e.degradationPreference=oc(t);t.setDegradationPreference(e.degradationPreference)}if(p){if(qr()&&t.kind===br.Kind.Audio){let e=undefined;for(const i of this.engine.pcManager.publisher.getTransceivers()){if(i.sender===t.sender){e=i;break}}if(e){this.engine.pcManager.publisher.setTrackCodecBitrate({transceiver:e,codec:"opus",maxbr:((n=p[0])===null||n===void 0?void 0:n.maxBitrate)?p[0].maxBitrate/1e3:0})}}else if(t.codec&&Ur(t.codec)&&((s=p[0])===null||s===void 0?void 0:s.maxBitrate)){this.engine.pcManager.publisher.setTrackCodecBitrate({cid:v.cid,codec:t.codec,maxbr:p[0].maxBitrate/1e3})}}yield this.engine.negotiate()}));let g;if(this.enabledPublishVideoCodecs.length>0){const t=yield Promise.all([this.engine.addTrack(v),b()]);g=t[0]}else{g=yield this.engine.addTrack(v);let i;g.codecs.forEach((t=>{if(i===undefined){i=t.mimeType}}));if(i&&t.kind===br.Kind.Video){const n=Uo(i);if(n!==m){this.log.debug("falling back to server selected codec",Object.assign(Object.assign(Object.assign({},this.logContext),Fo(t)),{codec:n}));e.videoCodec=n;p=$a(t.source===br.Source.ScreenShare,v.width,v.height,e)}}yield b()}const y=new Uc(t.kind,g,t,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});y.options=e;t.sid=g.sid;this.log.debug("publishing ".concat(t.kind," with encodings"),Object.assign(Object.assign({},this.logContext),{encodings:p,trackInfo:g}));if(To(t)){t.startMonitor(this.engine.client)}else if(So(t)){t.startMonitor()}this.addTrackPublication(y);this.emit(tr.LocalTrackPublished,y);return y}))}get isLocal(){return true}publishAdditionalCodecForTrack(t,e,i){return bn(this,void 0,void 0,(function*(){var n;if(this.encryptionType!==Ie.NONE){return}let s;this.trackPublications.forEach((e=>{if(!e.track){return}if(e.track===t){s=e}}));if(!s){throw new Hs("track is not published")}if(!To(t)){throw new Hs("track is not a video track")}const r=Object.assign(Object.assign({},(n=this.roomOptions)===null||n===void 0?void 0:n.publishDefaults),i);const o=Xa(t,e,r);if(!o){this.log.info("backup codec has been disabled, ignoring request to add additional codec for track",Object.assign(Object.assign({},this.logContext),Fo(t)));return}const a=t.addSimulcastTrack(e,o);if(!a){return}const c=new fi({cid:a.mediaStreamTrack.id,type:br.kindToProto(t.kind),muted:t.isMuted,source:br.sourceToProto(t.source),sid:t.sid,simulcastCodecs:[{codec:r.videoCodec,cid:a.mediaStreamTrack.id}]});c.layers=hc(c.width,c.height,o);if(!this.engine||this.engine.isClosed){throw new Ws("cannot publish track when not connected")}const u=()=>bn(this,void 0,void 0,(function*(){yield this.engine.createSimulcastSender(t,a,r,o);yield this.engine.negotiate()}));const d=yield Promise.all([this.engine.addTrack(c),u()]);const h=d[0];this.log.debug("published ".concat(e," for track ").concat(t.sid),Object.assign(Object.assign({},this.logContext),{encodings:o,trackInfo:h}))}))}unpublishTrack(t,e){return bn(this,void 0,void 0,(function*(){var i,n;if(yo(t)){const e=this.pendingPublishPromises.get(t);if(e){this.log.info("awaiting publish promise before attempting to unpublish",Object.assign(Object.assign({},this.logContext),Fo(t)));yield e}}const s=this.getPublicationForTrack(t);const r=s?Fo(s):undefined;this.log.debug("unpublishing track",Object.assign(Object.assign({},this.logContext),r));if(!s||!s.track){this.log.warn("track was not unpublished because no publication was found",Object.assign(Object.assign({},this.logContext),r));return undefined}t=s.track;t.off(ir.Muted,this.onTrackMuted);t.off(ir.Unmuted,this.onTrackUnmuted);t.off(ir.Ended,this.handleTrackEnded);t.off(ir.UpstreamPaused,this.onTrackUpstreamPaused);t.off(ir.UpstreamResumed,this.onTrackUpstreamResumed);t.off(ir.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate);if(e===undefined){e=(n=(i=this.roomOptions)===null||i===void 0?void 0:i.stopLocalTrackOnUnpublish)!==null&&n!==void 0?n:true}if(e){t.stop()}else{t.stopMonitor()}let o=false;const a=t.sender;t.sender=undefined;if(this.engine.pcManager&&this.engine.pcManager.currentState<Da.FAILED&&a){try{for(const t of this.engine.pcManager.publisher.getTransceivers()){if(t.sender===a){t.direction="inactive";o=true}}if(this.engine.removeTrack(a)){o=true}if(To(t)){for(const[,e]of t.simulcastCodecs){if(e.sender){if(this.engine.removeTrack(e.sender)){o=true}e.sender=undefined}}t.simulcastCodecs.clear()}}catch(t){this.log.warn("failed to unpublish track",Object.assign(Object.assign(Object.assign({},this.logContext),r),{error:t}))}}this.trackPublications.delete(s.trackSid);switch(s.kind){case br.Kind.Audio:this.audioTrackPublications.delete(s.trackSid);break;case br.Kind.Video:this.videoTrackPublications.delete(s.trackSid);break}this.emit(tr.LocalTrackUnpublished,s);s.setTrack(undefined);if(o){yield this.engine.negotiate()}return s}))}unpublishTracks(t){return bn(this,void 0,void 0,(function*(){const e=yield Promise.all(t.map((t=>this.unpublishTrack(t))));return e.filter((t=>!!t))}))}republishAllTracks(t){return bn(this,arguments,void 0,(function(t){var e=this;let i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;return function*(){if(e.republishPromise){yield e.republishPromise}e.republishPromise=new Promise(((n,s)=>bn(e,void 0,void 0,(function*(){try{const e=[];this.trackPublications.forEach((i=>{if(i.track){if(t){i.options=Object.assign(Object.assign({},i.options),t)}e.push(i)}}));yield Promise.all(e.map((t=>bn(this,void 0,void 0,(function*(){const e=t.track;yield this.unpublishTrack(e,false);if(i&&!e.isMuted&&e.source!==br.Source.ScreenShare&&e.source!==br.Source.ScreenShareAudio&&(So(e)||To(e))&&!e.isUserProvided){this.log.debug("restarting existing track",Object.assign(Object.assign({},this.logContext),{track:t.trackSid}));yield e.restartTrack()}yield this.publishOrRepublishTrack(e,t.options,true)})))));n()}catch(t){s(t)}finally{this.republishPromise=undefined}}))));yield e.republishPromise}()}))}publishData(t){return bn(this,arguments,void 0,(function(t){var e=this;let i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};return function*(){const n=i.reliable?Ae.RELIABLE:Ae.LOSSY;const s=i.destinationIdentities;const r=i.topic;const o=new De({kind:n,value:{case:"user",value:new Ue({participantIdentity:e.identity,payload:t,destinationIdentities:s,topic:r})}});yield e.engine.sendDataPacket(o,n)}()}))}publishDtmf(t,e){return bn(this,void 0,void 0,(function*(){const i=new De({kind:Ae.RELIABLE,value:{case:"sipDtmf",value:new Le({code:t,digit:e})}});yield this.engine.sendDataPacket(i,Ae.RELIABLE)}))}sendChatMessage(t,e){return bn(this,void 0,void 0,(function*(){const i={id:crypto.randomUUID(),message:t,timestamp:Date.now(),attachedFiles:e===null||e===void 0?void 0:e.attachments};const n=new De({value:{case:"chatMessage",value:new Be(Object.assign(Object.assign({},i),{timestamp:B.parse(i.timestamp)}))}});yield this.engine.sendDataPacket(n,Ae.RELIABLE);this.emit(tr.ChatMessage,i);return i}))}editChatMessage(t,e){return bn(this,void 0,void 0,(function*(){const i=Object.assign(Object.assign({},e),{message:t,editTimestamp:Date.now()});const n=new De({value:{case:"chatMessage",value:new Be(Object.assign(Object.assign({},i),{timestamp:B.parse(i.timestamp),editTimestamp:B.parse(i.editTimestamp)}))}});yield this.engine.sendDataPacket(n,Ae.RELIABLE);this.emit(tr.ChatMessage,i);return i}))}sendText(t,e){return bn(this,void 0,void 0,(function*(){var i;const n=crypto.randomUUID();const s=(new TextEncoder).encode(t);const r=s.byteLength;const o=(i=e===null||e===void 0?void 0:e.attachments)===null||i===void 0?void 0:i.map((()=>crypto.randomUUID()));const a=new Array(o?o.length+1:1).fill(0);const c=(t,i)=>{var n;a[i]=t;const s=a.reduce(((t,e)=>t+e),0);(n=e===null||e===void 0?void 0:e.onProgress)===null||n===void 0?void 0:n.call(e,s)};const u=yield this.streamText({streamId:n,totalSize:r,destinationIdentities:e===null||e===void 0?void 0:e.destinationIdentities,topic:e===null||e===void 0?void 0:e.topic,attachedStreamIds:o,attributes:e===null||e===void 0?void 0:e.attributes});yield u.write(t);c(1,0);yield u.close();if((e===null||e===void 0?void 0:e.attachments)&&o){yield Promise.all(e.attachments.map(((t,i)=>bn(this,void 0,void 0,(function*(){return this._sendFile(o[i],t,{topic:e.topic,mimeType:t.type,onProgress:t=>{c(t,i+1)}})})))))}return u.info}))}streamText(t){return bn(this,void 0,void 0,(function*(){var e,i;const n=(e=t===null||t===void 0?void 0:t.streamId)!==null&&e!==void 0?e:crypto.randomUUID();const s={id:n,mimeType:"text/plain",timestamp:Date.now(),topic:(i=t===null||t===void 0?void 0:t.topic)!==null&&i!==void 0?i:"",size:t===null||t===void 0?void 0:t.totalSize,attributes:t===null||t===void 0?void 0:t.attributes};const r=new si({streamId:n,mimeType:s.mimeType,topic:s.topic,timestamp:go(s.timestamp),totalLength:go(t===null||t===void 0?void 0:t.totalSize),attributes:s.attributes,contentHeader:{case:"textHeader",value:new ii({version:t===null||t===void 0?void 0:t.version,attachedStreamIds:t===null||t===void 0?void 0:t.attachedStreamIds,replyToStreamId:t===null||t===void 0?void 0:t.replyToStreamId,operationType:(t===null||t===void 0?void 0:t.type)==="update"?ei.UPDATE:ei.CREATE})}});const o=t===null||t===void 0?void 0:t.destinationIdentities;const a=new De({destinationIdentities:o,value:{case:"streamHeader",value:r}});yield this.engine.sendDataPacket(a,Ae.RELIABLE);let c=0;const u=this;const d=new WritableStream({write(t){return bn(this,void 0,void 0,(function*(){for(const e of Ro(t,Jc)){yield u.engine.waitForBufferStatusLow(Ae.RELIABLE);const t=new ri({content:e,streamId:n,chunkIndex:go(c)});const i=new De({destinationIdentities:o,value:{case:"streamChunk",value:t}});yield u.engine.sendDataPacket(i,Ae.RELIABLE);c+=1}}))},close(){return bn(this,void 0,void 0,(function*(){const t=new oi({streamId:n});const e=new De({destinationIdentities:o,value:{case:"streamTrailer",value:t}});yield u.engine.sendDataPacket(e,Ae.RELIABLE)}))},abort(t){console.log("Sink error:",t)}});let h=()=>bn(this,void 0,void 0,(function*(){yield l.close()}));u.engine.once(er.Closing,h);const l=new jc(d,s,(()=>this.engine.off(er.Closing,h)));return l}))}sendFile(t,e){return bn(this,void 0,void 0,(function*(){const i=crypto.randomUUID();yield this._sendFile(i,t,e);return{id:i}}))}_sendFile(t,e,i){return bn(this,void 0,void 0,(function*(){var n;const s=yield this.streamBytes({streamId:t,totalSize:e.size,name:e.name,mimeType:(n=i===null||i===void 0?void 0:i.mimeType)!==null&&n!==void 0?n:e.type,topic:i===null||i===void 0?void 0:i.topic,destinationIdentities:i===null||i===void 0?void 0:i.destinationIdentities});const r=e.stream().getReader();while(true){const{done:t,value:e}=yield r.read();if(t){break}yield s.write(e)}yield s.close();return s.info}))}streamBytes(t){return bn(this,void 0,void 0,(function*(){var e,i,n,s,r;const o=(e=t===null||t===void 0?void 0:t.streamId)!==null&&e!==void 0?e:crypto.randomUUID();const a=t===null||t===void 0?void 0:t.destinationIdentities;const c={id:o,mimeType:(i=t===null||t===void 0?void 0:t.mimeType)!==null&&i!==void 0?i:"application/octet-stream",topic:(n=t===null||t===void 0?void 0:t.topic)!==null&&n!==void 0?n:"",timestamp:Date.now(),attributes:t===null||t===void 0?void 0:t.attributes,size:t===null||t===void 0?void 0:t.totalSize,name:(s=t===null||t===void 0?void 0:t.name)!==null&&s!==void 0?s:"unknown"};const u=new si({totalLength:go((r=c.size)!==null&&r!==void 0?r:0),mimeType:c.mimeType,streamId:o,topic:c.topic,timestamp:go(Date.now()),contentHeader:{case:"byteHeader",value:new ni({name:c.name})}});const h=new De({destinationIdentities:a,value:{case:"streamHeader",value:u}});yield this.engine.sendDataPacket(h,Ae.RELIABLE);let l=0;const f=new d;const m=this.engine;const v=this.log;const p=new WritableStream({write(t){return bn(this,void 0,void 0,(function*(){const e=yield f.lock();let i=0;try{while(i<t.byteLength){const e=t.slice(i,i+Jc);yield m.waitForBufferStatusLow(Ae.RELIABLE);const n=new De({destinationIdentities:a,value:{case:"streamChunk",value:new ri({content:e,streamId:o,chunkIndex:go(l)})}});yield m.sendDataPacket(n,Ae.RELIABLE);l+=1;i+=e.byteLength}}finally{e()}}))},close(){return bn(this,void 0,void 0,(function*(){const t=new oi({streamId:o});const e=new De({destinationIdentities:a,value:{case:"streamTrailer",value:t}});yield m.sendDataPacket(e,Ae.RELIABLE)}))},abort(t){v.error("Sink error:",t)}});const b=new Rc(p,c);return b}))}performRpc(t){return bn(this,arguments,void 0,(function(t){var e=this;let{destinationIdentity:i,method:n,payload:s,responseTimeout:r=1e4}=t;return function*(){const t=2e3;return new Promise(((o,a)=>bn(e,void 0,void 0,(function*(){var e,c,u,d;if(Ua(s)>Ma){a(xa.builtIn("REQUEST_PAYLOAD_TOO_LARGE"));return}if(((c=(e=this.engine.latestJoinResponse)===null||e===void 0?void 0:e.serverInfo)===null||c===void 0?void 0:c.version)&&Zr((d=(u=this.engine.latestJoinResponse)===null||u===void 0?void 0:u.serverInfo)===null||d===void 0?void 0:d.version,"1.8.0")<0){a(xa.builtIn("UNSUPPORTED_SERVER"));return}const h=crypto.randomUUID();yield this.publishRpcRequest(i,h,n,s,r-t);const l=setTimeout((()=>{this.pendingAcks.delete(h);a(xa.builtIn("CONNECTION_TIMEOUT"));this.pendingResponses.delete(h);clearTimeout(f)}),t);this.pendingAcks.set(h,{resolve:()=>{clearTimeout(l)},participantIdentity:i});const f=setTimeout((()=>{this.pendingResponses.delete(h);a(xa.builtIn("RESPONSE_TIMEOUT"))}),r);this.pendingResponses.set(h,{resolve:(t,e)=>{clearTimeout(f);if(this.pendingAcks.has(h)){console.warn("RPC response received before ack",h);this.pendingAcks.delete(h);clearTimeout(l)}if(e){a(e)}else{o(t!==null&&t!==void 0?t:"")}},participantIdentity:i})}))))}()}))}registerRpcMethod(t,e){if(this.rpcHandlers.has(t)){this.log.warn("you're overriding the RPC handler for method ".concat(t,", in the future this will throw an error"))}this.rpcHandlers.set(t,e)}unregisterRpcMethod(t){this.rpcHandlers.delete(t)}setTrackSubscriptionPermissions(t){let e=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];this.participantTrackPermissions=e;this.allParticipantsAllowedToSubscribe=t;if(!this.engine.client.isDisconnected){this.updateTrackSubscriptionPermissions()}}handleIncomingRpcAck(t){const e=this.pendingAcks.get(t);if(e){e.resolve();this.pendingAcks.delete(t)}else{console.error("Ack received for unexpected RPC request",t)}}handleIncomingRpcResponse(t,e,i){const n=this.pendingResponses.get(t);if(n){n.resolve(e,i);this.pendingResponses.delete(t)}else{console.error("Response received for unexpected RPC request",t)}}publishRpcRequest(t,e,i,n,s){return bn(this,void 0,void 0,(function*(){const r=new De({destinationIdentities:[t],kind:Ae.RELIABLE,value:{case:"rpcRequest",value:new Ve({id:e,method:i,payload:n,responseTimeoutMs:s,version:1})}});yield this.engine.sendDataPacket(r,Ae.RELIABLE)}))}handleParticipantDisconnected(t){for(const[e,{participantIdentity:i}]of this.pendingAcks){if(i===t){this.pendingAcks.delete(e)}}for(const[e,{participantIdentity:i,resolve:n}]of this.pendingResponses){if(i===t){n(null,xa.builtIn("RECIPIENT_DISCONNECTED"));this.pendingResponses.delete(e)}}}setEnabledPublishCodecs(t){this.enabledPublishVideoCodecs=t.filter((t=>t.mime.split("/")[0].toLowerCase()==="video"))}updateInfo(t){if(!super.updateInfo(t)){return false}t.tracks.forEach((t=>{var e,i;const n=this.trackPublications.get(t.sid);if(n){const s=n.isMuted||((i=(e=n.track)===null||e===void 0?void 0:e.isUpstreamPaused)!==null&&i!==void 0?i:false);if(s!==t.muted){this.log.debug("updating server mute state after reconcile",Object.assign(Object.assign(Object.assign({},this.logContext),Fo(n)),{mutedOnServer:s}));this.engine.client.sendMuteTrack(t.sid,s)}}}));return true}getPublicationForTrack(t){let e;this.trackPublications.forEach((i=>{const n=i.track;if(!n){return}if(t instanceof MediaStreamTrack){if(So(n)||To(n)){if(n.mediaStreamTrack===t){e=i}}}else if(t===n){e=i}}));return e}waitForPendingPublicationOfSource(t){return bn(this,void 0,void 0,(function*(){const e=1e4;const i=Date.now();while(Date.now()<i+e){const e=Array.from(this.pendingPublishPromises.entries()).find((e=>{let[i]=e;return i.source===t}));if(e){return e[1]}yield Nr(20)}}))}}class Hc extends Mc{constructor(t,e,i,n){super(t,e.sid,e.name,n);this.track=undefined;this.allowed=true;this.disabled=false;this.currentVideoQuality=pr.HIGH;this.handleEnded=t=>{this.setTrack(undefined);this.emit(ir.Ended,t)};this.handleVisibilityChange=t=>{this.log.debug("adaptivestream video visibility ".concat(this.trackSid,", visible=").concat(t),this.logContext);this.disabled=!t;this.emitTrackUpdate()};this.handleVideoDimensionsChange=t=>{this.log.debug("adaptivestream video dimensions ".concat(t.width,"x").concat(t.height),this.logContext);this.videoDimensions=t;this.emitTrackUpdate()};this.subscribed=i;this.updateInfo(e)}setSubscribed(t){const e=this.subscriptionStatus;const i=this.permissionStatus;this.subscribed=t;if(t){this.allowed=true}const n=new Ti({trackSids:[this.trackSid],subscribe:this.subscribed,participantTracks:[new ze({participantSid:"",trackSids:[this.trackSid]})]});this.emit(ir.UpdateSubscription,n);this.emitSubscriptionUpdateIfChanged(e);this.emitPermissionUpdateIfChanged(i)}get subscriptionStatus(){if(this.subscribed===false){return Mc.SubscriptionStatus.Unsubscribed}if(!super.isSubscribed){return Mc.SubscriptionStatus.Desired}return Mc.SubscriptionStatus.Subscribed}get permissionStatus(){return this.allowed?Mc.PermissionStatus.Allowed:Mc.PermissionStatus.NotAllowed}get isSubscribed(){if(this.subscribed===false){return false}return super.isSubscribed}get isDesired(){return this.subscribed!==false}get isEnabled(){return!this.disabled}get isLocal(){return false}setEnabled(t){if(!this.isManualOperationAllowed()||this.disabled===!t){return}this.disabled=!t;this.emitTrackUpdate()}setVideoQuality(t){if(!this.isManualOperationAllowed()||this.currentVideoQuality===t){return}this.currentVideoQuality=t;this.videoDimensions=undefined;this.emitTrackUpdate()}setVideoDimensions(t){var e,i;if(!this.isManualOperationAllowed()){return}if(((e=this.videoDimensions)===null||e===void 0?void 0:e.width)===t.width&&((i=this.videoDimensions)===null||i===void 0?void 0:i.height)===t.height){return}if(Co(this.track)){this.videoDimensions=t}this.currentVideoQuality=undefined;this.emitTrackUpdate()}setVideoFPS(t){if(!this.isManualOperationAllowed()){return}if(!Co(this.track)){return}if(this.fps===t){return}this.fps=t;this.emitTrackUpdate()}get videoQuality(){return this.currentVideoQuality}setTrack(t){const e=this.subscriptionStatus;const i=this.permissionStatus;const n=this.track;if(n===t){return}if(n){n.off(ir.VideoDimensionsChanged,this.handleVideoDimensionsChange);n.off(ir.VisibilityChanged,this.handleVisibilityChange);n.off(ir.Ended,this.handleEnded);n.detach();n.stopMonitor();this.emit(ir.Unsubscribed,n)}super.setTrack(t);if(t){t.sid=this.trackSid;t.on(ir.VideoDimensionsChanged,this.handleVideoDimensionsChange);t.on(ir.VisibilityChanged,this.handleVisibilityChange);t.on(ir.Ended,this.handleEnded);this.emit(ir.Subscribed,t)}this.emitPermissionUpdateIfChanged(i);this.emitSubscriptionUpdateIfChanged(e)}setAllowed(t){const e=this.subscriptionStatus;const i=this.permissionStatus;this.allowed=t;this.emitPermissionUpdateIfChanged(i);this.emitSubscriptionUpdateIfChanged(e)}setSubscriptionError(t){this.emit(ir.SubscriptionFailed,t)}updateInfo(t){super.updateInfo(t);const e=this.metadataMuted;this.metadataMuted=t.muted;if(this.track){this.track.setMuted(t.muted)}else if(e!==t.muted){this.emit(t.muted?ir.Muted:ir.Unmuted)}}emitSubscriptionUpdateIfChanged(t){const e=this.subscriptionStatus;if(t===e){return}this.emit(ir.SubscriptionStatusChanged,e,t)}emitPermissionUpdateIfChanged(t){const e=this.permissionStatus;if(e!==t){this.emit(ir.SubscriptionPermissionChanged,this.permissionStatus,t)}}isManualOperationAllowed(){if(this.kind===br.Kind.Video&&this.isAdaptiveStream){this.log.warn("adaptive stream is enabled, cannot change video track settings",this.logContext);return false}if(!this.isDesired){this.log.warn("cannot update track settings when not subscribed",this.logContext);return false}return true}get isAdaptiveStream(){return Co(this.track)&&this.track.isAdaptiveStream}emitTrackUpdate(){const t=new Si({trackSids:[this.trackSid],disabled:this.disabled,fps:this.fps});if(this.videoDimensions){t.width=Math.ceil(this.videoDimensions.width);t.height=Math.ceil(this.videoDimensions.height)}else if(this.currentVideoQuality!==undefined){t.quality=this.currentVideoQuality}else{t.quality=pr.HIGH}this.emit(ir.UpdateSettings,t)}}class zc extends Bc{static fromParticipantInfo(t,e,i){return new zc(t,e.sid,e.identity,e.name,e.metadata,e.attributes,i,e.kind)}get logContext(){return Object.assign(Object.assign({},super.logContext),{rpID:this.sid,remoteParticipant:this.identity})}constructor(t,e,i,n,s,r,o){let a=arguments.length>7&&arguments[7]!==undefined?arguments[7]:je.STANDARD;super(e,i||"",n,s,r,o,a);this.signalClient=t;this.trackPublications=new Map;this.audioTrackPublications=new Map;this.videoTrackPublications=new Map;this.volumeMap=new Map}addTrackPublication(t){super.addTrackPublication(t);t.on(ir.UpdateSettings,(e=>{this.log.debug("send update settings",Object.assign(Object.assign({},this.logContext),Fo(t)));this.signalClient.sendUpdateTrackSettings(e)}));t.on(ir.UpdateSubscription,(t=>{t.participantTracks.forEach((t=>{t.participantSid=this.sid}));this.signalClient.sendUpdateSubscription(t)}));t.on(ir.SubscriptionPermissionChanged,(e=>{this.emit(tr.TrackSubscriptionPermissionChanged,t,e)}));t.on(ir.SubscriptionStatusChanged,(e=>{this.emit(tr.TrackSubscriptionStatusChanged,t,e)}));t.on(ir.Subscribed,(e=>{this.emit(tr.TrackSubscribed,e,t)}));t.on(ir.Unsubscribed,(e=>{this.emit(tr.TrackUnsubscribed,e,t)}));t.on(ir.SubscriptionFailed,(e=>{this.emit(tr.TrackSubscriptionFailed,t.trackSid,e)}))}getTrackPublication(t){const e=super.getTrackPublication(t);if(e){return e}}getTrackPublicationByName(t){const e=super.getTrackPublicationByName(t);if(e){return e}}setVolume(t){let e=arguments.length>1&&arguments[1]!==undefined?arguments[1]:br.Source.Microphone;this.volumeMap.set(e,t);const i=this.getTrackPublication(e);if(i&&i.track){i.track.setVolume(t)}}getVolume(){let t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:br.Source.Microphone;const e=this.getTrackPublication(t);if(e&&e.track){return e.track.getVolume()}return this.volumeMap.get(t)}addSubscribedMediaTrack(t,e,i,n,s,r){let o=this.getTrackPublicationBySid(e);if(!o){if(!e.startsWith("TR")){this.trackPublications.forEach((e=>{if(!o&&t.kind===e.kind.toString()){o=e}}))}}if(!o){if(r===0){this.log.error("could not find published track",Object.assign(Object.assign({},this.logContext),{trackSid:e}));this.emit(tr.TrackSubscriptionFailed,e);return}if(r===undefined)r=20;setTimeout((()=>{this.addSubscribedMediaTrack(t,e,i,n,s,r-1)}),150);return}if(t.readyState==="ended"){this.log.error("unable to subscribe because MediaStreamTrack is ended. Do not call MediaStreamTrack.stop()",Object.assign(Object.assign({},this.logContext),Fo(o)));this.emit(tr.TrackSubscriptionFailed,e);return}const a=t.kind==="video";let c;if(a){c=new Nc(t,e,n,s)}else{c=new _c(t,e,n,this.audioContext,this.audioOutput)}c.source=o.source;c.isMuted=o.isMuted;c.setMediaStream(i);c.start();o.setTrack(c);if(this.volumeMap.has(o.source)&&Oo(c)&&ko(c)){c.setVolume(this.volumeMap.get(o.source))}return o}get hasMetadata(){return!!this.participantInfo}getTrackPublicationBySid(t){return this.trackPublications.get(t)}updateInfo(t){if(!super.updateInfo(t)){return false}const e=new Map;const i=new Map;t.tracks.forEach((t=>{var n,s;let r=this.getTrackPublicationBySid(t.sid);if(!r){const e=br.kindFromProto(t.type);if(!e){return}r=new Hc(e,t,(n=this.signalClient.connectOptions)===null||n===void 0?void 0:n.autoSubscribe,{loggerContextCb:()=>this.logContext,loggerName:(s=this.loggerOptions)===null||s===void 0?void 0:s.loggerName});r.updateInfo(t);i.set(t.sid,r);const o=Array.from(this.trackPublications.values()).find((t=>t.source===(r===null||r===void 0?void 0:r.source)));if(o&&r.source!==br.Source.Unknown){this.log.debug("received a second track publication for ".concat(this.identity," with the same source: ").concat(r.source),Object.assign(Object.assign({},this.logContext),{oldTrack:Fo(o),newTrack:Fo(r)}))}this.addTrackPublication(r)}else{r.updateInfo(t)}e.set(t.sid,r)}));this.trackPublications.forEach((t=>{if(!e.has(t.trackSid)){this.log.trace("detected removed track on remote participant, unpublishing",Object.assign(Object.assign({},this.logContext),Fo(t)));this.unpublishTrack(t.trackSid,true)}}));i.forEach((t=>{this.emit(tr.TrackPublished,t)}));return true}unpublishTrack(t,e){const i=this.trackPublications.get(t);if(!i){return}const{track:n}=i;if(n){n.stop();i.setTrack(undefined)}this.trackPublications.delete(t);switch(i.kind){case br.Kind.Audio:this.audioTrackPublications.delete(t);break;case br.Kind.Video:this.videoTrackPublications.delete(t);break}if(e){this.emit(tr.TrackUnpublished,i)}}setAudioOutput(t){return bn(this,void 0,void 0,(function*(){this.audioOutput=t;const e=[];this.audioTrackPublications.forEach((i=>{var n;if(ko(i.track)&&Oo(i.track)){e.push(i.track.setSinkId((n=t.deviceId)!==null&&n!==void 0?n:"default"))}}));yield Promise.all(e)}))}emit(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++){i[n-1]=arguments[n]}this.log.trace("participant event",Object.assign(Object.assign({},this.logContext),{event:t,args:i}));return super.emit(t,...i)}}var Wc;(function(t){t["Disconnected"]="disconnected";t["Connecting"]="connecting";t["Connected"]="connected";t["Reconnecting"]="reconnecting";t["SignalReconnecting"]="signalReconnecting"})(Wc||(Wc={}));const Kc=4*1e3;class Qc extends Sn.EventEmitter{constructor(t){var e;var i,n,s;super();e=this;this.state=Wc.Disconnected;this.activeSpeakers=[];this.isE2EEEnabled=false;this.audioEnabled=true;this.isVideoPlaybackBlocked=false;this.log=dn;this.bufferedEvents=[];this.isResuming=false;this.byteStreamControllers=new Map;this.textStreamControllers=new Map;this.byteStreamHandlers=new Map;this.textStreamHandlers=new Map;this.rpcHandlers=new Map;this.connect=(t,e,i)=>bn(this,void 0,void 0,(function*(){var n;if(!Fr()){if(zr()){throw Error("WebRTC isn't detected, have you called registerGlobals?")}else{throw Error("LiveKit doesn't seem to be supported on this browser. Try to update your browser and make sure no browser extensions are disabling webRTC.")}}const s=yield this.disconnectLock.lock();if(this.state===Wc.Connected){this.log.info("already connected to room ".concat(this.name),this.logContext);s();return Promise.resolve()}if(this.connectFuture){s();return this.connectFuture.promise}this.setAndEmitConnectionState(Wc.Connecting);if(((n=this.regionUrlProvider)===null||n===void 0?void 0:n.getServerUrl().toString())!==t){this.regionUrl=undefined;this.regionUrlProvider=undefined}if(Wr(new URL(t))){if(this.regionUrlProvider===undefined){this.regionUrlProvider=new wc(t,e)}else{this.regionUrlProvider.updateToken(e)}this.regionUrlProvider.fetchRegionSettings().then((t=>{var e;(e=this.regionUrlProvider)===null||e===void 0?void 0:e.setServerReportedRegions(t)})).catch((t=>{this.log.warn("could not fetch region settings",Object.assign(Object.assign({},this.logContext),{error:t}))}))}const r=(n,o,a)=>bn(this,void 0,void 0,(function*(){var c,u;if(this.abortController){this.abortController.abort()}const d=new AbortController;this.abortController=d;s===null||s===void 0?void 0:s();try{yield this.attemptConnection(a!==null&&a!==void 0?a:t,e,i,d);this.abortController=undefined;n()}catch(t){if(this.regionUrlProvider&&t instanceof Js&&t.reason!==Vs.Cancelled&&t.reason!==Vs.NotAllowed){let e=null;try{e=yield this.regionUrlProvider.getNextBestRegionUrl((c=this.abortController)===null||c===void 0?void 0:c.signal)}catch(t){if(t instanceof Js&&(t.status===401||t.reason===Vs.Cancelled)){this.handleDisconnect(this.options.stopLocalTrackOnUnpublish);o(t);return}}if(e&&!((u=this.abortController)===null||u===void 0?void 0:u.signal.aborted)){this.log.info("Initial connection failed with ConnectionError: ".concat(t.message,". Retrying with another region: ").concat(e),this.logContext);this.recreateEngine();yield r(n,o,e)}else{this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,po(t));o(t)}}else{let e=ge.UNKNOWN_REASON;if(t instanceof Js){e=po(t)}this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,e);o(t)}}}));const o=this.regionUrl;this.regionUrl=undefined;this.connectFuture=new co(((t,e)=>{r(t,e,o)}),(()=>{this.clearConnectionFutures()}));return this.connectFuture.promise}));this.connectSignal=(t,e,i,n,s,r)=>bn(this,void 0,void 0,(function*(){var o,a,c;const u=yield i.join(t,e,{autoSubscribe:n.autoSubscribe,adaptiveStream:typeof s.adaptiveStream==="object"?true:s.adaptiveStream,maxRetries:n.maxRetries,e2eeEnabled:!!this.e2eeManager,websocketTimeout:n.websocketTimeout},r.signal);let d=u.serverInfo;if(!d){d={version:u.serverVersion,region:u.serverRegion}}this.serverInfo=d;this.log.debug("connected to Livekit Server ".concat(Object.entries(d).map((t=>{let[e,i]=t;return"".concat(e,": ").concat(i)})).join(", ")),{room:(o=u.room)===null||o===void 0?void 0:o.name,roomSid:(a=u.room)===null||a===void 0?void 0:a.sid,identity:(c=u.participant)===null||c===void 0?void 0:c.identity});if(!d.version){throw new zs("unknown server version")}if(d.version==="0.15.1"&&this.options.dynacast){this.log.debug("disabling dynacast due to server version",this.logContext);s.dynacast=false}return u}));this.applyJoinResponse=t=>{const e=t.participant;this.localParticipant.sid=e.sid;this.localParticipant.identity=e.identity;this.localParticipant.setEnabledPublishCodecs(t.enabledPublishCodecs);if(this.options.e2ee&&this.e2eeManager){try{this.e2eeManager.setSifTrailer(t.sifTrailer)}catch(t){this.log.error(t instanceof Error?t.message:"Could not set SifTrailer",Object.assign(Object.assign({},this.logContext),{error:t}))}}this.handleParticipantUpdates([e,...t.otherParticipants]);if(t.room){this.handleRoomUpdate(t.room)}};this.attemptConnection=(t,e,i,n)=>bn(this,void 0,void 0,(function*(){var s,r;if(this.state===Wc.Reconnecting||this.isResuming||((s=this.engine)===null||s===void 0?void 0:s.pendingReconnect)){this.log.info("Reconnection attempt replaced by new connection attempt",this.logContext);this.recreateEngine()}else{this.maybeCreateEngine()}if((r=this.regionUrlProvider)===null||r===void 0?void 0:r.isCloud()){this.engine.setRegionUrlProvider(this.regionUrlProvider)}this.acquireAudioContext();this.connOptions=Object.assign(Object.assign({},Na),i);if(this.connOptions.rtcConfig){this.engine.rtcConfig=this.connOptions.rtcConfig}if(this.connOptions.peerConnectionTimeout){this.engine.peerConnectionTimeout=this.connOptions.peerConnectionTimeout}try{const i=yield this.connectSignal(t,e,this.engine,this.connOptions,this.options,n);this.applyJoinResponse(i);this.setupLocalParticipantEvents();this.emit(Xs.SignalConnected)}catch(t){yield this.engine.close();this.recreateEngine();const e=new Js("could not establish signal connection",Vs.ServerUnreachable);if(t instanceof Error){e.message="".concat(e.message,": ").concat(t.message)}if(t instanceof Js){e.reason=t.reason;e.status=t.status}this.log.debug("error trying to establish signal connection",Object.assign(Object.assign({},this.logContext),{error:t}));throw e}if(n.signal.aborted){yield this.engine.close();this.recreateEngine();throw new Js("Connection attempt aborted",Vs.Cancelled)}try{yield this.engine.waitForPCInitialConnection(this.connOptions.peerConnectionTimeout,n)}catch(t){yield this.engine.close();this.recreateEngine();throw t}if(Hr()&&this.options.disconnectOnPageLeave){window.addEventListener("pagehide",this.onPageLeave);window.addEventListener("beforeunload",this.onPageLeave)}if(Hr()){document.addEventListener("freeze",this.onPageLeave)}this.setAndEmitConnectionState(Wc.Connected);this.emit(Xs.Connected);this.registerConnectionReconcile()}));this.disconnect=function(){for(var t=arguments.length,i=new Array(t),n=0;n<t;n++){i[n]=arguments[n]}return bn(e,[...i],void 0,(function(){var t=this;let e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;return function*(){var i,n,s,r;const o=yield t.disconnectLock.lock();try{if(t.state===Wc.Disconnected){t.log.debug("already disconnected",t.logContext);return}t.log.info("disconnect from room",Object.assign({},t.logContext));if(t.state===Wc.Connecting||t.state===Wc.Reconnecting||t.isResuming){t.log.warn("abort connection attempt",t.logContext);(i=t.abortController)===null||i===void 0?void 0:i.abort();(s=(n=t.connectFuture)===null||n===void 0?void 0:n.reject)===null||s===void 0?void 0:s.call(n,new Js("Client initiated disconnect",Vs.Cancelled));t.connectFuture=undefined}if(!((r=t.engine)===null||r===void 0?void 0:r.client.isDisconnected)){yield t.engine.client.sendLeave()}if(t.engine){yield t.engine.close()}t.handleDisconnect(e,ge.CLIENT_INITIATED);t.engine=undefined}finally{o()}}()}))};this.onPageLeave=()=>bn(this,void 0,void 0,(function*(){this.log.info("Page leave detected, disconnecting",this.logContext);yield this.disconnect()}));this.startAudio=()=>bn(this,void 0,void 0,(function*(){const t=[];const e=or();if(e&&e.os==="iOS"){const e="livekit-dummy-audio-el";let i=document.getElementById(e);if(!i){i=document.createElement("audio");i.id=e;i.autoplay=true;i.hidden=true;const t=ao();t.enabled=true;const n=new MediaStream([t]);i.srcObject=n;document.addEventListener("visibilitychange",(()=>{if(!i){return}i.srcObject=document.hidden?null:n;if(!document.hidden){this.log.debug("page visible again, triggering startAudio to resume playback and update playback status",this.logContext);this.startAudio()}}));document.body.append(i);this.once(Xs.Disconnected,(()=>{i===null||i===void 0?void 0:i.remove();i=null}))}t.push(i)}this.remoteParticipants.forEach((e=>{e.audioTrackPublications.forEach((e=>{if(e.track){e.track.attachedElements.forEach((e=>{t.push(e)}))}}))}));try{yield Promise.all([this.acquireAudioContext(),...t.map((t=>{t.muted=false;return t.play()}))]);this.handleAudioPlaybackStarted()}catch(t){this.handleAudioPlaybackFailed(t);throw t}}));this.startVideo=()=>bn(this,void 0,void 0,(function*(){const t=[];for(const e of this.remoteParticipants.values()){e.videoTrackPublications.forEach((e=>{var i;(i=e.track)===null||i===void 0?void 0:i.attachedElements.forEach((e=>{if(!t.includes(e)){t.push(e)}}))}))}yield Promise.all(t.map((t=>t.play()))).then((()=>{this.handleVideoPlaybackStarted()})).catch((t=>{if(t.name==="NotAllowedError"){this.handleVideoPlaybackFailed()}else{this.log.warn("Resuming video playback failed, make sure you call `startVideo` directly in a user gesture handler",this.logContext)}}))}));this.handleRestarting=()=>{this.clearConnectionReconcile();this.isResuming=false;for(const t of this.remoteParticipants.values()){this.handleParticipantDisconnected(t.identity,t)}if(this.setAndEmitConnectionState(Wc.Reconnecting)){this.emit(Xs.Reconnecting)}};this.handleSignalRestarted=t=>bn(this,void 0,void 0,(function*(){this.log.debug("signal reconnected to server, region ".concat(t.serverRegion),Object.assign(Object.assign({},this.logContext),{region:t.serverRegion}));this.bufferedEvents=[];this.applyJoinResponse(t);try{yield this.localParticipant.republishAllTracks(undefined,true)}catch(t){this.log.error("error trying to re-publish tracks after reconnection",Object.assign(Object.assign({},this.logContext),{error:t}))}try{yield this.engine.waitForRestarted();this.log.debug("fully reconnected to server",Object.assign(Object.assign({},this.logContext),{region:t.serverRegion}))}catch(t){return}this.setAndEmitConnectionState(Wc.Connected);this.emit(Xs.Reconnected);this.registerConnectionReconcile();this.emitBufferedEvents()}));this.handleParticipantUpdates=t=>{t.forEach((t=>{var e;if(t.identity===this.localParticipant.identity){this.localParticipant.updateInfo(t);return}if(t.identity===""){t.identity=(e=this.sidToIdentity.get(t.sid))!==null&&e!==void 0?e:""}let i=this.remoteParticipants.get(t.identity);if(t.state===Ce.DISCONNECTED){this.handleParticipantDisconnected(t.identity,i)}else{i=this.getOrCreateParticipant(t.identity,t)}}))};this.handleActiveSpeakersUpdate=t=>{const e=[];const i={};t.forEach((t=>{i[t.sid]=true;if(t.sid===this.localParticipant.sid){this.localParticipant.audioLevel=t.level;this.localParticipant.setIsSpeaking(true);e.push(this.localParticipant)}else{const i=this.getRemoteParticipantBySid(t.sid);if(i){i.audioLevel=t.level;i.setIsSpeaking(true);e.push(i)}}}));if(!i[this.localParticipant.sid]){this.localParticipant.audioLevel=0;this.localParticipant.setIsSpeaking(false)}this.remoteParticipants.forEach((t=>{if(!i[t.sid]){t.audioLevel=0;t.setIsSpeaking(false)}}));this.activeSpeakers=e;this.emitWhenConnected(Xs.ActiveSpeakersChanged,e)};this.handleSpeakersChanged=t=>{const e=new Map;this.activeSpeakers.forEach((t=>{const i=this.remoteParticipants.get(t.identity);if(i&&i.sid!==t.sid){return}e.set(t.sid,t)}));t.forEach((t=>{let i=this.getRemoteParticipantBySid(t.sid);if(t.sid===this.localParticipant.sid){i=this.localParticipant}if(!i){return}i.audioLevel=t.level;i.setIsSpeaking(t.active);if(t.active){e.set(t.sid,i)}else{e.delete(t.sid)}}));const i=Array.from(e.values());i.sort(((t,e)=>e.audioLevel-t.audioLevel));this.activeSpeakers=i;this.emitWhenConnected(Xs.ActiveSpeakersChanged,i)};this.handleStreamStateUpdate=t=>{t.streamStates.forEach((t=>{const e=this.getRemoteParticipantBySid(t.participantSid);if(!e){return}const i=e.getTrackPublicationBySid(t.trackSid);if(!i||!i.track){return}const n=br.streamStateFromProto(t.state);if(n!==i.track.streamState){i.track.streamState=n;e.emit(tr.TrackStreamStateChanged,i,i.track.streamState);this.emitWhenConnected(Xs.TrackStreamStateChanged,i,i.track.streamState,e)}}))};this.handleSubscriptionPermissionUpdate=t=>{const e=this.getRemoteParticipantBySid(t.participantSid);if(!e){return}const i=e.getTrackPublicationBySid(t.trackSid);if(!i){return}i.setAllowed(t.allowed)};this.handleSubscriptionError=t=>{const e=Array.from(this.remoteParticipants.values()).find((e=>e.trackPublications.has(t.trackSid)));if(!e){return}const i=e.getTrackPublicationBySid(t.trackSid);if(!i){return}i.setSubscriptionError(t.err)};this.handleDataPacket=t=>{const e=this.remoteParticipants.get(t.participantIdentity);if(t.value.case==="user"){this.handleUserPacket(e,t.value.value,t.kind)}else if(t.value.case==="transcription"){this.handleTranscription(e,t.value.value)}else if(t.value.case==="sipDtmf"){this.handleSipDtmf(e,t.value.value)}else if(t.value.case==="chatMessage"){this.handleChatMessage(e,t.value.value)}else if(t.value.case==="metrics"){this.handleMetrics(t.value.value,e)}else if(t.value.case==="streamHeader"){this.handleStreamHeader(t.value.value,t.participantIdentity)}else if(t.value.case==="streamChunk"){this.handleStreamChunk(t.value.value)}else if(t.value.case==="streamTrailer"){this.handleStreamTrailer(t.value.value)}else if(t.value.case==="rpcRequest"){const e=t.value.value;this.handleIncomingRpcRequest(t.participantIdentity,e.id,e.method,e.payload,e.responseTimeoutMs,e.version)}};this.handleUserPacket=(t,e,i)=>{this.emit(Xs.DataReceived,e.payload,t,i,e.topic);t===null||t===void 0?void 0:t.emit(tr.DataReceived,e.payload,i)};this.handleSipDtmf=(t,e)=>{this.emit(Xs.SipDTMFReceived,e,t);t===null||t===void 0?void 0:t.emit(tr.SipDTMFReceived,e)};this.bufferedSegments=new Map;this.handleTranscription=(t,e)=>{const i=e.transcribedParticipantIdentity===this.localParticipant.identity?this.localParticipant:this.getParticipantByIdentity(e.transcribedParticipantIdentity);const n=i===null||i===void 0?void 0:i.trackPublications.get(e.trackId);const s=mo(e,this.transcriptionReceivedTimes);n===null||n===void 0?void 0:n.emit(ir.TranscriptionReceived,s);i===null||i===void 0?void 0:i.emit(tr.TranscriptionReceived,s,n);this.emit(Xs.TranscriptionReceived,s,i,n)};this.handleChatMessage=(t,e)=>{const i=vo(e);this.emit(Xs.ChatMessage,i,t)};this.handleMetrics=(t,e)=>{this.emit(Xs.MetricsReceived,t,e)};this.handleAudioPlaybackStarted=()=>{if(this.canPlaybackAudio){return}this.audioEnabled=true;this.emit(Xs.AudioPlaybackStatusChanged,true)};this.handleAudioPlaybackFailed=t=>{this.log.warn("could not playback audio",Object.assign(Object.assign({},this.logContext),{error:t}));if(!this.canPlaybackAudio){return}this.audioEnabled=false;this.emit(Xs.AudioPlaybackStatusChanged,false)};this.handleVideoPlaybackStarted=()=>{if(this.isVideoPlaybackBlocked){this.isVideoPlaybackBlocked=false;this.emit(Xs.VideoPlaybackStatusChanged,true)}};this.handleVideoPlaybackFailed=()=>{if(!this.isVideoPlaybackBlocked){this.isVideoPlaybackBlocked=true;this.emit(Xs.VideoPlaybackStatusChanged,false)}};this.handleDeviceChange=()=>bn(this,void 0,void 0,(function*(){var t,e,i;const n=zo.getInstance().previousDevices;const s=yield zo.getInstance().getDevices(undefined,false);const r=or();if((r===null||r===void 0?void 0:r.name)==="Chrome"&&r.os!=="iOS"){for(let t of s){const e=n.find((e=>e.deviceId===t.deviceId));if(e&&e.label!==""&&e.kind===t.kind&&e.label!==t.label){if(this.getActiveDevice(t.kind)==="default"){this.emit(Xs.ActiveDeviceChanged,t.kind,t.deviceId)}}}}const o=["audiooutput","audioinput","videoinput"];for(let r of o){const o=Ao(r);const a=this.localParticipant.getTrackPublication(o);if(a&&((t=a.track)===null||t===void 0?void 0:t.isUserProvided)){continue}const c=s.filter((t=>t.kind===r));const u=this.getActiveDevice(r);if(u===((e=n.filter((t=>t.kind===r))[0])===null||e===void 0?void 0:e.deviceId)){if(c.length>0&&((i=c[0])===null||i===void 0?void 0:i.deviceId)!==u){yield this.switchActiveDevice(r,c[0].deviceId);continue}}if(r==="audioinput"&&!Br()||r==="videoinput"){continue}if(c.length>0&&!c.find((t=>t.deviceId===this.getActiveDevice(r)))){yield this.switchActiveDevice(r,c[0].deviceId)}}this.emit(Xs.MediaDevicesChanged)}));this.handleRoomUpdate=t=>{const e=this.roomInfo;this.roomInfo=t;if(e&&e.metadata!==t.metadata){this.emitWhenConnected(Xs.RoomMetadataChanged,t.metadata)}if((e===null||e===void 0?void 0:e.activeRecording)!==t.activeRecording){this.emitWhenConnected(Xs.RecordingStatusChanged,t.activeRecording)}};this.handleConnectionQualityUpdate=t=>{t.updates.forEach((t=>{if(t.participantSid===this.localParticipant.sid){this.localParticipant.setConnectionQuality(t.quality);return}const e=this.getRemoteParticipantBySid(t.participantSid);if(e){e.setConnectionQuality(t.quality)}}))};this.onLocalParticipantMetadataChanged=t=>{this.emit(Xs.ParticipantMetadataChanged,t,this.localParticipant)};this.onLocalParticipantNameChanged=t=>{this.emit(Xs.ParticipantNameChanged,t,this.localParticipant)};this.onLocalAttributesChanged=t=>{this.emit(Xs.ParticipantAttributesChanged,t,this.localParticipant)};this.onLocalTrackMuted=t=>{this.emit(Xs.TrackMuted,t,this.localParticipant)};this.onLocalTrackUnmuted=t=>{this.emit(Xs.TrackUnmuted,t,this.localParticipant)};this.onTrackProcessorUpdate=t=>{var e;(e=t===null||t===void 0?void 0:t.onPublish)===null||e===void 0?void 0:e.call(t,this)};this.onLocalTrackPublished=t=>bn(this,void 0,void 0,(function*(){var e,i,n,s,r,o;(e=t.track)===null||e===void 0?void 0:e.on(ir.TrackProcessorUpdate,this.onTrackProcessorUpdate);(i=t.track)===null||i===void 0?void 0:i.on(ir.Restarted,this.onLocalTrackRestarted);(r=(s=(n=t.track)===null||n===void 0?void 0:n.getProcessor())===null||s===void 0?void 0:s.onPublish)===null||r===void 0?void 0:r.call(s,this);this.emit(Xs.LocalTrackPublished,t,this.localParticipant);if(So(t.track)){const e=yield t.track.checkForSilence();if(e){this.emit(Xs.LocalAudioSilenceDetected,t)}}const a=yield(o=t.track)===null||o===void 0?void 0:o.getDeviceId(false);const c=xo(t.source);if(c&&a&&a!==this.localParticipant.activeDeviceMap.get(c)){this.localParticipant.activeDeviceMap.set(c,a);this.emit(Xs.ActiveDeviceChanged,c,a)}}));this.onLocalTrackUnpublished=t=>{var e,i;(e=t.track)===null||e===void 0?void 0:e.off(ir.TrackProcessorUpdate,this.onTrackProcessorUpdate);(i=t.track)===null||i===void 0?void 0:i.off(ir.Restarted,this.onLocalTrackRestarted);this.emit(Xs.LocalTrackUnpublished,t,this.localParticipant)};this.onLocalTrackRestarted=t=>bn(this,void 0,void 0,(function*(){const e=yield t.getDeviceId(false);const i=xo(t.source);if(i&&e&&e!==this.localParticipant.activeDeviceMap.get(i)){this.log.debug("local track restarted, setting ".concat(i," ").concat(e," active"),this.logContext);this.localParticipant.activeDeviceMap.set(i,e);this.emit(Xs.ActiveDeviceChanged,i,e)}}));this.onLocalConnectionQualityChanged=t=>{this.emit(Xs.ConnectionQualityChanged,t,this.localParticipant)};this.onMediaDevicesError=t=>{this.emit(Xs.MediaDevicesError,t)};this.onLocalParticipantPermissionsChanged=t=>{this.emit(Xs.ParticipantPermissionsChanged,t,this.localParticipant)};this.onLocalChatMessageSent=t=>{this.emit(Xs.ChatMessage,t,this.localParticipant)};this.setMaxListeners(100);this.remoteParticipants=new Map;this.sidToIdentity=new Map;this.options=Object.assign(Object.assign({},Pa),t);this.log=hn((i=this.options.loggerName)!==null&&i!==void 0?i:un.Room);this.transcriptionReceivedTimes=new Map;this.options.audioCaptureDefaults=Object.assign(Object.assign({},Ia),t===null||t===void 0?void 0:t.audioCaptureDefaults);this.options.videoCaptureDefaults=Object.assign(Object.assign({},_a),t===null||t===void 0?void 0:t.videoCaptureDefaults);this.options.publishDefaults=Object.assign(Object.assign({},Ra),t===null||t===void 0?void 0:t.publishDefaults);this.maybeCreateEngine();this.disconnectLock=new d;this.localParticipant=new Gc("","",this.engine,this.options,this.rpcHandlers);if(this.options.videoCaptureDefaults.deviceId){this.localParticipant.activeDeviceMap.set("videoinput",ho(this.options.videoCaptureDefaults.deviceId))}if(this.options.audioCaptureDefaults.deviceId){this.localParticipant.activeDeviceMap.set("audioinput",ho(this.options.audioCaptureDefaults.deviceId))}if((n=this.options.audioOutput)===null||n===void 0?void 0:n.deviceId){this.switchActiveDevice("audiooutput",ho(this.options.audioOutput.deviceId)).catch((t=>this.log.warn("Could not set audio output: ".concat(t.message),this.logContext)))}if(this.options.e2ee){this.setupE2EE()}if(Hr()){const t=new AbortController;(s=navigator.mediaDevices)===null||s===void 0?void 0:s.addEventListener("devicechange",this.handleDeviceChange,{signal:t.signal});if(Qc.cleanupRegistry){Qc.cleanupRegistry.register(this,(()=>{t.abort()}))}}}registerTextStreamHandler(t,e){if(this.textStreamHandlers.has(t)){throw new TypeError('A text stream handler for topic "'.concat(t,'" has already been set.'))}this.textStreamHandlers.set(t,e)}unregisterTextStreamHandler(t){this.textStreamHandlers.delete(t)}registerByteStreamHandler(t,e){if(this.byteStreamHandlers.has(t)){throw new TypeError('A byte stream handler for topic "'.concat(t,'" has already been set.'))}this.byteStreamHandlers.set(t,e)}unregisterByteStreamHandler(t){this.byteStreamHandlers.delete(t)}registerRpcMethod(t,e){if(this.rpcHandlers.has(t)){throw Error("RPC handler already registered for method ".concat(t,", unregisterRpcMethod before trying to register again"))}this.rpcHandlers.set(t,e)}unregisterRpcMethod(t){this.rpcHandlers.delete(t)}handleIncomingRpcRequest(t,e,i,n,s,r){return bn(this,void 0,void 0,(function*(){yield this.engine.publishRpcAck(t,e);if(r!==1){yield this.engine.publishRpcResponse(t,e,null,xa.builtIn("UNSUPPORTED_VERSION"));return}const o=this.rpcHandlers.get(i);if(!o){yield this.engine.publishRpcResponse(t,e,null,xa.builtIn("UNSUPPORTED_METHOD"));return}let a=null;let c=null;try{const r=yield o({requestId:e,callerIdentity:t,payload:n,responseTimeout:s});if(Ua(r)>Ma){a=xa.builtIn("RESPONSE_PAYLOAD_TOO_LARGE");console.warn("RPC Response payload too large for ".concat(i))}else{c=r}}catch(t){if(t instanceof xa){a=t}else{console.warn("Uncaught error returned by RPC handler for ".concat(i,". Returning APPLICATION_ERROR instead."),t);a=xa.builtIn("APPLICATION_ERROR")}}yield this.engine.publishRpcResponse(t,e,c,a)}))}setE2EEEnabled(t){return bn(this,void 0,void 0,(function*(){if(this.e2eeManager){yield Promise.all([this.localParticipant.setE2EEEnabled(t)]);if(this.localParticipant.identity!==""){this.e2eeManager.setParticipantCryptorEnabled(t,this.localParticipant.identity)}}else{throw Error("e2ee not configured, please set e2ee settings within the room options")}}))}setupE2EE(){var t;if(this.options.e2ee){if("e2eeManager"in this.options.e2ee){this.e2eeManager=this.options.e2ee.e2eeManager}else{this.e2eeManager=new Go(this.options.e2ee)}this.e2eeManager.on(Ms.ParticipantEncryptionStatusChanged,((t,e)=>{if(jo(e)){this.isE2EEEnabled=t}this.emit(Xs.ParticipantEncryptionStatusChanged,t,e)}));this.e2eeManager.on(Ms.EncryptionError,(t=>this.emit(Xs.EncryptionError,t)));(t=this.e2eeManager)===null||t===void 0?void 0:t.setup(this)}}get logContext(){var t;return{room:this.name,roomID:(t=this.roomInfo)===null||t===void 0?void 0:t.sid,participant:this.localParticipant.identity,pID:this.localParticipant.sid}}get isRecording(){var t,e;return(e=(t=this.roomInfo)===null||t===void 0?void 0:t.activeRecording)!==null&&e!==void 0?e:false}getSid(){return bn(this,void 0,void 0,(function*(){if(this.state===Wc.Disconnected){return""}if(this.roomInfo&&this.roomInfo.sid!==""){return this.roomInfo.sid}return new Promise(((t,e)=>{const i=e=>{if(e.sid!==""){this.engine.off(er.RoomUpdate,i);t(e.sid)}};this.engine.on(er.RoomUpdate,i);this.once(Xs.Disconnected,(()=>{this.engine.off(er.RoomUpdate,i);e("Room disconnected before room server id was available")}))}))}))}get name(){var t,e;return(e=(t=this.roomInfo)===null||t===void 0?void 0:t.name)!==null&&e!==void 0?e:""}get metadata(){var t;return(t=this.roomInfo)===null||t===void 0?void 0:t.metadata}get numParticipants(){var t,e;return(e=(t=this.roomInfo)===null||t===void 0?void 0:t.numParticipants)!==null&&e!==void 0?e:0}get numPublishers(){var t,e;return(e=(t=this.roomInfo)===null||t===void 0?void 0:t.numPublishers)!==null&&e!==void 0?e:0}maybeCreateEngine(){if(this.engine&&!this.engine.isClosed){return}this.engine=new bc(this.options);this.engine.on(er.ParticipantUpdate,this.handleParticipantUpdates).on(er.RoomUpdate,this.handleRoomUpdate).on(er.SpeakersChanged,this.handleSpeakersChanged).on(er.StreamStateChanged,this.handleStreamStateUpdate).on(er.ConnectionQualityUpdate,this.handleConnectionQualityUpdate).on(er.SubscriptionError,this.handleSubscriptionError).on(er.SubscriptionPermissionUpdate,this.handleSubscriptionPermissionUpdate).on(er.MediaTrackAdded,((t,e,i)=>{this.onTrackAdded(t,e,i)})).on(er.Disconnected,(t=>{this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,t)})).on(er.ActiveSpeakersUpdate,this.handleActiveSpeakersUpdate).on(er.DataPacketReceived,this.handleDataPacket).on(er.Resuming,(()=>{this.clearConnectionReconcile();this.isResuming=true;this.log.info("Resuming signal connection",this.logContext);if(this.setAndEmitConnectionState(Wc.SignalReconnecting)){this.emit(Xs.SignalReconnecting)}})).on(er.Resumed,(()=>{this.registerConnectionReconcile();this.isResuming=false;this.log.info("Resumed signal connection",this.logContext);this.updateSubscriptions();this.emitBufferedEvents();if(this.setAndEmitConnectionState(Wc.Connected)){this.emit(Xs.Reconnected)}})).on(er.SignalResumed,(()=>{this.bufferedEvents=[];if(this.state===Wc.Reconnecting||this.isResuming){this.sendSyncState()}})).on(er.Restarting,this.handleRestarting).on(er.SignalRestarted,this.handleSignalRestarted).on(er.Offline,(()=>{if(this.setAndEmitConnectionState(Wc.Reconnecting)){this.emit(Xs.Reconnecting)}})).on(er.DCBufferStatusChanged,((t,e)=>{this.emit(Xs.DCBufferStatusChanged,t,e)})).on(er.LocalTrackSubscribed,(t=>{const e=this.localParticipant.getTrackPublications().find((e=>{let{trackSid:i}=e;return i===t}));if(!e){this.log.warn("could not find local track subscription for subscribed event",this.logContext);return}this.localParticipant.emit(tr.LocalTrackSubscribed,e);this.emitWhenConnected(Xs.LocalTrackSubscribed,e,this.localParticipant)})).on(er.RoomMoved,(t=>{this.log.debug("room moved",t);if(t.room){this.handleRoomUpdate(t.room)}this.remoteParticipants.forEach(((t,e)=>{this.handleParticipantDisconnected(e,t)}));this.emit(Xs.Moved,t.room.name,t.token);if(t.participant){this.handleParticipantUpdates([t.participant,...t.otherParticipants])}else{this.handleParticipantUpdates(t.otherParticipants)}}));if(this.localParticipant){this.localParticipant.setupEngine(this.engine)}if(this.e2eeManager){this.e2eeManager.setupEngine(this.engine)}}static getLocalDevices(t){let e=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;return zo.getInstance().getDevices(t,e)}prepareConnection(t,e){return bn(this,void 0,void 0,(function*(){if(this.state!==Wc.Disconnected){return}this.log.debug("prepareConnection to ".concat(t),this.logContext);try{if(Wr(new URL(t))&&e){this.regionUrlProvider=new wc(t,e);const i=yield this.regionUrlProvider.getNextBestRegionUrl();if(i&&this.state===Wc.Disconnected){this.regionUrl=i;yield fetch(fo(i),{method:"HEAD"});this.log.debug("prepared connection to ".concat(i),this.logContext)}}else{yield fetch(fo(t),{method:"HEAD"})}}catch(t){this.log.warn("could not prepare connection",Object.assign(Object.assign({},this.logContext),{error:t}))}}))}getParticipantByIdentity(t){if(this.localParticipant.identity===t){return this.localParticipant}return this.remoteParticipants.get(t)}clearConnectionFutures(){this.connectFuture=undefined}simulateScenario(t,e){return bn(this,void 0,void 0,(function*(){let i=()=>{};let n;switch(t){case"signal-reconnect":yield this.engine.client.handleOnClose("simulate disconnect");break;case"speaker":n=new zi({scenario:{case:"speakerUpdate",value:3}});break;case"node-failure":n=new zi({scenario:{case:"nodeFailure",value:true}});break;case"server-leave":n=new zi({scenario:{case:"serverLeave",value:true}});break;case"migration":n=new zi({scenario:{case:"migration",value:true}});break;case"resume-reconnect":this.engine.failNext();yield this.engine.client.handleOnClose("simulate resume-disconnect");break;case"disconnect-signal-on-resume":i=()=>bn(this,void 0,void 0,(function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}));n=new zi({scenario:{case:"disconnectSignalOnResume",value:true}});break;case"disconnect-signal-on-resume-no-messages":i=()=>bn(this,void 0,void 0,(function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}));n=new zi({scenario:{case:"disconnectSignalOnResumeNoMessages",value:true}});break;case"full-reconnect":this.engine.fullReconnectOnNext=true;yield this.engine.client.handleOnClose("simulate full-reconnect");break;case"force-tcp":case"force-tls":n=new zi({scenario:{case:"switchCandidateProtocol",value:t==="force-tls"?2:1}});i=()=>bn(this,void 0,void 0,(function*(){const t=this.engine.client.onLeave;if(t){t(new Ci({reason:ge.CLIENT_INITIATED,action:ji.RECONNECT}))}}));break;case"subscriber-bandwidth":if(e===undefined||typeof e!=="number"){throw new Error("subscriber-bandwidth requires a number as argument")}n=new zi({scenario:{case:"subscriberBandwidth",value:go(e)}});break;case"leave-full-reconnect":n=new zi({scenario:{case:"leaveRequestFullReconnect",value:true}})}if(n){yield this.engine.client.sendSimulateScenario(n);yield i()}}))}get canPlaybackAudio(){return this.audioEnabled}get canPlaybackVideo(){return!this.isVideoPlaybackBlocked}getActiveDevice(t){return this.localParticipant.activeDeviceMap.get(t)}switchActiveDevice(t,e){return bn(this,arguments,void 0,(function(t,e){var i=this;let n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;return function*(){var s,r,o,a,c,u,d;var h;let l=true;let f=false;const m=n?{exact:e}:e;if(t==="audioinput"){f=i.localParticipant.audioTrackPublications.size===0;const e=(s=i.getActiveDevice(t))!==null&&s!==void 0?s:i.options.audioCaptureDefaults.deviceId;i.options.audioCaptureDefaults.deviceId=m;const n=Array.from(i.localParticipant.audioTrackPublications.values()).filter((t=>t.source===br.Source.Microphone));try{l=(yield Promise.all(n.map((t=>{var e;return(e=t.audioTrack)===null||e===void 0?void 0:e.setDeviceId(m)})))).every((t=>t===true))}catch(t){i.options.audioCaptureDefaults.deviceId=e;throw t}}else if(t==="videoinput"){f=i.localParticipant.videoTrackPublications.size===0;const e=(r=i.getActiveDevice(t))!==null&&r!==void 0?r:i.options.videoCaptureDefaults.deviceId;i.options.videoCaptureDefaults.deviceId=m;const n=Array.from(i.localParticipant.videoTrackPublications.values()).filter((t=>t.source===br.Source.Camera));try{l=(yield Promise.all(n.map((t=>{var e;return(e=t.videoTrack)===null||e===void 0?void 0:e.setDeviceId(m)})))).every((t=>t===true))}catch(t){i.options.videoCaptureDefaults.deviceId=e;throw t}}else if(t==="audiooutput"){if(!Lr()&&!i.options.webAudioMix||i.options.webAudioMix&&i.audioContext&&!("setSinkId"in i.audioContext)){throw new Error("cannot switch audio output, setSinkId not supported")}if(i.options.webAudioMix){e=(o=yield zo.getInstance().normalizeDeviceId("audiooutput",e))!==null&&o!==void 0?o:""}(a=(h=i.options).audioOutput)!==null&&a!==void 0?a:h.audioOutput={};const n=(c=i.getActiveDevice(t))!==null&&c!==void 0?c:i.options.audioOutput.deviceId;i.options.audioOutput.deviceId=e;try{if(i.options.webAudioMix){(u=i.audioContext)===null||u===void 0?void 0:u.setSinkId(e)}yield Promise.all(Array.from(i.remoteParticipants.values()).map((t=>t.setAudioOutput({deviceId:e}))))}catch(t){i.options.audioOutput.deviceId=n;throw t}}if(f||t==="audiooutput"){i.localParticipant.activeDeviceMap.set(t,t==="audiooutput"&&((d=i.options.audioOutput)===null||d===void 0?void 0:d.deviceId)||e);i.emit(Xs.ActiveDeviceChanged,t,e)}return l}()}))}setupLocalParticipantEvents(){this.localParticipant.on(tr.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).on(tr.ParticipantNameChanged,this.onLocalParticipantNameChanged).on(tr.AttributesChanged,this.onLocalAttributesChanged).on(tr.TrackMuted,this.onLocalTrackMuted).on(tr.TrackUnmuted,this.onLocalTrackUnmuted).on(tr.LocalTrackPublished,this.onLocalTrackPublished).on(tr.LocalTrackUnpublished,this.onLocalTrackUnpublished).on(tr.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).on(tr.MediaDevicesError,this.onMediaDevicesError).on(tr.AudioStreamAcquired,this.startAudio).on(tr.ChatMessage,this.onLocalChatMessageSent).on(tr.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged)}recreateEngine(){var t;(t=this.engine)===null||t===void 0?void 0:t.close();this.engine=undefined;this.isResuming=false;this.remoteParticipants.clear();this.sidToIdentity.clear();this.bufferedEvents=[];this.maybeCreateEngine()}onTrackAdded(t,e,i){if(this.state===Wc.Connecting||this.state===Wc.Reconnecting){const n=()=>{this.onTrackAdded(t,e,i);s()};const s=()=>{this.off(Xs.Reconnected,n);this.off(Xs.Connected,n);this.off(Xs.Disconnected,s)};this.once(Xs.Reconnected,n);this.once(Xs.Connected,n);this.once(Xs.Disconnected,s);return}if(this.state===Wc.Disconnected){this.log.warn("skipping incoming track after Room disconnected",this.logContext);return}if(t.readyState==="ended"){this.log.info("skipping incoming track as it already ended",this.logContext);return}const n=Pr(e.id);const s=n[0];let r=n[1];let o=t.id;if(r&&r.startsWith("TR"))o=r;if(s===this.localParticipant.sid){this.log.warn("tried to create RemoteParticipant for local participant",this.logContext);return}const a=Array.from(this.remoteParticipants.values()).find((t=>t.sid===s));if(!a){this.log.error("Tried to add a track for a participant, that's not present. Sid: ".concat(s),this.logContext);return}let c;if(this.options.adaptiveStream){if(typeof this.options.adaptiveStream==="object"){c=this.options.adaptiveStream}else{c={}}}a.addSubscribedMediaTrack(t,o,e,i,c)}handleDisconnect(){let t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;let e=arguments.length>1?arguments[1]:undefined;var i;this.clearConnectionReconcile();this.isResuming=false;this.bufferedEvents=[];this.transcriptionReceivedTimes.clear();if(this.state===Wc.Disconnected){return}this.regionUrl=undefined;try{this.remoteParticipants.forEach((t=>{t.trackPublications.forEach((e=>{t.unpublishTrack(e.trackSid)}))}));this.localParticipant.trackPublications.forEach((e=>{var i,n,s;if(e.track){this.localParticipant.unpublishTrack(e.track,t)}if(t){(i=e.track)===null||i===void 0?void 0:i.detach();(n=e.track)===null||n===void 0?void 0:n.stop()}else{(s=e.track)===null||s===void 0?void 0:s.stopMonitor()}}));this.localParticipant.off(tr.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).off(tr.ParticipantNameChanged,this.onLocalParticipantNameChanged).off(tr.AttributesChanged,this.onLocalAttributesChanged).off(tr.TrackMuted,this.onLocalTrackMuted).off(tr.TrackUnmuted,this.onLocalTrackUnmuted).off(tr.LocalTrackPublished,this.onLocalTrackPublished).off(tr.LocalTrackUnpublished,this.onLocalTrackUnpublished).off(tr.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).off(tr.MediaDevicesError,this.onMediaDevicesError).off(tr.AudioStreamAcquired,this.startAudio).off(tr.ChatMessage,this.onLocalChatMessageSent).off(tr.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged);this.localParticipant.trackPublications.clear();this.localParticipant.videoTrackPublications.clear();this.localParticipant.audioTrackPublications.clear();this.remoteParticipants.clear();this.sidToIdentity.clear();this.activeSpeakers=[];if(this.audioContext&&typeof this.options.webAudioMix==="boolean"){this.audioContext.close();this.audioContext=undefined}if(Hr()){window.removeEventListener("beforeunload",this.onPageLeave);window.removeEventListener("pagehide",this.onPageLeave);window.removeEventListener("freeze",this.onPageLeave);(i=navigator.mediaDevices)===null||i===void 0?void 0:i.removeEventListener("devicechange",this.handleDeviceChange)}}finally{this.setAndEmitConnectionState(Wc.Disconnected);this.emit(Xs.Disconnected,e)}}handleParticipantDisconnected(t,e){var i;this.remoteParticipants.delete(t);if(!e){return}e.trackPublications.forEach((t=>{e.unpublishTrack(t.trackSid,true)}));this.emit(Xs.ParticipantDisconnected,e);(i=this.localParticipant)===null||i===void 0?void 0:i.handleParticipantDisconnected(e.identity)}handleStreamHeader(t,e){return bn(this,void 0,void 0,(function*(){var i;if(t.contentHeader.case==="byteHeader"){const n=this.byteStreamHandlers.get(t.topic);if(!n){this.log.debug("ignoring incoming byte stream due to no handler for topic",t.topic);return}let s;const r={id:t.streamId,name:(i=t.contentHeader.value.name)!==null&&i!==void 0?i:"unknown",mimeType:t.mimeType,size:t.totalLength?Number(t.totalLength):undefined,topic:t.topic,timestamp:bo(t.timestamp),attributes:t.attributes};const o=new ReadableStream({start:e=>{s=e;this.byteStreamControllers.set(t.streamId,{info:r,controller:s,startTime:Date.now()})}});n(new Oc(r,o,bo(t.totalLength)),{identity:e})}else if(t.contentHeader.case==="textHeader"){const i=this.textStreamHandlers.get(t.topic);if(!i){this.log.debug("ignoring incoming text stream due to no handler for topic",t.topic);return}let n;const s={id:t.streamId,mimeType:t.mimeType,size:t.totalLength?Number(t.totalLength):undefined,topic:t.topic,timestamp:Number(t.timestamp),attributes:t.attributes};const r=new ReadableStream({start:e=>{n=e;this.textStreamControllers.set(t.streamId,{info:s,controller:n,startTime:Date.now()})}});i(new Ec(s,r,bo(t.totalLength)),{identity:e})}}))}handleStreamChunk(t){const e=this.byteStreamControllers.get(t.streamId);if(e){if(t.content.length>0){e.controller.enqueue(t)}}const i=this.textStreamControllers.get(t.streamId);if(i){if(t.content.length>0){i.controller.enqueue(t)}}}handleStreamTrailer(t){const e=this.textStreamControllers.get(t.streamId);if(e){e.info.attributes=Object.assign(Object.assign({},e.info.attributes),t.attributes);e.controller.close();this.textStreamControllers.delete(t.streamId)}const i=this.byteStreamControllers.get(t.streamId);if(i){{i.info.attributes=Object.assign(Object.assign({},i.info.attributes),t.attributes);i.controller.close();this.byteStreamControllers.delete(t.streamId)}}}acquireAudioContext(){return bn(this,void 0,void 0,(function*(){var t,e;if(typeof this.options.webAudioMix!=="boolean"&&this.options.webAudioMix.audioContext){this.audioContext=this.options.webAudioMix.audioContext}else if(!this.audioContext||this.audioContext.state==="closed"){this.audioContext=(t=Do())!==null&&t!==void 0?t:undefined}if(this.options.webAudioMix){this.remoteParticipants.forEach((t=>t.setAudioContext(this.audioContext)))}this.localParticipant.setAudioContext(this.audioContext);if(this.audioContext&&this.audioContext.state==="suspended"){try{yield Promise.race([this.audioContext.resume(),Nr(200)])}catch(t){this.log.warn("Could not resume audio context",Object.assign(Object.assign({},this.logContext),{error:t}))}}const i=((e=this.audioContext)===null||e===void 0?void 0:e.state)==="running";if(i!==this.canPlaybackAudio){this.audioEnabled=i;this.emit(Xs.AudioPlaybackStatusChanged,i)}}))}createParticipant(t,e){var i;let n;if(e){n=zc.fromParticipantInfo(this.engine.client,e,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName})}else{n=new zc(this.engine.client,"",t,undefined,undefined,undefined,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName})}if(this.options.webAudioMix){n.setAudioContext(this.audioContext)}if((i=this.options.audioOutput)===null||i===void 0?void 0:i.deviceId){n.setAudioOutput(this.options.audioOutput).catch((t=>this.log.warn("Could not set audio output: ".concat(t.message),this.logContext)))}return n}getOrCreateParticipant(t,e){if(this.remoteParticipants.has(t)){const i=this.remoteParticipants.get(t);if(e){const t=i.updateInfo(e);if(t){this.sidToIdentity.set(e.sid,e.identity)}}return i}const i=this.createParticipant(t,e);this.remoteParticipants.set(t,i);this.sidToIdentity.set(e.sid,e.identity);this.emitWhenConnected(Xs.ParticipantConnected,i);i.on(tr.TrackPublished,(t=>{this.emitWhenConnected(Xs.TrackPublished,t,i)})).on(tr.TrackSubscribed,((t,e)=>{if(t.kind===br.Kind.Audio){t.on(ir.AudioPlaybackStarted,this.handleAudioPlaybackStarted);t.on(ir.AudioPlaybackFailed,this.handleAudioPlaybackFailed)}else if(t.kind===br.Kind.Video){t.on(ir.VideoPlaybackFailed,this.handleVideoPlaybackFailed);t.on(ir.VideoPlaybackStarted,this.handleVideoPlaybackStarted)}this.emit(Xs.TrackSubscribed,t,e,i)})).on(tr.TrackUnpublished,(t=>{this.emit(Xs.TrackUnpublished,t,i)})).on(tr.TrackUnsubscribed,((t,e)=>{this.emit(Xs.TrackUnsubscribed,t,e,i)})).on(tr.TrackMuted,(t=>{this.emitWhenConnected(Xs.TrackMuted,t,i)})).on(tr.TrackUnmuted,(t=>{this.emitWhenConnected(Xs.TrackUnmuted,t,i)})).on(tr.ParticipantMetadataChanged,(t=>{this.emitWhenConnected(Xs.ParticipantMetadataChanged,t,i)})).on(tr.ParticipantNameChanged,(t=>{this.emitWhenConnected(Xs.ParticipantNameChanged,t,i)})).on(tr.AttributesChanged,(t=>{this.emitWhenConnected(Xs.ParticipantAttributesChanged,t,i)})).on(tr.ConnectionQualityChanged,(t=>{this.emitWhenConnected(Xs.ConnectionQualityChanged,t,i)})).on(tr.ParticipantPermissionsChanged,(t=>{this.emitWhenConnected(Xs.ParticipantPermissionsChanged,t,i)})).on(tr.TrackSubscriptionStatusChanged,((t,e)=>{this.emitWhenConnected(Xs.TrackSubscriptionStatusChanged,t,e,i)})).on(tr.TrackSubscriptionFailed,((t,e)=>{this.emit(Xs.TrackSubscriptionFailed,t,i,e)})).on(tr.TrackSubscriptionPermissionChanged,((t,e)=>{this.emitWhenConnected(Xs.TrackSubscriptionPermissionChanged,t,e,i)}));if(e){i.updateInfo(e)}return i}sendSyncState(){const t=Array.from(this.remoteParticipants.values()).reduce(((t,e)=>{t.push(...e.getTrackPublications());return t}),[]);const e=this.localParticipant.getTrackPublications();this.engine.sendSyncState(t,e)}updateSubscriptions(){for(const t of this.remoteParticipants.values()){for(const e of t.videoTrackPublications.values()){if(e.isSubscribed&&Eo(e)){e.emitTrackUpdate()}}}}getRemoteParticipantBySid(t){const e=this.sidToIdentity.get(t);if(e){return this.remoteParticipants.get(e)}}registerConnectionReconcile(){this.clearConnectionReconcile();let t=0;this.connectionReconcileInterval=fr.setInterval((()=>{if(!this.engine||this.engine.isClosed||!this.engine.verifyTransport()){t++;this.log.warn("detected connection state mismatch",Object.assign(Object.assign({},this.logContext),{numFailures:t,engine:this.engine?{closed:this.engine.isClosed,transportsConnected:this.engine.verifyTransport()}:undefined}));if(t>=3){this.recreateEngine();this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,ge.STATE_MISMATCH)}}else{t=0}}),Kc)}clearConnectionReconcile(){if(this.connectionReconcileInterval){fr.clearInterval(this.connectionReconcileInterval)}}setAndEmitConnectionState(t){if(t===this.state){return false}this.state=t;this.emit(Xs.ConnectionStateChanged,this.state);return true}emitBufferedEvents(){this.bufferedEvents.forEach((t=>{let[e,i]=t;this.emit(e,...i)}));this.bufferedEvents=[]}emitWhenConnected(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++){i[n-1]=arguments[n]}if(this.state===Wc.Reconnecting||this.isResuming||!this.engine||this.engine.pendingReconnect){this.bufferedEvents.push([t,i])}else if(this.state===Wc.Connected){return this.emit(t,...i)}return false}simulateParticipants(t){return bn(this,void 0,void 0,(function*(){var e,i;const n=Object.assign({audio:true,video:true,useRealTracks:false},t.publish);const s=Object.assign({count:9,audio:false,video:true,aspectRatios:[1.66,1.7,1.3]},t.participants);this.handleDisconnect();this.roomInfo=new Te({sid:"RM_SIMULATED",name:"simulated-room",emptyTimeout:0,maxParticipants:0,creationTime:B.parse((new Date).getTime()),metadata:"",numParticipants:1,numPublishers:1,turnPassword:"",enabledCodecs:[],activeRecording:false});this.localParticipant.updateInfo(new Ee({identity:"simulated-local",name:"local-name"}));this.setupLocalParticipantEvents();this.emit(Xs.SignalConnected);this.emit(Xs.Connected);this.setAndEmitConnectionState(Wc.Connected);if(n.video){const t=new Uc(br.Kind.Video,new Pe({source:me.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:fe.AUDIO,name:"video-dummy"}),new cc(n.useRealTracks?(yield window.navigator.mediaDevices.getUserMedia({video:true})).getVideoTracks()[0]:ro(160*((e=s.aspectRatios[0])!==null&&e!==void 0?e:1),160,true,true),undefined,false,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(t);this.localParticipant.emit(tr.LocalTrackPublished,t)}if(n.audio){const t=new Uc(br.Kind.Audio,new Pe({source:me.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:fe.AUDIO}),new Ja(n.useRealTracks?(yield navigator.mediaDevices.getUserMedia({audio:true})).getAudioTracks()[0]:ao(),undefined,false,this.audioContext,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(t);this.localParticipant.emit(tr.LocalTrackPublished,t)}for(let t=0;t<s.count-1;t+=1){let e=new Ee({sid:Math.floor(Math.random()*1e4).toString(),identity:"simulated-".concat(t),state:Ce.ACTIVE,tracks:[],joinedAt:B.parse(Date.now())});const n=this.getOrCreateParticipant(e.identity,e);if(s.video){const r=ro(160*((i=s.aspectRatios[t%s.aspectRatios.length])!==null&&i!==void 0?i:1),160,false,true);const o=new Pe({source:me.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:fe.AUDIO});n.addSubscribedMediaTrack(r,o.sid,new MediaStream([r]),new RTCRtpReceiver);e.tracks=[...e.tracks,o]}if(s.audio){const t=ao();const i=new Pe({source:me.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:fe.AUDIO});n.addSubscribedMediaTrack(t,i.sid,new MediaStream([t]),new RTCRtpReceiver);e.tracks=[...e.tracks,i]}n.updateInfo(e)}}))}emit(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++){i[n-1]=arguments[n]}if(t!==Xs.ActiveSpeakersChanged&&t!==Xs.TranscriptionReceived){const e=Yc(i).filter((t=>t!==undefined));this.log.debug("room event ".concat(t),Object.assign(Object.assign({},this.logContext),{event:t,args:e}))}return super.emit(t,...i)}}Qc.cleanupRegistry=typeof FinalizationRegistry!=="undefined"&&new FinalizationRegistry((t=>{t()}));function Yc(t){return t.map((t=>{if(!t){return}if(Array.isArray(t)){return Yc(t)}if(typeof t==="object"){return"logContext"in t?t.logContext:undefined}return t}))}var Zc;(function(t){t[t["IDLE"]=0]="IDLE";t[t["RUNNING"]=1]="RUNNING";t[t["SKIPPED"]=2]="SKIPPED";t[t["SUCCESS"]=3]="SUCCESS";t[t["FAILED"]=4]="FAILED"})(Zc||(Zc={}));function $c(t,e){t.on(tr.IsSpeakingChanged,(()=>{e(t,"add")}))}const Xc=async(t,e,i,n)=>{const s=new Qc;s.prepareConnection(t,e);s.on(Xs.ParticipantConnected,(t=>{$c(t,i)})).on(Xs.ParticipantDisconnected,(t=>i(t,"remove"))).on(Xs.ActiveSpeakersChanged,(t=>n?.activeSpeakersChanged&&n.activeSpeakersChanged(t))).on(Xs.LocalTrackPublished,(()=>{i(s.localParticipant,"add");$c(s.localParticipant,i)})).on(Xs.TranscriptionReceived,((t,e,i)=>{if(n?.updateTranscriptions){n.updateTranscriptions(t,e,i)}}));await s.connect(t,e);s.remoteParticipants.forEach((t=>{$c(t,i)}));$c(s.localParticipant,i);return s};const tu=":host{display:contents}audio{display:none}";const eu=tu;const iu=class{constructor(e){t(this,e);this.callbacks=undefined;this.connected=false;this.microphoneEnabled=false;this.token="";this.url=""}get el(){return e(this)}#t;#e=[];connectedChanged(){if(this.connected){this.#i()}else{this.#n()}}microphoneEnabledChanged(){if(this.connected){this.#s()}}#r=(t,e)=>{const n=this.#o(t);if(e==="add"){if(n===-1){this.#e.push({participant:t,shouldUpdate:true})}else{this.#e[n].shouldUpdate=true}}else{r(this.#e,n)}i(this)};#i=()=>Xc(this.url,this.token,this.#r,this.callbacks).then((t=>{this.#t=t;this.#s()}));#n=()=>{if(this.#t){this.#t.disconnect()}};#o=t=>this.#e.findIndex((e=>e.participant.identity===t.identity));#s=()=>this.#t?.localParticipant.setMicrophoneEnabled(this.microphoneEnabled);connectedCallback(){if(this.connected){this.#i()}}componentDidRender(){this.#e.forEach((t=>{if(t.shouldUpdate){t.shouldUpdate=false;if(!t.participant.isLocal){if(t.participant instanceof zc){t.participant.setVolume(1)}const e=t.participant.getTrackPublication(br.Source.Microphone);e?.audioTrack?.attach(t.ref)}}}))}disconnectedCallback(){if(this.connected){this.#n()}}render(){return n(s,{key:"99678563d025f4dd35c00c95c0c365eea4ae0431"},n("slot",{key:"4094c7ef5915e1d0ca09f2430c55609f6cda1018"}),this.#e.map((t=>n("audio",{key:t.participant.identity,ref:e=>t.ref=e}))))}static get watchers(){return{connected:["connectedChanged"],microphoneEnabled:["microphoneEnabledChanged"]}}};iu.style=eu;export{iu as ch_live_kit_room};
//# sourceMappingURL=p-30d30e3d.entry.js.map