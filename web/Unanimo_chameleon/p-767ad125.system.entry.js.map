{"version":3,"names":["STYLE_TO_AVOID_FOUC","ChTheme","exports","_a","_successThemes","set","this","_loadModel","__awaiter","_this","model","Array","isArray","length","normalizeModel","__classPrivateFieldGet","_normalizeModel","call","themePromises","map","item","getTheme","timeout","Promise","allSettled","then","results","__classPrivateFieldSet","filter","result","status","value","_attachThemes","themeLoaded","emit","success","successTheme","name","loaded","rejected","console","error","list","root","el","getRootNode","Document","ShadowRoot","forEach","_mustAttachTheme","adoptedStyleSheets","includes","styleSheet","push","_detachThemes","themeIndex","findIndex","adoptedStyleSheet","removeElement","normalizedModel","theme","themeItemModel","find","url","_b","attachStyleSheet","attachStyleSheets","_toggleAttachedModels","class_1","prototype","attachStyleSheetsChanged","modelChanged","_","oldModel","connectedCallback","hidden","render","avoidFlashOfUnstyledContent","h","key"],"sources":["src/components/theme/theme.tsx"],"sourcesContent":["import {\r\n  Component,\r\n  Element,\r\n  Prop,\r\n  Event,\r\n  EventEmitter,\r\n  h,\r\n  State,\r\n  Watch\r\n} from \"@stencil/core\";\r\nimport {\r\n  ChThemeLoadedEvent,\r\n  Theme,\r\n  ThemeItemModel,\r\n  ThemeItemModelStyleSheet,\r\n  ThemeItemModelUrl,\r\n  ThemeModel\r\n} from \"./theme-types\";\r\nimport { getTheme } from \"./theme-stylesheet\";\r\nimport { removeElement } from \"../../common/array\";\r\n\r\nconst STYLE_TO_AVOID_FOUC = \":host,html{visibility:hidden !important}\";\r\n\r\n/**\r\n * It allows you to load a style sheet in a similar way to the\r\n * native LINK or STYLE tags, but assigning it a name so that\r\n * it can be reused in different contexts,\r\n * either in the Document or in a Shadow-Root.\r\n */\r\n@Component({\r\n  tag: \"ch-theme\"\r\n})\r\nexport class ChTheme {\r\n  #successThemes: Theme[] = [];\r\n\r\n  @Element() el: HTMLChThemeElement;\r\n\r\n  @State() loaded: boolean = false;\r\n\r\n  /**\r\n   * Indicates whether the theme should be attached to the Document or\r\n   * the ShadowRoot after loading.\r\n   * The value can be overridden by the `attachStyleSheet` property of the model.\r\n   */\r\n  @Prop() readonly attachStyleSheets: boolean = true;\r\n  @Watch(\"attachStyleSheets\")\r\n  attachStyleSheetsChanged() {\r\n    this.#toggleAttachedModels();\r\n  }\r\n\r\n  /**\r\n   * `true` to visually hide the contents of the root node while the control's\r\n   * style is not loaded.\r\n   */\r\n  @Prop() readonly avoidFlashOfUnstyledContent: boolean = true;\r\n\r\n  /**\r\n   * Specify themes to load\r\n   */\r\n  @Prop() readonly model: ThemeModel | undefined | null;\r\n  @Watch(\"model\")\r\n  modelChanged(_, oldModel: ThemeModel) {\r\n    // TODO: Make fully reactive the model property\r\n    if (!oldModel) {\r\n      this.#loadModel();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Specifies the time to wait for the requested theme to load.\r\n   */\r\n  @Prop() readonly timeout = 10000;\r\n\r\n  /**\r\n   * Event emitted when the theme has successfully loaded\r\n   */\r\n  @Event({ bubbles: true, composed: false })\r\n  themeLoaded: EventEmitter<ChThemeLoadedEvent>;\r\n\r\n  connectedCallback() {\r\n    this.el.hidden = true;\r\n    this.#loadModel();\r\n  }\r\n\r\n  #loadModel = async () => {\r\n    if (!this.model || (Array.isArray(this.model) && this.model.length === 0)) {\r\n      return;\r\n    }\r\n\r\n    const normalizeModel = this.#normalizeModel();\r\n    const themePromises = normalizeModel.map(item =>\r\n      getTheme(item, this.timeout)\r\n    );\r\n\r\n    Promise.allSettled(themePromises).then(results => {\r\n      this.#successThemes = results\r\n        .filter(result => result.status === \"fulfilled\")\r\n        .map(result => result.status === \"fulfilled\" && result.value);\r\n\r\n      this.#attachThemes();\r\n      this.themeLoaded.emit({\r\n        success: this.#successThemes.map(successTheme => successTheme.name)\r\n      });\r\n      this.loaded = true;\r\n\r\n      const rejected = results.filter(result => result.status === \"rejected\");\r\n      if (rejected.length > 0) {\r\n        // eslint-disable-next-line no-console\r\n        console.error(\"Failed to load themes:\", rejected);\r\n      }\r\n    });\r\n  };\r\n\r\n  #normalizeModel = (): ThemeItemModel[] => {\r\n    const list = Array.isArray(this.model) ? this.model : [this.model];\r\n\r\n    return list.map(item => {\r\n      if (typeof item === \"string\") {\r\n        return { name: item };\r\n      }\r\n\r\n      return item;\r\n    });\r\n  };\r\n\r\n  #attachThemes = () => {\r\n    const root = this.el.getRootNode();\r\n\r\n    if (!(root instanceof Document || root instanceof ShadowRoot)) {\r\n      return;\r\n    }\r\n    const normalizeModel = this.#normalizeModel();\r\n\r\n    this.#successThemes.forEach(successTheme => {\r\n      if (\r\n        this.#mustAttachTheme(normalizeModel, successTheme) &&\r\n        !root.adoptedStyleSheets.includes(successTheme.styleSheet)\r\n      ) {\r\n        root.adoptedStyleSheets.push(successTheme.styleSheet);\r\n      }\r\n    });\r\n  };\r\n\r\n  #detachThemes = () => {\r\n    const root = this.el.getRootNode();\r\n\r\n    if (!(root instanceof Document || root instanceof ShadowRoot)) {\r\n      return;\r\n    }\r\n\r\n    this.#successThemes.forEach(successTheme => {\r\n      const themeIndex = root.adoptedStyleSheets.findIndex(\r\n        adoptedStyleSheet => adoptedStyleSheet === successTheme.styleSheet\r\n      );\r\n\r\n      if (themeIndex > -1) {\r\n        removeElement(root.adoptedStyleSheets, themeIndex);\r\n      }\r\n    });\r\n  };\r\n\r\n  #mustAttachTheme = (normalizedModel: ThemeItemModel[], theme: Theme) => {\r\n    // TODO: \"normalizedModel\" should be a Set to reduce lookup times\r\n    const themeItemModel = normalizedModel.find(\r\n      item => item.name === theme.name\r\n    );\r\n\r\n    // TODO: What's the meaning of this condition?\r\n    if (\r\n      (themeItemModel as ThemeItemModelUrl).url ||\r\n      (themeItemModel as ThemeItemModelStyleSheet).styleSheet\r\n    ) {\r\n      return themeItemModel.attachStyleSheet ?? this.attachStyleSheets;\r\n    }\r\n\r\n    // TODO: Why do we return `true` instead of `false`?\r\n    return true;\r\n  };\r\n\r\n  #toggleAttachedModels = () => {\r\n    if (!this.loaded || !this.model) {\r\n      return;\r\n    }\r\n\r\n    // TODO: We should unify this condition to iterate only over the successful\r\n    // themes using \"themeItemModel.attachStyleSheet ?? this.attachStyleSheets\".\r\n    // For this, we should see the TODOs in `#mustAttachTheme` method\r\n    if (this.attachStyleSheets) {\r\n      this.#attachThemes();\r\n    } else {\r\n      this.#detachThemes();\r\n    }\r\n  };\r\n\r\n  render() {\r\n    return (\r\n      this.avoidFlashOfUnstyledContent &&\r\n      !this.loaded && <style>{STYLE_TO_AVOID_FOUC}</style>\r\n    );\r\n  }\r\n}\r\n"],"mappings":"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"}