{"version":3,"names":["copy","text","copyToTheClipboard","getAriaBusyValue","status","undefined","getAssistantParts","concat","downloadCode","options","hyperlinkRef","blob","Blob","plainText","type","url","window","URL","createObjectURL","anchor","href","download","click","setTimeout","revokeObjectURL","defaultCodeRender","chatRef","translations","h","class","part","language","isMobile","copyCodeButton","onClick","hyperlinkToDownloadFile","accessibleName","downloadCodeButton","title","lastNestedChildClass","showIndicator","value","renderUserMessage","userMessage","content","slice","map","imageContent","image_url","src","alt","loading","renderDefaultAssistantMessage","messageModel","messageContent","message","files","_b","renderCode","_c","theme","markdownTheme","sourceFiles","file","target","caption","copyResponseButton","renderErrorMessage","defaultChatRender","role","chatCss","ChChatStyle0","ENTER_KEY","ChChat","exports","_a","_editRef","set","this","_scrollRef","_virtualScrollRef","_pushMessage","__awaiter","_this","items","length","push","forceUpdate","__classPrivateFieldGet","addItems","sent","_getMessageContent","_updateMessage","messageIndex","mode","newMessageContent","call","messageId","id","Object","assign","_sendMessageKeyboard","event","key","shiftKey","preventDefault","_sendMessage","_addUserMessageToRecordAndFocusInput","scrollTop","scrollHeight","disabled","loadingState","generatingResponse","uploadingImagesToTheServer","imageUpload","imagesToUpload","userMessageToAdd_1","Date","getTime","callbacks","sendChatToLLM","userContent","forEach","imageToUpload","index","uploadImage","then","imageSrc","catch","userMessageToAdd","_handleStopGenerating","stopPropagation","stopGeneratingAnswer","_removeUploadedImage","buttonToRemove","nextFocusedButton","nextElementSibling","previousElementSibling","focus","removeElement","_removeImageResource","imageFile","_virtualItemsChanged","virtualItems","detail","_renderChatOrEmpty","name","dataProvider","inverseLoading","itemsCount","onInfiniteThresholdReached","_loadMoreItems","ref","el","__classPrivateFieldSet","slot","onVirtualItemsChanged","_renderItem","cellId","tokenMap","parts","renderItem","totalItems","newItems","Array","from","_","apply","__spreadArray","clearChat","imagePicker","removeUploadedImage","sendButton","sendInput","stopGeneratingAnswerButton","placeholder","processing","class_1","prototype","addNewMessage","focusChatInput","setChatInputMessage","updateChatMessage","updateLastMessage","at","connectedCallback","adoptCommonThemes","shadowRoot","adoptedStyleSheets","render","canShowAdditionalContent","showAdditionalContent","Host","model","onLoad","autoGrow","hostParts","multiline","onKeyDown"],"sources":["src/components/chat/default-chat-render.tsx","src/components/chat/chat.scss?tag=ch-chat&encapsulation=shadow","src/components/chat/chat.tsx"],"sourcesContent":["import { h } from \"@stencil/core\";\r\nimport {\r\n  ChatAssistantContentFiles,\r\n  ChatContentImage,\r\n  ChatMessageByRole\r\n} from \"./types\";\r\nimport { ChatTranslations } from \"./translations\";\r\nimport { copyToTheClipboard } from \"../../common/utils\";\r\nimport {\r\n  MarkdownViewerCodeRender,\r\n  MarkdownViewerCodeRenderOptions\r\n} from \"../markdown-viewer/parsers/types\";\r\n\r\nconst copy = (text: string) => () => copyToTheClipboard(text);\r\n\r\nconst getAriaBusyValue = (\r\n  status?: \"complete\" | \"waiting\" | \"streaming\" | undefined\r\n): \"true\" | \"false\" =>\r\n  status === \"complete\" || status === undefined ? \"false\" : \"true\";\r\n\r\nconst getAssistantParts = (\r\n  status?: \"complete\" | \"waiting\" | \"streaming\" | undefined\r\n) => (status ? `assistant-content ${status}` : \"assistant-content\");\r\n\r\nconst downloadCode =\r\n  (\r\n    options: MarkdownViewerCodeRenderOptions,\r\n    hyperlinkRef: { anchor: HTMLAnchorElement }\r\n  ) =>\r\n  () => {\r\n    // Create the blob variable on the click event\r\n    const blob = new Blob([options.plainText], { type: \"text/plain\" });\r\n\r\n    // Create blob object\r\n    const url = window.URL.createObjectURL(blob);\r\n\r\n    hyperlinkRef.anchor.href = url;\r\n    hyperlinkRef.anchor.download = \"Answer.txt\";\r\n    hyperlinkRef.anchor.click(); // Download the blob\r\n\r\n    // Remove the blob object to free the memory\r\n    setTimeout(() => {\r\n      window.URL.revokeObjectURL(url);\r\n    });\r\n  };\r\n\r\nconst defaultCodeRender =\r\n  (\r\n    chatRef: HTMLChChatElement,\r\n    translations: ChatTranslations\r\n  ): MarkdownViewerCodeRender =>\r\n  (options: MarkdownViewerCodeRenderOptions): any =>\r\n    (\r\n      <div>\r\n        <div class=\"code-block__header\" part=\"code-block__header\">\r\n          {options.language}\r\n\r\n          <div\r\n            class=\"code-block__header-actions\"\r\n            part=\"code-block__header-actions\"\r\n          >\r\n            <button\r\n              aria-label={\r\n                chatRef.isMobile ? translations.text.copyCodeButton : undefined\r\n              }\r\n              class=\"code-block__copy-code-button\"\r\n              part=\"code-block__copy-code-button\"\r\n              type=\"button\"\r\n              onClick={copy(options.plainText)}\r\n            >\r\n              {!chatRef.isMobile && translations.text.copyCodeButton}\r\n            </button>\r\n\r\n            {chatRef.hyperlinkToDownloadFile && (\r\n              <button\r\n                aria-label={translations.accessibleName.downloadCodeButton}\r\n                title={translations.accessibleName.downloadCodeButton}\r\n                class=\"code-block__download-code-button\"\r\n                part=\"code-block__download-code-button\"\r\n                onClick={downloadCode(options, chatRef.hyperlinkToDownloadFile)}\r\n              ></button>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        <ch-code\r\n          class=\"code-block__content\"\r\n          language={options.language}\r\n          lastNestedChildClass={options.lastNestedChildClass}\r\n          showIndicator={options.showIndicator}\r\n          value={options.plainText}\r\n        ></ch-code>\r\n      </div>\r\n    );\r\n\r\nconst renderUserMessage = (userMessage: ChatMessageByRole<\"user\">) => {\r\n  return typeof userMessage.content === \"string\" ? (\r\n    userMessage.content\r\n  ) : (\r\n    <div class=\"message-with-images\" part=\"message-with-images\">\r\n      <span part=\"message-with-images__text\">\r\n        {userMessage.content[0].text}\r\n      </span>\r\n\r\n      {(userMessage.content.slice(1) as ChatContentImage[]).map(\r\n        imageContent => (\r\n          <img\r\n            aria-hidden=\"true\"\r\n            class={!imageContent.image_url.url ? \"file-skeleton\" : undefined}\r\n            part={\r\n              imageContent.image_url.url\r\n                ? \"message-with-images__image\"\r\n                : \"message-with-images__image file-skeleton\"\r\n            }\r\n            src={imageContent.image_url.url}\r\n            alt=\"\"\r\n            loading=\"lazy\"\r\n          ></img>\r\n        )\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nconst renderDefaultAssistantMessage = (\r\n  chatRef: HTMLChChatElement,\r\n  messageModel: ChatMessageByRole<\"assistant\">\r\n) => {\r\n  const messageContent =\r\n    typeof messageModel.content === \"string\"\r\n      ? messageModel.content\r\n      : messageModel.content.message;\r\n\r\n  const files =\r\n    (messageModel.content as ChatAssistantContentFiles).files ?? null;\r\n\r\n  const translations = chatRef.translations;\r\n\r\n  return (\r\n    <div\r\n      // Improve accessibility by announcing live changes\r\n      aria-live=\"polite\"\r\n      // Wait until all changes are made to prevents assistive\r\n      // technologies from announcing changes before updates are done\r\n      aria-busy={getAriaBusyValue(messageModel.status)}\r\n      class=\"assistant-content\"\r\n      part={getAssistantParts(messageModel.status)}\r\n    >\r\n      {messageModel.status === \"waiting\" ? (\r\n        <div class=\"assistant-loading\" part=\"assistant-loading\">\r\n          {/* {spinner()} */}\r\n          {messageContent}\r\n        </div>\r\n      ) : (\r\n        [\r\n          <ch-markdown-viewer\r\n            renderCode={\r\n              chatRef.renderCode ?? defaultCodeRender(chatRef, translations)\r\n            }\r\n            showIndicator={messageModel.status === \"streaming\"}\r\n            theme={chatRef.markdownTheme}\r\n            value={messageContent}\r\n          ></ch-markdown-viewer>,\r\n\r\n          files && (\r\n            <div class=\"assistant-files\" part=\"assistant-files\">\r\n              {translations.text.sourceFiles}\r\n\r\n              {files.map(file => (\r\n                <a href={file.url} target=\"_blank\" part=\"assistant-file\">\r\n                  {file.caption}\r\n                </a>\r\n              ))}\r\n            </div>\r\n          )\r\n        ]\r\n      )}\r\n\r\n      {(messageModel.status === \"complete\" || !messageModel.status) && (\r\n        <button\r\n          aria-label={translations.accessibleName.copyResponseButton}\r\n          title={translations.accessibleName.copyResponseButton}\r\n          part=\"copy-response-button\"\r\n          type=\"button\"\r\n          onClick={copy(messageContent)}\r\n        ></button>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nconst renderErrorMessage = (\r\n  chatRef: HTMLChChatElement,\r\n  messageModel: ChatMessageByRole<\"error\">\r\n) => (\r\n  <ch-markdown-viewer\r\n    renderCode={\r\n      chatRef.renderCode ?? defaultCodeRender(chatRef, chatRef.translations)\r\n    }\r\n    theme={chatRef.markdownTheme}\r\n    value={messageModel.content}\r\n  ></ch-markdown-viewer>\r\n);\r\n\r\nexport const defaultChatRender =\r\n  (chatRef: HTMLChChatElement) =>\r\n  (messageModel: ChatMessageByRole<\"assistant\" | \"error\" | \"user\">) => {\r\n    if (messageModel.role === \"assistant\") {\r\n      return renderDefaultAssistantMessage(chatRef, messageModel);\r\n    }\r\n\r\n    return messageModel.role === \"user\"\r\n      ? renderUserMessage(messageModel)\r\n      : renderErrorMessage(chatRef, messageModel);\r\n  };\r\n","@import \"../../common/base\";\r\n\r\n@include button-reset();\r\n@include box-sizing();\r\n@include typography-reset();\r\n\r\n:host {\r\n  display: grid;\r\n  grid-template-rows: 1fr max-content;\r\n}\r\n\r\n:host(.ch-chat--additional-content) {\r\n  grid-template-rows: 1fr max-content max-content;\r\n}\r\n\r\n.assistant-content,\r\n.user-content {\r\n  // Improve rendering performance by not rendering off-screen messages\r\n  contain: paint;\r\n}\r\n\r\n.message-with-images {\r\n  display: grid;\r\n}\r\n\r\nimg {\r\n  display: block;\r\n  // Necessary to avoid overflowing the cell width when the window does not\r\n  // have enough width\r\n  max-inline-size: 100%;\r\n}\r\n\r\n.assistant-loading {\r\n  display: grid;\r\n  grid-template-columns: max-content 1fr;\r\n  align-items: center;\r\n}\r\n\r\n.assistant-files {\r\n  grid-area: 2 / 2;\r\n  display: flex;\r\n  flex-wrap: wrap;\r\n  align-items: center;\r\n}\r\n\r\n.file-skeleton {\r\n  position: relative;\r\n\r\n  &::before,\r\n  &::after {\r\n    content: \"\";\r\n    display: inline-flex;\r\n  }\r\n}\r\n\r\n// - - - - - - - - - - - - - - - -\r\n//         Send container\r\n// - - - - - - - - - - - - - - - -\r\n.stop-generating-answer-button {\r\n  grid-area: input-wrapper;\r\n  position: absolute;\r\n  inset-block-start: 0;\r\n  justify-self: center;\r\n  transform: translateY(-100%);\r\n}\r\n\r\n.images-to-upload {\r\n  display: flex;\r\n  flex-wrap: wrap;\r\n}\r\n\r\n.send-container {\r\n  display: grid;\r\n  grid-template: \"input-wrapper send-or-audio\" 1fr / 1fr max-content;\r\n  position: relative;\r\n  align-items: end;\r\n\r\n  &--file-uploading {\r\n    grid-template: \"upload-image input-wrapper send-or-audio\" 1fr / max-content 1fr max-content;\r\n  }\r\n}\r\n\r\n.send-input-wrapper {\r\n  grid-area: input-wrapper;\r\n}\r\n\r\n.send-or-audio-button {\r\n  grid-area: send-or-audio;\r\n}\r\n\r\n.spinner-loading {\r\n  animation: infinite-rotate 0.875s linear 0s infinite;\r\n}\r\n\r\n// This is a WA due to shadow DOM limitations/scoping with keyframes\r\n@keyframes infinite-rotate {\r\n  100% {\r\n    transform: rotate(1turn);\r\n  }\r\n}\r\n\r\n@keyframes gx-skeleton-load {\r\n  to {\r\n    transform: translateX(192%);\r\n  }\r\n}\r\n\r\n.processing-animation {\r\n  content: \"\";\r\n  margin-inline-start: auto;\r\n  display: block;\r\n  background-image: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"6\" height=\"6\" viewBox=\"0 0 6 6\"><path d=\"M3 6C4.65685 6 6 4.65685 6 3C6 1.34315 4.65685 0 3 0C1.34315 0 0 1.34315 0 3C0 4.65685 1.34315 6 3 6Z\" fill=\"%23939498\"/></svg>'),\r\n    url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"6\" height=\"6\" viewBox=\"0 0 6 6\"><path d=\"M3 6C4.65685 6 6 4.65685 6 3C6 1.34315 4.65685 0 3 0C1.34315 0 0 1.34315 0 3C0 4.65685 1.34315 6 3 6Z\" fill=\"%23939498\"/></svg>'),\r\n    url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"6\" height=\"6\" viewBox=\"0 0 6 6\"><path d=\"M3 6C4.65685 6 6 4.65685 6 3C6 1.34315 4.65685 0 3 0C1.34315 0 0 1.34315 0 3C0 4.65685 1.34315 6 3 6Z\" fill=\"%23939498\"/></svg>');\r\n  inline-size: 20px;\r\n  block-size: 16px;\r\n  background-position: left, center, right;\r\n  background-size: 4px, 4px, 4px;\r\n  background-repeat: no-repeat;\r\n  animation: ellipsis 1s infinite linear;\r\n}\r\n\r\n// This is a WA to have an animation\r\n@keyframes ellipsis {\r\n  0% {\r\n    background-size: 6px, 4px, 4px;\r\n  }\r\n  25% {\r\n    background-size: 4px, 6px, 4px;\r\n  }\r\n  50% {\r\n    background-size: 4px, 4px, 6px;\r\n  }\r\n  75% {\r\n    background-size: 4px, 6px, 4px;\r\n  }\r\n  100% {\r\n    background-size: 6px, 4px, 4px;\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Element,\r\n  Host,\r\n  Method,\r\n  Prop,\r\n  State,\r\n  forceUpdate,\r\n  h\r\n} from \"@stencil/core\";\r\nimport type {\r\n  ChVirtualScrollerCustomEvent,\r\n  VirtualScrollVirtualItems\r\n} from \"../../components\";\r\nimport type { ThemeModel } from \"../theme/theme-types\";\r\nimport {\r\n  ChatContentImages,\r\n  ChatInternalCallbacks,\r\n  ChatMessage,\r\n  ChatMessageByRole,\r\n  ChatMessageByRoleNoId\r\n} from \"./types\";\r\nimport { SmartGridDataState } from \"../smart-grid/internal/infinite-scroll/types\";\r\nimport { removeElement } from \"../../common/array\";\r\nimport { ChatTranslations } from \"./translations\";\r\nimport { defaultChatRender } from \"./default-chat-render\";\r\nimport { adoptCommonThemes } from \"../../common/theme\";\r\nimport { MarkdownViewerCodeRender } from \"../markdown-viewer/parsers/types\";\r\nimport { tokenMap } from \"../../common/utils\";\r\n\r\nconst ENTER_KEY = \"Enter\";\r\n\r\n/**\r\n * TODO: Add description\r\n */\r\n@Component({\r\n  tag: \"ch-chat\",\r\n  styleUrl: \"chat.scss\",\r\n  shadow: true\r\n})\r\nexport class ChChat {\r\n  #editRef!: HTMLChEditElement;\r\n  #scrollRef: HTMLChSmartGridElement | undefined;\r\n  #virtualScrollRef: HTMLChVirtualScrollerElement | undefined;\r\n\r\n  @Element() el!: HTMLChChatElement;\r\n\r\n  @State() imagesToUpload: { src: string; file: File }[] = [];\r\n  @State() uploadingImagesToTheServer = 0;\r\n  @State() virtualItems: ChatMessage[] = [];\r\n\r\n  /**\r\n   * Specifies the callbacks required in the control.\r\n   */\r\n  @Prop() readonly callbacks?: ChatInternalCallbacks | undefined;\r\n\r\n  /**\r\n   * Specifies if all interactions are disabled\r\n   */\r\n  @Prop() readonly disabled: boolean = false;\r\n\r\n  /**\r\n   * `true` if a response for the assistant is being generated.\r\n   */\r\n  @Prop() readonly generatingResponse?: boolean = false;\r\n\r\n  /**\r\n   * Specifies an object containing an HTMLAnchorElement reference. Use this\r\n   * property to render a button to download the code when displaying a code\r\n   * block.\r\n   */\r\n  @Prop() readonly hyperlinkToDownloadFile?: { anchor: HTMLAnchorElement };\r\n\r\n  /**\r\n   * Specifies if the control can render a button to load images from the file\r\n   * system.\r\n   */\r\n  @Prop() readonly imageUpload: boolean = false;\r\n\r\n  /**\r\n   * Specifies if the chat is used in a mobile device.\r\n   */\r\n  @Prop() readonly isMobile?: boolean = false;\r\n\r\n  // TODO: Add support for undefined messages.\r\n  /**\r\n   * Specifies the items that the chat will display.\r\n   */\r\n  @Prop({ mutable: true }) items: ChatMessage[] = [];\r\n\r\n  /**\r\n   * Specifies if the chat is waiting for the data to be loaded.\r\n   */\r\n  @Prop({ mutable: true }) loadingState: SmartGridDataState = \"initial\";\r\n\r\n  /**\r\n   * Specifies the theme to be used for rendering the markdown.\r\n   * If `null`, no theme will be applied.\r\n   */\r\n  @Prop() readonly markdownTheme?: string | null = \"ch-markdown-viewer\";\r\n\r\n  /**\r\n   * This property allows us to implement custom rendering for the code blocks.\r\n   */\r\n  @Prop() readonly renderCode?: MarkdownViewerCodeRender;\r\n\r\n  /**\r\n   * `true` to render a slot named \"additional-content\" to project elements\r\n   * between the \"content\" slot (grid messages) and the \"send-container\" slot.\r\n   *\r\n   * This slot can only be rendered if loadingState !== \"initial\" and\r\n   * (loadingState !== \"all-records-loaded\" && items.length > 0).\r\n   */\r\n  @Prop() readonly showAdditionalContent: boolean = false;\r\n\r\n  /**\r\n   * Specifies the theme to be used for rendering the chat.\r\n   * If `undefined`, no theme will be applied.\r\n   */\r\n  @Prop() readonly theme?: ThemeModel | undefined;\r\n\r\n  /**\r\n   * Specifies the literals required in the control.\r\n   */\r\n  @Prop() readonly translations: ChatTranslations = {\r\n    accessibleName: {\r\n      clearChat: \"Clear chat\",\r\n      copyResponseButton: \"Copy assistant response\",\r\n      downloadCodeButton: \"Download code\",\r\n      imagePicker: \"Select images\",\r\n      removeUploadedImage: \"Remove uploaded image\",\r\n      sendButton: \"Send\",\r\n      sendInput: \"Message\",\r\n      stopGeneratingAnswerButton: \"Stop generating answer\"\r\n    },\r\n    placeholder: {\r\n      sendInput: \"Ask me a question...\"\r\n    },\r\n    text: {\r\n      stopGeneratingAnswerButton: \"Stop generating answer\",\r\n      copyCodeButton: \"Copy code\",\r\n      processing: `Processing...`,\r\n      sourceFiles: \"Source files:\"\r\n    }\r\n  };\r\n\r\n  /**\r\n   * This property allows us to implement custom rendering of chat items.\r\n   * If allow us to implement the render of the cell content.\r\n   */\r\n  @Prop() readonly renderItem?: (\r\n    messageModel: ChatMessageByRole<\"assistant\" | \"error\" | \"user\">\r\n  ) => any;\r\n\r\n  /**\r\n   * Add a new message at the end of the record, performing a re-render.\r\n   */\r\n  @Method()\r\n  async addNewMessage(message: ChatMessage) {\r\n    this.#pushMessage(message);\r\n  }\r\n\r\n  /**\r\n   * Focus the chat input\r\n   */\r\n  @Method()\r\n  async focusChatInput() {\r\n    this.#editRef?.focus();\r\n  }\r\n\r\n  /**\r\n   * Set the text for the chat input\r\n   */\r\n  @Method()\r\n  async setChatInputMessage(text: string) {\r\n    if (this.#editRef) {\r\n      this.#editRef.value = text;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Given the id of the message, it updates the content of the indexed message.\r\n   */\r\n  @Method()\r\n  async updateChatMessage(\r\n    messageIndex: number,\r\n    message: ChatMessageByRoleNoId<\"system\" | \"assistant\">,\r\n    mode: \"concat\" | \"replace\"\r\n  ) {\r\n    if (this.items.length === 0 || !this.items[messageIndex]) {\r\n      return;\r\n    }\r\n    this.#updateMessage(messageIndex, message, mode);\r\n\r\n    forceUpdate(this);\r\n  }\r\n\r\n  // TODO: Add unit tests to validate how the chat message should be copied\r\n  // into the last chat message, considering that messages can have more\r\n  // properties that the interface/type has\r\n  /**\r\n   * Update the content of the last message, performing a re-render.\r\n   */\r\n  @Method()\r\n  async updateLastMessage(\r\n    message: ChatMessageByRoleNoId<\"system\" | \"assistant\">,\r\n    mode: \"concat\" | \"replace\"\r\n  ) {\r\n    if (this.items.length === 0) {\r\n      return;\r\n    }\r\n    this.#updateMessage(this.items.length - 1, message, mode);\r\n\r\n    // Sync the last virtual item with the real item that is updated\r\n    this.virtualItems[this.virtualItems.length - 1] = this.items.at(-1);\r\n\r\n    forceUpdate(this);\r\n  }\r\n\r\n  #pushMessage = async (message: ChatMessage) => {\r\n    if (this.items.length === 0) {\r\n      this.items.push(message);\r\n      forceUpdate(this);\r\n    } else {\r\n      await this.#virtualScrollRef.addItems(\"end\", message);\r\n    }\r\n  };\r\n\r\n  #getMessageContent = (\r\n    message: ChatMessageByRoleNoId<\"system\" | \"assistant\">\r\n  ) =>\r\n    typeof message.content === \"string\"\r\n      ? message.content\r\n      : message.content.message;\r\n\r\n  #updateMessage = (\r\n    messageIndex: number,\r\n    message: ChatMessageByRoleNoId<\"system\" | \"assistant\">,\r\n    mode: \"concat\" | \"replace\"\r\n  ) => {\r\n    if (mode === \"concat\") {\r\n      // Temporal store for the new message\r\n      const newMessageContent =\r\n        this.#getMessageContent(\r\n          this.items[messageIndex] as ChatMessageByRole<\"system\" | \"assistant\">\r\n        ) + this.#getMessageContent(message);\r\n\r\n      // Reuse the message ref to correctly update the message content\r\n      if (typeof message.content === \"string\") {\r\n        message.content = newMessageContent;\r\n      } else {\r\n        message.content.message = newMessageContent;\r\n      }\r\n    }\r\n\r\n    // Replace the message\r\n    const messageId = this.items[messageIndex].id;\r\n    this.items[messageIndex] = Object.assign({ id: messageId }, message);\r\n  };\r\n\r\n  #sendMessageKeyboard = (event: KeyboardEvent) => {\r\n    if (event.key !== ENTER_KEY || event.shiftKey) {\r\n      return;\r\n    }\r\n    event.preventDefault();\r\n\r\n    this.#sendMessage();\r\n  };\r\n\r\n  #addUserMessageToRecordAndFocusInput = async (\r\n    userMessage: ChatMessageByRole<\"user\">\r\n  ) => {\r\n    this.#editRef.value = \"\";\r\n    this.#editRef.click();\r\n\r\n    // Scroll to bottom\r\n    if (this.#scrollRef) {\r\n      this.#scrollRef.scrollTop = this.#scrollRef.scrollHeight;\r\n    }\r\n\r\n    await this.#pushMessage(userMessage);\r\n  };\r\n\r\n  #sendMessage = async () => {\r\n    if (\r\n      !this.#editRef.value ||\r\n      this.disabled ||\r\n      this.loadingState === \"initial\" ||\r\n      this.loadingState === \"loading\" ||\r\n      this.generatingResponse ||\r\n      this.uploadingImagesToTheServer > 0\r\n    ) {\r\n      return;\r\n    }\r\n\r\n    // Message without resources\r\n    if (!this.imageUpload || this.imagesToUpload.length === 0) {\r\n      const userMessageToAdd: ChatMessageByRole<\"user\"> = {\r\n        id: `${new Date().getTime()}`,\r\n        role: \"user\",\r\n        content: this.#editRef.value\r\n      };\r\n\r\n      await this.#addUserMessageToRecordAndFocusInput(userMessageToAdd);\r\n      this.callbacks?.sendChatToLLM(this.items);\r\n\r\n      // Queue a new re-render\r\n      forceUpdate(this);\r\n      return;\r\n    }\r\n\r\n    this.uploadingImagesToTheServer = this.imagesToUpload.length;\r\n\r\n    const userContent: ChatContentImages = [\r\n      { type: \"text\", text: this.#editRef.value }\r\n    ] as ChatContentImages;\r\n\r\n    this.imagesToUpload.forEach((imageToUpload, index) => {\r\n      // Add the image with empty src, since it's not in the server yet\r\n      userContent.push({\r\n        type: \"image_url\",\r\n        image_url: { url: \"\" }\r\n      });\r\n\r\n      // Upload the image to the server asynchronously\r\n      this.callbacks\r\n        ?.uploadImage(imageToUpload.file)\r\n        .then(imageSrc => {\r\n          userContent[index + 1] = {\r\n            type: \"image_url\",\r\n            image_url: { url: imageSrc }\r\n          };\r\n\r\n          // Queue a new re-render\r\n          this.uploadingImagesToTheServer--;\r\n\r\n          if (this.uploadingImagesToTheServer === 0) {\r\n            this.callbacks?.sendChatToLLM(this.items);\r\n          }\r\n        })\r\n        .catch(() => {\r\n          // console.log(\"Reject...\", reason);\r\n          // TODO: Error uploading the image\r\n\r\n          this.uploadingImagesToTheServer--;\r\n\r\n          if (this.uploadingImagesToTheServer === 0) {\r\n            this.callbacks?.sendChatToLLM(this.items);\r\n          }\r\n        });\r\n    });\r\n\r\n    const userMessageToAdd: ChatMessageByRole<\"user\"> = {\r\n      id: `${new Date().getTime()}`,\r\n      role: \"user\",\r\n      content: userContent\r\n    };\r\n    await this.#addUserMessageToRecordAndFocusInput(userMessageToAdd);\r\n\r\n    // Free the memory\r\n    this.imagesToUpload = [];\r\n  };\r\n\r\n  #handleStopGenerating = (event: MouseEvent) => {\r\n    event.stopPropagation();\r\n\r\n    this.callbacks?.stopGeneratingAnswer!();\r\n  };\r\n\r\n  // #handleFilesChanged = (event: ImagePickerCustomEvent<FileList | null>) => {\r\n  //   this.imagesToUpload =\r\n  //     event.detail === null\r\n  //       ? []\r\n  //       : [...event.detail].map(imageFile => ({\r\n  //           file: imageFile,\r\n  //           src: URL.createObjectURL(imageFile)\r\n  //         }));\r\n  // };\r\n\r\n  #removeUploadedImage = (index: number) => (event: MouseEvent) => {\r\n    const buttonToRemove = event.target as HTMLButtonElement;\r\n    const nextFocusedButton = (buttonToRemove.nextElementSibling ??\r\n      buttonToRemove.previousElementSibling) as HTMLButtonElement | null;\r\n\r\n    // Focus the next item to improve accessibility\r\n    nextFocusedButton?.focus();\r\n\r\n    // TODO: Remove the file from the image-picker reference\r\n    removeElement(this.imagesToUpload, index);\r\n    forceUpdate(this);\r\n  };\r\n\r\n  #removeImageResource = (imageFile: string) => () => {\r\n    URL.revokeObjectURL(imageFile); // Free the memory\r\n  };\r\n\r\n  #virtualItemsChanged = (\r\n    event: ChVirtualScrollerCustomEvent<VirtualScrollVirtualItems>\r\n  ) => {\r\n    this.virtualItems = event.detail.virtualItems as ChatMessage[];\r\n  };\r\n\r\n  #renderChatOrEmpty = () =>\r\n    this.loadingState === \"all-records-loaded\" && this.items.length === 0 ? (\r\n      <slot name=\"empty-chat\"></slot>\r\n    ) : (\r\n      <ch-smart-grid\r\n        dataProvider={this.loadingState === \"more-data-to-fetch\"}\r\n        loadingState={\r\n          this.virtualItems.length === 0 ? \"initial\" : this.loadingState\r\n        }\r\n        inverseLoading\r\n        itemsCount={this.virtualItems.length}\r\n        onInfiniteThresholdReached={this.#loadMoreItems}\r\n        ref={el => (this.#scrollRef = el as HTMLChSmartGridElement)}\r\n      >\r\n        <ch-virtual-scroller\r\n          role=\"row\"\r\n          slot=\"grid-content\"\r\n          class=\"grid-content\"\r\n          part=\"content\"\r\n          inverseLoading\r\n          // mode=\"lazy-render\"\r\n          items={this.items}\r\n          itemsCount={this.items.length}\r\n          onVirtualItemsChanged={this.#virtualItemsChanged}\r\n          ref={el =>\r\n            (this.#virtualScrollRef = el as HTMLChVirtualScrollerElement)\r\n          }\r\n        >\r\n          {this.virtualItems.map(this.#renderItem)}\r\n        </ch-virtual-scroller>\r\n      </ch-smart-grid>\r\n    );\r\n\r\n  #renderItem = (messageModel: ChatMessage) =>\r\n    messageModel.role !== \"system\" && (\r\n      <ch-smart-grid-cell\r\n        key={messageModel.id}\r\n        cellId={messageModel.id}\r\n        part={tokenMap({\r\n          [`message ${messageModel.role}`]: true,\r\n          [messageModel.parts]: !!messageModel.parts,\r\n          [(messageModel as ChatMessageByRole<\"assistant\">).status]:\r\n            messageModel.role === \"assistant\"\r\n        })}\r\n      >\r\n        {this.renderItem\r\n          ? this.renderItem(messageModel)\r\n          : defaultChatRender(this.el)(messageModel)}\r\n      </ch-smart-grid-cell>\r\n    );\r\n\r\n  #loadMoreItems = () => {\r\n    this.loadingState = \"loading\";\r\n\r\n    // WA to test\r\n    setTimeout(() => {\r\n      const totalItems = this.items.length;\r\n\r\n      const newItems: ChatMessage[] = Array.from({ length: 20 }, (_, index) =>\r\n        index % 2 === 0\r\n          ? {\r\n              id: `index: ${index - totalItems}`,\r\n              role: \"user\",\r\n              content:\r\n                `index: ${index - totalItems}` +\r\n                `index: ${index - totalItems}\\n` +\r\n                `index: ${index - totalItems}\\n` +\r\n                `index: ${index - totalItems}\\n` +\r\n                `index: ${index - totalItems}\\n` +\r\n                `index: ${index - totalItems}\\n` +\r\n                `index: ${index - totalItems}\\n`\r\n            }\r\n          : {\r\n              id: `index: ${index - totalItems}`,\r\n              role: \"assistant\",\r\n              content:\r\n                `\\nindex: ${index - totalItems}\\n` +\r\n                `index: ${index - totalItems}\\n` +\r\n                `index: ${index - totalItems}\\n` +\r\n                `index: ${index - totalItems}\\n` +\r\n                `index: ${index - totalItems}\\n` +\r\n                `index: ${index - totalItems}\\n` +\r\n                `index: ${index - totalItems}\\n`\r\n            }\r\n      );\r\n\r\n      this.#virtualScrollRef.addItems(\"start\", ...newItems);\r\n\r\n      this.loadingState = \"more-data-to-fetch\";\r\n    }, 10);\r\n  };\r\n\r\n  connectedCallback() {\r\n    // Scrollbar styles\r\n    adoptCommonThemes(this.el.shadowRoot.adoptedStyleSheets);\r\n  }\r\n\r\n  render() {\r\n    const text = this.translations.text;\r\n    const accessibleName = this.translations.accessibleName;\r\n\r\n    const canShowAdditionalContent =\r\n      this.showAdditionalContent &&\r\n      // It's not the initial load\r\n      this.loadingState !== \"initial\" &&\r\n      // It's not the empty chat\r\n      !(this.items.length === 0 && this.loadingState === \"all-records-loaded\");\r\n\r\n    return (\r\n      <Host\r\n        class={\r\n          canShowAdditionalContent ? \"ch-chat--additional-content\" : undefined\r\n        }\r\n      >\r\n        {this.theme && <ch-theme model={this.theme}></ch-theme>}\r\n\r\n        {this.loadingState === \"initial\" ? (\r\n          // TODO: Improve this slot name\r\n          <div class=\"loading-chat\" slot=\"empty-chat\"></div>\r\n        ) : (\r\n          this.#renderChatOrEmpty()\r\n        )}\r\n\r\n        {canShowAdditionalContent && <slot name=\"additional-content\" />}\r\n\r\n        <div\r\n          class={{\r\n            \"send-container\": true,\r\n            \"send-container--file-uploading\": this.imageUpload\r\n          }}\r\n          part=\"send-container\"\r\n        >\r\n          {this.generatingResponse && this.callbacks?.stopGeneratingAnswer && (\r\n            <button\r\n              aria-label={\r\n                accessibleName.stopGeneratingAnswerButton !==\r\n                  text.stopGeneratingAnswerButton &&\r\n                (accessibleName.stopGeneratingAnswerButton ??\r\n                  text.stopGeneratingAnswerButton)\r\n              }\r\n              class=\"stop-generating-answer-button\"\r\n              part=\"stop-generating-answer-button\"\r\n              type=\"button\"\r\n              onClick={this.#handleStopGenerating}\r\n            >\r\n              {text.stopGeneratingAnswerButton}\r\n            </button>\r\n          )}\r\n          {/* \r\n          {this.imageUpload && (\r\n            <gx-eai-image-picker\r\n              part=\"image-picker\"\r\n              translations={this.translations}\r\n              onFilesChanged={this.#handleFilesChanged}\r\n            ></gx-eai-image-picker>\r\n          )} */}\r\n\r\n          <div class=\"send-input-wrapper\" part=\"send-input-wrapper\">\r\n            {this.imagesToUpload.length > 0 && (\r\n              <div class=\"images-to-upload\" part=\"images-to-upload\">\r\n                {this.imagesToUpload.map((imageFile, index) => (\r\n                  <button\r\n                    key={imageFile.src}\r\n                    aria-label={accessibleName.removeUploadedImage}\r\n                    title={accessibleName.removeUploadedImage}\r\n                    part=\"remove-image-to-upload-button\"\r\n                    type=\"button\"\r\n                    onClick={this.#removeUploadedImage(index)}\r\n                  >\r\n                    <img\r\n                      part=\"image-to-upload\"\r\n                      aria-hidden=\"true\"\r\n                      src={imageFile.src}\r\n                      alt=\"\"\r\n                      loading=\"lazy\"\r\n                      onLoad={this.#removeImageResource(imageFile.src)}\r\n                    ></img>\r\n                  </button>\r\n                ))}\r\n              </div>\r\n            )}\r\n\r\n            <ch-edit\r\n              accessibleName={accessibleName.sendInput}\r\n              autoGrow\r\n              hostParts=\"send-input\"\r\n              multiline\r\n              placeholder={this.translations.placeholder.sendInput}\r\n              onKeyDown={this.#sendMessageKeyboard}\r\n              ref={el => (this.#editRef = el as HTMLChEditElement)}\r\n            ></ch-edit>\r\n          </div>\r\n\r\n          <button\r\n            aria-label={accessibleName.sendButton}\r\n            title={accessibleName.sendButton}\r\n            class=\"send-or-audio-button\"\r\n            part=\"send-button\"\r\n            disabled={this.disabled}\r\n            type=\"button\"\r\n            onClick={\r\n              this.loadingState !== \"initial\" ? this.#sendMessage : undefined\r\n            }\r\n          ></button>\r\n        </div>\r\n      </Host>\r\n    );\r\n  }\r\n}\r\n"],"mappings":"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"}