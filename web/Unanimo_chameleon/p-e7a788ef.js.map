{"version":3,"names":["THEMES","Map","PROMISE_RESOLVER","BASEURL_REGEX","createStyleSheetFromString","baseUrl","cssText","CSSStyleSheet","replace","applyBaseUrl","async","getTheme","themeModel","timeout","promise","get","name","set","createThemePromise","url","instanceTheme","styleSheet","Promise","resolve","themeBaseUrl","createThemePromiseUrl","reject","setTimeout","promiseTimeout","isLoading","resolvePromise","resolver","value","disposeResolver","rejectPromise","error","Error","clearTimeout","delete","loadThemeStyleSheet","requestStyleSheet","response","fetch","ok","status","text","message"],"sources":["src/components/theme/theme-stylesheet.ts"],"sourcesContent":["import {\r\n  Theme,\r\n  ThemeItemModel,\r\n  ThemeItemModelStyleSheet,\r\n  ThemeItemModelUrl\r\n} from \"./theme-types\";\r\n\r\nconst THEMES = new Map<string, Promise<Theme>>();\r\nconst PROMISE_RESOLVER = new Map<string, ThemePromiseResolver>();\r\n\r\nconst BASEURL_REGEX =\r\n  /(url\\((?!\\s*[\"']?(?:\\/|https?:|data:))\\s*[\"']?)([^'\")]+)/g;\r\n\r\ntype ThemePromiseResolver = {\r\n  name: string;\r\n  resolve: (value: Theme) => void;\r\n  reject: (reason?: any) => void;\r\n  timeout: NodeJS.Timeout;\r\n  isLoading: boolean;\r\n};\r\n\r\nconst createStyleSheetFromString = (\r\n  baseUrl: string | undefined,\r\n  cssText: string\r\n) => new CSSStyleSheet().replace(applyBaseUrl(baseUrl, cssText));\r\n\r\nexport async function getTheme(\r\n  themeModel: ThemeItemModel,\r\n  timeout: number\r\n): Promise<Theme> {\r\n  const promise =\r\n    THEMES.get(themeModel.name) ??\r\n    THEMES.set(themeModel.name, createThemePromise(themeModel, timeout)).get(\r\n      themeModel.name\r\n    );\r\n\r\n  if ((themeModel as ThemeItemModelUrl).url) {\r\n    instanceTheme(themeModel);\r\n  }\r\n\r\n  return promise;\r\n}\r\n\r\nasync function createThemePromise(\r\n  themeModel: ThemeItemModel,\r\n  timeout: number\r\n): Promise<Theme> {\r\n  // If it has an inlined styleSheet, directly resolve the promise\r\n  if ((themeModel as ThemeItemModelStyleSheet).styleSheet) {\r\n    return Promise.resolve({\r\n      name: themeModel.name,\r\n      styleSheet: await createStyleSheetFromString(\r\n        themeModel.themeBaseUrl,\r\n        (themeModel as ThemeItemModelStyleSheet).styleSheet\r\n      )\r\n    });\r\n  }\r\n  return createThemePromiseUrl(themeModel.name, timeout);\r\n}\r\n\r\nfunction createThemePromiseUrl(name: string, timeout: number): Promise<Theme> {\r\n  return new Promise<Theme>((resolve, reject) => {\r\n    PROMISE_RESOLVER.set(name, {\r\n      name,\r\n      resolve,\r\n      reject,\r\n      timeout: setTimeout(() => promiseTimeout(name), timeout),\r\n      isLoading: false\r\n    });\r\n  });\r\n}\r\n\r\nfunction resolvePromise(resolver: ThemePromiseResolver, value: Theme) {\r\n  disposeResolver(resolver);\r\n  resolver.resolve(value);\r\n}\r\n\r\nfunction rejectPromise(resolver: ThemePromiseResolver, error: Error) {\r\n  disposeResolver(resolver);\r\n  resolver.reject(error);\r\n}\r\n\r\nfunction promiseTimeout(name: string) {\r\n  const resolver = PROMISE_RESOLVER.get(name);\r\n  if (resolver) {\r\n    rejectPromise(resolver, new Error(`Theme load timeout: ${name}`));\r\n  }\r\n}\r\n\r\nfunction disposeResolver(resolver: ThemePromiseResolver) {\r\n  clearTimeout(resolver.timeout);\r\n  PROMISE_RESOLVER.delete(resolver.name);\r\n}\r\n\r\nasync function instanceTheme(themeModel: ThemeItemModelUrl) {\r\n  const resolver = PROMISE_RESOLVER.get(themeModel.name);\r\n\r\n  if (resolver && !resolver.isLoading) {\r\n    resolver.isLoading = true;\r\n\r\n    try {\r\n      const styleSheet = await loadThemeStyleSheet(\r\n        themeModel.url,\r\n        themeModel.themeBaseUrl\r\n      );\r\n      resolvePromise(resolver, { name: themeModel.name, styleSheet });\r\n    } catch (error) {\r\n      rejectPromise(resolver, error);\r\n    }\r\n  }\r\n}\r\n\r\nasync function loadThemeStyleSheet(\r\n  url: string,\r\n  baseUrl: string\r\n): Promise<CSSStyleSheet> {\r\n  try {\r\n    return createStyleSheetFromString(baseUrl, await requestStyleSheet(url));\r\n  } catch (error) {\r\n    throw new Error(`Failed to load theme stylesheet: ${error}`);\r\n  }\r\n}\r\n\r\nasync function requestStyleSheet(url: string): Promise<string> {\r\n  try {\r\n    const response = await fetch(url);\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`HTTP error! status: ${response.status}`);\r\n    }\r\n    return await response.text();\r\n  } catch (error) {\r\n    throw new Error(`Failed to fetch stylesheet: ${error.message}`);\r\n  }\r\n}\r\n\r\n/**\r\n * @example\r\n * const baseUrl = \"https://example.com/\"\r\n * const cssText = \"background-image: url(images/background.png);\"\r\n *\r\n * result: \"background-image: url(https://example.com/images/background.png);\"\r\n */\r\nfunction applyBaseUrl(baseUrl: string | undefined, cssText: string): string {\r\n  if (baseUrl) {\r\n    return cssText.replace(BASEURL_REGEX, `$1${baseUrl}$2`);\r\n  }\r\n  return cssText;\r\n}\r\n"],"mappings":"AAOA,MAAMA,EAAS,IAAIC,IACnB,MAAMC,EAAmB,IAAID,IAE7B,MAAME,EACJ,4DAUF,MAAMC,EAA6B,CACjCC,EACAC,KACG,IAAIC,eAAgBC,QAAQC,EAAaJ,EAASC,IAEhDI,eAAeC,EACpBC,EACAC,GAEA,MAAMC,EACJd,EAAOe,IAAIH,EAAWI,OACtBhB,EAAOiB,IAAIL,EAAWI,KAAME,EAAmBN,EAAYC,IAAUE,IACnEH,EAAWI,MAGf,GAAKJ,EAAiCO,IAAK,CACzCC,EAAcR,E,CAGhB,OAAOE,CACT,CAEAJ,eAAeQ,EACbN,EACAC,GAGA,GAAKD,EAAwCS,WAAY,CACvD,OAAOC,QAAQC,QAAQ,CACrBP,KAAMJ,EAAWI,KACjBK,iBAAkBjB,EAChBQ,EAAWY,aACVZ,EAAwCS,a,CAI/C,OAAOI,EAAsBb,EAAWI,KAAMH,EAChD,CAEA,SAASY,EAAsBT,EAAcH,GAC3C,OAAO,IAAIS,SAAe,CAACC,EAASG,KAClCxB,EAAiBe,IAAID,EAAM,CACzBA,OACAO,UACAG,SACAb,QAASc,YAAW,IAAMC,EAAeZ,IAAOH,GAChDgB,UAAW,OACX,GAEN,CAEA,SAASC,EAAeC,EAAgCC,GACtDC,EAAgBF,GAChBA,EAASR,QAAQS,EACnB,CAEA,SAASE,EAAcH,EAAgCI,GACrDF,EAAgBF,GAChBA,EAASL,OAAOS,EAClB,CAEA,SAASP,EAAeZ,GACtB,MAAMe,EAAW7B,EAAiBa,IAAIC,GACtC,GAAIe,EAAU,CACZG,EAAcH,EAAU,IAAIK,MAAM,uBAAuBpB,K,CAE7D,CAEA,SAASiB,EAAgBF,GACvBM,aAAaN,EAASlB,SACtBX,EAAiBoC,OAAOP,EAASf,KACnC,CAEAN,eAAeU,EAAcR,GAC3B,MAAMmB,EAAW7B,EAAiBa,IAAIH,EAAWI,MAEjD,GAAIe,IAAaA,EAASF,UAAW,CACnCE,EAASF,UAAY,KAErB,IACE,MAAMR,QAAmBkB,EACvB3B,EAAWO,IACXP,EAAWY,cAEbM,EAAeC,EAAU,CAAEf,KAAMJ,EAAWI,KAAMK,c,CAClD,MAAOc,GACPD,EAAcH,EAAUI,E,EAG9B,CAEAzB,eAAe6B,EACbpB,EACAd,GAEA,IACE,OAAOD,EAA2BC,QAAemC,EAAkBrB,G,CACnE,MAAOgB,GACP,MAAM,IAAIC,MAAM,oCAAoCD,I,CAExD,CAEAzB,eAAe8B,EAAkBrB,GAC/B,IACE,MAAMsB,QAAiBC,MAAMvB,GAE7B,IAAKsB,EAASE,GAAI,CAChB,MAAM,IAAIP,MAAM,uBAAuBK,EAASG,S,CAElD,aAAaH,EAASI,M,CACtB,MAAOV,GACP,MAAM,IAAIC,MAAM,+BAA+BD,EAAMW,U,CAEzD,CASA,SAASrC,EAAaJ,EAA6BC,GACjD,GAAID,EAAS,CACX,OAAOC,EAAQE,QAAQL,EAAe,KAAKE,M,CAE7C,OAAOC,CACT,Q"}