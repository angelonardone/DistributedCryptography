{"version":3,"names":["THEMES","Map","PROMISE_RESOLVER","BASEURL_REGEX","createStyleSheetFromString","baseUrl","cssText","CSSStyleSheet","replace","applyBaseUrl","getTheme","themeModel","timeout","promise","_a","get","name","set","createThemePromise","url","instanceTheme","styleSheet","_b","Promise","resolve","themeBaseUrl","apply","_c","_d","sent","createThemePromiseUrl","reject","setTimeout","promiseTimeout","isLoading","resolvePromise","resolver","value","disposeResolver","rejectPromise","error","Error","concat","clearTimeout","delete","loadThemeStyleSheet","error_1","requestStyleSheet","error_2","fetch","response","ok","status","text","error_3","message"],"sources":["src/components/theme/theme-stylesheet.ts"],"sourcesContent":["import {\r\n  Theme,\r\n  ThemeItemModel,\r\n  ThemeItemModelStyleSheet,\r\n  ThemeItemModelUrl\r\n} from \"./theme-types\";\r\n\r\nconst THEMES = new Map<string, Promise<Theme>>();\r\nconst PROMISE_RESOLVER = new Map<string, ThemePromiseResolver>();\r\n\r\nconst BASEURL_REGEX =\r\n  /(url\\((?!\\s*[\"']?(?:\\/|https?:|data:))\\s*[\"']?)([^'\")]+)/g;\r\n\r\ntype ThemePromiseResolver = {\r\n  name: string;\r\n  resolve: (value: Theme) => void;\r\n  reject: (reason?: any) => void;\r\n  timeout: NodeJS.Timeout;\r\n  isLoading: boolean;\r\n};\r\n\r\nconst createStyleSheetFromString = (\r\n  baseUrl: string | undefined,\r\n  cssText: string\r\n) => new CSSStyleSheet().replace(applyBaseUrl(baseUrl, cssText));\r\n\r\nexport async function getTheme(\r\n  themeModel: ThemeItemModel,\r\n  timeout: number\r\n): Promise<Theme> {\r\n  const promise =\r\n    THEMES.get(themeModel.name) ??\r\n    THEMES.set(themeModel.name, createThemePromise(themeModel, timeout)).get(\r\n      themeModel.name\r\n    );\r\n\r\n  if ((themeModel as ThemeItemModelUrl).url) {\r\n    instanceTheme(themeModel);\r\n  }\r\n\r\n  return promise;\r\n}\r\n\r\nasync function createThemePromise(\r\n  themeModel: ThemeItemModel,\r\n  timeout: number\r\n): Promise<Theme> {\r\n  // If it has an inlined styleSheet, directly resolve the promise\r\n  if ((themeModel as ThemeItemModelStyleSheet).styleSheet) {\r\n    return Promise.resolve({\r\n      name: themeModel.name,\r\n      styleSheet: await createStyleSheetFromString(\r\n        themeModel.themeBaseUrl,\r\n        (themeModel as ThemeItemModelStyleSheet).styleSheet\r\n      )\r\n    });\r\n  }\r\n  return createThemePromiseUrl(themeModel.name, timeout);\r\n}\r\n\r\nfunction createThemePromiseUrl(name: string, timeout: number): Promise<Theme> {\r\n  return new Promise<Theme>((resolve, reject) => {\r\n    PROMISE_RESOLVER.set(name, {\r\n      name,\r\n      resolve,\r\n      reject,\r\n      timeout: setTimeout(() => promiseTimeout(name), timeout),\r\n      isLoading: false\r\n    });\r\n  });\r\n}\r\n\r\nfunction resolvePromise(resolver: ThemePromiseResolver, value: Theme) {\r\n  disposeResolver(resolver);\r\n  resolver.resolve(value);\r\n}\r\n\r\nfunction rejectPromise(resolver: ThemePromiseResolver, error: Error) {\r\n  disposeResolver(resolver);\r\n  resolver.reject(error);\r\n}\r\n\r\nfunction promiseTimeout(name: string) {\r\n  const resolver = PROMISE_RESOLVER.get(name);\r\n  if (resolver) {\r\n    rejectPromise(resolver, new Error(`Theme load timeout: ${name}`));\r\n  }\r\n}\r\n\r\nfunction disposeResolver(resolver: ThemePromiseResolver) {\r\n  clearTimeout(resolver.timeout);\r\n  PROMISE_RESOLVER.delete(resolver.name);\r\n}\r\n\r\nasync function instanceTheme(themeModel: ThemeItemModelUrl) {\r\n  const resolver = PROMISE_RESOLVER.get(themeModel.name);\r\n\r\n  if (resolver && !resolver.isLoading) {\r\n    resolver.isLoading = true;\r\n\r\n    try {\r\n      const styleSheet = await loadThemeStyleSheet(\r\n        themeModel.url,\r\n        themeModel.themeBaseUrl\r\n      );\r\n      resolvePromise(resolver, { name: themeModel.name, styleSheet });\r\n    } catch (error) {\r\n      rejectPromise(resolver, error);\r\n    }\r\n  }\r\n}\r\n\r\nasync function loadThemeStyleSheet(\r\n  url: string,\r\n  baseUrl: string\r\n): Promise<CSSStyleSheet> {\r\n  try {\r\n    return createStyleSheetFromString(baseUrl, await requestStyleSheet(url));\r\n  } catch (error) {\r\n    throw new Error(`Failed to load theme stylesheet: ${error}`);\r\n  }\r\n}\r\n\r\nasync function requestStyleSheet(url: string): Promise<string> {\r\n  try {\r\n    const response = await fetch(url);\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`HTTP error! status: ${response.status}`);\r\n    }\r\n    return await response.text();\r\n  } catch (error) {\r\n    throw new Error(`Failed to fetch stylesheet: ${error.message}`);\r\n  }\r\n}\r\n\r\n/**\r\n * @example\r\n * const baseUrl = \"https://example.com/\"\r\n * const cssText = \"background-image: url(images/background.png);\"\r\n *\r\n * result: \"background-image: url(https://example.com/images/background.png);\"\r\n */\r\nfunction applyBaseUrl(baseUrl: string | undefined, cssText: string): string {\r\n  if (baseUrl) {\r\n    return cssText.replace(BASEURL_REGEX, `$1${baseUrl}$2`);\r\n  }\r\n  return cssText;\r\n}\r\n"],"mappings":"8hDAOA,IAAMA,EAAS,IAAIC,IACnB,IAAMC,EAAmB,IAAID,IAE7B,IAAME,EACJ,4DAUF,IAAMC,EAA6B,SACjCC,EACAC,GACG,WAAIC,eAAgBC,QAAQC,EAAaJ,EAASC,GAAlD,EAEE,SAAeI,EACpBC,EACAC,G,iGAEMC,GACJC,EAAAd,EAAOe,IAAIJ,EAAWK,SAAK,MAAAF,SAAA,EAAAA,EAC3Bd,EAAOiB,IAAIN,EAAWK,KAAME,EAAmBP,EAAYC,IAAUG,IACnEJ,EAAWK,MAGf,GAAKL,EAAiCQ,IAAK,CACzCC,EAAcT,E,CAGhB,SAAOE,E,OAGT,SAAeK,EACbP,EACAC,G,8HAGKD,EAAwCU,WAAxC,YACIC,GAAAR,EAAAS,SAAQC,Q,GACbR,KAAML,EAAWK,MACL,SAAMZ,EAChBO,EAAWc,aACVd,EAAwCU,a,OAJ7C,SAAOC,EAAAI,MAAAZ,EAAA,EAELa,EAAAN,WAAYO,EAAAC,O,aAMhB,SAAOC,EAAsBnB,EAAWK,KAAMJ,I,OAGhD,SAASkB,EAAsBd,EAAcJ,GAC3C,OAAO,IAAIW,SAAe,SAACC,EAASO,GAClC7B,EAAiBe,IAAID,EAAM,CACzBA,KAAIA,EACJQ,QAAOA,EACPO,OAAMA,EACNnB,QAASoB,YAAW,WAAM,OAAAC,EAAejB,EAAf,GAAsBJ,GAChDsB,UAAW,O,GAGjB,CAEA,SAASC,EAAeC,EAAgCC,GACtDC,EAAgBF,GAChBA,EAASZ,QAAQa,EACnB,CAEA,SAASE,EAAcH,EAAgCI,GACrDF,EAAgBF,GAChBA,EAASL,OAAOS,EAClB,CAEA,SAASP,EAAejB,GACtB,IAAMoB,EAAWlC,EAAiBa,IAAIC,GACtC,GAAIoB,EAAU,CACZG,EAAcH,EAAU,IAAIK,MAAM,uBAAAC,OAAuB1B,I,CAE7D,CAEA,SAASsB,EAAgBF,GACvBO,aAAaP,EAASxB,SACtBV,EAAiB0C,OAAOR,EAASpB,KACnC,CAEA,SAAeI,EAAcT,G,sHACrByB,EAAWlC,EAAiBa,IAAIJ,EAAWK,M,KAE7CoB,IAAaA,EAASF,WAAtB,YACFE,EAASF,UAAY,K,uCAGA,SAAMW,EACvBlC,EAAWQ,IACXR,EAAWc,e,OAFPJ,EAAaP,EAAAe,OAInBM,EAAeC,EAAU,CAAEpB,KAAML,EAAWK,KAAMK,WAAUA,I,8BAE5DkB,EAAcH,EAAUU,G,oCAK9B,SAAeD,EACb1B,EACAd,G,4IAGSS,EAAAV,E,GAA2BC,GAAS,SAAM0C,EAAkB5B,I,OAAnE,SAAOL,EAAAY,WAAA,EAAAJ,EAAAoB,OAAA,CAAoCf,EAAAE,W,kBAE3C,MAAM,IAAIY,MAAM,oCAAAC,OAAoCM,I,wBAIxD,SAAeD,EAAkB5B,G,0IAEZ,SAAM8B,MAAM9B,I,OAAvB+B,EAAWpC,EAAAe,OAEjB,IAAKqB,EAASC,GAAI,CAChB,MAAM,IAAIV,MAAM,uBAAAC,OAAuBQ,EAASE,Q,CAE3C,SAAMF,EAASG,Q,OAAtB,SAAOvC,EAAAe,Q,kBAEP,MAAM,IAAIY,MAAM,+BAAAC,OAA+BY,EAAMC,U,wBAWzD,SAAS9C,EAAaJ,EAA6BC,GACjD,GAAID,EAAS,CACX,OAAOC,EAAQE,QAAQL,EAAe,KAAAuC,OAAKrC,EAAO,M,CAEpD,OAAOC,CACT,C"}