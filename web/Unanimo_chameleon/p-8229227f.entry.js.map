{"version":3,"names":["STYLE_TO_AVOID_FOUC","ChTheme","successThemes","attachStyleSheetsChanged","this","toggleAttachedModels","modelChanged","_","oldModel","loadModel","themeLoaded","connectedCallback","el","hidden","async","model","Array","isArray","length","normalizeModel","themePromises","map","item","getTheme","timeout","Promise","allSettled","then","results","filter","result","status","value","attachThemes","emit","success","successTheme","name","loaded","rejected","console","error","list","root","getRootNode","Document","ShadowRoot","forEach","mustAttachTheme","adoptedStyleSheets","includes","styleSheet","push","detachThemes","themeIndex","findIndex","adoptedStyleSheet","removeElement","normalizedModel","theme","themeItemModel","find","url","attachStyleSheet","attachStyleSheets","render","avoidFlashOfUnstyledContent","h","key"],"sources":["src/components/theme/theme.tsx"],"sourcesContent":["import {\r\n  Component,\r\n  Element,\r\n  Prop,\r\n  Event,\r\n  EventEmitter,\r\n  h,\r\n  State,\r\n  Watch\r\n} from \"@stencil/core\";\r\nimport {\r\n  ChThemeLoadedEvent,\r\n  Theme,\r\n  ThemeItemModel,\r\n  ThemeItemModelStyleSheet,\r\n  ThemeItemModelUrl,\r\n  ThemeModel\r\n} from \"./theme-types\";\r\nimport { getTheme } from \"./theme-stylesheet\";\r\nimport { removeElement } from \"../../common/array\";\r\n\r\nconst STYLE_TO_AVOID_FOUC = \":host,html{visibility:hidden !important}\";\r\n\r\n/**\r\n * It allows you to load a style sheet in a similar way to the\r\n * native LINK or STYLE tags, but assigning it a name so that\r\n * it can be reused in different contexts,\r\n * either in the Document or in a Shadow-Root.\r\n */\r\n@Component({\r\n  tag: \"ch-theme\"\r\n})\r\nexport class ChTheme {\r\n  #successThemes: Theme[] = [];\r\n\r\n  @Element() el: HTMLChThemeElement;\r\n\r\n  @State() loaded: boolean = false;\r\n\r\n  /**\r\n   * Indicates whether the theme should be attached to the Document or\r\n   * the ShadowRoot after loading.\r\n   * The value can be overridden by the `attachStyleSheet` property of the model.\r\n   */\r\n  @Prop() readonly attachStyleSheets: boolean = true;\r\n  @Watch(\"attachStyleSheets\")\r\n  attachStyleSheetsChanged() {\r\n    this.#toggleAttachedModels();\r\n  }\r\n\r\n  /**\r\n   * `true` to visually hide the contents of the root node while the control's\r\n   * style is not loaded.\r\n   */\r\n  @Prop() readonly avoidFlashOfUnstyledContent: boolean = true;\r\n\r\n  /**\r\n   * Specify themes to load\r\n   */\r\n  @Prop() readonly model: ThemeModel | undefined | null;\r\n  @Watch(\"model\")\r\n  modelChanged(_, oldModel: ThemeModel) {\r\n    // TODO: Make fully reactive the model property\r\n    if (!oldModel) {\r\n      this.#loadModel();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Specifies the time to wait for the requested theme to load.\r\n   */\r\n  @Prop() readonly timeout = 10000;\r\n\r\n  /**\r\n   * Event emitted when the theme has successfully loaded\r\n   */\r\n  @Event({ bubbles: true, composed: false })\r\n  themeLoaded: EventEmitter<ChThemeLoadedEvent>;\r\n\r\n  connectedCallback() {\r\n    this.el.hidden = true;\r\n    this.#loadModel();\r\n  }\r\n\r\n  #loadModel = async () => {\r\n    if (!this.model || (Array.isArray(this.model) && this.model.length === 0)) {\r\n      return;\r\n    }\r\n\r\n    const normalizeModel = this.#normalizeModel();\r\n    const themePromises = normalizeModel.map(item =>\r\n      getTheme(item, this.timeout)\r\n    );\r\n\r\n    Promise.allSettled(themePromises).then(results => {\r\n      this.#successThemes = results\r\n        .filter(result => result.status === \"fulfilled\")\r\n        .map(result => result.status === \"fulfilled\" && result.value);\r\n\r\n      this.#attachThemes();\r\n      this.themeLoaded.emit({\r\n        success: this.#successThemes.map(successTheme => successTheme.name)\r\n      });\r\n      this.loaded = true;\r\n\r\n      const rejected = results.filter(result => result.status === \"rejected\");\r\n      if (rejected.length > 0) {\r\n        // eslint-disable-next-line no-console\r\n        console.error(\"Failed to load themes:\", rejected);\r\n      }\r\n    });\r\n  };\r\n\r\n  #normalizeModel = (): ThemeItemModel[] => {\r\n    const list = Array.isArray(this.model) ? this.model : [this.model];\r\n\r\n    return list.map(item => {\r\n      if (typeof item === \"string\") {\r\n        return { name: item };\r\n      }\r\n\r\n      return item;\r\n    });\r\n  };\r\n\r\n  #attachThemes = () => {\r\n    const root = this.el.getRootNode();\r\n\r\n    if (!(root instanceof Document || root instanceof ShadowRoot)) {\r\n      return;\r\n    }\r\n    const normalizeModel = this.#normalizeModel();\r\n\r\n    this.#successThemes.forEach(successTheme => {\r\n      if (\r\n        this.#mustAttachTheme(normalizeModel, successTheme) &&\r\n        !root.adoptedStyleSheets.includes(successTheme.styleSheet)\r\n      ) {\r\n        root.adoptedStyleSheets.push(successTheme.styleSheet);\r\n      }\r\n    });\r\n  };\r\n\r\n  #detachThemes = () => {\r\n    const root = this.el.getRootNode();\r\n\r\n    if (!(root instanceof Document || root instanceof ShadowRoot)) {\r\n      return;\r\n    }\r\n\r\n    this.#successThemes.forEach(successTheme => {\r\n      const themeIndex = root.adoptedStyleSheets.findIndex(\r\n        adoptedStyleSheet => adoptedStyleSheet === successTheme.styleSheet\r\n      );\r\n\r\n      if (themeIndex > -1) {\r\n        removeElement(root.adoptedStyleSheets, themeIndex);\r\n      }\r\n    });\r\n  };\r\n\r\n  #mustAttachTheme = (normalizedModel: ThemeItemModel[], theme: Theme) => {\r\n    // TODO: \"normalizedModel\" should be a Set to reduce lookup times\r\n    const themeItemModel = normalizedModel.find(\r\n      item => item.name === theme.name\r\n    );\r\n\r\n    // TODO: What's the meaning of this condition?\r\n    if (\r\n      (themeItemModel as ThemeItemModelUrl).url ||\r\n      (themeItemModel as ThemeItemModelStyleSheet).styleSheet\r\n    ) {\r\n      return themeItemModel.attachStyleSheet ?? this.attachStyleSheets;\r\n    }\r\n\r\n    // TODO: Why do we return `true` instead of `false`?\r\n    return true;\r\n  };\r\n\r\n  #toggleAttachedModels = () => {\r\n    if (!this.loaded || !this.model) {\r\n      return;\r\n    }\r\n\r\n    // TODO: We should unify this condition to iterate only over the successful\r\n    // themes using \"themeItemModel.attachStyleSheet ?? this.attachStyleSheets\".\r\n    // For this, we should see the TODOs in `#mustAttachTheme` method\r\n    if (this.attachStyleSheets) {\r\n      this.#attachThemes();\r\n    } else {\r\n      this.#detachThemes();\r\n    }\r\n  };\r\n\r\n  render() {\r\n    return (\r\n      this.avoidFlashOfUnstyledContent &&\r\n      !this.loaded && <style>{STYLE_TO_AVOID_FOUC}</style>\r\n    );\r\n  }\r\n}\r\n"],"mappings":"iIAqBA,MAAMA,EAAsB,2C,MAWfC,EAAO,M,8EAKS,M,uBAOmB,K,iCAUU,K,kCAiB7B,G,CAtC3BC,GAA0B,G,wBAa1B,wBAAAC,GACEC,MAAKC,G,CAcP,YAAAC,CAAaC,EAAGC,GAEd,IAAKA,EAAU,CACbJ,MAAKK,G,EAaTC,YAEA,iBAAAC,GACEP,KAAKQ,GAAGC,OAAS,KACjBT,MAAKK,G,CAGPA,GAAaK,UACX,IAAKV,KAAKW,OAAUC,MAAMC,QAAQb,KAAKW,QAAUX,KAAKW,MAAMG,SAAW,EAAI,CACzE,M,CAGF,MAAMC,EAAiBf,MAAKe,IAC5B,MAAMC,EAAgBD,EAAeE,KAAIC,GACvCC,EAASD,EAAMlB,KAAKoB,WAGtBC,QAAQC,WAAWN,GAAeO,MAAKC,IACrCxB,MAAKF,EAAiB0B,EACnBC,QAAOC,GAAUA,EAAOC,SAAW,cACnCV,KAAIS,GAAUA,EAAOC,SAAW,aAAeD,EAAOE,QAEzD5B,MAAK6B,IACL7B,KAAKM,YAAYwB,KAAK,CACpBC,QAAS/B,MAAKF,EAAemB,KAAIe,GAAgBA,EAAaC,SAEhEjC,KAAKkC,OAAS,KAEd,MAAMC,EAAWX,EAAQC,QAAOC,GAAUA,EAAOC,SAAW,aAC5D,GAAIQ,EAASrB,OAAS,EAAG,CAEvBsB,QAAQC,MAAM,yBAA0BF,E,IAE1C,EAGJpB,GAAkB,KAChB,MAAMuB,EAAO1B,MAAMC,QAAQb,KAAKW,OAASX,KAAKW,MAAQ,CAACX,KAAKW,OAE5D,OAAO2B,EAAKrB,KAAIC,IACd,UAAWA,IAAS,SAAU,CAC5B,MAAO,CAAEe,KAAMf,E,CAGjB,OAAOA,CAAI,GACX,EAGJW,GAAgB,KACd,MAAMU,EAAOvC,KAAKQ,GAAGgC,cAErB,KAAMD,aAAgBE,UAAYF,aAAgBG,YAAa,CAC7D,M,CAEF,MAAM3B,EAAiBf,MAAKe,IAE5Bf,MAAKF,EAAe6C,SAAQX,IAC1B,GACEhC,MAAK4C,EAAiB7B,EAAgBiB,KACrCO,EAAKM,mBAAmBC,SAASd,EAAae,YAC/C,CACAR,EAAKM,mBAAmBG,KAAKhB,EAAae,W,IAE5C,EAGJE,GAAgB,KACd,MAAMV,EAAOvC,KAAKQ,GAAGgC,cAErB,KAAMD,aAAgBE,UAAYF,aAAgBG,YAAa,CAC7D,M,CAGF1C,MAAKF,EAAe6C,SAAQX,IAC1B,MAAMkB,EAAaX,EAAKM,mBAAmBM,WACzCC,GAAqBA,IAAsBpB,EAAae,aAG1D,GAAIG,GAAc,EAAG,CACnBG,EAAcd,EAAKM,mBAAoBK,E,IAEzC,EAGJN,GAAmB,CAACU,EAAmCC,KAErD,MAAMC,EAAiBF,EAAgBG,MACrCvC,GAAQA,EAAKe,OAASsB,EAAMtB,OAI9B,GACGuB,EAAqCE,KACrCF,EAA4CT,WAC7C,CACA,OAAOS,EAAeG,kBAAoB3D,KAAK4D,iB,CAIjD,OAAO,IAAI,EAGb3D,GAAwB,KACtB,IAAKD,KAAKkC,SAAWlC,KAAKW,MAAO,CAC/B,M,CAMF,GAAIX,KAAK4D,kBAAmB,CAC1B5D,MAAK6B,G,KACA,CACL7B,MAAKiD,G,GAIT,MAAAY,GACE,OACE7D,KAAK8D,8BACJ9D,KAAKkC,QAAU6B,EAAA,SAAAC,IAAA,4CAAQpE,E"}